<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <?!= include('style'); ?>
  <style>
    /* SPAç”¨è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .page { display: none; }
    .page.active { display: block; }
    .nav-link { cursor: pointer; }
    .nav-link:hover { background: rgba(255,255,255,0.1); }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4a86e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .tab-count {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 4px;
    }
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .filter-bar select, .filter-bar input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    /* ã€Œãã®ä»–ã€è©³ç´°å…¥åŠ›æ¬„ */
    .other-detail-input {
      display: none;
      margin-top: 8px;
    }
    .other-detail-input.visible {
      display: block;
    }
    .other-detail-input input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    /* Buddyã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .buddy-alert-header {
      background: linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%);
      padding: 24px;
      text-align: center;
      color: white;
    }
    .buddy-alert-header.level3 {
      background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);
    }
    .buddy-avatar-large {
      font-size: 64px;
      margin-bottom: 8px;
    }
    .buddy-alert-level {
      font-size: 14px;
      font-weight: bold;
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      display: inline-block;
    }
    .buddy-alert-body {
      padding: 24px;
    }
    .buddy-alert-message {
      font-size: 16px;
      line-height: 1.6;
      color: #333;
      margin-bottom: 16px;
    }
    .buddy-alert-detail {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .alert-detail-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }
    .alert-detail-label {
      color: #666;
      font-size: 13px;
    }
    .alert-detail-value {
      font-weight: bold;
      color: #333;
    }
    .buddy-alert-count {
      text-align: center;
      font-size: 13px;
      color: #666;
      padding: 8px;
      background: #fff3cd;
      border-radius: 4px;
    }
    .buddy-alert-actions {
      padding: 16px 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    /* ã‚·ãƒ•ãƒˆç®¡ç† */
    .shift-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .shift-day-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      min-height: 180px;
    }
    .shift-day-header {
      font-weight: bold;
      text-align: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
    }
    .shift-day-header.weekend {
      color: #dc3545;
    }
    .shift-time-slot {
      margin-bottom: 8px;
    }
    .shift-time-slot label {
      font-size: 11px;
      color: #666;
      display: block;
      margin-bottom: 2px;
    }
    .shift-time-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .shift-time-row select {
      flex: 1;
      padding: 4px;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .shift-time-row span {
      font-size: 12px;
      color: #666;
    }
    .shift-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .shift-table th, .shift-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .shift-table th {
      background: #f5f5f5;
      font-weight: bold;
    }
    .shift-table .staff-name {
      text-align: left;
      font-weight: bold;
      white-space: nowrap;
    }
    .shift-cell {
      min-width: 80px;
    }
    .shift-time-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-block;
      margin: 1px;
    }
    .shift-empty {
      color: #ccc;
    }
    @media (max-width: 768px) {
      .shift-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    /* ãƒãƒƒã‚¸è¡¨ç¤º */
    .badge-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .badge-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
      border: 1px solid #ffc107;
      border-radius: 20px;
      font-size: 13px;
    }
    .badge-item.locked {
      background: #f5f5f5;
      border-color: #ddd;
      opacity: 0.5;
    }
    .badge-icon {
      font-size: 18px;
    }
    .badge-name {
      font-weight: bold;
    }
    /* ãƒãƒƒã‚¸ç²å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes badgePopIn {
      0% { transform: scale(0) rotate(-15deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(5deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes badgeGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(255, 193, 7, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 193, 7, 1), 0 0 40px rgba(255, 193, 7, 0.5); }
    }
    @keyframes badgeShine {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    .badge-item.new-badge {
      animation: badgePopIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards,
                 badgeGlow 2s ease-in-out 0.6s infinite;
    }
    /* ãƒãƒƒã‚¸ç²å¾—ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .badge-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .badge-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .badge-modal {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      transform: scale(0.8) translateY(20px);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    .badge-modal-overlay.show .badge-modal {
      transform: scale(1) translateY(0);
    }
    .badge-modal-title {
      color: #ffd700;
      font-size: 24px;
      margin-bottom: 10px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    .badge-modal-icon {
      font-size: 80px;
      margin: 20px 0;
      animation: badgePopIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.3s both;
    }
    .badge-modal-name {
      color: #fff;
      font-size: 28px;
      font-weight: bold;
      margin: 15px 0;
    }
    .badge-modal-description {
      color: #aaa;
      font-size: 16px;
      margin-bottom: 30px;
    }
    .badge-modal-close {
      background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
      border: none;
      color: #1a1a2e;
      padding: 12px 40px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .badge-modal-close:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
    }
    /* ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤ºå¼·åŒ– */
    .streak-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      border-radius: 25px;
      color: #fff;
      font-weight: bold;
      animation: streakPulse 2s ease-in-out infinite;
    }
    @keyframes streakPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .streak-fire {
      font-size: 20px;
      animation: fireFlicker 0.5s ease-in-out infinite alternate;
    }
    @keyframes fireFlicker {
      0% { transform: scale(1) rotate(-5deg); }
      100% { transform: scale(1.1) rotate(5deg); }
    }
    .streak-count {
      font-size: 18px;
    }
    .badge-item:hover {
      transform: scale(1.05);
      transition: transform 0.2s;
    }
    /* ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– */
    .report-tabs {
      display: flex;
      gap: 4px;
      background: #f5f5f5;
      border-radius: 8px;
      padding: 4px;
    }
    .report-tab {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    .report-tab.active {
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      color: #4a86e8;
    }
    .report-tab-content {
      display: none;
    }
    .report-tab-content.active {
      display: block;
    }
    .buddy-feedback-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #FF6B35;
    }
    .buddy-feedback-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .buddy-avatar-small {
      font-size: 24px;
    }
    .buddy-feedback-text {
      line-height: 1.6;
      color: #333;
    }
    /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹…å½“æ¡ˆä»¶ãƒ†ãƒ¼ãƒ–ãƒ« */
    .active-deals-table-container {
      overflow-x: auto;
    }
    .active-deals-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .active-deals-table th,
    .active-deals-table td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    .active-deals-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¡Œ */
    .clickable-row {
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .clickable-row:hover {
      background-color: #f0f7ff;
    }
    /* æ¡ˆä»¶æ“ä½œãƒœã‚¿ãƒ³ */
    .deal-row-actions {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    .deal-row-btn {
      background: none;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.15s ease;
    }
    .deal-row-btn:hover {
      background: #f0f0f0;
      border-color: #bbb;
    }
    .deal-row-btn-message:hover {
      background: #e8f4fd;
      border-color: #4a86e8;
    }
    .deal-row-btn-report:hover {
      background: #fff8e6;
      border-color: #f5a623;
    }
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .deal-status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .deal-status-badge.status-å¯¾å¿œä¸­ { background: #e3f2fd; color: #1976d2; }
    .deal-status-badge.status-ææ¡ˆä¸­ { background: #fff3e0; color: #f57c00; }
    .deal-status-badge.status-è¦‹ç©ä¸­ { background: #f3e5f5; color: #7b1fa2; }
    .deal-status-badge.status-ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚° { background: #e8f5e9; color: #388e3c; }
  </style>
</head>
<body>
  <!-- èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º -->
  <div id="auth-loading" style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5;">
    <div style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”</div>
      <p>èªè¨¼ä¸­...</p>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆèªè¨¼æˆåŠŸå¾Œã«è¡¨ç¤ºï¼‰ -->
  <div id="app-container" style="display: none;">

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo-box">
        <div class="sidebar-logo-icon">
          <svg width="24" height="24" viewBox="0 0 24 24">
            <defs>
              <linearGradient id="orangeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#FF6B35"/>
                <stop offset="100%" style="stop-color:#FF8C5A"/>
              </linearGradient>
            </defs>
            <circle cx="12" cy="12" r="10" fill="url(#orangeGrad)"/>
          </svg>
        </div>
        <div class="sidebar-logo-text">
          <span class="logo-main">CRM</span>
          <span class="logo-sub">Sales Ops</span>
        </div>
      </div>
    </div>
    <nav class="sidebar-menu" id="sidebarMenu">
      <!-- CSã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="sidebar-section" id="section-cs" data-section="cs">
        <div class="sidebar-section-header" onclick="toggleSidebarSection('section-cs')">
          <span>ğŸ’¬ CS</span>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="sidebar-section-items">
          <a class="sidebar-menu-item" data-page="leads-in">
            <span class="menu-icon">ğŸ“¥</span>
            ãƒªãƒ¼ãƒ‰ï¼ˆINï¼‰
            <span class="sidebar-badge" id="badge-leads-in"></span>
          </a>
          <a class="sidebar-menu-item" data-page="leads-out">
            <span class="menu-icon">ğŸ“¤</span>
            ãƒªãƒ¼ãƒ‰ï¼ˆOUTï¼‰
            <span class="sidebar-badge" id="badge-leads-out"></span>
          </a>
          <a class="sidebar-menu-item" data-page="archive">
            <span class="menu-icon">ğŸ—„ï¸</span>
            ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
          </a>
        </div>
      </div>

      <!-- å–¶æ¥­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="sidebar-section" id="section-sales" data-section="sales">
        <div class="sidebar-section-header" onclick="toggleSidebarSection('section-sales')">
          <span>ğŸ’¼ å–¶æ¥­</span>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="sidebar-section-items">
          <a class="sidebar-menu-item" data-page="dashboard">
            <span class="menu-icon">ğŸ“Š</span>
            ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
          </a>
          <a class="sidebar-menu-item" data-page="deals">
            <span class="menu-icon">ğŸ’¼</span>
            å•†è«‡ç®¡ç†
            <span class="sidebar-badge" id="badge-deals"></span>
          </a>
          <a class="sidebar-menu-item coming-soon" onclick="showComingSoon(event)">
            <span class="menu-icon">ğŸ“¦</span>
            åœ¨åº«è¡¨ï¼ˆæº–å‚™ä¸­ï¼‰
          </a>
          <a class="sidebar-menu-item coming-soon" onclick="showComingSoon(event)">
            <span class="menu-icon">ğŸ“„</span>
            è¦‹ç©ã‚‚ã‚Šï¼ˆæº–å‚™ä¸­ï¼‰
          </a>
          <a class="sidebar-menu-item coming-soon" onclick="showComingSoon(event)">
            <span class="menu-icon">ğŸ¢</span>
            é¡§å®¢ãƒã‚¹ã‚¿ï¼ˆæº–å‚™ä¸­ï¼‰
          </a>
          <a class="sidebar-menu-item coming-soon" onclick="showComingSoon(event)">
            <span class="menu-icon">ğŸ§¾</span>
            è«‹æ±‚æ›¸ç™ºè¡Œï¼ˆæº–å‚™ä¸­ï¼‰
          </a>
        </div>
      </div>

      <!-- å…±é€šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="sidebar-section" id="section-common" data-section="common">
        <div class="sidebar-section-header" onclick="toggleSidebarSection('section-common')">
          <span>ğŸ“‹ å…±é€š</span>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="sidebar-section-items">
          <a class="sidebar-menu-item" data-page="shift-submit">
            <span class="menu-icon">ğŸ“…</span>
            ã‚·ãƒ•ãƒˆæå‡º
          </a>
          <a class="sidebar-menu-item" data-page="daily-report">
            <span class="menu-icon">ğŸ“</span>
            æ—¥å ±
          </a>
          <a class="sidebar-menu-item" data-page="report">
            <span class="menu-icon">ğŸ“Š</span>
            é€±æ¬¡/æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
          </a>
        </div>
      </div>

      <!-- ãƒªãƒ¼ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="sidebar-section" id="section-leader" data-section="leader">
        <div class="sidebar-section-header" onclick="toggleSidebarSection('section-leader')">
          <span>ğŸ‘‘ ãƒªãƒ¼ãƒ€ãƒ¼</span>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="sidebar-section-items">
          <a class="sidebar-menu-item coming-soon" onclick="showComingSoon(event)">
            <span class="menu-icon">ğŸ“ˆ</span>
            ãƒªãƒ¼ãƒ€ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæº–å‚™ä¸­ï¼‰
          </a>
          <a class="sidebar-menu-item" data-page="shift">
            <span class="menu-icon">ğŸ“…</span>
            ã‚·ãƒ•ãƒˆç®¡ç†
          </a>
          <a class="sidebar-menu-item coming-soon" onclick="showComingSoon(event)">
            <span class="menu-icon">ğŸ“‹</span>
            ãƒ¬ãƒãƒ¼ãƒˆãƒ­ã‚°ï¼ˆæº–å‚™ä¸­ï¼‰
          </a>
          <a class="sidebar-menu-item coming-soon" onclick="showComingSoon(event)">
            <span class="menu-icon">ğŸ“Š</span>
            é€±æ¬¡/æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ­ã‚°ï¼ˆæº–å‚™ä¸­ï¼‰
          </a>
          <a class="sidebar-menu-item" data-page="staff">
            <span class="menu-icon">ğŸ‘¥</span>
            ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†
          </a>
        </div>
      </div>

      <!-- ç®¡ç†è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="sidebar-section" id="section-admin" data-section="admin">
        <div class="sidebar-section-header" onclick="toggleSidebarSection('section-admin')">
          <span>âš™ï¸ ç®¡ç†è€…</span>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="sidebar-section-items">
          <a class="sidebar-menu-item" data-page="admin">
            <span class="menu-icon">âš™ï¸</span>
            ç®¡ç†è€…è¨­å®š
          </a>
        </div>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <button class="notification-bell" onclick="toggleNotificationPanel()" title="ãŠçŸ¥ã‚‰ã›">
          ğŸ””
          <span class="notification-badge" id="notification-count" style="display:none;">0</span>
        </button>
        <span class="user-icon">ğŸ‘¤</span>
        <span id="user-display">èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>
    </div>
  </aside>

  <!-- é€šçŸ¥ãƒ‘ãƒãƒ« -->
  <div id="notification-panel" class="notification-panel" style="display:none;">
    <div class="notification-panel-header">
      <h4>ğŸ”” æ–°ã—ã„ãŠçŸ¥ã‚‰ã›ï¼ˆ<span id="unread-count">0</span>ä»¶ï¼‰</h4>
      <button onclick="closeNotificationPanel()">âœ•</button>
    </div>
    <div class="notification-panel-body" id="notification-list">
    </div>
    <div class="notification-panel-footer">
      <button class="btn-text" onclick="markAllNoticesRead()">ã™ã¹ã¦æ—¢èª­ã«ã™ã‚‹</button>
      <button class="btn-text" onclick="switchPage('notices'); closeNotificationPanel();">ã™ã¹ã¦è¡¨ç¤º</button>
    </div>
  </div>

  <!-- æ‹…å½“è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰ -->
  <div id="staff-detail-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="staffDetailTitle">æ‹…å½“è€…è©³ç´°</h3>
        <button class="modal-close" onclick="closeModal('staff-detail-modal')">âœ•</button>
      </div>
      <div class="modal-body">
        <!-- ä»Šæœˆã®æ•°å­— -->
        <div class="staff-detail-metrics">
          <div class="staff-metric-card">
            <div class="staff-metric-value" id="staffDetailDeals">-</div>
            <div class="staff-metric-label">å•†è«‡æ•°</div>
          </div>
          <div class="staff-metric-card staff-metric-success">
            <div class="staff-metric-value" id="staffDetailWon">-</div>
            <div class="staff-metric-label">æˆç´„</div>
          </div>
          <div class="staff-metric-card staff-metric-danger">
            <div class="staff-metric-value" id="staffDetailLost">-</div>
            <div class="staff-metric-label">å¤±æ³¨</div>
          </div>
          <div class="staff-metric-card staff-metric-info">
            <div class="staff-metric-value" id="staffDetailWinRate">-</div>
            <div class="staff-metric-label">æˆç´„ç‡</div>
          </div>
        </div>

        <!-- å¯¾å¿œãŒå¿…è¦ãªæ¡ˆä»¶ -->
        <div class="staff-detail-section">
          <h4>âš ï¸ å¯¾å¿œãŒå¿…è¦ãªæ¡ˆä»¶</h4>
          <div id="staffDetailProblemDeals" class="staff-problem-deals">
            <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- é€±æ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ -->
        <div class="staff-detail-section">
          <h4>ğŸ“Š é€±æ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»4é€±ï¼‰</h4>
          <div id="staffDetailWeeklyTrend" class="staff-weekly-trend">
            <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('staff-detail-modal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãŠçŸ¥ã‚‰ã›è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="notice-detail-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="notice-detail-title"></h3>
        <button class="modal-close" onclick="closeModal('notice-detail-modal')">âœ•</button>
      </div>
      <div class="modal-body">
        <p class="notice-datetime" id="notice-detail-datetime"></p>
        <div class="notice-body" id="notice-detail-body"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-action" id="notice-action-btn" style="display:none;"></button>
        <button class="btn btn-secondary" onclick="markCurrentNoticeRead()">ç¢ºèªæ¸ˆã¿</button>
      </div>
    </div>
  </div>

  <!-- é‡è¤‡è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="duplicate-warning-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header" style="background: #fff3cd;">
        <h3>âš ï¸ éå»ã«å•ã„åˆã‚ã›å±¥æ­´ãŒã‚ã‚Šã¾ã™</h3>
        <button class="modal-close" onclick="closeModal('duplicate-warning-modal')">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="dup-info-grid">
          <div class="dup-info-row">
            <span class="dup-label">é¡§å®¢å:</span>
            <span id="dup-customer-name"></span>
          </div>
          <div class="dup-info-row">
            <span class="dup-label">å‰å›:</span>
            <span id="dup-last-date"></span>ï¼ˆ<span id="dup-last-status"></span>ï¼‰
          </div>
          <div class="dup-info-row">
            <span class="dup-label">å‰å›æ‹…å½“:</span>
            <span id="dup-last-staff"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="showDuplicateHistory()">å±¥æ­´ã‚’ç¢ºèª</button>
        <button class="btn btn-primary" onclick="confirmAsNewLead()">æ–°è¦ã¨ã—ã¦ç™»éŒ²</button>
        <button class="btn" onclick="closeModal('duplicate-warning-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <div class="container">

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ -->
    <div class="page active" id="page-dashboard">

      <!-- å–¶æ¥­ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
      <div id="dashboard-sales" class="dashboard-container" style="display: none;">
        <!-- Buddyã‚«ãƒ¼ãƒ‰ï¼ˆæ‹¡å¼µç‰ˆï¼‰ -->
        <div class="buddy-card buddy-card-extended" id="buddyCard">
          <div class="buddy-header">
            <div class="buddy-avatar">ğŸ§”â€â™‚ï¸</div>
            <div class="buddy-name">Buddy</div>
            <div class="buddy-goal-badge" id="buddyGoalBadge" style="display: none;">
              <span class="badge-progress" id="buddyGoalProgress">-</span>
            </div>
          </div>
          <div class="buddy-message" id="buddyMessage">
            èª­ã¿è¾¼ã¿ä¸­...
          </div>

          <!-- ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤º -->
          <div id="streakDisplay" class="streak-display" style="display: none;">
            <span class="streak-fire">ğŸ”¥</span>
            <span class="streak-count" id="streakCount">0</span>
            <span>é€£å‹ä¸­ï¼</span>
          </div>

          <!-- ä»Šé€±ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ -->
          <div class="buddy-focus-section" id="buddyFocusSection" style="display: none;">
            <div class="focus-header">
              <span class="focus-icon">ğŸ¯</span>
              <span class="focus-title">ä»Šé€±ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</span>
            </div>
            <div class="focus-content" id="buddyFocusContent">-</div>
          </div>

          <!-- ç›®æ¨™é€²æ—ãƒãƒ¼ -->
          <div class="buddy-progress-section" id="buddyProgressSection" style="display: none;">
            <div class="progress-header">
              <span>ä»Šæœˆã®é€²æ—</span>
              <span id="buddyProgressLabel">-</span>
            </div>
            <div class="buddy-mini-progress-bar">
              <div class="mini-progress-fill" id="buddyProgressFill" style="width: 0%"></div>
            </div>
          </div>

          <div class="buddy-actions-section" id="buddyActionsSection" style="display: none;">
            <h4>ğŸ“‹ ä»Šæ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
            <ul class="buddy-action-list" id="buddyActionList"></ul>
          </div>
          <div class="buddy-buttons">
            <button class="buddy-btn buddy-btn-primary" onclick="navigateToBuddyCoaching()">
              ğŸ§”â€â™‚ï¸ Buddyå£æ‰“ã¡
            </button>
          </div>
        </div>

        <div class="dashboard-header">
          <h2>å–¶æ¥­ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
        </div>

        <!-- ã‚¿ãƒ– -->
        <div class="dashboard-tabs">
          <button class="dashboard-tab active" onclick="showSalesTab('personal')">ğŸ‘¤ å€‹äºº</button>
          <button class="dashboard-tab" onclick="showSalesTab('team')">ğŸ‘¥ ãƒãƒ¼ãƒ </button>
        </div>

        <!-- å€‹äººã‚¿ãƒ– -->
        <div id="sales-personal" class="dashboard-tab-content active">
          <!-- ã‚«ãƒ¼ãƒ‰1: ä»Šæœˆã®ç›®æ¨™é€²æ— -->
          <div class="section goal-progress-card">
            <h3>ğŸ“Š ä»Šæœˆã®ç›®æ¨™é€²æ—</h3>
            <div class="goal-progress-content">
              <div class="goal-progress-item">
                <div class="goal-progress-header">
                  <span class="goal-label">æˆç´„</span>
                  <span class="goal-values"><span id="goalClosedCurrent">-</span>/<span id="goalClosedTarget">-</span>ä»¶</span>
                </div>
                <div class="goal-progress-bar">
                  <div class="goal-progress-fill" id="goalClosedFill" style="width: 0%"></div>
                </div>
                <div class="goal-progress-percent" id="goalClosedPercent">0%</div>
              </div>
              <div class="goal-progress-item">
                <div class="goal-progress-header">
                  <span class="goal-label">å£²ä¸Š</span>
                  <span class="goal-values"><span id="goalSalesCurrent">-</span>/<span id="goalSalesTarget">-</span>ä¸‡</span>
                </div>
                <div class="goal-progress-bar">
                  <div class="goal-progress-fill" id="goalSalesFill" style="width: 0%"></div>
                </div>
                <div class="goal-progress-percent" id="goalSalesPercent">0%</div>
              </div>
            </div>
            <div class="goal-no-data" id="goalNoData" style="display: none;">
              <p>ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              <button class="btn btn-sm" onclick="navigateToBuddyCoaching()">ç›®æ¨™ã‚’è¨­å®šã™ã‚‹</button>
            </div>
          </div>

          <!-- ã‚«ãƒ¼ãƒ‰2: æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="section upcoming-actions-card">
            <h3>âš ï¸ æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div id="upcomingActions" class="upcoming-actions-list">
              <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>

          <!-- ã‚«ãƒ¼ãƒ‰3: æ‹…å½“æ¡ˆä»¶ï¼ˆé€²è¡Œä¸­ï¼‰ -->
          <div class="section active-deals-card">
            <h3>ğŸ’¼ æ‹…å½“æ¡ˆä»¶ï¼ˆé€²è¡Œä¸­ï¼‰</h3>
            <div class="active-deals-table-container">
              <table class="active-deals-table" id="activeDealsTable">
                <thead>
                  <tr>
                    <th>é¡§å®¢å</th>
                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <th>æ¬¡å›</th>
                    <th style="width: 110px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="activeDealsBody">
                  <tr><td colspan="4" class="no-data">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div id="activeDealsMore" style="display: none; text-align: center; margin-top: 12px;">
              <a href="#" onclick="switchPage('deals'); return false;" style="color: #4a86e8; font-size: 13px;">ã‚‚ã£ã¨è¦‹ã‚‹ â†’</a>
            </div>
          </div>

          <!-- ãƒãƒƒã‚¸ï¼ˆç¸®å°ç‰ˆï¼‰ -->
          <div class="section badge-section-compact">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3>ğŸ† ç²å¾—ãƒãƒƒã‚¸ <span id="badgeCountDisplay" style="font-size: 14px; color: #666;"></span></h3>
            </div>
            <div id="badgeContainer" class="badge-grid-compact">
              <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>
        </div>

        <!-- ãƒãƒ¼ãƒ ã‚¿ãƒ– -->
        <div id="sales-team" class="dashboard-tab-content">
          <div class="section">
            <h3>ãƒãƒ¼ãƒ æˆç¸¾</h3>
            <div id="team-stats-table" class="team-stats-container">
              <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>
        </div>

        <div class="dashboard-footer">
          <span>æœ€çµ‚æ›´æ–°: <span id="sales-last-updated">-</span></span>
        </div>
      </div>

      <!-- ãƒªãƒ¼ãƒ€ãƒ¼/ã‚ªãƒ¼ãƒŠãƒ¼/ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
      <div id="dashboard-full" class="dashboard-container" style="display: none;">
        <!-- Buddyã‚«ãƒ¼ãƒ‰ï¼ˆãƒªãƒ¼ãƒ€ãƒ¼/ã‚ªãƒ¼ãƒŠãƒ¼ç”¨ï¼‰ -->
        <div class="buddy-card buddy-card-extended" id="buddyCardFull">
          <div class="buddy-header">
            <div class="buddy-avatar">ğŸ§”â€â™‚ï¸</div>
            <div class="buddy-name">Buddy</div>
            <div class="buddy-goal-badge" id="buddyGoalBadgeFull" style="display: none;">
              <span class="badge-progress" id="buddyGoalProgressFull">-</span>
            </div>
          </div>
          <div class="buddy-message" id="buddyMessageFull">
            èª­ã¿è¾¼ã¿ä¸­...
          </div>

          <!-- ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤º -->
          <div id="streakDisplayFull" class="streak-display" style="display: none;">
            <span class="streak-fire">ğŸ”¥</span>
            <span class="streak-count" id="streakCountFull">0</span>
            <span>é€£å‹ä¸­ï¼</span>
          </div>

          <!-- ä»Šé€±ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ -->
          <div class="buddy-focus-section" id="buddyFocusSectionFull" style="display: none;">
            <div class="focus-header">
              <span class="focus-icon">ğŸ¯</span>
              <span class="focus-title">ä»Šé€±ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</span>
            </div>
            <div class="focus-content" id="buddyFocusContentFull">-</div>
          </div>

          <!-- ç›®æ¨™é€²æ—ãƒãƒ¼ -->
          <div class="buddy-progress-section" id="buddyProgressSectionFull" style="display: none;">
            <div class="progress-header">
              <span>ä»Šæœˆã®é€²æ—</span>
              <span id="buddyProgressLabelFull">-</span>
            </div>
            <div class="buddy-mini-progress-bar">
              <div class="mini-progress-fill" id="buddyProgressFillFull" style="width: 0%"></div>
            </div>
          </div>

          <div class="buddy-actions-section" id="buddyActionsSectionFull">
            <div class="reminder-header">
              <div class="reminder-title">
                <span>ğŸ””</span>
                <span>ä»Šæ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
              </div>
              <div class="reminder-progress" id="reminderProgressText">0/0 å®Œäº†</div>
            </div>
            <div class="reminder-progress-bar">
              <div class="reminder-progress-fill" id="reminderProgressFill" style="width: 0%"></div>
            </div>
            <div class="reminder-list" id="buddyActionListFull"></div>
            <div class="reminder-more" id="reminderMoreBtn" style="display: none;" onclick="showAllReminders()">
              +<span id="reminderMoreCount">0</span>ä»¶ã‚’è¦‹ã‚‹
            </div>
          </div>
          <div class="buddy-buttons">
            <button class="buddy-btn buddy-btn-primary" onclick="navigateToBuddyCoaching()">
              ğŸ§”â€â™‚ï¸ Buddyå£æ‰“ã¡
            </button>
          </div>
        </div>

        <div class="dashboard-tabs">
          <button class="dashboard-tab active" data-tab="personal" onclick="showDashboardTab('personal')">ğŸ‘¤ å€‹äºº</button>
          <button class="dashboard-tab" data-tab="team" onclick="showDashboardTab('team')">ğŸ‘¥ ãƒãƒ¼ãƒ </button>
          <button class="dashboard-tab" data-tab="leader" onclick="showDashboardTab('leader')" id="tabBtnLeader" style="display: none;">ğŸ‘‘ ãƒªãƒ¼ãƒ€ãƒ¼</button>
        </div>

        <!-- å€‹äººã‚¿ãƒ– -->
        <div id="tab-personal" class="dashboard-tab-content active">
          <!-- å€‹äººKPI -->
          <div class="kpi-cards">
            <div class="kpi-card">
              <div class="kpi-value" id="fullPersonalDeals">-</div>
              <div class="kpi-label">æ‹…å½“å•†è«‡</div>
            </div>
            <div class="kpi-card kpi-card-success">
              <div class="kpi-value" id="fullPersonalWon">-</div>
              <div class="kpi-label">æˆç´„</div>
            </div>
            <div class="kpi-card kpi-card-info">
              <div class="kpi-value" id="fullPersonalWinRate">-</div>
              <div class="kpi-label">æˆç´„ç‡</div>
            </div>
            <div class="kpi-card kpi-card-highlight">
              <div class="kpi-value" id="fullPersonalSales">-</div>
              <div class="kpi-label">å£²ä¸Š</div>
            </div>
          </div>

          <!-- ç›®æ¨™é€²æ— -->
          <div class="section">
            <h3>ä»Šæœˆã®ç›®æ¨™é€²æ—</h3>
            <div id="fullPersonalGoalProgress">
              <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>

          <!-- æ‹…å½“æ¡ˆä»¶ä¸€è¦§ -->
          <div class="section">
            <h3>æ‹…å½“æ¡ˆä»¶ï¼ˆé€²è¡Œä¸­ï¼‰</h3>
            <div id="fullPersonalDealsTable" style="overflow-x: auto;">
              <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>

          <!-- æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="section">
            <h3>æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div id="fullPersonalUpcoming" class="action-list-container">
              <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>

          <div style="text-align: right; font-size: 12px; color: #999; margin-top: 16px;">
            æœ€çµ‚æ›´æ–°: <span id="fullPersonalLastUpdated">-</span>
          </div>
        </div>

        <!-- ãƒãƒ¼ãƒ ã‚¿ãƒ–ï¼ˆæº–å‚™ä¸­ï¼‰ -->
        <div id="tab-team" class="dashboard-tab-content">
          <div class="section" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¥</div>
            <h3 style="color: #666; margin-bottom: 8px;">ãƒãƒ¼ãƒ æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™</h3>
            <p style="color: #999; font-size: 14px;">ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãŠå¾…ã¡ãã ã•ã„</p>
          </div>
        </div>

        <!-- ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ãƒ–ï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ -->
        <div id="tab-leader" class="dashboard-tab-content">
          <!-- ãƒãƒ¼ãƒ KPI -->
          <div class="kpi-cards">
            <div class="kpi-card">
              <div class="kpi-value" id="bnTeamDeals">-</div>
              <div class="kpi-label">ä»Šæœˆå•†è«‡æ•°</div>
            </div>
            <div class="kpi-card kpi-card-success">
              <div class="kpi-value" id="bnTeamWon">-</div>
              <div class="kpi-label">æˆç´„æ•°</div>
            </div>
            <div class="kpi-card kpi-card-info">
              <div class="kpi-value" id="bnTeamWinRate">-</div>
              <div class="kpi-label">æˆç´„ç‡</div>
            </div>
            <div class="kpi-card kpi-card-warning" id="bnStagnantCard">
              <div class="kpi-value" id="bnStagnantCount">-</div>
              <div class="kpi-label">åœæ»æ¡ˆä»¶</div>
            </div>
          </div>

          <!-- ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="section bottleneck-section">
            <h3 class="bottleneck-header">ğŸš¨ å¯¾å¿œå¿…è¦</h3>

            <!-- åœæ»æ¡ˆä»¶ -->
            <div class="bottleneck-card" id="bnStagnantSection">
              <div class="bottleneck-card-header">
                <span class="bottleneck-icon">â°</span>
                <span class="bottleneck-title">åœæ»æ¡ˆä»¶ï¼ˆ48æ™‚é–“ä»¥ä¸Šæœªæ›´æ–°ï¼‰</span>
                <span class="bottleneck-count" id="bnStagnantBadge">0</span>
              </div>
              <div class="bottleneck-card-body" id="bnStagnantByStaff">
                <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
              </div>
            </div>

            <!-- ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°é•·æœŸåŒ– -->
            <div class="bottleneck-card" id="bnLongDealSection">
              <div class="bottleneck-card-header">
                <span class="bottleneck-icon">ğŸ“…</span>
                <span class="bottleneck-title">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°é•·æœŸåŒ–ï¼ˆ7æ—¥ä»¥ä¸Šï¼‰</span>
                <span class="bottleneck-count" id="bnLongDealBadge">0</span>
              </div>
              <div class="bottleneck-card-body" id="bnLongDeals">
                <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
              </div>
            </div>

            <!-- æˆç´„ç‡ä½ä¸‹ -->
            <div class="bottleneck-card" id="bnConversionDropSection">
              <div class="bottleneck-card-header">
                <span class="bottleneck-icon">ğŸ“‰</span>
                <span class="bottleneck-title">æˆç´„ç‡ä½ä¸‹ï¼ˆå…ˆæœˆæ¯”-20%ä»¥ä¸Šï¼‰</span>
                <span class="bottleneck-count" id="bnConversionDropBadge">0</span>
              </div>
              <div class="bottleneck-card-body" id="bnConversionDrop">
                <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
              </div>
            </div>
          </div>

          <!-- æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
          <div class="section">
            <h3>æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
            <div id="bnStaffPerformanceTable" style="overflow-x: auto;">
              <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>

          <div style="text-align: right; font-size: 12px; color: #999; margin-top: 16px;">
            æœ€çµ‚æ›´æ–°: <span id="bnLastUpdated">-</span>
          </div>
        </div>
      </div>

    </div>

    <!-- ãƒªãƒ¼ãƒ‰ï¼ˆINï¼‰ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-leads-in">
      <!-- ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰KPI -->
      <div class="section" style="padding: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="font-size: 18px;">ğŸ“Š</span>
          <span style="font-weight: bold; color: #333;">ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div class="kpi-card-small kpi-blue">
            <div class="kpi-label">ç·æ•°</div>
            <div class="kpi-value" id="kpiInTotal">-</div>
          </div>
          <div class="kpi-card-small kpi-green">
            <div class="kpi-label">æœ¬æ—¥æ–°è¦</div>
            <div class="kpi-value" id="kpiInToday">-</div>
          </div>
          <div class="kpi-card-small kpi-yellow">
            <div class="kpi-label">æœªã‚¢ã‚µã‚¤ãƒ³</div>
            <div class="kpi-value" id="kpiInUnassigned">-</div>
          </div>
        </div>
      </div>
      <!-- æ¤œç´¢ãƒ»ä¸¦ã¹æ›¿ãˆãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
      <div class="section" style="padding: 12px 16px;">
        <div class="leads-toolbar">
          <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" id="search-leads-in" placeholder="é¡§å®¢åã§æ¤œç´¢..." oninput="filterLeads('in')">
          </div>
          <div class="sort-container">
            <label style="font-size: 13px; color: #666; margin-right: 8px;">ä¸¦ã¹æ›¿ãˆ:</label>
            <select class="sort-select" id="sort-leads-in" onchange="sortLeads('in', this.value)">
              <option value="date-desc">æ›´æ–°æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
              <option value="date-asc">æ›´æ–°æ—¥ï¼ˆå¤ã„é †ï¼‰</option>
              <option value="alpha">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †</option>
              <option value="source">æµå…¥å…ƒ</option>
            </select>
          </div>
          <button class="btn btn-primary btn-sm" onclick="openAddLeadModal('in')">+ æ–°è¦ãƒªãƒ¼ãƒ‰è¿½åŠ </button>
        </div>
      </div>
      <div class="section" style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>æ›´æ–°æ—¥</th>
              <th>é¡§å®¢å</th>
              <th>æµå…¥å…ƒ</th>
              <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            </tr>
          </thead>
          <tbody id="leadsInBody">
            <tr><td colspan="4" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ãƒªãƒ¼ãƒ‰ï¼ˆOUTï¼‰ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-leads-out">
      <!-- ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰KPI -->
      <div class="section" style="padding: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="font-size: 18px;">ğŸ“Š</span>
          <span style="font-weight: bold; color: #333;">ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div class="kpi-card-small kpi-blue">
            <div class="kpi-label">ç·æ•°</div>
            <div class="kpi-value" id="kpiOutTotal">-</div>
          </div>
          <div class="kpi-card-small kpi-green">
            <div class="kpi-label">æœ¬æ—¥æ–°è¦</div>
            <div class="kpi-value" id="kpiOutToday">-</div>
          </div>
          <div class="kpi-card-small kpi-yellow">
            <div class="kpi-label">æœªã‚¢ã‚µã‚¤ãƒ³</div>
            <div class="kpi-value" id="kpiOutUnassigned">-</div>
          </div>
        </div>
      </div>
      <!-- æ¤œç´¢ãƒ»ä¸¦ã¹æ›¿ãˆãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
      <div class="section" style="padding: 12px 16px;">
        <div class="leads-toolbar">
          <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" id="search-leads-out" placeholder="é¡§å®¢åã§æ¤œç´¢..." oninput="filterLeads('out')">
          </div>
          <div class="sort-container">
            <label style="font-size: 13px; color: #666; margin-right: 8px;">ä¸¦ã¹æ›¿ãˆ:</label>
            <select class="sort-select" id="sort-leads-out" onchange="sortLeads('out', this.value)">
              <option value="date-desc">æ›´æ–°æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
              <option value="date-asc">æ›´æ–°æ—¥ï¼ˆå¤ã„é †ï¼‰</option>
              <option value="alpha">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †</option>
              <option value="source">æµå…¥å…ƒ</option>
            </select>
          </div>
          <button class="btn btn-primary btn-sm" onclick="openAddLeadModal('out')">+ æ–°è¦ãƒªãƒ¼ãƒ‰è¿½åŠ </button>
        </div>
      </div>
      <div class="section" style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>æ›´æ–°æ—¥</th>
              <th>é¡§å®¢å</th>
              <th>æµå…¥å…ƒ</th>
              <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            </tr>
          </thead>
          <tbody id="leadsOutBody">
            <tr><td colspan="4" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- å•†è«‡ç®¡ç†ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-deals">
      <div class="section" style="padding: 16px;">
        <div class="deals-toolbar">
          <div class="deals-toolbar-left">
            <div class="search-container">
              <span class="search-icon">ğŸ”</span>
              <input type="text" class="search-input" id="filterSearch" placeholder="æ¤œç´¢..." oninput="filterDeals()">
            </div>
            <select class="sort-select" id="filterStatus" onchange="filterDeals()">
              <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
              <option value="åˆå›é€£çµ¡">åˆå›é€£çµ¡</option>
              <option value="ææ¡ˆä¸­">ææ¡ˆä¸­</option>
              <option value="è¦‹ç©ä¸­">è¦‹ç©ä¸­</option>
              <option value="ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°</option>
              <option value="ä¿ç•™">ä¿ç•™</option>
            </select>
          </div>
          <div class="deals-toolbar-right">
            <span id="dealCount">-</span> ä»¶ã®å•†è«‡
          </div>
        </div>
      </div>
      <div class="section" style="overflow-x: auto;">
        <table class="data-table" id="dealsTable">
          <thead>
            <tr>
              <th class="sortable-header" data-column="leadId" onclick="sortDealsByHeader('leadId')">ãƒªãƒ¼ãƒ‰ID</th>
              <th class="sortable-header" data-column="staff" onclick="sortDealsByHeader('staff')">æ‹…å½“è€…</th>
              <th class="sortable-header" data-column="customer" onclick="sortDealsByHeader('customer')">é¡§å®¢å</th>
              <th class="sortable-header" data-column="country" onclick="sortDealsByHeader('country')">å›½</th>
              <th class="sortable-header" data-column="source" onclick="sortDealsByHeader('source')">æµå…¥çµŒè·¯</th>
              <th class="sortable-header" data-column="title" onclick="sortDealsByHeader('title')">å–ã‚Šæ‰±ã„ã‚¿ã‚¤ãƒˆãƒ«</th>
              <th class="sortable-header" data-column="type" onclick="sortDealsByHeader('type')">è²©å£²å½¢æ…‹</th>
              <th class="sortable-header" data-column="status" onclick="sortDealsByHeader('status')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th class="sortable-header" data-column="result" onclick="sortDealsByHeader('result')">å•†è«‡çµæœ</th>
              <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
            </tr>
          </thead>
          <tbody id="dealsBody">
            <tr><td colspan="10" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- å•†è«‡è©³ç´°ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆ3ã‚¿ãƒ–æ§‹æˆï¼‰ -->
    <div class="slide-panel-overlay" id="dealSlideOverlay" onclick="closeDealSlidePanel()"></div>
    <div class="slide-panel" id="dealSlidePanel">
      <div class="slide-panel-header">
        <h3 id="dealSlideTitle">å•†è«‡è©³ç´°</h3>
        <button class="slide-panel-close" onclick="closeDealSlidePanel()">&times;</button>
      </div>
      <!-- ã‚¿ãƒ– -->
      <div class="slide-panel-tabs">
        <button class="slide-panel-tab active" data-tab="detail" onclick="switchDealSlideTab('detail')">
          ğŸ“‹ è©³ç´°
        </button>
        <button class="slide-panel-tab" data-tab="conversation" onclick="switchDealSlideTab('conversation')">
          ğŸ’¬ ä¼šè©±
        </button>
        <button class="slide-panel-tab" data-tab="report" onclick="switchDealSlideTab('report')">
          ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆ
        </button>
      </div>
      <div class="slide-panel-body" id="dealSlideBody">
        <!-- ğŸ“‹ è©³ç´°ã‚¿ãƒ– -->
        <div class="slide-tab-content active" id="tabDetail">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        <!-- ğŸ’¬ ä¼šè©±ã‚¿ãƒ– -->
        <div class="slide-tab-content" id="tabConversation">
          <!-- ä¼šè©±è¦ç´„ -->
          <div class="conv-summary-box">
            <h4>ğŸ’¬ ä¼šè©±è¦ç´„</h4>
            <div class="conv-summary-text" id="convSummaryText">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div class="conv-meta-info">
              <span>æœ€çµ‚: <span id="convLastDate">-</span></span>
              <span>ä¼šè©±æ•°: <span id="convCount">0</span></span>
            </div>
          </div>
          <button class="conv-btn conv-btn-secondary" onclick="toggleConversationLogs()" id="btnShowLogs">
            å…¨ãƒ­ã‚°ã‚’è¡¨ç¤º
          </button>
          <div class="conv-log-container" id="convLogContainer">
            <!-- ä¼šè©±ãƒ­ã‚°ãŒå‹•çš„ã«è¡¨ç¤º -->
          </div>

          <hr style="margin: 16px 0; border: none; border-top: 1px solid #e5e7eb;">

          <!-- ç›¸æ‰‹ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ  -->
          <div class="conv-section">
            <h4>ğŸ“¥ ç›¸æ‰‹ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ </h4>
            <textarea id="convReceivedInput" placeholder="è‹±èªã§å…¥åŠ› or ãƒšãƒ¼ã‚¹ãƒˆ"></textarea>
            <div class="conv-btn-group">
              <button class="conv-btn conv-btn-primary" onclick="recordAndTranslate()">è¨˜éŒ²ã—ã¦ç¿»è¨³</button>
            </div>
            <div class="conv-translated-result" id="receivedTranslation">
              <strong>ç¿»è¨³:</strong> <span id="receivedTranslationText"></span>
            </div>
          </div>

          <!-- è¿”ä¿¡ã‚’ä½œæˆ -->
          <div class="conv-section">
            <h4>ğŸ“¤ è¿”ä¿¡ã‚’ä½œæˆ</h4>
            <textarea id="convReplyInput" placeholder="æ—¥æœ¬èªã§å…¥åŠ›"></textarea>
            <div class="conv-btn-group">
              <button class="conv-btn conv-btn-secondary" onclick="translateAndCopy()">è‹±è¨³ã—ã¦ã‚³ãƒ”ãƒ¼</button>
              <button class="conv-btn conv-btn-primary" onclick="translateAndRecord()">è‹±è¨³ã—ã¦è¨˜éŒ²</button>
            </div>
            <div class="conv-translated-result" id="replyTranslation">
              <strong>è‹±è¨³:</strong> <span id="replyTranslationText"></span>
            </div>
          </div>
        </div>
        <!-- ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
        <div class="slide-tab-content" id="tabReport">
          <div class="report-form-group">
            <label>æœ¬æ—¥ã®æ´»å‹•å†…å®¹</label>
            <textarea id="reportActivity" placeholder="ä»Šæ—¥è¡Œã£ãŸæ´»å‹•ã‚’å…¥åŠ›..."></textarea>
          </div>
          <div class="report-form-group">
            <label>æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
            <textarea id="reportNextAction" placeholder="æ¬¡ã«è¡Œã†ã¹ãã“ã¨ã‚’å…¥åŠ›..."></textarea>
          </div>
          <div class="report-form-group">
            <label>èª²é¡Œãƒ»æ‡¸å¿µç‚¹</label>
            <textarea id="reportConcerns" placeholder="èª²é¡Œã‚„æ‡¸å¿µç‚¹ãŒã‚ã‚Œã°å…¥åŠ›..."></textarea>
          </div>
          <div style="text-align: right; margin-top: 16px;">
            <button class="btn btn-primary" onclick="submitDealReport()">ãƒ¬ãƒãƒ¼ãƒˆæå‡º</button>
          </div>

          <!-- éå»ã®ãƒ¬ãƒãƒ¼ãƒˆ -->
          <div class="past-reports">
            <h4>ğŸ“‹ éå»ã®ãƒ¬ãƒãƒ¼ãƒˆ</h4>
            <div id="pastReportsList">
              <p class="no-data" style="font-size: 12px; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>
        </div>
      </div>
      <div class="slide-panel-footer" id="dealSlideFooter">
        <button class="btn btn-secondary" onclick="openMessageFromSlide()">ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª</button>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button class="btn btn-success" id="btnStartResponse" style="display: none;" onclick="startDealResponseFromSlide()">â–¶ å¯¾å¿œé–‹å§‹</button>
          <button class="btn btn-secondary" onclick="closeDealSlidePanel()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="saveDealFromSlide()">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- æ‹…å½“è€…ç®¡ç†ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-staff">
      <div class="section" style="padding: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <h2 style="margin: 0;">ğŸ‘¥ æ‹…å½“è€…ç®¡ç†</h2>
          <button class="btn btn-primary" onclick="openStaffModal()">+ æ‹…å½“è€…è¿½åŠ </button>
        </div>
      </div>
      <div class="section" style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>æ‹…å½“è€…ID</th>
              <th>æ°å</th>
              <th>ãƒ¡ãƒ¼ãƒ«</th>
              <th>Discord ID</th>
              <th>å½¹å‰²</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th style="width: 120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="staffTableBody">
            <tr><td colspan="7" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ—¥å ±ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-daily-report">
      <div class="section" style="padding: 16px;">
        <h2 style="margin: 0 0 8px 0;">ğŸ“ æ—¥å ± - <span id="dailyReportDateLabel">-</span></h2>
        <p style="margin: 0; color: #666; font-size: 14px;">æ¯æ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
      </div>

      <!-- æœ¬æ—¥ã®å®Ÿç¸¾ï¼ˆè‡ªå‹•é›†è¨ˆï¼‰ -->
      <div class="section">
        <h3 style="margin: 0 0 12px 0;">ğŸ“Š æœ¬æ—¥ã®å®Ÿç¸¾ï¼ˆè‡ªå‹•é›†è¨ˆï¼‰</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div class="daily-stats-card">
            <div class="daily-stats-label">å•†è«‡æ•°</div>
            <div class="daily-stats-value" id="dailyStatsDeal">-</div>
          </div>
          <div class="daily-stats-card">
            <div class="daily-stats-label">æˆç´„æ•°</div>
            <div class="daily-stats-value" id="dailyStatsClosed">-</div>
          </div>
          <div class="daily-stats-card">
            <div class="daily-stats-label">æ–°è¦æ¥è§¦</div>
            <div class="daily-stats-value" id="dailyStatsContact">-</div>
          </div>
        </div>
      </div>

      <!-- æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="section" id="dailyReportFormSection">
        <form id="dailyReportForm" onsubmit="submitDailyReport(event)">
          <div class="form-group">
            <label class="form-label">ã€ä»Šæ—¥å‡ºæ¥ãŸã“ã¨ã€‘<span class="required">*</span></label>
            <textarea class="form-textarea" id="dailyAchievement" rows="3" placeholder="ä»Šæ—¥é”æˆã—ãŸã“ã¨ã€é€²æ—ã‚’è¨˜å…¥" required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ã€æœªé”æˆã ã£ãŸã“ã¨ã€‘<span class="required">*</span></label>
            <textarea class="form-textarea" id="dailyUnachieved" rows="3" placeholder="äºˆå®šã—ã¦ã„ãŸãŒã§ããªã‹ã£ãŸã“ã¨" required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ã€å›°ã£ã¦ã„ã‚‹ã“ã¨ã€‘<span class="required">*</span></label>
            <textarea class="form-textarea" id="dailyTrouble" rows="3" placeholder="å›°ã£ã¦ã„ã‚‹ã“ã¨ã€ç›¸è«‡ã—ãŸã„ã“ã¨" required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ã€å­¦ã³ãƒ»æ°—ã¥ãã€‘<span class="required">*</span></label>
            <textarea class="form-textarea" id="dailyLearning" rows="3" placeholder="ä»Šæ—¥ã®å­¦ã³ã‚„æ°—ã¥ã" required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ã€æ˜æ—¥ã®äºˆå®šã€‘<span class="required">*</span></label>
            <textarea class="form-textarea" id="dailyTomorrowPlan" rows="3" placeholder="æ˜æ—¥ã‚„ã‚‹äºˆå®šã®ã“ã¨" required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ã€ã²ã¨ã“ã¨ã€‘<span class="required">*</span></label>
            <textarea class="form-textarea" id="dailyComment" rows="2" placeholder="ä»Šæ—¥ã®æ„Ÿæƒ³ã€ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ" required></textarea>
          </div>

          <div style="background: #fff3cd; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <span style="color: #856404; font-size: 14px;">âš ï¸ ç· åˆ‡: 22:00</span>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="saveDailyReportDraft()">ä¸‹æ›¸ãä¿å­˜</button>
            <button type="submit" class="btn btn-primary">æå‡º</button>
          </div>
        </form>
      </div>

      <!-- æå‡ºæ¸ˆã¿è¡¨ç¤º -->
      <div class="section" id="dailyReportSubmittedSection" style="display: none;">
        <div class="daily-report-submitted-badge">
          <span>âœ… æå‡ºæ¸ˆ</span>
          <span id="dailyReportSubmittedTime">-</span>
        </div>

        <div class="daily-report-view">
          <div class="daily-report-item">
            <div class="daily-report-item-label">ã€ä»Šæ—¥å‡ºæ¥ãŸã“ã¨ã€‘</div>
            <div class="daily-report-item-value" id="viewAchievement">-</div>
          </div>
          <div class="daily-report-item">
            <div class="daily-report-item-label">ã€æœªé”æˆã ã£ãŸã“ã¨ã€‘</div>
            <div class="daily-report-item-value" id="viewUnachieved">-</div>
          </div>
          <div class="daily-report-item">
            <div class="daily-report-item-label">ã€å›°ã£ã¦ã„ã‚‹ã“ã¨ã€‘</div>
            <div class="daily-report-item-value" id="viewTrouble">-</div>
          </div>
          <div class="daily-report-item">
            <div class="daily-report-item-label">ã€å­¦ã³ãƒ»æ°—ã¥ãã€‘</div>
            <div class="daily-report-item-value" id="viewLearning">-</div>
          </div>
          <div class="daily-report-item">
            <div class="daily-report-item-label">ã€æ˜æ—¥ã®äºˆå®šã€‘</div>
            <div class="daily-report-item-value" id="viewTomorrowPlan">-</div>
          </div>
          <div class="daily-report-item">
            <div class="daily-report-item-label">ã€ã²ã¨ã“ã¨ã€‘</div>
            <div class="daily-report-item-value" id="viewComment">-</div>
          </div>
        </div>
      </div>

      <!-- æ—¥å ±å±¥æ­´ -->
      <div class="section">
        <h3 style="margin: 0 0 12px 0;">ğŸ“‹ éå»ã®æ—¥å ±</h3>
        <div id="dailyReportHistoryList">
          <p style="color: #666; text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- æ—¥å ±å±¥æ­´ãƒšãƒ¼ã‚¸ï¼ˆãƒªãƒ¼ãƒ€ãƒ¼ãƒ»ç®¡ç†è€…å‘ã‘ï¼‰ -->
    <div class="page" id="page-daily-report-history">
      <div class="section" style="padding: 16px;">
        <h2 style="margin: 0 0 16px 0;">ğŸ“‹ ãƒãƒ¼ãƒ æ—¥å ±ä¸€è¦§</h2>
        <div class="filter-bar">
          <input type="date" id="dailyReportFilterFrom" onchange="loadTeamDailyReports()">
          <span>ã€œ</span>
          <input type="date" id="dailyReportFilterTo" onchange="loadTeamDailyReports()">
          <select id="dailyReportFilterStaff" onchange="loadTeamDailyReports()">
            <option value="">å…¨å“¡</option>
          </select>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="dailyReportFilterTrouble" onchange="loadTeamDailyReports()">
            å›°ã£ã¦ã„ã‚‹ã“ã¨ã‚ã‚Š
          </label>
        </div>
      </div>

      <div class="section">
        <table class="data-table" id="teamDailyReportTable">
          <thead>
            <tr>
              <th>æ—¥ä»˜</th>
              <th>æ‹…å½“è€…</th>
              <th>å‡ºæ¥ãŸã“ã¨</th>
              <th>å›°ã£ã¦ã„ã‚‹ã“ã¨</th>
              <th>æå‡ºæ™‚åˆ»</th>
            </tr>
          </thead>
          <tbody id="teamDailyReportBody">
            <tr><td colspan="5" style="text-align: center; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ãƒ¬ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-report">
      <div class="section" style="padding: 16px;">
        <h2 style="margin: 0 0 16px 0;">ğŸ“ é€±æ¬¡/æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
        <div class="report-tabs">
          <button class="report-tab active" onclick="showReportTab('weekly')">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
          <button class="report-tab" onclick="showReportTab('monthly')">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>

      <!-- é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
      <div class="report-tab-content active" id="report-weekly">
        <div class="section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button class="btn btn-sm" onclick="changeReportWeek(-1)">&lt;</button>
              <span id="reportWeekLabel" style="font-weight: bold; min-width: 120px; text-align: center;">-</span>
              <button class="btn btn-sm" onclick="changeReportWeek(1)">&gt;</button>
            </div>
          </div>

          <form id="weeklyReportForm" onsubmit="submitWeeklyReport(event)">
            <div class="form-group">
              <label class="form-label">ä»Šé€±ã®æˆæœ *</label>
              <textarea class="form-textarea" id="weeklyAchievements" rows="4" placeholder="ä»Šé€±é”æˆã—ãŸã“ã¨ã€é€²æ—ã‚’è¨˜å…¥" required></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label class="form-label">è‰¯ã‹ã£ãŸç‚¹</label>
                <textarea class="form-textarea" id="weeklyGoodPoints" rows="3" placeholder="è‰¯ã‹ã£ãŸç‚¹ã€æˆåŠŸä½“é¨“"></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">æ”¹å–„ç‚¹</label>
                <textarea class="form-textarea" id="weeklyImprovements" rows="3" placeholder="æ¬¡å›ã«æ´»ã‹ã—ãŸã„æ”¹å–„ç‚¹"></textarea>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">æ¥é€±ã®ç›®æ¨™ *</label>
              <textarea class="form-textarea" id="weeklyNextGoals" rows="3" placeholder="æ¥é€±ã®ç›®æ¨™ã€è¨ˆç”»" required></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label class="form-label">å›°ã£ã¦ã„ã‚‹ã“ã¨</label>
                <textarea class="form-textarea" id="weeklyTroubles" rows="2" placeholder="å›°ã£ã¦ã„ã‚‹ã“ã¨ã€ç›¸è«‡äº‹é …"></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Buddyã¸ã®è³ªå•</label>
                <textarea class="form-textarea" id="weeklyBuddyQuestion" rows="2" placeholder="Buddyã«èããŸã„ã“ã¨"></textarea>
              </div>
            </div>

            <!-- Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º -->
            <div id="weeklyBuddyFeedback" style="display: none; margin-top: 16px;">
              <div class="buddy-feedback-card">
                <div class="buddy-feedback-header">
                  <span class="buddy-avatar-small">ğŸ§™</span>
                  <span>Buddyã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                </div>
                <div id="weeklyBuddyFeedbackText" class="buddy-feedback-text"></div>
              </div>
            </div>

            <div style="margin-top: 16px; text-align: right;">
              <span id="weeklyReportStatus" style="margin-right: 12px; color: #666;"></span>
              <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>

      <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
      <div class="report-tab-content" id="report-monthly">
        <div class="section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button class="btn btn-sm" onclick="changeReportMonth(-1)">&lt;</button>
              <span id="reportMonthLabel" style="font-weight: bold; min-width: 100px; text-align: center;">-</span>
              <button class="btn btn-sm" onclick="changeReportMonth(1)">&gt;</button>
            </div>
          </div>

          <form id="monthlyReportForm" onsubmit="submitMonthlyReport(event)">
            <div class="form-group">
              <label class="form-label">ä»Šæœˆã®æˆæœ *</label>
              <textarea class="form-textarea" id="monthlyAchievements" rows="4" placeholder="ä»Šæœˆé”æˆã—ãŸã“ã¨ã€ä¸»ãªæˆæœ" required></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label class="form-label">è‰¯ã‹ã£ãŸç‚¹</label>
                <textarea class="form-textarea" id="monthlyGoodPoints" rows="3" placeholder="è‰¯ã‹ã£ãŸç‚¹ã€æˆåŠŸä½“é¨“"></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">æ”¹å–„ç‚¹</label>
                <textarea class="form-textarea" id="monthlyImprovements" rows="3" placeholder="æ”¹å–„ç‚¹ã€å­¦ã³"></textarea>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">æ¥æœˆã®ç›®æ¨™ *</label>
              <textarea class="form-textarea" id="monthlyNextGoals" rows="3" placeholder="æ¥æœˆã®ç›®æ¨™ã€é‡ç‚¹å–ã‚Šçµ„ã¿äº‹é …" required></textarea>
            </div>

            <!-- Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º -->
            <div id="monthlyBuddyFeedback" style="display: none; margin-top: 16px;">
              <div class="buddy-feedback-card">
                <div class="buddy-feedback-header">
                  <span class="buddy-avatar-small">ğŸ§™</span>
                  <span>Buddyã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                </div>
                <div id="monthlyBuddyFeedbackText" class="buddy-feedback-text"></div>
              </div>
            </div>

            <div style="margin-top: 16px; text-align: right;">
              <span id="monthlyReportStatus" style="margin-right: 12px; color: #666;"></span>
              <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-shift">
      <div class="section" style="padding: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <h2 style="margin: 0;">ğŸ“… ã‚·ãƒ•ãƒˆç®¡ç†</h2>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn btn-sm" onclick="changeShiftWeek(-1)">&lt; å‰é€±</button>
            <span id="shiftWeekLabel" style="font-weight: bold; min-width: 120px; text-align: center;">-</span>
            <button class="btn btn-sm" onclick="changeShiftWeek(1)">æ¬¡é€± &gt;</button>
          </div>
        </div>
      </div>

      <!-- å€‹äººã‚·ãƒ•ãƒˆå…¥åŠ› -->
      <div class="section" id="personalShiftSection">
        <h3>è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆ</h3>
        <div class="shift-grid" id="personalShiftGrid">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        <div style="margin-top: 16px; text-align: right;">
          <button class="btn btn-primary" onclick="savePersonalShift()">ã‚·ãƒ•ãƒˆã‚’ä¿å­˜</button>
        </div>
      </div>

      <!-- ç®¡ç†è€…ç”¨: æå‡ºçŠ¶æ³ -->
      <div class="section" id="shiftAdminSection" style="display: none;">
        <h3>ãƒãƒ¼ãƒ ã‚·ãƒ•ãƒˆä¸€è¦§</h3>
        <div style="margin-bottom: 16px;">
          <span>æå‡ºç‡: </span>
          <span id="shiftSubmissionRate" style="font-weight: bold;">-</span>
          <span> ï¼ˆ</span>
          <span id="shiftSubmittedCount">-</span>
          <span>/</span>
          <span id="shiftTotalCount">-</span>
          <span>ï¼‰</span>
        </div>
        <div id="weeklyShiftTable" style="overflow-x: auto;">
          <p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-archive">
      <div class="section" style="padding: 16px;">
        <div class="deals-toolbar">
          <div class="deals-toolbar-left">
            <div class="search-container">
              <span class="search-icon">ğŸ”</span>
              <input type="text" class="search-input" id="archiveSearchInput" placeholder="æ¤œç´¢..." oninput="filterArchive()">
            </div>
            <select class="sort-select" id="archiveReasonFilter" onchange="filterArchive()">
              <option value="">å…¨ã¦ã®é›¢è„±ç†ç”±</option>
              <option value="ç„¡è¿”ä¿¡">ç„¡è¿”ä¿¡</option>
              <option value="ä¾¡æ ¼NG">ä¾¡æ ¼NG</option>
              <option value="å¯¾è±¡å¤–">å¯¾è±¡å¤–</option>
              <option value="ç«¶åˆæµå‡º">ç«¶åˆæµå‡º</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
          <div class="deals-toolbar-right">
            <span id="archiveCount">-</span> ä»¶ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
            <button class="btn btn-sm" onclick="loadArchivedLeads()" style="margin-left: 8px; padding: 4px 8px; font-size: 12px;" title="å†èª­ã¿è¾¼ã¿">&#x21bb;</button>
          </div>
        </div>
      </div>
      <div class="section" style="overflow-x: auto;">
        <table class="data-table" id="archiveTable">
          <thead>
            <tr>
              <th class="sortable-header" data-column="leadId" onclick="sortArchiveByHeader('leadId')">ãƒªãƒ¼ãƒ‰ID</th>
              <th class="sortable-header" data-column="staff" onclick="sortArchiveByHeader('staff')">æ‹…å½“è€…</th>
              <th class="sortable-header" data-column="customer" onclick="sortArchiveByHeader('customer')">é¡§å®¢å</th>
              <th class="sortable-header" data-column="country" onclick="sortArchiveByHeader('country')">å›½</th>
              <th class="sortable-header" data-column="source" onclick="sortArchiveByHeader('source')">æµå…¥çµŒè·¯</th>
              <th class="sortable-header" data-column="dropReason" onclick="sortArchiveByHeader('dropReason')">é›¢è„±ç†ç”±</th>
              <th>CSãƒ¡ãƒ¢</th>
              <th class="sortable-header" data-column="dropDate" onclick="sortArchiveByHeader('dropDate')">é›¢è„±æ—¥</th>
              <th class="sortable-header" data-column="csStaff" onclick="sortArchiveByHeader('csStaff')">CSæ‹…å½“è€…</th>
              <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            </tr>
          </thead>
          <tbody id="archiveBody">
            <tr><td colspan="10" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ç®¡ç†è€…è¨­å®šãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-admin">
      <div class="section">
        <h2>ğŸ”§ ç®¡ç†è€…è¨­å®š</h2>

        <!-- é€šçŸ¥è¨­å®š -->
        <div class="admin-section" style="margin-bottom: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="margin-top: 0; color: #333;">ğŸ“¢ é€šçŸ¥è¨­å®š</h3>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">Discord Webhook URL</label>
            <input type="text" class="form-input" id="adminDiscordWebhook" placeholder="https://discord.com/api/webhooks/...">
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">PMOãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL</label>
            <input type="text" class="form-input" id="adminPmoUrl" placeholder="https://claude.ai/project/...">
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">GitHub URL</label>
            <input type="text" class="form-input" id="adminGithubUrl" placeholder="https://github.com/...">
          </div>
          <button class="btn btn-primary" onclick="saveNotificationSettings()">ä¿å­˜</button>
          <span id="notificationSaveStatus" style="margin-left: 12px; color: green;"></span>
        </div>

        <!-- æ¨©é™ç®¡ç† -->
        <div class="admin-section" style="margin-bottom: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="margin-top: 0; color: #333;">ğŸ‘¥ æ¨©é™ç®¡ç†</h3>
          <p style="color: #666; margin-bottom: 16px;">å½¹å‰²ã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¨­å®šã§ãã¾ã™ã€‚</p>
          <table class="data-table" id="rolesTable" style="margin-bottom: 16px;">
            <thead>
              <tr>
                <th>å½¹å‰²å</th>
                <th style="width: 150px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="rolesTableBody">
              <tr><td colspan="2" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
            </tbody>
          </table>
          <button class="btn btn-primary" onclick="openRoleModal()">+ å½¹å‰²ã‚’è¿½åŠ </button>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
        <div class="admin-section" style="margin-bottom: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="margin-top: 0; color: #333;">ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
          <p id="passwordStatus" style="color: #666; margin-bottom: 16px;"></p>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">æ–°ã—ã„ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" class="form-input" id="adminNewPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
            <input type="password" class="form-input" id="adminConfirmPassword" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›">
          </div>
          <button class="btn btn-primary" onclick="saveAdminPassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
          <span id="passwordSaveStatus" style="margin-left: 12px; color: green;"></span>
        </div>

        <!-- å±é™ºãªæ“ä½œ -->
        <div class="admin-section" style="padding: 20px; background: #fff5f5; border: 2px solid #dc3545; border-radius: 8px;">
          <h3 style="margin-top: 0; color: #c92a2a;">âš ï¸ å±é™ºãªæ“ä½œ</h3>
          <p style="color: #666; margin-bottom: 16px;">ä»¥ä¸‹ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ååˆ†ã«æ³¨æ„ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
          <button class="btn btn-danger" onclick="forceResetSettings()">è¨­å®šã‚·ãƒ¼ãƒˆã‚’å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ</button>
          <span id="resetStatus" style="margin-left: 12px;"></span>
        </div>
      </div>
    </div>

    <!-- Buddyå£æ‰“ã¡ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="page-buddy-coaching" style="position: relative;">
      <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <button class="buddy-back-btn" onclick="switchPage('dashboard')" title="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹">
        â†
      </button>
      <div class="section">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; padding-left: 50px;">
          <h2>ğŸ§”â€â™‚ï¸ Buddyå£æ‰“ã¡</h2>
          <div class="buddy-status" id="buddyStatus">
            <span class="status-indicator online"></span>
            <span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
          </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰ã‚¿ãƒ– -->
        <div class="buddy-mode-tabs">
          <button class="buddy-mode-tab active" data-mode="free_talk" onclick="switchBuddyMode('free_talk')">
            ğŸ’¬ ãƒ•ãƒªãƒ¼ãƒˆãƒ¼ã‚¯
          </button>
          <button class="buddy-mode-tab" data-mode="goal_setting" onclick="switchBuddyMode('goal_setting')">
            ğŸ¯ ç›®æ¨™è¨­å®š
          </button>
          <button class="buddy-mode-tab" data-mode="weekly_review" onclick="switchBuddyMode('weekly_review')">
            ğŸ“Š é€±æ¬¡æŒ¯ã‚Šè¿”ã‚Š
          </button>
        </div>

        <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
        <div class="buddy-chat-container">
          <!-- ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ -->
          <div class="buddy-mode-guide" id="buddyModeGuide">
            <div class="guide-content" id="guideContent">
              <h4>ğŸ’¬ ãƒ•ãƒªãƒ¼ãƒˆãƒ¼ã‚¯</h4>
              <p>æ—¥å¸¸ã®ç›¸è«‡ã‚„è³ªå•ãªã©ã€ãªã‚“ã§ã‚‚æ°—è»½ã«è©±ã—ã‹ã‘ã¦ã­ï¼</p>
            </div>
          </div>

          <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ -->
          <div class="buddy-chat-messages" id="buddyChatMessages">
            <div class="buddy-message">
              <div class="buddy-avatar">ğŸ§”â€â™‚ï¸</div>
              <div class="buddy-message-content">
                <div class="buddy-message-text">
                  ã‚„ã‚ï¼åƒ•ã¯Buddyã ã‚ˆã€‚å–¶æ¥­æ´»å‹•ã®ç›¸è«‡ç›¸æ‰‹ã¨ã—ã¦ã€ã„ã¤ã§ã‚‚è©±ã‚’èãã‚ˆã€‚<br>
                  ç›®æ¨™è¨­å®šã‚„é€±æ¬¡æŒ¯ã‚Šè¿”ã‚Šã®ã‚µãƒãƒ¼ãƒˆã‚‚ã§ãã‚‹ã‹ã‚‰ã€æ°—è»½ã«è©±ã—ã‹ã‘ã¦ã­ğŸ‘
                </div>
                <div class="buddy-message-time">ä»Šæ—¥</div>
              </div>
            </div>
          </div>

          <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
          <div class="buddy-chat-input-area">
            <div class="buddy-input-wrapper buddy-input-container">
              <textarea
                id="buddyChatInput"
                class="buddy-chat-input"
                placeholder="Buddyã«è©±ã—ã‹ã‘ã‚‹..."
                rows="1"
                onkeydown="handleBuddyChatKeydown(event)"
              ></textarea>
              <button class="voice-input-btn" onclick="toggleVoiceInput()" id="voiceInputBtn" title="éŸ³å£°å…¥åŠ›">
                ğŸ¤
              </button>
              <button class="buddy-send-btn" onclick="sendBuddyMessage()" id="buddySendBtn">
                é€ä¿¡
              </button>
            </div>
            <div class="buddy-input-hint">
              <span>Shift + Enter ã§æ”¹è¡Œ | ğŸ¤ éŸ³å£°å…¥åŠ›</span>
              <span id="buddyTypingIndicator" style="display: none;">BuddyãŒå…¥åŠ›ä¸­...</span>
            </div>
          </div>
        </div>

        <!-- ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ‰ï¼šç›®æ¨™ã‚«ãƒ¼ãƒ‰ -->
        <div class="buddy-goal-section" id="buddyGoalSection" style="display: none;">
          <h3>ğŸ¯ ä»Šæœˆã®ç›®æ¨™</h3>
          <div class="goal-card" id="currentGoalCard">
            <div class="goal-card-header">
              <span class="goal-period" id="goalPeriod">-</span>
              <span class="goal-status" id="goalStatus">æœªè¨­å®š</span>
            </div>
            <div class="goal-card-body">
              <div class="goal-metrics">
                <div class="goal-metric">
                  <span class="goal-metric-label">æˆç´„ç›®æ¨™</span>
                  <span class="goal-metric-value" id="goalClosedTarget">-</span>
                </div>
                <div class="goal-metric">
                  <span class="goal-metric-label">å£²ä¸Šç›®æ¨™</span>
                  <span class="goal-metric-value" id="goalSalesTarget">-</span>
                </div>
              </div>
              <div class="goal-action" id="goalActionText">-</div>
              <div class="goal-challenge" id="goalChallengeText">-</div>
            </div>
            <div class="goal-card-footer">
              <button class="btn btn-sm btn-outline" onclick="openGoalEditModal()">ç›®æ¨™ã‚’ç·¨é›†</button>
            </div>
          </div>

          <!-- å®Ÿç¸¾ã‚«ãƒ¼ãƒ‰ -->
          <h3 style="margin-top: 24px;">ğŸ“ˆ ä»Šæœˆã®å®Ÿç¸¾</h3>
          <div class="performance-card" id="performanceCard">
            <div class="performance-metrics">
              <div class="perf-metric">
                <span class="perf-metric-value" id="perfClosedWon">-</span>
                <span class="perf-metric-label">æˆç´„</span>
              </div>
              <div class="perf-metric">
                <span class="perf-metric-value" id="perfTotalRevenue">-</span>
                <span class="perf-metric-label">å£²ä¸Š</span>
              </div>
              <div class="perf-metric">
                <span class="perf-metric-value" id="perfConversionRate">-</span>
                <span class="perf-metric-label">æˆç´„ç‡</span>
              </div>
              <div class="perf-metric">
                <span class="perf-metric-value" id="perfInProgress">-</span>
                <span class="perf-metric-label">é€²è¡Œä¸­</span>
              </div>
            </div>
            <div class="goal-progress-bar" id="goalProgressBar">
              <div class="progress-fill" id="goalProgressFill" style="width: 0%"></div>
            </div>
            <div class="goal-progress-text" id="goalProgressText">ç›®æ¨™æœªè¨­å®š</div>
          </div>
        </div>

        <!-- é€±æ¬¡æŒ¯ã‚Šè¿”ã‚Šãƒ¢ãƒ¼ãƒ‰ï¼šãƒ¬ãƒãƒ¼ãƒˆå±¥æ­´ -->
        <div class="buddy-report-section" id="buddyReportSection" style="display: none;">
          <h3>ğŸ“‹ ç›´è¿‘ã®ãƒ¬ãƒãƒ¼ãƒˆ</h3>
          <div class="report-list" id="weeklyReportList">
            <div class="empty-state">ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        </div>
      </div>
    </div>

    </div>
  </div>

  <!-- ãƒªãƒ¼ãƒ‰è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="addLeadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="addLeadModalTitle">æ–°è¦ãƒªãƒ¼ãƒ‰è¿½åŠ </h3>
        <button class="modal-close" onclick="closeAddLeadModal()">&times;</button>
      </div>
      <form id="addLeadForm" onsubmit="submitAddLead(event)">
        <input type="hidden" id="addLeadType" value="in">
        <!-- Row 1: é¡§å®¢å -->
        <div class="form-group">
          <label class="form-label">é¡§å®¢å *</label>
          <input type="text" class="form-input" name="é¡§å®¢å" required>
        </div>
        <!-- Row 2: å‘¼ã³æ–¹ï¼ˆè‹±èªï¼‰ | å›½ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
          <div class="form-group">
            <label class="form-label">å‘¼ã³æ–¹ï¼ˆè‹±èªï¼‰</label>
            <input type="text" class="form-input" name="å‘¼ã³æ–¹ï¼ˆè‹±èªï¼‰" placeholder="ä¾‹: John">
          </div>
          <div class="form-group">
            <label class="form-label">å›½</label>
            <select class="form-select" name="å›½" id="selectCountry"></select>
          </div>
        </div>
        <!-- Row 3: æµå…¥çµŒè·¯ | SNS/é€£çµ¡æ‰‹æ®µ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
          <div class="form-group">
            <label class="form-label">æµå…¥çµŒè·¯</label>
            <select class="form-select" name="æµå…¥çµŒè·¯" id="selectChannelIn" style="display:none;" onchange="handleOtherSelect(this, 'channelOtherDetail')"></select>
            <select class="form-select" name="æµå…¥çµŒè·¯" id="selectChannelOut" style="display:none;" onchange="handleOtherSelect(this, 'channelOtherDetail')"></select>
            <div class="other-detail-input" id="channelOtherDetail">
              <input type="text" placeholder="è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" id="channelOtherInput">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">SNS/é€£çµ¡æ‰‹æ®µ</label>
            <select class="form-select" name="SNS/é€£çµ¡æ‰‹æ®µ" id="selectSns"></select>
          </div>
        </div>
        <!-- Row 4: é›»è©±ç•ªå· | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
          <div class="form-group">
            <label class="form-label">é›»è©±ç•ªå·</label>
            <input type="text" class="form-input" name="é›»è©±ç•ªå·">
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«</label>
            <input type="email" class="form-input" name="ãƒ¡ãƒ¼ãƒ«">
          </div>
        </div>
        <!-- Row 5: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL (full width) -->
        <div class="form-group" style="margin-top: 16px;">
          <label class="form-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL</label>
          <input type="url" class="form-input" name="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL">
        </div>
        <!-- Row 6: æ¸©åº¦æ„Ÿ | æƒ³å®šè¦æ¨¡ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
          <div class="form-group">
            <label class="form-label">æ¸©åº¦æ„Ÿ</label>
            <select class="form-select" name="æ¸©åº¦æ„Ÿ" id="selectTemp"></select>
          </div>
          <div class="form-group">
            <label class="form-label">æƒ³å®šè¦æ¨¡</label>
            <select class="form-select" name="æƒ³å®šè¦æ¨¡" id="selectScale"></select>
          </div>
        </div>
        <!-- Row 7: é¡§å®¢ã‚¿ã‚¤ãƒ— | è¿”ä¿¡é€Ÿåº¦ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
          <div class="form-group">
            <label class="form-label">é¡§å®¢ã‚¿ã‚¤ãƒ—</label>
            <select class="form-select" name="é¡§å®¢ã‚¿ã‚¤ãƒ—" id="selectType"></select>
          </div>
          <div class="form-group">
            <label class="form-label">è¿”ä¿¡é€Ÿåº¦</label>
            <select class="form-select" name="è¿”ä¿¡é€Ÿåº¦" id="selectSpeed"></select>
          </div>
        </div>
        <!-- Row 8: CSãƒ¡ãƒ¢ (full width) - å‚™è€ƒæ¬„ã¯å‰Šé™¤ï¼ˆå–¶æ¥­æ‹…å½“ç”¨ãªã®ã§ã‚¢ã‚µã‚¤ãƒ³å¾Œã«å…¥åŠ›ï¼‰ -->
        <div class="form-group" style="margin-top: 16px;">
          <label class="form-label">CSãƒ¡ãƒ¢</label>
          <textarea class="form-textarea" name="CSãƒ¡ãƒ¢" placeholder="å¯¾å¿œå±¥æ­´ã€ãƒ¡ãƒ¢ãªã©"></textarea>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
          <button type="button" class="btn btn-secondary" onclick="closeAddLeadModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">è¿½åŠ </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ãƒªãƒ¼ãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="leadDetailModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">ãƒªãƒ¼ãƒ‰è©³ç´°</h3>
        <button class="modal-close" onclick="closeLeadDetailModal()">&times;</button>
      </div>
      <div id="leadDetailContent"></div>
    </div>
  </div>

  <!-- ã‚¢ã‚µã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="assignModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h3 class="modal-title">æ‹…å½“è€…ã‚’ã‚¢ã‚µã‚¤ãƒ³</h3>
        <button class="modal-close" onclick="closeAssignModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <input type="hidden" id="assignLeadId">
        <input type="hidden" id="assignLeadType">
        <div style="margin-bottom: 16px;">
          <span style="font-weight: bold;">é¡§å®¢å:</span> <span id="assignCustomerName"></span>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label class="form-label">æ‹…å½“è€… <span style="color: red;">*</span></label>
          <select class="form-select" id="assignStaffSelect">
            <option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>
          </select>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button class="btn" onclick="closeAssignModal()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="confirmAssign()">ã‚¢ã‚µã‚¤ãƒ³ç¢ºå®š</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="archiveModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h3 class="modal-title">ãƒªãƒ¼ãƒ‰ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h3>
        <button class="modal-close" onclick="closeArchiveModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <input type="hidden" id="archiveLeadId">
        <input type="hidden" id="archiveLeadType">
        <div style="margin-bottom: 16px;">
          <span style="font-weight: bold;">é¡§å®¢å:</span> <span id="archiveCustomerName"></span>
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label class="form-label">é›¢è„±ç†ç”± <span style="color: red;">*</span></label>
          <select class="form-select" id="archiveReasonSelect">
            <option value="">ç†ç”±ã‚’é¸æŠ</option>
            <option value="ç„¡è¿”ä¿¡">ç„¡è¿”ä¿¡</option>
            <option value="ä¾¡æ ¼NG">ä¾¡æ ¼NG</option>
            <option value="å¯¾è±¡å¤–">å¯¾è±¡å¤–</option>
            <option value="ç«¶åˆæµå‡º">ç«¶åˆæµå‡º</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label class="form-label">CSãƒ¡ãƒ¢ <span style="color: red;">*</span></label>
          <textarea class="form-textarea" id="archiveCsMemo" rows="3" placeholder="é›¢è„±ç†ç”±ã®è©³ç´°ã€å¯¾å¿œå±¥æ­´ãªã©"></textarea>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button class="btn" onclick="closeArchiveModal()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn" onclick="confirmArchive()" style="background: #ef4444; color: white;">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒªãƒ¼ãƒ‰å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="restoreModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">ãƒªãƒ¼ãƒ‰ã«æˆ»ã™</h3>
        <button class="modal-close" onclick="closeRestoreModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <input type="hidden" id="restoreLeadId">
        <div style="margin-bottom: 16px;">
          <span style="font-weight: bold;">é¡§å®¢å:</span> <span id="restoreCustomerName"></span>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label class="form-label">ãƒªãƒ¼ãƒ‰ç¨®åˆ¥ <span style="color: red;">*</span></label>
          <select class="form-select" id="restoreLeadTypeSelect">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰">ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰</option>
            <option value="ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰">ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰</option>
          </select>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button class="btn" onclick="closeRestoreModal()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="confirmRestore()">æˆ»ã™</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨©é™ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="roleEditModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title" id="roleEditModalTitle">æ¨©é™ç·¨é›†</h3>
        <button class="modal-close" onclick="closeRoleModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <input type="hidden" id="roleOriginalName">
        <div class="form-group" style="margin-bottom: 20px;">
          <label class="form-label">å½¹å‰²å</label>
          <input type="text" class="form-input" id="roleNameInput" placeholder="å½¹å‰²åã‚’å…¥åŠ›">
        </div>

        <div id="permissionGroups"></div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button class="btn" onclick="closeRoleModal()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="saveRoleFromModal()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Buddyã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div class="modal" id="buddyAlertPopup">
    <div class="modal-content" style="max-width: 450px; border-radius: 16px; overflow: hidden;">
      <div class="buddy-alert-header" id="buddyAlertHeader">
        <div class="buddy-avatar-large">&#129492;</div>
        <div class="buddy-alert-level" id="buddyAlertLevel">æ³¨æ„</div>
      </div>
      <div class="buddy-alert-body">
        <p class="buddy-alert-message" id="buddyAlertMessage"></p>
        <div class="buddy-alert-detail" id="buddyAlertDetail">
          <div class="alert-detail-item">
            <span class="alert-detail-label">é¡§å®¢å</span>
            <span class="alert-detail-value" id="alertCustomerName">-</span>
          </div>
          <div class="alert-detail-item">
            <span class="alert-detail-label">çŠ¶æ³</span>
            <span class="alert-detail-value" id="alertSituation">-</span>
          </div>
        </div>
        <div class="buddy-alert-count" id="buddyAlertCount" style="display: none;">
          ä»–ã«ã‚‚ <span id="alertCountNum">0</span> ä»¶ã®æ³¨æ„äº‹é …ãŒã‚ã‚Šã¾ã™
        </div>
      </div>
      <div class="buddy-alert-actions">
        <button class="btn btn-primary" onclick="handleAlertAction()">ç¢ºèªã™ã‚‹</button>
        <button class="btn btn-secondary" onclick="closeBuddyAlertPopup()">å¾Œã§</button>
      </div>
    </div>
  </div>

  <!-- Buddyç›¸è«‡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="buddyChatModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">&#128172; Buddyã«ç›¸è«‡</h3>
        <button class="modal-close" onclick="closeBuddyChat()">&times;</button>
      </div>
      <div id="buddyChatContainerModal" class="buddy-chat-container">
        <div class="buddy-chat-message">
          <span class="buddy-chat-avatar">&#129492;</span>
          <div class="buddy-chat-bubble buddy">ã©ã†ã—ãŸï¼Ÿä½•ã§ã‚‚è©±ã—ã¦ã­ã€‚</div>
        </div>
      </div>
      <div class="buddy-chat-input-container">
        <textarea id="buddyChatInputModal" class="buddy-chat-input" placeholder="ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›..."></textarea>
        <button id="buddyChatSendBtnModal" class="buddy-chat-send" onclick="sendBuddyMessageModal()">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- å•†è«‡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="dealReportModal">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 class="modal-title">&#128221; å•†è«‡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
        <button class="modal-close" onclick="closeDealReportModal()">&times;</button>
      </div>
      <form id="dealReportForm" onsubmit="submitDealReportV2(event)">
        <!-- Step 1: åŸºæœ¬æƒ…å ± -->
        <div class="form-group">
          <label class="form-label">é¡§å®¢å *</label>
          <select class="form-select" id="reportDealSelect" required onchange="onDealSelect()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å•†è«‡é–‹å§‹æ—¥ *</label>
          <input type="date" class="form-input" id="reportDealStartDate" required>
        </div>

        <!-- Step 2: å•†è«‡çµæœé¸æŠ -->
        <div class="form-group">
          <label class="form-label">å•†è«‡çµæœ *</label>
          <div class="report-result-group" id="reportResultGroup">
            <button type="button" class="report-result-btn" data-value="æˆç´„" onclick="selectDealResult(this)">&#127881; æˆç´„</button>
            <button type="button" class="report-result-btn" data-value="å¤±æ³¨" onclick="selectDealResult(this)">&#128546; å¤±æ³¨</button>
            <button type="button" class="report-result-btn" data-value="è¿½å®¢" onclick="selectDealResult(this)">&#128172; è¿½å®¢</button>
            <button type="button" class="report-result-btn" data-value="è¦‹é€ã‚Š" onclick="selectDealResult(this)">&#9203; è¦‹é€ã‚Š</button>
            <button type="button" class="report-result-btn" data-value="å¯¾è±¡å¤–" onclick="selectDealResult(this)">&#10060; å¯¾è±¡å¤–</button>
          </div>
          <input type="hidden" id="reportDealResult" required>
        </div>

        <!-- æ¡ä»¶ä»˜ãè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="conditionalFieldsArea">

          <!-- å¯¾è±¡å¤–ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <div id="fieldsExcluded" class="conditional-fields" style="display: none;">
            <div class="form-group">
              <label class="form-label">é¡§å®¢ã®å›½ *</label>
              <select class="form-select" id="reportCountryExcluded"></select>
            </div>
            <div class="form-group">
              <label class="form-label">å–ã‚Šæ‰±ã„å•†æ</label>
              <div class="checkbox-group" id="reportProductsExcluded"></div>
            </div>
            <div class="form-group">
              <label class="form-label">å¯¾è±¡å¤–ç†ç”± *</label>
              <textarea class="report-textarea" id="reportExcludeReason" placeholder="å¯¾è±¡å¤–ã¨åˆ¤æ–­ã—ãŸç†ç”±"></textarea>
            </div>
          </div>

          <!-- å…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæˆç´„/å¤±æ³¨/è¿½å®¢/è¦‹é€ã‚Šç”¨ï¼‰ -->
          <div id="fieldsCommon" class="conditional-fields" style="display: none;">
            <div class="form-group">
              <label class="form-label">é¡§å®¢ã®å›½ *</label>
              <select class="form-select" id="reportCountry"></select>
            </div>

            <!-- å–ã‚Šæ‰±ã„å•†æï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰ -->
            <div class="form-group">
              <label class="form-label">å–ã‚Šæ‰±ã„å•†æ *</label>
              <div class="checkbox-group" id="reportProducts"></div>
              <div class="other-detail-input" id="reportProductsOtherInput">
                <input type="text" id="reportProductsOther" placeholder="ãã®ä»–ã®å•†æã‚’å…¥åŠ›">
              </div>
            </div>

            <!-- è²©å£²å…ˆï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰ -->
            <div class="form-group">
              <label class="form-label">è²©å£²å…ˆ *</label>
              <div class="checkbox-group" id="reportSalesChannels"></div>
              <div class="other-detail-input" id="reportSalesChannelsOtherInput">
                <input type="text" id="reportSalesChannelsOther" placeholder="ãã®ä»–ã®è²©å£²å…ˆã‚’å…¥åŠ›">
              </div>
            </div>

            <!-- é¡§å®¢ã‚¿ã‚¤ãƒ— -->
            <div class="form-group">
              <label class="form-label">ä¿¡é ¼é‡è¦–/ä¾¡æ ¼é‡è¦– *</label>
              <div class="report-option-group">
                <button type="button" class="report-option-btn" data-field="customerType" data-value="ä¿¡é ¼é‡è¦–" onclick="selectOption(this)">ä¿¡é ¼é‡è¦–</button>
                <button type="button" class="report-option-btn" data-field="customerType" data-value="ä¾¡æ ¼é‡è¦–" onclick="selectOption(this)">ä¾¡æ ¼é‡è¦–</button>
                <button type="button" class="report-option-btn" data-field="customerType" data-value="ä¸æ˜" onclick="selectOption(this)">ä¸æ˜</button>
              </div>
              <input type="hidden" id="reportCustomerType">
            </div>

            <!-- ç™ºæ³¨é‡‘é¡ -->
            <div class="form-group">
              <label class="form-label">1å›ã®ç™ºæ³¨é‡‘é¡ï¼ˆå††ï¼‰ *</label>
              <div class="input-with-button">
                <input type="text" class="form-input" id="reportOrderAmount" placeholder="ä¾‹: 50000">
                <button type="button" class="btn-unknown" onclick="setUnknown('reportOrderAmount')">ä¸æ˜</button>
              </div>
            </div>

            <!-- è³¼å…¥é »åº¦ -->
            <div class="form-group">
              <label class="form-label">è³¼å…¥é »åº¦ï¼ˆæœˆæ¬¡ï¼‰ *</label>
              <div class="report-option-group" id="reportFrequencyGroup">
                <button type="button" class="report-option-btn" data-field="frequency" data-value="é€±1ä»¥ä¸Š" onclick="selectOption(this)">é€±1ä»¥ä¸Š</button>
                <button type="button" class="report-option-btn" data-field="frequency" data-value="é€±1" onclick="selectOption(this)">é€±1</button>
                <button type="button" class="report-option-btn" data-field="frequency" data-value="æœˆ2-3å›" onclick="selectOption(this)">æœˆ2-3å›</button>
                <button type="button" class="report-option-btn" data-field="frequency" data-value="æœˆ1" onclick="selectOption(this)">æœˆ1</button>
                <button type="button" class="report-option-btn" data-field="frequency" data-value="ä¸å®šæœŸ" onclick="selectOption(this)">ä¸å®šæœŸ</button>
                <button type="button" class="report-option-btn" data-field="frequency" data-value="ä¸æ˜" onclick="selectOption(this)">ä¸æ˜</button>
              </div>
              <input type="hidden" id="reportFrequency">
            </div>

            <!-- æœˆã®ç™ºæ³¨é‡è¦‹è¾¼ã¿ -->
            <div class="form-group">
              <label class="form-label">æœˆã®ç™ºæ³¨é‡è¦‹è¾¼ã¿ï¼ˆå††ï¼‰</label>
              <div class="input-with-button">
                <input type="text" class="form-input" id="reportMonthlyEstimate" placeholder="ä¾‹: æœˆ3å›ã€å„20000å††ç¨‹åº¦">
                <button type="button" class="btn-unknown" onclick="setUnknown('reportMonthlyEstimate')">ä¸æ˜</button>
              </div>
            </div>

            <!-- è¦‹è¾¼åº¦ -->
            <div class="form-group">
              <label class="form-label">è¦‹è¾¼åº¦ *</label>
              <div class="report-rating-group" id="reportProspectGroup">
                <button type="button" class="report-rating-btn" data-value="5" onclick="selectRating('prospect', this)">5</button>
                <button type="button" class="report-rating-btn" data-value="4" onclick="selectRating('prospect', this)">4</button>
                <button type="button" class="report-rating-btn" data-value="3" onclick="selectRating('prospect', this)">3</button>
                <button type="button" class="report-rating-btn" data-value="2" onclick="selectRating('prospect', this)">2</button>
                <button type="button" class="report-rating-btn" data-value="1" onclick="selectRating('prospect', this)">1</button>
              </div>
              <input type="hidden" id="reportProspect">
            </div>

            <!-- å•†è«‡ã®æ‰‹å¿œãˆ -->
            <div class="form-group">
              <label class="form-label">å•†è«‡ã®æ‰‹å¿œãˆ *</label>
              <div class="report-feeling-group" id="reportFeelingGroup">
                <button type="button" class="report-feeling-btn" data-value="5" onclick="selectFeeling(this)">ã¨ã¦ã‚‚è‰¯ã„</button>
                <button type="button" class="report-feeling-btn" data-value="4" onclick="selectFeeling(this)">è‰¯ã„</button>
                <button type="button" class="report-feeling-btn" data-value="3" onclick="selectFeeling(this)">ã¾ã‚ã¾ã‚</button>
                <button type="button" class="report-feeling-btn" data-value="2" onclick="selectFeeling(this)">æ‚ªã„</button>
                <button type="button" class="report-feeling-btn" data-value="1" onclick="selectFeeling(this)">ã¨ã¦ã‚‚æ‚ªã„</button>
              </div>
              <input type="hidden" id="reportFeeling">
            </div>

            <!-- è‰¯ã‹ã£ãŸç‚¹ -->
            <div class="form-group">
              <label class="form-label">è‰¯ã‹ã£ãŸç‚¹ *</label>
              <textarea class="report-textarea" id="reportGoodPoints" placeholder="ä»Šå›ã®å•†è«‡ã§è‰¯ã‹ã£ãŸç‚¹"></textarea>
            </div>

            <!-- æˆç´„ãƒã‚¤ãƒ³ãƒˆï¼ˆæˆç´„æ™‚ã®ã¿ï¼‰ -->
            <div class="form-group" id="fieldSuccessPoints" style="display: none;">
              <label class="form-label">æˆç´„ãƒã‚¤ãƒ³ãƒˆ *</label>
              <textarea class="report-textarea" id="reportSuccessPoints" placeholder="æˆç´„ã«è‡³ã£ãŸæ±ºã‚æ‰‹ã¯ï¼Ÿ"></textarea>
            </div>

            <!-- æ”¹å–„ç‚¹ï¼ˆå¤±æ³¨æ™‚ã®ã¿ï¼‰ -->
            <div class="form-group" id="fieldImprovements" style="display: none;">
              <label class="form-label">æ”¹å–„ç‚¹ *</label>
              <textarea class="report-textarea" id="reportImprovements" placeholder="æ¬¡å›ã«æ´»ã‹ã—ãŸã„æ”¹å–„ç‚¹"></textarea>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ -->
            <div class="form-group">
              <label class="form-label">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ *</label>
              <textarea class="report-textarea" id="reportActionPlan" placeholder="ä»Šå¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³"></textarea>
            </div>

            <!-- æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥ï¼ˆè¿½å®¢æ™‚ã®ã¿ï¼‰ -->
            <div class="form-group" id="fieldNextActionDate" style="display: none;">
              <label class="form-label">æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥ *</label>
              <input type="date" class="form-input" id="reportNextActionDate">
            </div>

            <!-- æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥ãƒ»è¦‹é€ã‚Šç†ç”±ï¼ˆè¦‹é€ã‚Šæ™‚ã®ã¿ï¼‰ -->
            <div class="form-group" id="fieldReapproachDate" style="display: none;">
              <label class="form-label">æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥</label>
              <input type="date" class="form-input" id="reportReapproachDate">
            </div>
            <div class="form-group" id="fieldPostponeReason" style="display: none;">
              <label class="form-label">è¦‹é€ã‚Šç†ç”± *</label>
              <textarea class="report-textarea" id="reportPostponeReason" placeholder="è¦‹é€ã‚Šã®ç†ç”±"></textarea>
            </div>

            <!-- ä¼šè©±ãƒ­ã‚°ï¼ˆä»»æ„ï¼‰ -->
            <div class="form-group">
              <label class="form-label">ä¼šè©±ãƒ­ã‚°ï¼ˆä»»æ„ï¼‰</label>
              <textarea class="report-textarea" id="reportConversationLog" placeholder="å•†è«‡ã®ä¼šè©±ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒš" style="min-height: 100px;"></textarea>
            </div>
          </div>
        </div>

        <!-- Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="buddyFeedbackContainer" style="display: none;">
          <div class="buddy-feedback-card">
            <div class="buddy-feedback-header">
              <span class="buddy-avatar-small">&#129492;</span>
              <span>Buddyã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
            </div>
            <div id="buddyFeedbackText" class="buddy-feedback-text"></div>
            <div class="buddy-feedback-actions">
              <button type="button" class="btn btn-primary" onclick="startBuddyWallHit()">&#128172; å£æ‰“ã¡ã™ã‚‹</button>
              <button type="button" class="btn btn-secondary" onclick="closeDealReportModal()">ã‚¹ã‚­ãƒƒãƒ—</button>
            </div>
          </div>
        </div>

        <!-- ãƒœã‚¿ãƒ³ -->
        <div id="reportButtonArea" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
          <button type="button" class="btn btn-secondary" onclick="closeDealReportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary" id="reportSubmitBtn" disabled>ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ‹…å½“è€…ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="staffEditModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title" id="staffEditModalTitle">æ‹…å½“è€…è¿½åŠ </h3>
        <button class="modal-close" onclick="closeStaffModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <input type="hidden" id="staffEditId">
        <div class="form-group" style="margin-bottom: 16px;">
          <label class="form-label">æ‹…å½“è€…ID</label>
          <input type="text" class="form-input" id="staffIdDisplay" disabled style="background: #e9ecef;">
          <small style="color: #666;">â€» è‡ªå‹•æ¡ç•ªã•ã‚Œã¾ã™</small>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">æ°åï¼ˆæ—¥æœ¬èªï¼‰ *</label>
            <input type="text" class="form-input" id="staffNameJa" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ°åï¼ˆè‹±èªï¼‰</label>
            <input type="text" class="form-input" id="staffNameEn">
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«</label>
          <input type="email" class="form-input" id="staffEmail">
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label class="form-label">Discord ID</label>
          <input type="text" class="form-input" id="staffDiscordId" placeholder="ä¾‹: 123456789012345678">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">å½¹å‰² *</label>
            <select class="form-select" id="staffRole"></select>
          </div>
          <div class="form-group">
            <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
            <select class="form-select" id="staffStatus">
              <option value="æœ‰åŠ¹">æœ‰åŠ¹</option>
              <option value="ç„¡åŠ¹">ç„¡åŠ¹</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label class="form-label">å…ƒå€™è£œè€…ID</label>
          <input type="text" class="form-input" id="staffCandidateId" placeholder="ä»»æ„">
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button class="btn" onclick="closeStaffModal()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="saveStaffFromModal()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
    let currentUser = null;

    // ========== ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ==========
    const cache = {
      leadsIn: null,
      leadsOut: null,
      deals: null,
      staff: null,
      roleNames: null,
      kpis: null,
      dropdownOptions: null,
      lastUpdated: null,
      leadsInError: null,
      leadsOutError: null,
      archive: null
    };

    // ========== ã‚»ãƒ¼ãƒ•DOMæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼ ==========
    function safeSetText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }
    function safeSetHtml(id, value) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = value;
    }
    function safeSetStyle(id, prop, value) {
      const el = document.getElementById(id);
      if (el) el.style[prop] = value;
    }
    function safeSetValue(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value;
    }
    function safeGetValue(id) {
      const el = document.getElementById(id);
      return el ? el.value : '';
    }

    // ========== æ‹…å½“è€…åãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆæ–°å½¢å¼/æ—§å½¢å¼å¯¾å¿œï¼‰==========
    // æ‹…å½“è€…ã®æ—¥æœ¬èªåã‚’å–å¾—ï¼ˆæ–°å½¢å¼: è‹—å­—+åå‰ã€æ—§å½¢å¼: æ°åï¼‰
    function getStaffDisplayNameForIndex(staff) {
      // æ–°å½¢å¼ï¼ˆè‹—å­—/åå‰åˆ†é›¢ï¼‰ã‚’å„ªå…ˆ
      if (staff['è‹—å­—ï¼ˆæ—¥æœ¬èªï¼‰'] || staff['åå‰ï¼ˆæ—¥æœ¬èªï¼‰']) {
        const family = staff['è‹—å­—ï¼ˆæ—¥æœ¬èªï¼‰'] || '';
        const given = staff['åå‰ï¼ˆæ—¥æœ¬èªï¼‰'] || '';
        return (family + ' ' + given).trim() || '-';
      }
      // æ—§å½¢å¼
      return staff['æ°åï¼ˆæ—¥æœ¬èªï¼‰'] || '-';
    }

    // æ‹…å½“è€…ã®è‹±èªåã‚’å–å¾—ï¼ˆæ–°å½¢å¼: è‹—å­—+åå‰ã€æ—§å½¢å¼: æ°åï¼‰
    function getStaffEnglishNameForIndex(staff) {
      // æ–°å½¢å¼ï¼ˆè‹—å­—/åå‰åˆ†é›¢ï¼‰ã‚’å„ªå…ˆ
      if (staff['è‹—å­—ï¼ˆè‹±èªï¼‰'] || staff['åå‰ï¼ˆè‹±èªï¼‰']) {
        const family = staff['è‹—å­—ï¼ˆè‹±èªï¼‰'] || '';
        const given = staff['åå‰ï¼ˆè‹±èªï¼‰'] || '';
        // è‹±èªåã¯ã€Œå å§“ã€å½¢å¼ã§è¡¨ç¤º
        return (given + ' ' + family).trim() || '';
      }
      // æ—§å½¢å¼
      return staff['æ°åï¼ˆè‹±èªï¼‰'] || '';
    }

    // ä¿å­˜æ™‚ã«åå‰ã‚’åˆ†å‰²
    function splitNameForSave(fullName, lang) {
      if (!fullName) return { family: '', given: '' };
      fullName = fullName.trim();

      // ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
      if (fullName.includes(' ') || fullName.includes('ã€€')) {
        const parts = fullName.split(/[\sã€€]+/);
        if (lang === 'ja') {
          // æ—¥æœ¬èª: è‹—å­— åå‰
          return { family: parts[0] || '', given: parts.slice(1).join(' ') || '' };
        } else {
          // è‹±èª: First Last â†’ given=First, family=Last
          return { given: parts[0] || '', family: parts.slice(1).join(' ') || '' };
        }
      }

      // ã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„å ´åˆã¯å…¨ä½“ã‚’åå‰ã¨ã—ã¦æ‰±ã†
      return { family: '', given: fullName };
    }

    // ========== åˆæœŸåŒ– ==========
    document.addEventListener('DOMContentLoaded', function() {
      initializeUser();
      initNavigation();
      loadAllData();
      setupModalCloseHandlers();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ + Escã‚­ãƒ¼ï¼‰
    function setupModalCloseHandlers() {
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ï¼‰ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeAllModalsIndex();
          }
        });
      });

      // Escã‚­ãƒ¼ã§é–‰ã˜ã‚‹
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAllModalsIndex();
        }
      });
    }

    function closeAllModalsIndex() {
      // å…¨ã¦ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.querySelectorAll('.modal.active').forEach(modal => {
        modal.classList.remove('active');
      });
    }

    // ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ ==========
    function initializeUser() {
      google.script.run
        .withSuccessHandler(function(user) {
          currentUser = user;

          // èªè¨¼ãƒã‚§ãƒƒã‚¯
          if (!user.isAuthenticated) {
            showAuthError(user.error || 'æ‹…å½“è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          // èªè¨¼æˆåŠŸï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã€ã‚¢ãƒ—ãƒªã‚’è¡¨ç¤º
          safeSetStyle('auth-loading', 'display', 'none');
          safeSetStyle('app-container', 'display', 'flex');

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º
          updateUserDisplay(user);

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ¨©é™ã«å¿œã˜ã¦åˆ¶å¾¡
          updateMenuByPermissions(user.permissions);

          // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å½¹å‰²ã«å¿œã˜ã¦è¡¨ç¤º
          showDashboardByRole(user.role);
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          showAuthError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getCurrentUserWithPermissions();
    }

    // èªè¨¼ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆå…¨ç”»é¢ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    function showAuthError(message) {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
      safeSetStyle('auth-loading', 'display', 'none');

      // ã‚¨ãƒ©ãƒ¼ç”»é¢ã‚’è¡¨ç¤ºï¼ˆbodyã‚’ç½®ãæ›ãˆï¼‰
      document.body.innerHTML = `
        <div class="auth-error-screen">
          <div class="auth-error-box">
            <div class="auth-error-icon">ğŸš«</div>
            <h2>ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h2>
            <p class="auth-error-message">${message}</p>
            <div class="auth-error-info">
              <p>ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€æ‹…å½“è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
              <p>ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ã€æ‹…å½“è€…ãƒã‚¹ã‚¿ã¸ã®ç™»éŒ²ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div class="auth-error-contact">
              <p>ãŠå•ã„åˆã‚ã›: ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„</p>
            </div>
          </div>
        </div>
      `;
    }

    function updateUserDisplay(user) {
      const userDisplay = document.getElementById('user-display');
      if (userDisplay) {
        userDisplay.textContent = user.staffName || user.email || 'ä¸æ˜';
      }
    }

    function updateMenuByPermissions(permissions) {
      // ãƒªãƒ¼ãƒ‰ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const leadInMenu = document.querySelector('[data-page="leads-in"]');
      const leadOutMenu = document.querySelector('[data-page="leads-out"]');
      if (leadInMenu) leadInMenu.style.display = permissions.lead_view ? '' : 'none';
      if (leadOutMenu) leadOutMenu.style.display = permissions.lead_view ? '' : 'none';

      // å•†è«‡ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const dealMenu = document.querySelector('[data-page="deals"]');
      if (dealMenu) {
        dealMenu.style.display = (permissions.deal_view_all || permissions.deal_view_own) ? '' : 'none';
      }

      // æ‹…å½“è€…ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const staffMenu = document.querySelector('[data-page="staff"]');
      if (staffMenu) staffMenu.style.display = permissions.staff_manage ? '' : 'none';

      // ç®¡ç†è€…è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const adminMenu = document.querySelector('[data-page="admin"]');
      if (adminMenu) adminMenu.style.display = permissions.admin_access ? '' : 'none';
    }

    function showDashboardByRole(role) {
      // ã™ã¹ã¦ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
      document.querySelectorAll('.dashboard-container').forEach(d => d.style.display = 'none');

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      updateSidebarByRole(role);

      // å…¨ãƒ­ãƒ¼ãƒ«å…±é€šã§dashboard-fullã‚’ä½¿ç”¨ï¼ˆçµ±ä¸€ä»•æ§˜ï¼‰
      safeSetStyle('dashboard-full', 'display', 'block');
      loadFullPersonalMetrics(); // å€‹äººã‚¿ãƒ–ç”¨

      // ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ãƒ–ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼/ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…/ãƒªãƒ¼ãƒ€ãƒ¼ã®ã¿ï¼‰
      const tabBtnLeader = document.getElementById('tabBtnLeader');
      if (tabBtnLeader) {
        if (['ã‚ªãƒ¼ãƒŠãƒ¼', 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…', 'ãƒªãƒ¼ãƒ€ãƒ¼'].includes(role)) {
          tabBtnLeader.style.display = 'inline-block';
          loadBottleneckDashboard(); // ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ãƒ–ç”¨ï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®šï¼‰
        } else {
          tabBtnLeader.style.display = 'none';
        }
      }

      initBuddyCard('Full'); // Buddyã‚«ãƒ¼ãƒ‰åˆæœŸåŒ–
      // ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆå°‘ã—é…å»¶ã—ã¦è¡¨ç¤ºï¼‰
      setTimeout(checkBuddyAlertPopup, 2000);

      // ãƒ­ã‚°ã‚¤ãƒ³è¨˜éŒ²ã¨ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé–‹å§‹
      recordLogin();
      startHeartbeat();
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
    function updateSidebarByRole(role) {
      const sidebarMenu = document.getElementById('sidebarMenu');
      const sections = {
        cs: document.getElementById('section-cs'),
        sales: document.getElementById('section-sales'),
        common: document.getElementById('section-common'),
        leader: document.getElementById('section-leader'),
        admin: document.getElementById('section-admin')
      };

      // ã™ã¹ã¦éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
      Object.values(sections).forEach(s => { if (s) s.style.display = 'none'; });

      // å½¹å‰²ã«å¿œã˜ãŸè¡¨ç¤ºé †åºã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå±•é–‹çŠ¶æ…‹ã‚’è¨­å®š
      let sectionOrder = [];
      let defaultExpanded = [];

      switch (role) {
        case 'CS':
          sectionOrder = ['cs', 'common', 'admin'];
          defaultExpanded = ['cs'];
          break;
        case 'å–¶æ¥­':
          sectionOrder = ['sales', 'common', 'admin'];
          defaultExpanded = ['sales'];
          break;
        case 'ãƒªãƒ¼ãƒ€ãƒ¼':
          sectionOrder = ['leader', 'sales', 'cs', 'common', 'admin'];
          defaultExpanded = ['leader'];
          break;
        case 'ã‚ªãƒ¼ãƒŠãƒ¼':
        case 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…':
        default:
          sectionOrder = ['sales', 'cs', 'common', 'leader', 'admin'];
          defaultExpanded = ['sales'];
          break;
      }

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é †åºé€šã‚Šã«ä¸¦ã¹æ›¿ãˆ
      sectionOrder.forEach(key => {
        const section = sections[key];
        if (section) {
          section.style.display = 'block';
          sidebarMenu.appendChild(section);
        }
      });

      // localStorageã«çŠ¶æ…‹ãŒãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå±•é–‹çŠ¶æ…‹ã‚’é©ç”¨
      const savedState = localStorage.getItem('sidebarState');
      if (!savedState) {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æŒ‡å®šä»¥å¤–ã¯æŠ˜ã‚ŠãŸãŸã‚€
        Object.keys(sections).forEach(key => {
          const sectionId = 'section-' + key;
          if (!defaultExpanded.includes(key)) {
            collapseSidebarSection(sectionId, true);
          }
        });
      } else {
        // ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ã‚’å¾©å…ƒ
        restoreSidebarState();
      }
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
    function toggleSidebarSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (!section) return;

      const isCollapsed = section.classList.toggle('collapsed');
      const icon = section.querySelector('.collapse-icon');
      if (icon) {
        icon.textContent = isCollapsed ? 'â–¶' : 'â–¼';
      }

      // çŠ¶æ…‹ã‚’ä¿å­˜
      saveSidebarState();
    }

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€ï¼ˆåˆæœŸè¨­å®šç”¨ï¼‰
    function collapseSidebarSection(sectionId, collapsed) {
      const section = document.getElementById(sectionId);
      if (!section) return;

      if (collapsed) {
        section.classList.add('collapsed');
      } else {
        section.classList.remove('collapsed');
      }

      const icon = section.querySelector('.collapse-icon');
      if (icon) {
        icon.textContent = collapsed ? 'â–¶' : 'â–¼';
      }
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼çŠ¶æ…‹ã‚’ä¿å­˜
    function saveSidebarState() {
      const state = {};
      document.querySelectorAll('.sidebar-section').forEach(section => {
        if (section.id) {
          state[section.id] = section.classList.contains('collapsed');
        }
      });
      localStorage.setItem('sidebarState', JSON.stringify(state));
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼çŠ¶æ…‹ã‚’å¾©å…ƒ
    function restoreSidebarState() {
      try {
        const state = JSON.parse(localStorage.getItem('sidebarState') || '{}');
        Object.keys(state).forEach(sectionId => {
          collapseSidebarSection(sectionId, state[sectionId]);
        });
      } catch (e) {
        console.warn('ã‚µã‚¤ãƒ‰ãƒãƒ¼çŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—:', e);
      }
    }

    // å–¶æ¥­ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’èª­ã¿è¾¼ã¿
    function loadSalesMetrics() {
      if (!currentUser || !currentUser.staffId) {
        console.warn('currentUser or staffId is not available');
        return;
      }

      // å€‹äººãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(data) {
          if (data.error) {
            console.error('å€‹äººãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:', data.error);
            return;
          }

          // ã‚«ãƒ¼ãƒ‰1: ä»Šæœˆã®ç›®æ¨™é€²æ—
          renderGoalProgress(data.goalProgress);

          // ã‚«ãƒ¼ãƒ‰2: æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          renderUpcomingActions(data.upcomingActions);

          // ã‚«ãƒ¼ãƒ‰3: æ‹…å½“æ¡ˆä»¶ï¼ˆé€²è¡Œä¸­ï¼‰
          renderActiveDeals(data.activeDeals, data.totalActiveDeals);

          // æœ€çµ‚æ›´æ–°
          if (data.lastUpdated) {
            const updateTime = new Date(data.lastUpdated);
            safeSetText('sales-last-updated',
              updateTime.toLocaleString('ja-JP', { hour: '2-digit', minute: '2-digit' }));
          }
        })
        .withFailureHandler(function(error) {
          console.error('å€‹äººãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getPersonalDashboardData(currentUser.staffId);
    }

    // ã‚«ãƒ¼ãƒ‰1: ä»Šæœˆã®ç›®æ¨™é€²æ—ã‚’æç”»
    function renderGoalProgress(progress) {
      const noDataEl = document.getElementById('goalNoData');
      const contentEl = document.querySelector('.goal-progress-content');

      if (!progress || !progress.hasGoal) {
        if (noDataEl) noDataEl.style.display = 'block';
        if (contentEl) contentEl.style.display = 'none';
        return;
      }

      if (noDataEl) noDataEl.style.display = 'none';
      if (contentEl) contentEl.style.display = 'flex';

      // æˆç´„
      const closedCurrentEl = document.getElementById('goalClosedCurrent');
      const closedTargetEl = document.getElementById('goalClosedTarget');
      const closedPercentEl = document.getElementById('goalClosedPercent');
      const closedFillEl = document.getElementById('goalClosedFill');
      if (closedCurrentEl) closedCurrentEl.textContent = progress.closedCurrent;
      if (closedTargetEl) closedTargetEl.textContent = progress.closedTarget;
      if (closedPercentEl) closedPercentEl.textContent = progress.closedPercent + '%';
      if (closedFillEl) closedFillEl.style.width = Math.min(progress.closedPercent, 100) + '%';

      // å£²ä¸Š
      const salesCurrentEl = document.getElementById('goalSalesCurrent');
      const salesTargetEl = document.getElementById('goalSalesTarget');
      const salesPercentEl = document.getElementById('goalSalesPercent');
      const salesFillEl = document.getElementById('goalSalesFill');
      if (salesCurrentEl) salesCurrentEl.textContent = progress.salesCurrent;
      if (salesTargetEl) salesTargetEl.textContent = progress.salesTarget;
      if (salesPercentEl) salesPercentEl.textContent = progress.salesPercent + '%';
      if (salesFillEl) salesFillEl.style.width = Math.min(progress.salesPercent, 100) + '%';
    }

    // ã‚«ãƒ¼ãƒ‰2: æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æç”»
    function renderUpcomingActions(actions) {
      const container = document.getElementById('upcomingActions');
      if (!container) {
        console.warn('è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: upcomingActions');
        return;
      }

      if (!actions || actions.length === 0) {
        container.innerHTML = '<p class="no-data">æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      let html = '';
      actions.forEach(function(action) {
        const dueClass = action.dueType === 'today' ? 'due-today' :
                        (action.dueType === 'tomorrow' ? 'due-tomorrow' : '');

        html += `
          <div class="upcoming-action-item ${dueClass}">
            <div>
              <span class="upcoming-action-company">${escapeHtml(action.company)}</span>
              <span class="upcoming-action-name">${escapeHtml(action.action)}</span>
            </div>
            <span class="upcoming-action-date">${action.dateFormatted}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // ã‚«ãƒ¼ãƒ‰3: æ‹…å½“æ¡ˆä»¶ï¼ˆé€²è¡Œä¸­ï¼‰ã‚’æç”»
    function renderActiveDeals(deals, totalCount) {
      const tbody = document.getElementById('activeDealsBody');
      const moreLink = document.getElementById('activeDealsMore');

      if (!tbody) {
        console.warn('è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: activeDealsBody');
        return;
      }

      if (!deals || deals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">é€²è¡Œä¸­ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
        if (moreLink) moreLink.style.display = 'none';
        return;
      }

      let html = '';
      deals.forEach(function(deal, index) {
        const leadId = deal.leadId || '';
        const messageUrl = deal.messageUrl || '';
        const nextActionDate = deal.nextActionDate ? formatDate(deal.nextActionDate) : '-';

        html += `
          <tr class="clickable-row" onclick="openDealSlidePanelFromDashboard('${leadId}')">
            <td>${escapeHtml(deal.company)}</td>
            <td><span class="deal-status-badge status-${deal.status}">${deal.status}</span></td>
            <td>${nextActionDate}</td>
            <td class="deal-row-actions" onclick="event.stopPropagation();">
              <button class="deal-row-btn deal-row-btn-message" onclick="openMessageBox('${messageUrl}')" title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–‹ã">ğŸ“©</button>
              <button class="deal-row-btn deal-row-btn-report" onclick="openDealSlidePanelFromDashboard('${leadId}', 'report')" title="ãƒ¬ãƒãƒ¼ãƒˆæå‡º">ğŸ“</button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // 10ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆã¯ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ã‚’è¡¨ç¤º
      if (moreLink) {
        moreLink.style.display = (totalCount > 10) ? 'block' : 'none';
      }
    }

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å•†è«‡ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‹ã
    function openDealSlidePanelFromDashboard(leadId, initialTab) {
      if (!leadId) {
        console.error('[ERROR] leadId is empty!');
        showToast('æ¡ˆä»¶IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      // cache.dealsãŒãªã‘ã‚Œã°èª­ã¿è¾¼ã‚€
      if (!cache.deals || cache.deals.length === 0) {
        showLoading();
        google.script.run
          .withSuccessHandler(function(data) {
            hideLoading();
            cache.deals = data || [];
            openDealSlidePanel(leadId, initialTab || 'detail');
          })
          .withFailureHandler(function(e) {
            hideLoading();
            console.error('å•†è«‡å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            showToast('å•†è«‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
          })
          .getLeads('deal');
      } else {
        openDealSlidePanel(leadId, initialTab || 'detail');
      }
    }

    // ãƒãƒ¼ãƒ æˆç¸¾ã‚’èª­ã¿è¾¼ã¿
    function loadTeamStats() {
      google.script.run
        .withSuccessHandler(function(stats) {
          const container = document.getElementById('team-stats-table');

          if (stats.length === 0) {
            container.innerHTML = '<p class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
          }

          let html = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>é †ä½</th>
                  <th>æ‹…å½“è€…</th>
                  <th>å•†è«‡æ•°</th>
                  <th>æˆç´„æ•°</th>
                  <th>æˆç´„ç‡</th>
                  <th>å£²ä¸Š</th>
                </tr>
              </thead>
              <tbody>
          `;

          stats.forEach((stat, index) => {
            const isMe = currentUser && stat.name === currentUser.staffName;
            const rowClass = isMe ? 'highlight-row' : '';
            const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1);

            html += `
              <tr class="${rowClass}">
                <td>${medal}</td>
                <td>${stat.name}${isMe ? ' â˜…' : ''}</td>
                <td>${stat.deals}</td>
                <td>${stat.won}</td>
                <td>${stat.winRate}%</td>
                <td>$${stat.sales.toLocaleString()}</td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          console.error('ãƒãƒ¼ãƒ æˆç¸¾å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getTeamStats();
    }

    // å–¶æ¥­ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function showSalesTab(tab) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('#dashboard-sales .dashboard-tab').forEach((btn, index) => {
        if ((tab === 'personal' && index === 0) || (tab === 'team' && index === 1)) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡ã‚Šæ›¿ãˆ
      safeSetStyle('sales-personal', 'display', tab === 'personal' ? 'block' : 'none');
      safeSetStyle('sales-team', 'display', tab === 'team' ? 'block' : 'none');

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      if (tab === 'personal') {
        loadSalesMetrics();
      } else {
        loadTeamStats();
      }
    }

    // å€‹äººãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ•ãƒ«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰
    function loadFullPersonalMetrics() {
      const staffName = currentUser ? currentUser.staffName : null;

      google.script.run
        .withSuccessHandler(function(metrics) {
          safeSetText('fullPersonalDeals', metrics.totalDeals);
          safeSetText('fullPersonalWon', metrics.wonDeals);
          safeSetText('fullPersonalWinRate', metrics.winRate + '%');
          safeSetText('fullPersonalSales', 'Â¥' + metrics.totalSales.toLocaleString());
          safeSetText('fullPersonalLastUpdated', metrics.lastUpdated);

          // ç›®æ¨™é€²æ—
          const goalContainer = document.getElementById('fullPersonalGoalProgress');
          if (goalContainer && metrics.goalProgress) {
            const progress = metrics.goalProgress;
            const progressPercent = Math.min(100, Math.round((progress.current / progress.target) * 100));
            goalContainer.innerHTML = `
              <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span>å£²ä¸Šç›®æ¨™</span>
                  <span>Â¥${progress.current.toLocaleString()} / Â¥${progress.target.toLocaleString()}</span>
                </div>
                <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                  <div style="background: ${progressPercent >= 100 ? '#16a34a' : '#3b82f6'}; height: 100%; width: ${progressPercent}%;"></div>
                </div>
                <div style="text-align: right; font-size: 12px; color: #666; margin-top: 4px;">${progressPercent}%é”æˆ</div>
              </div>
            `;
          } else if (goalContainer) {
            goalContainer.innerHTML = '<p class="no-data">ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
          }

          // æ‹…å½“æ¡ˆä»¶ä¸€è¦§ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‹ãï¼‰
          const dealsContainer = document.getElementById('fullPersonalDealsTable');
          if (dealsContainer) {
            if (metrics.activeDeals && metrics.activeDeals.length > 0) {
              let html = `
                <table class="data-table mini-table active-deals-table">
                  <thead><tr><th>é¡§å®¢å</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ¬¡å›</th><th style="width: 110px;">æ“ä½œ</th></tr></thead>
                  <tbody>
              `;
              metrics.activeDeals.slice(0, 5).forEach(deal => {
                const leadId = deal.leadId || '';
                const messageUrl = deal.messageUrl || '';
                html += `
                  <tr class="clickable-row" onclick="openDealSlidePanelFromDashboard('${leadId}')">
                    <td>${escapeHtml(deal.customerName || deal.company || '-')}</td>
                    <td><span class="deal-status-badge status-${deal.status}">${deal.status || '-'}</span></td>
                    <td>${deal.nextActionDate || '-'}</td>
                    <td class="deal-row-actions" onclick="event.stopPropagation();">
                      <button class="deal-row-btn deal-row-btn-message" onclick="openMessageBox('${messageUrl}')" title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–‹ã">ğŸ“©</button>
                      <button class="deal-row-btn deal-row-btn-report" onclick="openDealSlidePanelFromDashboard('${leadId}', 'report')" title="ãƒ¬ãƒãƒ¼ãƒˆæå‡º">ğŸ“</button>
                    </td>
                  </tr>
                `;
              });
              html += '</tbody></table>';
              dealsContainer.innerHTML = html;
            } else {
              dealsContainer.innerHTML = '<p class="no-data">é€²è¡Œä¸­ã®æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
          }

          // æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          const upcomingContainer = document.getElementById('fullPersonalUpcoming');
          if (upcomingContainer) {
            if (metrics.todayActions && metrics.todayActions.length > 0) {
              let html = '<ul class="action-list">';
              metrics.todayActions.slice(0, 5).forEach(action => {
                html += `<li class="action-item"><span class="action-customer">${action.customer}</span><span class="action-text">${action.content}</span></li>`;
              });
              html += '</ul>';
              upcomingContainer.innerHTML = html;
            } else {
              upcomingContainer.innerHTML = '<p class="no-data">æœŸé™é–“è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            }
          }

          // ä¾å­˜æ€§UIç”¨ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
          renderReminderCards(metrics.reminderActions || []);
        })
        .withFailureHandler(function(error) {
          console.error('å€‹äººãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getSalesMetrics(staffName);
    }

    // ãƒãƒ¼ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ•ãƒ«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰
    function loadLeaderMetrics() {
      google.script.run
        .withSuccessHandler(function(metrics) {
          // ãƒãƒ¼ãƒ KPI
          safeSetText('leaderSalesDeals', metrics.sales.totalDeals);
          safeSetText('leaderSalesWon', metrics.sales.wonDeals);
          safeSetText('leaderSalesWinRate', metrics.sales.winRate + '%');
          safeSetText('leaderSalesTotal', 'Â¥' + metrics.sales.totalSales.toLocaleString());

          // ãƒãƒ¼ãƒ ç›®æ¨™é€²æ—
          const teamGoalContainer = document.getElementById('teamGoalProgress');
          if (teamGoalContainer) {
            if (metrics.teamGoal) {
              const progress = metrics.teamGoal;
              const progressPercent = Math.min(100, Math.round((progress.current / progress.target) * 100));
              teamGoalContainer.innerHTML = `
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>ãƒãƒ¼ãƒ å£²ä¸Šç›®æ¨™</span>
                    <span>Â¥${progress.current.toLocaleString()} / Â¥${progress.target.toLocaleString()}</span>
                  </div>
                  <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div style="background: ${progressPercent >= 100 ? '#16a34a' : '#3b82f6'}; height: 100%; width: ${progressPercent}%;"></div>
                  </div>
                  <div style="text-align: right; font-size: 12px; color: #666; margin-top: 4px;">${progressPercent}%é”æˆ</div>
                </div>
              `;
            } else {
              teamGoalContainer.innerHTML = '<p class="no-data">ãƒãƒ¼ãƒ ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            }
          }

          // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
          const rankingContainer = document.getElementById('leaderRankingTable');
          if (rankingContainer) {
            if (metrics.salesRanking && metrics.salesRanking.length > 0) {
              let html = `
                <table class="data-table mini-table">
                  <thead>
                    <tr>
                      <th>é †ä½</th>
                      <th>æ‹…å½“è€…</th>
                      <th>å•†è«‡</th>
                      <th>æˆç´„</th>
                      <th>æˆç´„ç‡</th>
                      <th>å£²ä¸Š</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              metrics.salesRanking.forEach((staff, index) => {
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1);
                html += `
                  <tr>
                    <td>${medal}</td>
                    <td>${staff.name}</td>
                    <td>${staff.deals}</td>
                    <td>${staff.won}</td>
                    <td>${staff.winRate}%</td>
                    <td>Â¥${staff.sales.toLocaleString()}</td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              rankingContainer.innerHTML = html;
            } else {
              rankingContainer.innerHTML = '<p class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
          }

          // æœ€çµ‚æ›´æ–°
          safeSetText('leaderLastUpdated', metrics.lastUpdated);
        })
        .withFailureHandler(function(error) {
          console.error('ãƒãƒ¼ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getLeaderMetrics();

      // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿
      loadTrendCharts();
    }

    // ============================================================
    // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    // ============================================================

    function loadBottleneckDashboard() {
      google.script.run
        .withSuccessHandler(function(data) {
          if (data.error) {
            console.error('ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:', data.error);
            return;
          }
          renderBottleneckDashboard(data);
        })
        .withFailureHandler(function(error) {
          console.error('ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getBottleneckDashboardData();
    }

    function renderBottleneckDashboard(data) {
      // ãƒãƒ¼ãƒ KPI
      safeSetText('bnTeamDeals', data.teamKPI.totalDeals);
      safeSetText('bnTeamWon', data.teamKPI.wonDeals);
      safeSetText('bnTeamWinRate', data.teamKPI.winRate + '%');
      safeSetText('bnStagnantCount', data.teamKPI.stagnantCount);

      // åœæ»æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
      const stagnantCard = document.getElementById('bnStagnantCard');
      if (stagnantCard) {
        if (data.teamKPI.stagnantCount > 0) {
          stagnantCard.classList.add('has-issues');
        } else {
          stagnantCard.classList.remove('has-issues');
        }
      }

      // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯: åœæ»æ¡ˆä»¶ï¼ˆæ‹…å½“è€…åˆ¥ï¼‰
      const stagnantBadge = document.getElementById('bnStagnantBadge');
      const stagnantByStaffEl = document.getElementById('bnStagnantByStaff');
      if (stagnantBadge) {
        stagnantBadge.textContent = data.bottlenecks.stagnantDeals.length;
        stagnantBadge.classList.toggle('zero', data.bottlenecks.stagnantDeals.length === 0);
      }
      if (stagnantByStaffEl) {
        if (data.bottlenecks.stagnantByStaff && data.bottlenecks.stagnantByStaff.length > 0) {
          let html = '';
          data.bottlenecks.stagnantByStaff.forEach(item => {
            html += `
              <div class="stagnant-staff-item" onclick="filterStaffDeals('${escapeHtml(item.staffName)}', 'stagnant')">
                <span class="stagnant-staff-name">${escapeHtml(item.staffName)}</span>
                <span class="stagnant-staff-count">${item.count}ä»¶</span>
              </div>
            `;
          });
          stagnantByStaffEl.innerHTML = html;
        } else {
          stagnantByStaffEl.innerHTML = '<p class="no-data" style="color: #16a34a;">åœæ»æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }
      }

      // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯: ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°é•·æœŸåŒ–
      const longDealBadge = document.getElementById('bnLongDealBadge');
      const longDealsEl = document.getElementById('bnLongDeals');
      if (longDealBadge) {
        longDealBadge.textContent = data.bottlenecks.longDeals.length;
        longDealBadge.classList.toggle('zero', data.bottlenecks.longDeals.length === 0);
      }
      if (longDealsEl) {
        if (data.bottlenecks.longDeals && data.bottlenecks.longDeals.length > 0) {
          let html = '';
          data.bottlenecks.longDeals.forEach(deal => {
            html += `
              <div class="long-deal-item" onclick="openDealSlidePanelFromDashboard('${deal.leadId}')">
                <div class="long-deal-info">
                  <span class="long-deal-customer">${escapeHtml(deal.customerName)}</span>
                  <span class="long-deal-staff">${escapeHtml(deal.staffName)}</span>
                </div>
                <span class="long-deal-days">${deal.daysSinceAssign}æ—¥çµŒé</span>
              </div>
            `;
          });
          longDealsEl.innerHTML = html;
        } else {
          longDealsEl.innerHTML = '<p class="no-data" style="color: #16a34a;">é•·æœŸåŒ–æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }
      }

      // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯: æˆç´„ç‡ä½ä¸‹
      const conversionBadge = document.getElementById('bnConversionDropBadge');
      const conversionDropEl = document.getElementById('bnConversionDrop');
      if (conversionBadge) {
        conversionBadge.textContent = data.bottlenecks.conversionDropStaff.length;
        conversionBadge.classList.toggle('zero', data.bottlenecks.conversionDropStaff.length === 0);
      }
      if (conversionDropEl) {
        if (data.bottlenecks.conversionDropStaff && data.bottlenecks.conversionDropStaff.length > 0) {
          let html = '';
          data.bottlenecks.conversionDropStaff.forEach(staff => {
            html += `
              <div class="conversion-drop-item">
                <span class="conversion-drop-name">${escapeHtml(staff.staffName)}</span>
                <div class="conversion-rates">
                  <span class="rate-previous">${staff.lastMonthRate}%</span>
                  <span class="rate-arrow">â†’</span>
                  <span class="rate-current">${staff.thisMonthRate}%</span>
                  <span style="color: #dc2626; font-size: 11px;">(-${staff.drop}%)</span>
                </div>
              </div>
            `;
          });
          conversionDropEl.innerHTML = html;
        } else {
          conversionDropEl.innerHTML = '<p class="no-data" style="color: #16a34a;">æˆç´„ç‡ä½ä¸‹è€…ã¯ã„ã¾ã›ã‚“</p>';
        }
      }

      // æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¡¨
      const perfTableEl = document.getElementById('bnStaffPerformanceTable');
      if (perfTableEl) {
        if (data.staffPerformance && data.staffPerformance.length > 0) {
          let html = `
            <table class="performance-table">
              <thead>
                <tr>
                  <th>æ‹…å½“è€…</th>
                  <th>å•†è«‡æ•°</th>
                  <th>æˆç´„æ•°</th>
                  <th>åœæ»</th>
                  <th>æˆç´„ç‡</th>
                  <th>çŠ¶æ…‹</th>
                </tr>
              </thead>
              <tbody>
          `;
          data.staffPerformance.forEach(staff => {
            const statusIcon = staff.status === 'ok' ? 'âœ…' : staff.status === 'warning' ? 'âš ï¸' : 'ğŸš¨';
            const statusLabel = staff.status === 'ok' ? 'é †èª¿' : staff.status === 'warning' ? 'æ³¨æ„' : 'è¦ä»‹å…¥';
            const stagnantClass = staff.stagnantCount >= 3 ? 'high' : '';

            html += `
              <tr onclick="openStaffDetailModal('${staff.staffId}')">
                <td>${escapeHtml(staff.staffName)}</td>
                <td>${staff.dealCount}</td>
                <td>${staff.wonCount}</td>
                <td>${staff.stagnantCount > 0 ? '<span class="stagnant-badge ' + stagnantClass + '">' + staff.stagnantCount + '</span>' : '-'}</td>
                <td>${staff.winRate !== null ? staff.winRate + '%' : '-'}</td>
                <td><span class="performance-status status-${staff.status}">${statusIcon} ${statusLabel}</span></td>
              </tr>
            `;
          });
          html += '</tbody></table>';
          perfTableEl.innerHTML = html;
        } else {
          perfTableEl.innerHTML = '<p class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }
      }

      // æœ€çµ‚æ›´æ–°
      safeSetText('bnLastUpdated', data.lastUpdated);
    }

    // æ‹…å½“è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openStaffDetailModal(staffId) {
      const modal = document.getElementById('staff-detail-modal');
      if (!modal) return;

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      safeSetText('staffDetailTitle', 'èª­ã¿è¾¼ã¿ä¸­...');
      safeSetText('staffDetailDeals', '-');
      safeSetText('staffDetailWon', '-');
      safeSetText('staffDetailLost', '-');
      safeSetText('staffDetailWinRate', '-');

      const problemDealsEl = document.getElementById('staffDetailProblemDeals');
      if (problemDealsEl) problemDealsEl.innerHTML = '<p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>';

      const weeklyTrendEl = document.getElementById('staffDetailWeeklyTrend');
      if (weeklyTrendEl) weeklyTrendEl.innerHTML = '<p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>';

      modal.style.display = 'flex';

      google.script.run
        .withSuccessHandler(function(data) {
          if (data.error) {
            console.error('æ‹…å½“è€…è©³ç´°ã‚¨ãƒ©ãƒ¼:', data.error);
            return;
          }
          renderStaffDetailModal(data);
        })
        .withFailureHandler(function(error) {
          console.error('æ‹…å½“è€…è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getStaffDetailForBottleneck(staffId);
    }

    function renderStaffDetailModal(data) {
      safeSetText('staffDetailTitle', data.staffName + ' ã®è©³ç´°');
      safeSetText('staffDetailDeals', data.metrics.dealCount);
      safeSetText('staffDetailWon', data.metrics.wonCount);
      safeSetText('staffDetailLost', data.metrics.lostCount);
      safeSetText('staffDetailWinRate', data.metrics.winRate !== null ? data.metrics.winRate + '%' : '-');

      // å¯¾å¿œãŒå¿…è¦ãªæ¡ˆä»¶
      const problemDealsEl = document.getElementById('staffDetailProblemDeals');
      if (problemDealsEl) {
        if (data.problemDeals && data.problemDeals.length > 0) {
          let html = '';
          data.problemDeals.forEach(deal => {
            const tags = deal.problems.map(p => {
              const tagClass = p === 'åœæ»ä¸­' ? 'stagnant' : 'long';
              return '<span class="problem-tag ' + tagClass + '">' + p + '</span>';
            }).join('');

            html += `
              <div class="problem-deal-item" onclick="closeModal('staff-detail-modal'); openDealSlidePanelFromDashboard('${deal.leadId}');">
                <div class="problem-deal-info">
                  <span class="problem-deal-customer">${escapeHtml(deal.customerName)}</span>
                  <span class="problem-deal-meta">${deal.status} / ${deal.stagnantDays > 0 ? deal.stagnantDays + 'æ—¥åœæ»' : deal.daysSinceAssign + 'æ—¥çµŒé'}</span>
                </div>
                <div class="problem-tags">${tags}</div>
              </div>
            `;
          });
          problemDealsEl.innerHTML = html;
        } else {
          problemDealsEl.innerHTML = '<p class="no-data" style="color: #16a34a;">å¯¾å¿œãŒå¿…è¦ãªæ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }
      }

      // é€±æ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰
      const weeklyTrendEl = document.getElementById('staffDetailWeeklyTrend');
      if (weeklyTrendEl) {
        let html = '';
        data.weeklyTrend.forEach(week => {
          html += `
            <div class="trend-week-card">
              <div class="trend-week-label">${week.weekLabel}</div>
              <div class="trend-week-rate ${week.winRate === null ? 'no-data' : ''}">${week.winRate !== null ? week.winRate + '%' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</div>
              <div class="trend-week-counts">${week.wonCount}æˆç´„ / ${week.lostCount}å¤±æ³¨</div>
            </div>
          `;
        });
        weeklyTrendEl.innerHTML = html;
      }
    }

    // æ‹…å½“è€…ã®åœæ»æ¡ˆä»¶ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦è¡¨ç¤ºï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
    function filterStaffDeals(staffName, filterType) {
      // å°†æ¥çš„ã«æ‹…å½“è€…ã®æ¡ˆä»¶ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ å¯èƒ½
      console.log('Filter:', staffName, filterType);
      // ä»Šã¯æ‹…å½“è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã“ã¨ã§ä»£ç”¨
      // TODO: staffIdã‚’å–å¾—ã—ã¦openStaffDetailModal()ã‚’å‘¼ã¶
    }

    // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿
    let trendDealChartInstance = null;
    let trendSalesChartInstance = null;

    function loadTrendCharts() {
      google.script.run
        .withSuccessHandler(function(trendData) {
          if (trendData.error) {
            console.error('ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:', trendData.error);
            return;
          }
          renderTrendCharts(trendData);
        })
        .withFailureHandler(function(error) {
          console.error('ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getTrendData(null, 6);
    }

    function renderTrendCharts(trendData) {
      // æˆç´„æ•°ãƒ»å¤±æ³¨æ•°ãƒãƒ£ãƒ¼ãƒˆ
      const dealCtx = document.getElementById('trendDealChart');
      if (dealCtx) {
        if (trendDealChartInstance) {
          trendDealChartInstance.destroy();
        }
        trendDealChartInstance = new Chart(dealCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: trendData.labels,
            datasets: [
              {
                label: 'æˆç´„',
                data: trendData.datasets.æˆç´„æ•°,
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
              },
              {
                label: 'å¤±æ³¨',
                data: trendData.datasets.å¤±æ³¨æ•°,
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            scales: {
              y: { beginAtZero: true }
            },
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }

      // å£²ä¸Šãƒãƒ£ãƒ¼ãƒˆ
      const salesCtx = document.getElementById('trendSalesChart');
      if (salesCtx) {
        if (trendSalesChartInstance) {
          trendSalesChartInstance.destroy();
        }
        trendSalesChartInstance = new Chart(salesCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: trendData.labels,
            datasets: [{
              label: 'å£²ä¸Š',
              data: trendData.datasets.å£²ä¸Š,
              borderColor: 'rgba(74, 134, 232, 1)',
              backgroundColor: 'rgba(74, 134, 232, 0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString();
                  }
                }
              }
            },
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }
    }

    // ç›®æ¨™é€²æ—ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
    function loadGoalProgressRanking() {
      const now = new Date();
      const period = now.getFullYear() + '/' + String(now.getMonth() + 1).padStart(2, '0');

      google.script.run
        .withSuccessHandler(function(result) {
          const container = document.getElementById('goalProgressRanking');
          if (!container) return;

          if (result.error) {
            container.innerHTML = '<p class="no-data">' + result.error + '</p>';
            return;
          }

          if (!result.ranking || result.ranking.length === 0) {
            container.innerHTML = '<p class="no-data">' + (result.message || 'ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“') + '</p>';
            return;
          }

          let html = `
            <table class="data-table mini-table">
              <thead>
                <tr>
                  <th>é †ä½</th>
                  <th>æ‹…å½“è€…</th>
                  <th>å£²ä¸Šç›®æ¨™</th>
                  <th>å£²ä¸Šå®Ÿç¸¾</th>
                  <th>é”æˆç‡</th>
                </tr>
              </thead>
              <tbody>
          `;

          result.ranking.slice(0, 5).forEach((item) => {
            const progressColor = item.å£²ä¸Šé”æˆç‡ >= 100 ? '#28a745' :
                                  item.å£²ä¸Šé”æˆç‡ >= 80 ? '#ffc107' : '#dc3545';
            const medal = item.é †ä½ === 1 ? 'ğŸ¥‡' : item.é †ä½ === 2 ? 'ğŸ¥ˆ' : item.é †ä½ === 3 ? 'ğŸ¥‰' : item.é †ä½;

            html += `
              <tr>
                <td>${medal}</td>
                <td>${item.æ‹…å½“è€…å}</td>
                <td>$${item.å£²ä¸Šç›®æ¨™.toLocaleString()}</td>
                <td>$${item.å£²ä¸Šå®Ÿç¸¾.toLocaleString()}</td>
                <td style="color: ${progressColor}; font-weight: bold;">${item.å£²ä¸Šé”æˆç‡}%</td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          console.error('ç›®æ¨™é€²æ—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          const container = document.getElementById('goalProgressRanking');
          if (container) {
            container.innerHTML = '<p class="no-data">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
          }
        })
        .getGoalProgressRanking('æœˆæ¬¡', period);
    }

    function loadCSMetrics() {
      google.script.run
        .withSuccessHandler(function(metrics) {
          // CSãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨
          safeSetText('csTodayNew', metrics.todayNewLeads);
          safeSetText('csWaitingAssign', metrics.waitingAssign);
          safeSetText('csWeekAssigned', metrics.weekAssigned);
          safeSetText('csTotalLeads', metrics.totalLeads);

          // ãƒ•ãƒ«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰CSã‚¿ãƒ–ç”¨
          safeSetText('tabCsTodayNew', metrics.todayNewLeads);
          safeSetText('tabCsWaitingAssign', metrics.waitingAssign);
          safeSetText('tabCsWeekAssigned', metrics.weekAssigned);
          safeSetText('tabCsTotalLeads', metrics.totalLeads);
        })
        .withFailureHandler(function(error) {
          console.error('CSãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getCSMetrics();
    }

    function showDashboardTab(tabName) {
      // dashboard-fullå†…ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('#dashboard-full .dashboard-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // dashboard-fullå†…ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('#dashboard-full .dashboard-tab-content').forEach(content => {
        content.classList.toggle('active', content.id === 'tab-' + tabName);
      });
    }

    function initNavigation() {
      document.querySelectorAll('.sidebar-menu-item').forEach(link => {
        link.addEventListener('click', function() {
          const page = this.dataset.page;
          switchPage(page);
        });
      });
    }

    function switchPage(page) {
      // shift-submitã¯shiftãƒšãƒ¼ã‚¸ã«ãƒãƒƒãƒ”ãƒ³ã‚°
      const actualPage = (page === 'shift-submit') ? 'shift' : page;

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
      document.querySelectorAll('.sidebar-menu-item').forEach(link => {
        link.classList.toggle('active', link.dataset.page === page);
      });

      // ãƒšãƒ¼ã‚¸è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.page').forEach(p => {
        p.classList.toggle('active', p.id === 'page-' + actualPage);
      });

      // ç®¡ç†è€…è¨­å®šãƒšãƒ¼ã‚¸ã®å ´åˆã¯è¨­å®šã‚’èª­ã¿è¾¼ã¿
      if (actualPage === 'admin') {
        loadAdminSettings();
      }

      // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (actualPage === 'archive') {
        if (!cache.archive) {
          loadArchivedLeads();
        }
      }

      // æ‹…å½“è€…ç®¡ç†ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (page === 'staff') {
        loadStaffData();
      }

      // ã‚·ãƒ•ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (page === 'shift') {
        loadShiftPage();
      }

      // ãƒ¬ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (page === 'report') {
        loadReportPage();
      }

      // Buddyå£æ‰“ã¡ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (page === 'buddy-coaching') {
        // åˆæœŸåŒ–ï¼ˆç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼‰
        if (buddyCurrentMode === 'goal_setting') {
          loadBuddyGoalData();
        } else if (buddyCurrentMode === 'weekly_review') {
          loadBuddyWeeklyReports();
        }
      }

      // æ—¥å ±ãƒšãƒ¼ã‚¸ã®å ´åˆã¯åˆæœŸåŒ–
      if (page === 'daily-report') {
        initDailyReportPage();
      }

      // ãƒãƒ¼ãƒ æ—¥å ±ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å ´åˆã¯åˆæœŸåŒ–
      if (page === 'daily-report-history') {
        initTeamDailyReportPage();
      }
    }

    // ========== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ==========
    function showLoading() {
      safeSetStyle('loadingOverlay', 'display', 'flex');
    }

    function hideLoading() {
      safeSetStyle('loadingOverlay', 'display', 'none');
    }

    function loadAllData() {
      showLoading();

      let completed = 0;
      const total = 4;

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ30ç§’å¾Œã«å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºï¼‰
      var loadingTimeout = setTimeout(function() {
        console.warn('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        hideLoading();
      }, 30000);

      function checkComplete() {
        completed++;
        if (completed >= total) {
          clearTimeout(loadingTimeout);
          hideLoading();
          cache.lastUpdated = new Date();
          // KPIã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†å¾Œã«éåŒæœŸã§ï¼‰
          loadLeadsKPIs();
        }
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      google.script.run
        .withSuccessHandler(function(options) {
          try {
            cache.dropdownOptions = options || {};
            populateDropdowns();
          } catch (e) {
            console.error('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šã‚¨ãƒ©ãƒ¼:', e);
          }
          checkComplete();
        })
        .withFailureHandler(function(e) { console.error('getDropdownOptions ã‚¨ãƒ©ãƒ¼:', e); checkComplete(); })
        .getDropdownOptions();

      // ãƒªãƒ¼ãƒ‰ï¼ˆINï¼‰
      console.log('=== ãƒªãƒ¼ãƒ‰(IN) å–å¾—é–‹å§‹ ===');
      console.log('å‘¼ã³å‡ºã—: getLeads("lead", "ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰")');
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('=== ãƒªãƒ¼ãƒ‰(IN) å–å¾—æˆåŠŸ ===');
          console.log('è¿”å´ãƒ‡ãƒ¼ã‚¿å‹:', typeof data);
          console.log('è¿”å´ãƒ‡ãƒ¼ã‚¿ is array:', Array.isArray(data));
          console.log('ä»¶æ•°:', data ? data.length : 'null/undefined');
          if (data && data.length > 0) {
            console.log('æœ€åˆã®ãƒªãƒ¼ãƒ‰:', JSON.stringify(data[0]).substring(0, 500));
          }
          try {
            cache.leadsIn = data || [];
            cache.leadsInError = null;
            console.log('renderLeadsIn() å‘¼ã³å‡ºã—å‰');
            renderLeadsIn();
            console.log('renderLeadsIn() å‘¼ã³å‡ºã—å¾Œ');
            updateSidebarBadges();
            console.log('ãƒªãƒ¼ãƒ‰(IN) å‡¦ç†å®Œäº†');
          } catch (e) {
            console.error('ãƒªãƒ¼ãƒ‰(IN)æç”»ã‚¨ãƒ©ãƒ¼:', e);
            console.error('ã‚¹ã‚¿ãƒƒã‚¯:', e.stack);
            cache.leadsInError = e.message;
            renderLeadsInError(e.message);
          }
          checkComplete();
        })
        .withFailureHandler(function(e) {
          console.error('=== ãƒªãƒ¼ãƒ‰(IN) å–å¾—ã‚¨ãƒ©ãƒ¼ ===');
          console.error('ã‚¨ãƒ©ãƒ¼å†…å®¹:', e);
          console.error('ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:', typeof e);
          console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', JSON.stringify(e));
          cache.leadsIn = [];
          cache.leadsInError = e.message || e.toString() || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          renderLeadsInError(cache.leadsInError);
          checkComplete();
        })
        .getLeads('lead', 'ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰');

      // ãƒªãƒ¼ãƒ‰ï¼ˆOUTï¼‰
      google.script.run
        .withSuccessHandler(function(data) {
          try {
            cache.leadsOut = data || [];
            cache.leadsOutError = null;
            renderLeadsOut();
            updateSidebarBadges();
          } catch (e) {
            console.error('ãƒªãƒ¼ãƒ‰(OUT)æç”»ã‚¨ãƒ©ãƒ¼:', e);
            cache.leadsOutError = e.message;
            renderLeadsOutError(e.message);
          }
          checkComplete();
        })
        .withFailureHandler(function(e) {
          console.error('getLeads(OUT) ã‚¨ãƒ©ãƒ¼:', e);
          cache.leadsOut = [];
          cache.leadsOutError = e.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          renderLeadsOutError(cache.leadsOutError);
          checkComplete();
        })
        .getLeads('lead', 'ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰');

      // å•†è«‡
      google.script.run
        .withSuccessHandler(function(data) {
          try {
            cache.deals = data || [];
            renderDeals();
            updateSidebarBadges();
            updateKPIs();
          } catch (e) {
            console.error('å•†è«‡æç”»ã‚¨ãƒ©ãƒ¼:', e);
          }
          checkComplete();
        })
        .withFailureHandler(function(e) { console.error('getDeals ã‚¨ãƒ©ãƒ¼:', e); checkComplete(); })
        .getDeals();
    }

    // ãƒªãƒ¼ãƒ‰KPIã‚’èª­ã¿è¾¼ã¿
    function loadLeadsKPIs() {
      // ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰KPI
      google.script.run
        .withSuccessHandler(function(kpi) {
          if (kpi) {
            safeSetText('kpiInTotal', kpi.total);
            safeSetText('kpiInToday', kpi.todayNew);
            safeSetText('kpiInUnassigned', kpi.unassigned);
            safeSetText('kpiInProgress', kpi.inProgress);
          }
        })
        .withFailureHandler(function(e) {
          console.error('ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰KPIå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getLeadsKPI('ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰');

      // ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰KPI
      google.script.run
        .withSuccessHandler(function(kpi) {
          if (kpi) {
            safeSetText('kpiOutTotal', kpi.total);
            safeSetText('kpiOutToday', kpi.todayNew);
            safeSetText('kpiOutUnassigned', kpi.unassigned);
            safeSetText('kpiOutProgress', kpi.inProgress);
          }
        })
        .withFailureHandler(function(e) {
          console.error('ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰KPIå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getLeadsKPI('ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰');
    }

    function refreshAllData() {
      cache.leadsIn = null;
      cache.leadsOut = null;
      cache.deals = null;
      loadAllData();
    }

    // ========== KPIæ›´æ–° ==========
    function updateKPIs() {
      // nullãƒã‚§ãƒƒã‚¯ä»˜ãã§å€¤ã‚’è¨­å®š
      const setValue = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };

      const setHtml = (id, html) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      };

      const leadsInCount = cache.leadsIn ? cache.leadsIn.length : 0;
      const leadsOutCount = cache.leadsOut ? cache.leadsOut.length : 0;
      const dealsCount = cache.deals ? cache.deals.length : 0;

      setValue('kpiTotalLeads', leadsInCount + leadsOutCount);
      setValue('kpiActiveDeals', dealsCount);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ
      const statusCounts = {};
      let wonCount = 0;
      let lostCount = 0;

      if (cache.deals) {
        cache.deals.forEach(deal => {
          const status = deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] || 'ä¸æ˜';
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
      }

      setValue('kpiWonDeals', wonCount);
      const totalClosed = wonCount + lostCount;
      const convRate = totalClosed > 0 ? Math.round((wonCount / totalClosed) * 100) : 0;
      setValue('kpiConversionRate', convRate + '%');

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚µãƒãƒªãƒ¼
      let statusHtml = '';
      Object.entries(statusCounts).forEach(([status, count]) => {
        statusHtml += `
          <div class="kpi-card">
            <div class="kpi-value">${count}</div>
            <div class="kpi-label">${status}</div>
          </div>
        `;
      });
      setHtml('statusSummary', statusHtml || '<p>ãƒ‡ãƒ¼ã‚¿ãªã—</p>');
    }

    // ========== ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ ==========
    function populateDropdowns() {
      if (!cache.dropdownOptions) return;

      // æµå…¥çµŒè·¯ã¯ IN/OUT ã§åˆ†ã‘ã‚‹
      setOptions('selectChannelIn', cache.dropdownOptions['æµå…¥çµŒè·¯ï¼ˆINï¼‰'] || cache.dropdownOptions.æµå…¥çµŒè·¯ || []);
      setOptions('selectChannelOut', cache.dropdownOptions['æµå…¥çµŒè·¯ï¼ˆOUTï¼‰'] || cache.dropdownOptions.æµå…¥çµŒè·¯ || []);
      setOptions('selectCountry', cache.dropdownOptions.å›½ || []);
      setOptions('selectSns', cache.dropdownOptions['SNS/é€£çµ¡æ‰‹æ®µ'] || ['WhatsApp', 'ãƒ¡ãƒ¼ãƒ«', 'Instagram', 'Messenger', 'Telegram', 'X', 'Discord', 'LINE', 'ãã®ä»–']);
      setOptions('selectTemp', cache.dropdownOptions.æ¸©åº¦æ„Ÿ || []);
      setOptions('selectScale', cache.dropdownOptions.æƒ³å®šè¦æ¨¡ || []);
      setOptions('selectType', cache.dropdownOptions.é¡§å®¢ã‚¿ã‚¤ãƒ— || []);
      setOptions('selectSpeed', cache.dropdownOptions.è¿”ä¿¡é€Ÿåº¦ || []);
    }

    function setOptions(selectId, options) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    // ========== ã€Œãã®ä»–ã€é¸æŠå‡¦ç† ==========
    function handleOtherSelect(selectElement, detailDivId) {
      const detailDiv = document.getElementById(detailDivId);
      if (!detailDiv) return;

      if (selectElement.value === 'ãã®ä»–') {
        detailDiv.classList.add('visible');
      } else {
        detailDiv.classList.remove('visible');
        // è©³ç´°å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        const input = detailDiv.querySelector('input');
        if (input) input.value = '';
      }
    }

    function resetOtherDetails() {
      // ã™ã¹ã¦ã®ã€Œãã®ä»–ã€è©³ç´°å…¥åŠ›æ¬„ã‚’éè¡¨ç¤ºã«ã—ã¦ã‚¯ãƒªã‚¢
      document.querySelectorAll('.other-detail-input').forEach(div => {
        div.classList.remove('visible');
        const input = div.querySelector('input');
        if (input) input.value = '';
      });
    }

    function getOtherValue(selectId, inputId) {
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      if (!select || select.style.display === 'none') return null;
      if (select.value !== 'ãã®ä»–') return select.value;

      // ã€Œãã®ä»–ã€ã®å ´åˆ
      const detail = input ? input.value.trim() : '';
      if (!detail) {
        return { error: 'ãã®ä»–ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
      }
      return 'ãã®ä»–: ' + detail;
    }

    // ========== ãƒªãƒ¼ãƒ‰è¡¨ç¤º ==========
    function renderLeadsIn() {
      renderLeadsTable(cache.leadsIn, 'leadsInBody', 'leadInCount', 'in');
    }

    function renderLeadsOut() {
      renderLeadsTable(cache.leadsOut, 'leadsOutBody', 'leadOutCount', 'out');
    }

    function renderLeadsInError(errorMessage) {
      renderLeadsError('leadsInBody', 'leadInCount', 'in', errorMessage);
    }

    function renderLeadsOutError(errorMessage) {
      renderLeadsError('leadsOutBody', 'leadOutCount', 'out', errorMessage);
    }

    // ========== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¡¨ç¤º ==========
    function loadArchivedLeads() {
      google.script.run
        .withSuccessHandler(function(data) {
          cache.archive = data || [];
          renderArchive();
        })
        .withFailureHandler(function(e) {
          console.error('getArchivedLeads ã‚¨ãƒ©ãƒ¼:', e);
          document.getElementById('archiveBody').innerHTML =
            '<tr><td colspan="7" style="text-align:center; color:#dc3545;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
        })
        .getArchivedLeads();
    }

    let archiveSortState = { column: null, direction: 'asc' };

    function sortArchiveByHeader(column) {
      if (archiveSortState.column === column) {
        archiveSortState.direction = archiveSortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        archiveSortState.column = column;
        archiveSortState.direction = 'asc';
      }
      updateArchiveSortIndicators();
      filterArchive();
    }

    function updateArchiveSortIndicators() {
      const table = document.getElementById('archiveTable');
      if (!table) return;
      table.querySelectorAll('.sortable-header').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.column === archiveSortState.column) {
          th.classList.add(archiveSortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function renderArchive() {
      const tbody = document.getElementById('archiveBody');
      if (!tbody) return;
      const data = cache.archive || [];
      const reasonFilter = safeGetValue('archiveReasonFilter');
      const searchTerm = (document.getElementById('archiveSearchInput')?.value || '').toLowerCase();

      // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
      let filtered = data;
      if (reasonFilter) {
        filtered = filtered.filter(l => l['ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±'] === reasonFilter);
      }
      if (searchTerm) {
        filtered = filtered.filter(l => {
          const searchFields = [
            l['ãƒªãƒ¼ãƒ‰ID'], l['é¡§å®¢å'], l['å›½'], l['æµå…¥å…ƒ'], l['ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±'],
            l['CSãƒ¡ãƒ¢'], l['æ‹…å½“è€…'], l['CSæ‹…å½“è€…']
          ].filter(Boolean).map(f => f.toString().toLowerCase());
          return searchFields.some(f => f.includes(searchTerm));
        });
      }

      // ã‚½ãƒ¼ãƒˆé©ç”¨
      if (archiveSortState.column) {
        const columnMap = {
          leadId: 'ãƒªãƒ¼ãƒ‰ID',
          staff: 'æ‹…å½“è€…',
          customer: 'é¡§å®¢å',
          country: 'å›½',
          source: 'æµå…¥å…ƒ',
          dropReason: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±',
          dropDate: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ—¥',
          csStaff: 'CSæ‹…å½“è€…'
        };
        const colKey = columnMap[archiveSortState.column];
        if (colKey) {
          filtered.sort((a, b) => {
            let valA = a[colKey] || '';
            let valB = b[colKey] || '';
            if (archiveSortState.column === 'dropDate') {
              valA = valA ? new Date(valA).getTime() : 0;
              valB = valB ? new Date(valB).getTime() : 0;
            }
            if (valA < valB) return archiveSortState.direction === 'asc' ? -1 : 1;
            if (valA > valB) return archiveSortState.direction === 'asc' ? 1 : -1;
            return 0;
          });
        }
      }

      safeSetText('archiveCount', filtered.length);

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="no-data">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      let html = '';
      filtered.forEach(lead => {
        const leadId = lead['ãƒªãƒ¼ãƒ‰ID'] || '';
        const staff = lead['æ‹…å½“è€…'] || '-';
        const customerName = lead['é¡§å®¢å'] || '(ä¸æ˜)';
        const country = lead['å›½'] || '-';
        const source = lead['æµå…¥å…ƒ'] || '-';
        const dropReason = lead['ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±'] || '-';
        const csMemo = lead['CSãƒ¡ãƒ¢'] || '';
        const csMemoDisplay = csMemo.length > 20 ? csMemo.substring(0, 20) + '...' : csMemo;
        const dropDate = lead['ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ—¥'] ? formatDate(lead['ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ—¥']) : '-';
        const csStaff = lead['CSæ‹…å½“è€…'] || '-';

        html += `
          <tr>
            <td>${leadId}</td>
            <td>${staff}</td>
            <td>${customerName}</td>
            <td>${country}</td>
            <td>${source}</td>
            <td>${dropReason}</td>
            <td title="${csMemo.replace(/"/g, '&quot;')}">${csMemoDisplay || '-'}</td>
            <td>${dropDate}</td>
            <td>${csStaff}</td>
            <td>
              <button class="btn-action btn-action-blue" onclick="openRestoreModal('${leadId}', '${customerName.replace(/'/g, "\\'")}')">ãƒªãƒ¼ãƒ‰ã«æˆ»ã™</button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    function filterArchive() {
      renderArchive();
    }

    function openRestoreModal(leadId, customerName) {
      safeSetValue('restoreLeadId', leadId);
      safeSetText('restoreCustomerName', customerName);
      safeSetValue('restoreLeadTypeSelect', '');
      const modal = document.getElementById('restoreModal');
      if (modal) modal.classList.add('active');
    }

    function closeRestoreModal() {
      const modal = document.getElementById('restoreModal');
      if (modal) modal.classList.remove('active');
    }

    function confirmRestore() {
      const leadId = safeGetValue('restoreLeadId');
      const leadType = safeGetValue('restoreLeadTypeSelect');

      if (!leadType) {
        showToastWarning('ãƒªãƒ¼ãƒ‰ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('ãƒªãƒ¼ãƒ‰ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            closeRestoreModal();
            loadArchivedLeads();
            // ãƒªãƒ¼ãƒ‰ä¸€è¦§ã‚‚æ›´æ–°
            refreshAllData();
          } else {
            showToastError('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(e) {
          showToastError('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        })
        .restoreLeadFromArchive(leadId, leadType);
    }

    function renderLeadsError(tbodyId, countId, type, errorMessage) {
      const tbody = document.getElementById(tbodyId);
      const countEl = document.getElementById(countId);
      if (countEl) {
        countEl.textContent = '!';
      }
      tbody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align:center; padding:40px;">
            <div style="color: #dc3545; margin-bottom: 16px;">
              <strong>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</strong>
            </div>
            <div style="color: #666; font-size: 12px; margin-bottom: 16px;">
              ${errorMessage || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}
            </div>
            <button class="btn btn-primary" onclick="retryLoadLeads('${type}')">
              å†èª­ã¿è¾¼ã¿
            </button>
          </td>
        </tr>
      `;
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šgetLeadså‹•ä½œãƒ†ã‚¹ãƒˆ
    function debugLeadsData() {
      console.log('=== ãƒ‡ãƒãƒƒã‚°: è¨ºæ–­é–‹å§‹ ===');
      let results = {};

      // Step 1: ã‚·ãƒ³ãƒ—ãƒ«ãªé…åˆ—ã‚’è¿”ã™ãƒ†ã‚¹ãƒˆ
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('è¨ºæ–­1 (ã‚·ãƒ³ãƒ—ãƒ«é…åˆ—):', result);
          results.test1 = Array.isArray(result) && result.length === 3 ? 'OK' : 'FAIL';

          // Step 2: ç›´æ¥getLeadså‘¼ã³å‡ºã—ï¼ˆloadAllDataã¨åŒã˜æ–¹æ³•ï¼‰
          google.script.run
            .withSuccessHandler(function(data) {
              console.log('è¨ºæ–­2 (ç›´æ¥getLeads):', data);
              results.test2_type = typeof data;
              results.test2_isArray = Array.isArray(data);
              results.test2_length = data ? data.length : 'null';
              results.test2_status = (Array.isArray(data)) ? 'OK' : 'FAIL';

              // Step 3: è¨ºæ–­é–¢æ•°çµŒç”±ã§getLeads
              google.script.run
                .withSuccessHandler(function(diag) {
                  console.log('è¨ºæ–­3 (è¨ºæ–­é–¢æ•°çµŒç”±):', diag);
                  results.test3 = diag.step6_result;

                  // çµæœè¡¨ç¤ºï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°å‡ºåŠ›ï¼‰
                  console.log('ã€è¨ºæ–­çµæœã€‘', results);
                  if (results.test2_status === 'OK') {
                    showToast('è¨ºæ–­å®Œäº†: getLeadsã¯æ­£å¸¸ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                  } else {
                    showToastError('è¨ºæ–­å®Œäº†: getLeadsã«å•é¡Œã‚ã‚Šã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                  }
                })
                .withFailureHandler(function(e) {
                  console.error('è¨ºæ–­3ã‚¨ãƒ©ãƒ¼:', e);
                  showToastError('è¨ºæ–­3ã‚¨ãƒ©ãƒ¼: ' + (e.message || JSON.stringify(e)));
                })
                .diagnosticGetLeadsSteps();
            })
            .withFailureHandler(function(e) {
              console.error('è¨ºæ–­2ã‚¨ãƒ©ãƒ¼:', e);
              results.test2_status = 'ERROR: ' + (e.message || JSON.stringify(e));
              showToastError('è¨ºæ–­2ã‚¨ãƒ©ãƒ¼: ' + (e.message || JSON.stringify(e)));
            })
            .getLeads('lead', 'ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰');
        })
        .withFailureHandler(function(e) {
          console.error('è¨ºæ–­1ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('è¨ºæ–­1ã‚¨ãƒ©ãƒ¼: ' + (e.message || JSON.stringify(e)));
        })
        .diagnosticSimpleArray();
    }

    // æ‰‹å‹•ã§ãƒªãƒ¼ãƒ‰(IN)ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œã®æ¤œè¨¼ç”¨ï¼‰
    function manualLoadLeadsIn() {
      console.log('=== æ‰‹å‹•èª­è¾¼: getLeadså‘¼ã³å‡ºã—é–‹å§‹ ===');
      console.log('ç¾åœ¨æ™‚åˆ»:', new Date().toISOString());
      console.log('currentUser:', currentUser);

      google.script.run
        .withSuccessHandler(function(data) {
          console.log('=== æ‰‹å‹•èª­è¾¼: æˆåŠŸ ===');
          console.log('è¿”å´ãƒ‡ãƒ¼ã‚¿å‹:', typeof data);
          console.log('é…åˆ—ã‹:', Array.isArray(data));
          console.log('ä»¶æ•°:', data ? data.length : 'null/undefined');
          console.log('ãƒ‡ãƒ¼ã‚¿:', data);

          if (Array.isArray(data)) {
            cache.leadsIn = data;
            cache.leadsInError = null;
            renderLeadsIn();
            updateSidebarBadges();
            showToast('æ‰‹å‹•èª­è¾¼æˆåŠŸ: ' + data.length + 'ä»¶ã®ãƒªãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¾ã—ãŸ');
          } else {
            console.error('æ‰‹å‹•èª­è¾¼: ãƒ‡ãƒ¼ã‚¿ãŒnull/é…åˆ—ä»¥å¤–ã§ã™', { type: typeof data, value: data });
            showToastError('æ‰‹å‹•èª­è¾¼: ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
          }
        })
        .withFailureHandler(function(e) {
          console.error('=== æ‰‹å‹•èª­è¾¼: ã‚¨ãƒ©ãƒ¼ ===');
          console.error('ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('æ‰‹å‹•èª­è¾¼ã‚¨ãƒ©ãƒ¼: ' + (e.message || JSON.stringify(e)));
        })
        .getLeads('lead', 'ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰');
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ•ã‚£ãƒ«ã‚¿ãªã—ã§å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    function debugAllLeadsData() {
      console.log('=== ãƒ‡ãƒãƒƒã‚°: å…¨ãƒªãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾— ===');
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ã€ãƒ‡ãƒãƒƒã‚°çµæœã€‘', result);
          console.table(result.stats);
          console.log('ãƒ˜ãƒƒãƒ€ãƒ¼ä½ç½®:', result.headerIndexes);
          console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿:', result.sampleLeads);
          showToast('ãƒ‡ãƒãƒƒã‚°å®Œäº†: ç·ä»¶æ•° ' + result.stats.total + 'ä»¶ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ç¢ºèªï¼‰');
        })
        .withFailureHandler(function(e) {
          console.error('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .getAllLeadsNoFilter();
    }

    function retryLoadLeads(type) {
      const leadType = type === 'in' ? 'ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰' : 'ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰';
      const tbodyId = type === 'in' ? 'leadsInBody' : 'leadsOutBody';
      const countId = type === 'in' ? 'leadInCount' : 'leadOutCount';

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      document.getElementById(tbodyId).innerHTML = '<tr><td colspan="9" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';

      google.script.run
        .withSuccessHandler(function(data) {
          if (type === 'in') {
            cache.leadsIn = data || [];
            cache.leadsInError = null;
            renderLeadsIn();
          } else {
            cache.leadsOut = data || [];
            cache.leadsOutError = null;
            renderLeadsOut();
          }
          updateSidebarBadges();
        })
        .withFailureHandler(function(e) {
          console.error('retryLoadLeads ã‚¨ãƒ©ãƒ¼:', e);
          if (type === 'in') {
            cache.leadsInError = e.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
            renderLeadsInError(cache.leadsInError);
          } else {
            cache.leadsOutError = e.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
            renderLeadsOutError(cache.leadsOutError);
          }
        })
        .getLeads('lead', leadType);
    }

    function renderLeadsTable(leads, tbodyId, countId, type) {
      console.log('[renderLeadsTable] START: tbodyId=' + tbodyId + ', countId=' + countId + ', type=' + type);
      console.log('[renderLeadsTable] leads:', leads);
      console.log('[renderLeadsTable] leads type:', typeof leads);
      console.log('[renderLeadsTable] leads is array:', Array.isArray(leads));
      console.log('[renderLeadsTable] leads count:', leads ? leads.length : 'null/undefined');

      try {
        const tbody = document.getElementById(tbodyId);
        const countEl = document.getElementById(countId);

        console.log('[renderLeadsTable] tbody element:', tbody);
        console.log('[renderLeadsTable] countEl element:', countEl);

        if (!tbody) {
          console.error('[renderLeadsTable] ERROR: tbodyè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', tbodyId);
          return;
        }

        if (countEl) {
          countEl.textContent = leads ? leads.length : 0;
        }

        if (!leads || leads.length === 0) {
          console.log('[renderLeadsTable] ãƒ‡ãƒ¼ã‚¿ãªã— - "ãƒªãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“" ã‚’è¡¨ç¤º');
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px;">ãƒªãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
          return;
        }

        console.log('[renderLeadsTable] ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š - ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–‹å§‹');
        if (leads.length > 0) {
          console.log('[renderLeadsTable] æœ€åˆã®ãƒªãƒ¼ãƒ‰:', JSON.stringify(leads[0]).substring(0, 500));
        }

        let html = '';
        leads.forEach(function(lead, index) {
          try {
            const updateDate = lead['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥'] ? formatDate(lead['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥']) : '-';
            const leadId = lead['ãƒªãƒ¼ãƒ‰ID'] || '';
            const customerName = (lead['é¡§å®¢å'] || '-').replace(/'/g, "\\'");
            const source = lead['æµå…¥çµŒè·¯'] || '-';
            const messageUrl = (lead['ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL'] || '').replace(/'/g, "\\'");
            const duplicateFlag = lead['é‡è¤‡ãƒ•ãƒ©ã‚°'] === true || lead['é‡è¤‡ãƒ•ãƒ©ã‚°'] === 'TRUE';
            const warningBtn = duplicateFlag
              ? `<button class="warning-btn" onclick="event.stopPropagation(); showDuplicateWarning('${leadId}')" title="éå»ã«å•ã„åˆã‚ã›å±¥æ­´ãŒã‚ã‚Šã¾ã™">âš ï¸</button>`
              : '';

            html += `
              <tr>
                <td onclick="openLeadDetail('${leadId}', '${type}')" style="cursor: pointer;">
                  ${warningBtn}${updateDate}
                </td>
                <td onclick="openLeadDetail('${leadId}', '${type}')" style="cursor: pointer;">${customerName}</td>
                <td onclick="openLeadDetail('${leadId}', '${type}')" style="cursor: pointer;">${source}</td>
                <td>
                  <div class="lead-action-buttons">
                    <button class="lead-action-btn btn-primary" onclick="openMessageBox('${messageUrl}')" title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Boxã‚’é–‹ã">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
                    <button class="lead-action-btn btn-warning" onclick="openAssignModal('${leadId}', '${customerName}', '${type}')" title="æ‹…å½“è€…ã‚’ã‚¢ã‚µã‚¤ãƒ³">ã‚¢ã‚µã‚¤ãƒ³</button>
                    <button class="lead-action-btn btn-secondary" onclick="openArchiveModal('${leadId}', '${customerName}', '${type}')" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
                  </div>
                </td>
              </tr>
            `;
          } catch (rowError) {
            console.error('[renderLeadsTable] è¡Œ' + index + 'ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', rowError);
            console.error('[renderLeadsTable] å•é¡Œã®ãƒªãƒ¼ãƒ‰:', lead);
          }
        });

        tbody.innerHTML = html;
        console.log('[renderLeadsTable] ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº†: ' + leads.length + 'è¡Œ');
      } catch (e) {
        console.error('[renderLeadsTable] ERROR:', e);
        console.error('[renderLeadsTable] Stack:', e.stack);
      }
    }

    // ========== ãƒªãƒ¼ãƒ‰æ¤œç´¢ãƒ»ä¸¦ã¹æ›¿ãˆ ==========
    // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    var leadsOriginalIn = [];
    var leadsOriginalOut = [];

    function filterLeads(type) {
      const searchInput = document.getElementById('search-leads-' + type);
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

      // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      let leads;
      if (type === 'in') {
        if (leadsOriginalIn.length === 0 && cache.leadsIn) {
          leadsOriginalIn = [...cache.leadsIn];
        }
        leads = leadsOriginalIn;
      } else {
        if (leadsOriginalOut.length === 0 && cache.leadsOut) {
          leadsOriginalOut = [...cache.leadsOut];
        }
        leads = leadsOriginalOut;
      }

      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
      let filtered = leads;
      if (searchTerm) {
        filtered = leads.filter(function(lead) {
          const customerName = (lead['é¡§å®¢å'] || '').toLowerCase();
          const leadId = (lead['ãƒªãƒ¼ãƒ‰ID'] || '').toLowerCase();
          return customerName.includes(searchTerm) || leadId.includes(searchTerm);
        });
      }

      // ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆé †ã‚’å–å¾—ã—ã¦é©ç”¨
      const sortSelect = document.getElementById('sort-leads-' + type);
      const sortBy = sortSelect ? sortSelect.value : 'date-desc';
      filtered = applySortToLeads(filtered, sortBy);

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
      const tbodyId = type === 'in' ? 'leadsInBody' : 'leadsOutBody';
      const countId = type === 'in' ? 'leadInCount' : 'leadOutCount';
      renderLeadsTableFiltered(filtered, tbodyId, countId, type);
    }

    function sortLeads(type, sortBy) {
      // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      let leads;
      if (type === 'in') {
        if (leadsOriginalIn.length === 0 && cache.leadsIn) {
          leadsOriginalIn = [...cache.leadsIn];
        }
        leads = leadsOriginalIn;
      } else {
        if (leadsOriginalOut.length === 0 && cache.leadsOut) {
          leadsOriginalOut = [...cache.leadsOut];
        }
        leads = leadsOriginalOut;
      }

      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
      const searchInput = document.getElementById('search-leads-' + type);
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      let filtered = leads;
      if (searchTerm) {
        filtered = leads.filter(function(lead) {
          const customerName = (lead['é¡§å®¢å'] || '').toLowerCase();
          const leadId = (lead['ãƒªãƒ¼ãƒ‰ID'] || '').toLowerCase();
          return customerName.includes(searchTerm) || leadId.includes(searchTerm);
        });
      }

      // ã‚½ãƒ¼ãƒˆé©ç”¨
      const sorted = applySortToLeads(filtered, sortBy);

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
      const tbodyId = type === 'in' ? 'leadsInBody' : 'leadsOutBody';
      const countId = type === 'in' ? 'leadInCount' : 'leadOutCount';
      renderLeadsTableFiltered(sorted, tbodyId, countId, type);
    }

    function applySortToLeads(leads, sortBy) {
      if (!leads) return [];
      var sorted = [...leads];

      switch(sortBy) {
        case 'date-desc':
          sorted.sort(function(a, b) {
            const dateA = new Date(a['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥'] || 0);
            const dateB = new Date(b['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥'] || 0);
            return dateB - dateA;
          });
          break;
        case 'date-asc':
          sorted.sort(function(a, b) {
            const dateA = new Date(a['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥'] || 0);
            const dateB = new Date(b['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥'] || 0);
            return dateA - dateB;
          });
          break;
        case 'alpha':
          sorted.sort(function(a, b) {
            const nameA = (a['é¡§å®¢å'] || '').toLowerCase();
            const nameB = (b['é¡§å®¢å'] || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
          break;
        case 'source':
          sorted.sort(function(a, b) {
            const srcA = (a['æµå…¥çµŒè·¯'] || '').toLowerCase();
            const srcB = (b['æµå…¥çµŒè·¯'] || '').toLowerCase();
            return srcA.localeCompare(srcB);
          });
          break;
      }

      return sorted;
    }

    function renderLeadsTableFiltered(leads, tbodyId, countId, type) {
      const tbody = document.getElementById(tbodyId);
      document.getElementById(countId).textContent = leads ? leads.length : 0;

      if (!leads || leads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px;">è©²å½“ã™ã‚‹ãƒªãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      let html = '';
      leads.forEach(function(lead) {
        const updateDate = lead['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥'] ? formatDate(lead['ã‚·ãƒ¼ãƒˆæ›´æ–°æ—¥']) : '-';
        const leadId = lead['ãƒªãƒ¼ãƒ‰ID'] || '';
        const customerName = lead['é¡§å®¢å'] || '-';
        const source = lead['æµå…¥çµŒè·¯'] || '-';
        const messageUrl = lead['ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL'] || '';
        const duplicateFlag = lead['é‡è¤‡ãƒ•ãƒ©ã‚°'] === true || lead['é‡è¤‡ãƒ•ãƒ©ã‚°'] === 'TRUE';
        const warningBtn = duplicateFlag
          ? `<button class="warning-btn" onclick="event.stopPropagation(); showDuplicateWarning('${leadId}')" title="éå»ã«å•ã„åˆã‚ã›å±¥æ­´ãŒã‚ã‚Šã¾ã™">âš ï¸</button>`
          : '';

        html += `
          <tr>
            <td onclick="openLeadDetail('${leadId}', '${type}')" style="cursor: pointer;">
              ${warningBtn}${updateDate}
            </td>
            <td onclick="openLeadDetail('${leadId}', '${type}')" style="cursor: pointer;">${customerName}</td>
            <td onclick="openLeadDetail('${leadId}', '${type}')" style="cursor: pointer;">${source}</td>
            <td>
              <div class="lead-action-buttons">
                <button class="lead-action-btn btn-primary" onclick="openMessageBox('${messageUrl}')" title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Boxã‚’é–‹ã">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
                <button class="lead-action-btn btn-warning" onclick="openAssignModal('${leadId}', '${customerName}', '${type}')" title="æ‹…å½“è€…ã‚’ã‚¢ã‚µã‚¤ãƒ³">ã‚¢ã‚µã‚¤ãƒ³</button>
                <button class="lead-action-btn btn-secondary" onclick="openArchiveModal('${leadId}', '${customerName}', '${type}')" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
              </div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å‘¼ã¶ï¼‰
    function initLeadsOriginalData() {
      if (cache.leadsIn && cache.leadsIn.length > 0) {
        leadsOriginalIn = [...cache.leadsIn];
      }
      if (cache.leadsOut && cache.leadsOut.length > 0) {
        leadsOriginalOut = [...cache.leadsOut];
      }
    }

    // ========== å•†è«‡è¡¨ç¤º ==========
    let dealSortState = { column: null, direction: 'asc' };

    function renderDeals() {
      filterDeals();
    }

    function filterDeals() {
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      const searchFilter = (document.getElementById('filterSearch')?.value || '').toLowerCase();

      let filtered = cache.deals || [];

      if (statusFilter) {
        filtered = filtered.filter(d => d['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === statusFilter);
      }

      if (searchFilter) {
        filtered = filtered.filter(d =>
          (d['é¡§å®¢å'] || '').toLowerCase().includes(searchFilter) ||
          (d['ãƒªãƒ¼ãƒ‰ID'] || '').toLowerCase().includes(searchFilter)
        );
      }

      // ã‚½ãƒ¼ãƒˆé©ç”¨
      if (dealSortState.column) {
        filtered = sortDealsArray(filtered, dealSortState.column, dealSortState.direction);
      }

      const tbody = document.getElementById('dealsBody');
      safeSetText('dealCount', filtered.length);

      if (!tbody) return;

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px;">å•†è«‡ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      let html = '';
      filtered.forEach(deal => {
        const leadId = deal['ãƒªãƒ¼ãƒ‰ID'] || '-';
        const messageUrl = deal['ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL'] || '';

        html += `
          <tr style="cursor: pointer;">
            <td onclick="openDealSlidePanel('${leadId}')">${leadId}</td>
            <td onclick="openDealSlidePanel('${leadId}')">${deal['æ‹…å½“è€…'] || '-'}</td>
            <td onclick="openDealSlidePanel('${leadId}')">${deal['é¡§å®¢å'] || '-'}</td>
            <td onclick="openDealSlidePanel('${leadId}')">${deal['å›½'] || '-'}</td>
            <td onclick="openDealSlidePanel('${leadId}')">${deal['æµå…¥çµŒè·¯'] || '-'}</td>
            <td onclick="openDealSlidePanel('${leadId}')">${deal['å–ã‚Šæ‰±ã„ã‚¿ã‚¤ãƒˆãƒ«'] || '-'}</td>
            <td onclick="openDealSlidePanel('${leadId}')">${deal['è²©å£²å½¢æ…‹'] || '-'}</td>
            <td onclick="openDealSlidePanel('${leadId}')"><span class="badge badge-b">${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] || '-'}</span></td>
            <td onclick="openDealSlidePanel('${leadId}')">${deal['å•†è«‡çµæœ'] || '-'}</td>
            <td><button class="btn-message-sm" onclick="openMessageBox('${messageUrl}')" title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–‹ã">ğŸ“©</button></td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    function sortDealsArray(deals, column, direction) {
      const columnMap = {
        'leadId': 'ãƒªãƒ¼ãƒ‰ID',
        'staff': 'æ‹…å½“è€…',
        'customer': 'é¡§å®¢å',
        'country': 'å›½',
        'source': 'æµå…¥çµŒè·¯',
        'title': 'å–ã‚Šæ‰±ã„ã‚¿ã‚¤ãƒˆãƒ«',
        'type': 'è²©å£²å½¢æ…‹',
        'status': 'é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
        'result': 'å•†è«‡çµæœ'
      };

      const key = columnMap[column];
      if (!key) return deals;

      return [...deals].sort((a, b) => {
        const valA = (a[key] || '').toString().toLowerCase();
        const valB = (b[key] || '').toString().toLowerCase();
        if (direction === 'asc') {
          return valA.localeCompare(valB, 'ja');
        } else {
          return valB.localeCompare(valA, 'ja');
        }
      });
    }

    function sortDealsByHeader(column) {
      if (dealSortState.column === column) {
        dealSortState.direction = dealSortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        dealSortState.column = column;
        dealSortState.direction = 'asc';
      }

      updateDealSortIndicators();
      filterDeals();
    }

    function updateDealSortIndicators() {
      document.querySelectorAll('#dealsTable .sortable-header').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
      });

      if (dealSortState.column) {
        const activeHeader = document.querySelector(`#dealsTable [data-column="${dealSortState.column}"]`);
        if (activeHeader) {
          activeHeader.classList.add(`sort-${dealSortState.direction}`);
        }
      }
    }

    // å•†è«‡è©³ç´°ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ãƒãƒ«
    let currentSlideDeal = null;
    let currentSlideTab = 'detail';

    function openDealSlidePanel(leadId, initialTab) {
      const deal = (cache.deals || []).find(d => d['ãƒªãƒ¼ãƒ‰ID'] === leadId);
      if (!deal) {
        showToastWarning('å•†è«‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      currentSlideDeal = deal;
      currentSlideTab = initialTab || 'detail';

      // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
      safeSetText('dealSlideTitle', 'å•†è«‡è©³ç´°: ' + (deal['é¡§å®¢å'] || '-'));

      // è©³ç´°ã‚¿ãƒ–ã®å†…å®¹ã‚’è¨­å®š
      renderDetailTab(deal);

      // æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
      initNextActionDateDropdown(deal);

      // ä¼šè©±ã‚¿ãƒ–ã®å†…å®¹ã‚’è¨­å®š
      renderConversationTab(deal);

      // ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–ã®å†…å®¹ã‚’è¨­å®š
      renderReportTab(deal);

      // ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
      switchDealSlideTab(currentSlideTab);

      // ã€Œå¯¾å¿œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
      const btnStartResponse = document.getElementById('btnStartResponse');
      if (btnStartResponse) {
        // é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œã‚¢ã‚µã‚¤ãƒ³ç¢ºå®šã€ã®å ´åˆã®ã¿è¡¨ç¤º
        const progressStatus = deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] || '';
        if (progressStatus === 'ã‚¢ã‚µã‚¤ãƒ³ç¢ºå®š') {
          btnStartResponse.style.display = 'inline-block';
        } else {
          btnStartResponse.style.display = 'none';
        }
      }

      const overlay = document.getElementById('dealSlideOverlay');
      const panel = document.getElementById('dealSlidePanel');
      if (overlay) overlay.classList.add('show');
      if (panel) panel.classList.add('open');
    }

    /**
     * ã€Œå¯¾å¿œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç† - é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œå•†è«‡ä¸­ã€ã«å¤‰æ›´
     */
    function startDealResponseFromSlide() {
      if (!currentSlideDeal) {
        showToast('æ¡ˆä»¶ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      const leadId = currentSlideDeal['ãƒªãƒ¼ãƒ‰ID'];
      if (!leadId) {
        showToast('ãƒªãƒ¼ãƒ‰IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      if (!confirm('ã“ã®æ¡ˆä»¶ã®å¯¾å¿œã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå•†è«‡ä¸­ã€ã«å¤‰æ›´ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          showToast('å¯¾å¿œã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
          // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          const btn = document.getElementById('btnStartResponse');
          if (btn) btn.style.display = 'none';
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
          currentSlideDeal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] = 'å•†è«‡ä¸­';
          // å•†è«‡ä¸€è¦§ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
          loadDeals();
        })
        .withFailureHandler(function(e) {
          hideLoading();
          showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        })
        .startDealResponse(leadId);
    }

    function renderDetailTab(deal) {
      const detailTab = document.getElementById('tabDetail');
      if (!detailTab) return;
      detailTab.innerHTML = `
        <form id="dealSlideForm">
          <input type="hidden" id="slideLeadId" value="${deal['ãƒªãƒ¼ãƒ‰ID']}">

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">é¡§å®¢å</label>
            <div style="font-weight: 500; padding: 8px 0;">${deal['é¡§å®¢å'] || '-'}</div>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">æ‹…å½“è€…</label>
            <div style="font-weight: 500; padding: 8px 0;">${deal['æ‹…å½“è€…'] || '-'}</div>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select class="form-select" id="slideDealStatus">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="æ–°è¦" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'æ–°è¦' ? 'selected' : ''}>æ–°è¦</option>
              <option value="å¯¾å¿œä¸­" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'å¯¾å¿œä¸­' ? 'selected' : ''}>å¯¾å¿œä¸­</option>
              <option value="ã‚¢ã‚µã‚¤ãƒ³ç¢ºå®š" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'ã‚¢ã‚µã‚¤ãƒ³ç¢ºå®š' ? 'selected' : ''}>ã‚¢ã‚µã‚¤ãƒ³ç¢ºå®š</option>
              <option value="å•†è«‡ä¸­" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'å•†è«‡ä¸­' ? 'selected' : ''}>å•†è«‡ä¸­</option>
              <option value="è¦‹ç©ã‚‚ã‚Šæç¤º" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'è¦‹ç©ã‚‚ã‚Šæç¤º' ? 'selected' : ''}>è¦‹ç©ã‚‚ã‚Šæç¤º</option>
              <option value="æˆç´„" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'æˆç´„' ? 'selected' : ''}>æˆç´„</option>
              <option value="å¤±æ³¨" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'å¤±æ³¨' ? 'selected' : ''}>å¤±æ³¨</option>
              <option value="è¿½å®¢" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'è¿½å®¢' ? 'selected' : ''}>è¿½å®¢</option>
              <option value="å¯¾è±¡å¤–" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'å¯¾è±¡å¤–' ? 'selected' : ''}>å¯¾è±¡å¤–</option>
              <option value="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–" ${deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' ? 'selected' : ''}>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
            <input type="text" class="form-input" id="slideNextAction" value="${escapeHtml(deal['æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'] || '')}">
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥</label>
            <select class="form-select" id="slideNextActionDateSelect" onchange="handleNextActionDateSelect(this.value)">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="waiting_reply">ç›¸æ‰‹ã®è¿”ä¿¡ãŒå±Šãæ¬¡ç¬¬</option>
              <option value="waiting_confirm">ä¸æ˜ç‚¹ã®ç¢ºèªãŒå®Œäº†æ¬¡ç¬¬</option>
              <option value="today">æœ¬æ—¥ä¸­</option>
              <option value="tomorrow">æ˜æ—¥</option>
              <option value="2days">2æ—¥å¾Œ</option>
              <option value="3days">3æ—¥å¾Œ</option>
              <option value="7days">7æ—¥å¾Œ</option>
              <option value="weekend">é€±æœ«</option>
              <option value="custom">æ—¥ä»˜å…¥åŠ›</option>
            </select>
            <input type="date" class="form-input" id="slideNextActionDateCustom" style="display: none; margin-top: 8px;" value="${formatDateForInput(deal['æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥'])}">
            <input type="hidden" id="slideNextActionDate" value="${formatDateForInput(deal['æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥'])}">
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">å•†è«‡ãƒ¡ãƒ¢</label>
            <textarea class="form-textarea" id="slideDealMemo" rows="3">${escapeHtml(deal['å•†è«‡ãƒ¡ãƒ¢'] || '')}</textarea>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">å–ã‚Šæ‰±ã„ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" class="form-input" id="slideTitle" value="${escapeHtml(deal['å–ã‚Šæ‰±ã„ã‚¿ã‚¤ãƒˆãƒ«'] || '')}">
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">è²©å£²å½¢æ…‹</label>
            <select class="form-select" id="slideSaleType">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å®Ÿåº—èˆ—" ${deal['è²©å£²å½¢æ…‹'] === 'å®Ÿåº—èˆ—' ? 'selected' : ''}>å®Ÿåº—èˆ—</option>
              <option value="EC" ${deal['è²©å£²å½¢æ…‹'] === 'EC' ? 'selected' : ''}>EC</option>
              <option value="ãƒ©ã‚¤ãƒ–é…ä¿¡" ${deal['è²©å£²å½¢æ…‹'] === 'ãƒ©ã‚¤ãƒ–é…ä¿¡' ? 'selected' : ''}>ãƒ©ã‚¤ãƒ–é…ä¿¡</option>
              <option value="è¤‡åˆ" ${deal['è²©å£²å½¢æ…‹'] === 'è¤‡åˆ' ? 'selected' : ''}>è¤‡åˆ</option>
              <option value="ä¸æ˜" ${deal['è²©å£²å½¢æ…‹'] === 'ä¸æ˜' ? 'selected' : ''}>ä¸æ˜</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">æœˆé–“è¦‹è¾¼ã¿é‡‘é¡</label>
            <input type="number" class="form-input" id="slideAmount" value="${deal['æœˆé–“è¦‹è¾¼ã¿é‡‘é¡'] || ''}">
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ç«¶åˆæ¯”è¼ƒä¸­</label>
            <select class="form-select" id="slideCompeting">
              <option value="">-</option>
              <option value="ã¯ã„" ${deal['ç«¶åˆæ¯”è¼ƒä¸­'] === 'ã¯ã„' ? 'selected' : ''}>ã¯ã„</option>
              <option value="ã„ã„ãˆ" ${deal['ç«¶åˆæ¯”è¼ƒä¸­'] === 'ã„ã„ãˆ' ? 'selected' : ''}>ã„ã„ãˆ</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">å•†è«‡çµæœ</label>
            <select class="form-select" id="slideResult">
              <option value="">-</option>
              <option value="æˆç´„" ${deal['å•†è«‡çµæœ'] === 'æˆç´„' ? 'selected' : ''}>æˆç´„</option>
              <option value="å¤±æ³¨" ${deal['å•†è«‡çµæœ'] === 'å¤±æ³¨' ? 'selected' : ''}>å¤±æ³¨</option>
              <option value="è¿½å®¢" ${deal['å•†è«‡çµæœ'] === 'è¿½å®¢' ? 'selected' : ''}>è¿½å®¢</option>
              <option value="è¦‹é€ã‚Š" ${deal['å•†è«‡çµæœ'] === 'è¦‹é€ã‚Š' ? 'selected' : ''}>è¦‹é€ã‚Š</option>
              <option value="å¯¾è±¡å¤–" ${deal['å•†è«‡çµæœ'] === 'å¯¾è±¡å¤–' ? 'selected' : ''}>å¯¾è±¡å¤–</option>
            </select>
          </div>
        </form>
      `;
    }

    function renderConversationTab(deal) {
      // ä¼šè©±è¦ç´„ã‚’ãƒªãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
      const summary = deal['ä¼šè©±è¦ç´„'] || 'ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“';
      const lastDate = deal['æœ€çµ‚ä¼šè©±æ—¥æ™‚'] ? formatDateTime(deal['æœ€çµ‚ä¼šè©±æ—¥æ™‚']) : '-';
      const count = deal['ä¼šè©±æ•°'] || 0;

      safeSetText('convSummaryText', summary);
      safeSetText('convLastDate', lastDate);
      safeSetText('convCount', count);

      // ãƒ­ã‚°ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒªã‚»ãƒƒãƒˆ
      const logContainer = document.getElementById('convLogContainer');
      if (logContainer) {
        logContainer.classList.remove('show');
        logContainer.innerHTML = '';
      }
      safeSetText('btnShowLogs', 'å…¨ãƒ­ã‚°ã‚’è¡¨ç¤º');

      // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
      safeSetValue('convReceivedInput', '');
      safeSetValue('convReplyInput', '');
      const receivedTrans = document.getElementById('receivedTranslation');
      const replyTrans = document.getElementById('replyTranslation');
      if (receivedTrans) receivedTrans.classList.remove('show');
      if (replyTrans) replyTrans.classList.remove('show');
    }

    function renderReportTab(deal) {
      // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
      safeSetValue('reportActivity', '');
      safeSetValue('reportNextAction', '');
      safeSetValue('reportConcerns', '');

      // éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
      loadPastReports(deal['ãƒªãƒ¼ãƒ‰ID']);
    }

    function switchDealSlideTab(tabName) {
      currentSlideTab = tabName;

      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.slide-panel-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.slide-tab-content').forEach(content => {
        content.classList.remove('active');
      });

      if (tabName === 'detail') {
        document.getElementById('tabDetail').classList.add('active');
        document.getElementById('dealSlideFooter').style.display = 'flex';
      } else if (tabName === 'conversation') {
        document.getElementById('tabConversation').classList.add('active');
        document.getElementById('dealSlideFooter').style.display = 'none';
      } else if (tabName === 'report') {
        document.getElementById('tabReport').classList.add('active');
        document.getElementById('dealSlideFooter').style.display = 'none';
      }
    }

    function openMessageFromSlide() {
      if (!currentSlideDeal) return;
      const url = currentSlideDeal['ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL'];
      if (url) {
        window.open(url, '_blank');
      } else {
        showToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
      }
    }

    // ========== ä¼šè©±ã‚¿ãƒ–æ©Ÿèƒ½ ==========
    function toggleConversationLogs() {
      const container = document.getElementById('convLogContainer');
      const btn = document.getElementById('btnShowLogs');

      if (container.classList.contains('show')) {
        container.classList.remove('show');
        btn.textContent = 'å…¨ãƒ­ã‚°ã‚’è¡¨ç¤º';
      } else {
        // ä¼šè©±ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
        loadConversationLogs();
      }
    }

    function loadConversationLogs() {
      if (!currentSlideDeal) return;

      const leadId = currentSlideDeal['ãƒªãƒ¼ãƒ‰ID'];
      const container = document.getElementById('convLogContainer');
      const btn = document.getElementById('btnShowLogs');

      container.innerHTML = '<p style="padding: 12px; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
      container.classList.add('show');

      google.script.run
        .withSuccessHandler(function(logs) {
          if (!logs || logs.length === 0) {
            container.innerHTML = '<p style="padding: 12px; color: #999;">ä¼šè©±ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            btn.textContent = 'ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹';
            return;
          }

          let html = '';
          logs.forEach(function(log) {
            const direction = log['é€å—ä¿¡'] === 'é€ä¿¡' ? 'sent' : 'received';
            const dateStr = formatDateTime(log['æ—¥æ™‚']);
            const speaker = log['ç™ºè¨€è€…'] || (direction === 'sent' ? 'è‡ªç¤¾' : 'é¡§å®¢');
            const text = log['åŸæ–‡'] || '';
            const translation = log['ç¿»è¨³æ–‡'] || '';

            html += `
              <div class="conv-log-item ${direction}">
                <div class="conv-log-header">
                  <span>${speaker}</span>
                  <span>${dateStr}</span>
                </div>
                <div class="conv-log-text">${escapeHtml(text)}</div>
                ${translation ? `<div class="log-translation">${escapeHtml(translation)}</div>` : ''}
              </div>
            `;
          });

          container.innerHTML = html;
          btn.textContent = 'ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹';
        })
        .withFailureHandler(function(e) {
          console.error('ä¼šè©±ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          container.innerHTML = '<p style="padding: 12px; color: #dc3545;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
        })
        .getConversationLogs(leadId, 'deal');
    }

    function recordAndTranslate() {
      if (!currentSlideDeal) return;

      const input = document.getElementById('convReceivedInput');
      const text = input.value.trim();

      if (!text) {
        showToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      showLoading();

      const data = {
        leadId: currentSlideDeal['ãƒªãƒ¼ãƒ‰ID'],
        direction: 'å—ä¿¡',
        originalText: text,
        recorderId: currentUser ? currentUser.staffId : '',
        type: 'deal'
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            // ç¿»è¨³çµæœã‚’è¡¨ç¤º
            if (result.translation) {
              safeSetText('receivedTranslationText', result.translation);
              const recvTrans = document.getElementById('receivedTranslation');
              if (recvTrans) recvTrans.classList.add('show');
            }
            showToast('è¨˜éŒ²ã—ã¾ã—ãŸ');
            input.value = '';

            // ä¼šè©±æ•°ã‚’æ›´æ–°
            const countEl = document.getElementById('convCount');
            if (countEl) countEl.textContent = parseInt(countEl.textContent || 0) + 1;
          } else {
            showToast('ã‚¨ãƒ©ãƒ¼: ' + (result.error || ''), 'error');
          }
        })
        .withFailureHandler(function(e) {
          hideLoading();
          console.error('è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
          showToast('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .translateAndAddLog(data);
    }

    function translateAndCopy() {
      if (!currentSlideDeal) return;

      const input = document.getElementById('convReplyInput');
      const text = input.value.trim();

      if (!text) {
        showToast('è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success && result.translation) {
            // ç¿»è¨³çµæœã‚’è¡¨ç¤º
            safeSetText('replyTranslationText', result.translation);
            const replyTrans = document.getElementById('replyTranslation');
            if (replyTrans) replyTrans.classList.add('show');

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(result.translation).then(function() {
              showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(function() {
              showToast('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'warning');
            });
          } else {
            showToast('ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ' + (result.error || ''), 'error');
          }
        })
        .withFailureHandler(function(e) {
          hideLoading();
          console.error('ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', e);
          showToast('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .translateMessage(text, 'ja-en');
    }

    function translateAndRecord() {
      if (!currentSlideDeal) return;

      const input = document.getElementById('convReplyInput');
      const text = input ? input.value.trim() : '';

      if (!text) {
        showToast('è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      showLoading();

      const data = {
        leadId: currentSlideDeal['ãƒªãƒ¼ãƒ‰ID'],
        direction: 'é€ä¿¡',
        originalText: text,
        recorderId: currentUser ? currentUser.staffId : '',
        type: 'deal'
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            // ç¿»è¨³çµæœã‚’è¡¨ç¤º
            if (result.translation) {
              safeSetText('replyTranslationText', result.translation);
              const replyTrans = document.getElementById('replyTranslation');
              if (replyTrans) replyTrans.classList.add('show');

              // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚‚ã‚³ãƒ”ãƒ¼
              navigator.clipboard.writeText(result.translation).catch(function() {});
            }
            showToast('è¨˜éŒ²ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            if (input) input.value = '';

            // ä¼šè©±æ•°ã‚’æ›´æ–°
            const countEl = document.getElementById('convCount');
            countEl.textContent = parseInt(countEl.textContent || 0) + 1;
          } else {
            showToast('ã‚¨ãƒ©ãƒ¼: ' + (result.error || ''), 'error');
          }
        })
        .withFailureHandler(function(e) {
          hideLoading();
          console.error('è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
          showToast('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .translateAndAddLog(data);
    }

    // ========== ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–æ©Ÿèƒ½ ==========
    function loadPastReports(leadId) {
      const container = document.getElementById('pastReportsList');
      container.innerHTML = '<p class="no-data" style="font-size: 12px; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</p>';

      google.script.run
        .withSuccessHandler(function(reports) {
          if (!reports || reports.length === 0) {
            container.innerHTML = '<p class="no-data" style="font-size: 12px; color: #999;">éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            return;
          }

          let html = '';
          reports.slice(0, 5).forEach(function(report) {
            const dateStr = formatDateTime(report['æå‡ºæ—¥æ™‚'] || report['è¨˜éŒ²æ—¥æ™‚']);
            const activity = report['æ´»å‹•å†…å®¹'] || report['å†…å®¹'] || '-';
            const preview = activity.length > 40 ? activity.substring(0, 40) + '...' : activity;

            html += `
              <div class="past-report-item">
                <div class="past-report-date">${dateStr}</div>
                <div class="past-report-text">${escapeHtml(preview)}</div>
              </div>
            `;
          });

          container.innerHTML = html;
        })
        .withFailureHandler(function(e) {
          console.error('ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          container.innerHTML = '<p class="no-data" style="font-size: 12px; color: #dc3545;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
        })
        .getDealReports(leadId);
    }

    function submitDealReport() {
      if (!currentSlideDeal) return;

      const activity = document.getElementById('reportActivity').value.trim();
      const nextAction = document.getElementById('reportNextAction').value.trim();
      const concerns = document.getElementById('reportConcerns').value.trim();

      if (!activity) {
        showToast('æ´»å‹•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      showLoading();

      const reportData = {
        leadId: currentSlideDeal['ãƒªãƒ¼ãƒ‰ID'],
        customerName: currentSlideDeal['é¡§å®¢å'] || '',
        activity: activity,
        nextAction: nextAction,
        concerns: concerns,
        staffId: currentUser ? currentUser.staffId : '',
        staffName: currentUser ? currentUser.staffName : ''
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            showToast('ãƒ¬ãƒãƒ¼ãƒˆã‚’æå‡ºã—ã¾ã—ãŸ');
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('reportActivity').value = '';
            document.getElementById('reportNextAction').value = '';
            document.getElementById('reportConcerns').value = '';
            // éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å†èª­ã¿è¾¼ã¿
            loadPastReports(currentSlideDeal['ãƒªãƒ¼ãƒ‰ID']);
          } else {
            showToast('ã‚¨ãƒ©ãƒ¼: ' + (result?.error || ''), 'error');
          }
        })
        .withFailureHandler(function(e) {
          hideLoading();
          console.error('ãƒ¬ãƒãƒ¼ãƒˆæå‡ºã‚¨ãƒ©ãƒ¼:', e);
          showToast('æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .submitDealReportFromSlide(reportData);
    }

    // ========== æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å‡¦ç† ==========
    function handleNextActionDateSelect(value) {
      const customInput = document.getElementById('slideNextActionDateCustom');
      const hiddenInput = document.getElementById('slideNextActionDate');

      if (value === 'custom') {
        // ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜å…¥åŠ›ã‚’è¡¨ç¤º
        customInput.style.display = 'block';
        customInput.focus();
        // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã®å¤‰æ›´ã‚’ç›£è¦–
        customInput.onchange = function() {
          hiddenInput.value = this.value;
        };
        // æ—¢å­˜ã®å€¤ãŒã‚ã‚Œã°ãã®ã¾ã¾
        if (customInput.value) {
          hiddenInput.value = customInput.value;
        }
      } else {
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠ
        customInput.style.display = 'none';
        const dateValue = calculateNextActionDate(value);
        hiddenInput.value = dateValue;
      }
    }

    function calculateNextActionDate(option) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      switch (option) {
        case 'waiting_reply':
          // ã€Œç›¸æ‰‹ã®è¿”ä¿¡ãŒå±Šãæ¬¡ç¬¬ã€â†’ 7æ—¥å¾Œã‚’ä»®è¨­å®šï¼ˆãƒªãƒã‚¤ãƒ³ãƒ‰ç”¨ï¼‰
          const waitReply = new Date(today);
          waitReply.setDate(waitReply.getDate() + 7);
          return formatDateForInput(waitReply) + '|waiting_reply';

        case 'waiting_confirm':
          // ã€Œä¸æ˜ç‚¹ã®ç¢ºèªãŒå®Œäº†æ¬¡ç¬¬ã€â†’ 3æ—¥å¾Œã‚’ä»®è¨­å®š
          const waitConfirm = new Date(today);
          waitConfirm.setDate(waitConfirm.getDate() + 3);
          return formatDateForInput(waitConfirm) + '|waiting_confirm';

        case 'today':
          return formatDateForInput(today);

        case 'tomorrow':
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          return formatDateForInput(tomorrow);

        case '2days':
          const twoDays = new Date(today);
          twoDays.setDate(twoDays.getDate() + 2);
          return formatDateForInput(twoDays);

        case '3days':
          const threeDays = new Date(today);
          threeDays.setDate(threeDays.getDate() + 3);
          return formatDateForInput(threeDays);

        case '7days':
          const sevenDays = new Date(today);
          sevenDays.setDate(sevenDays.getDate() + 7);
          return formatDateForInput(sevenDays);

        case 'weekend':
          // æ¬¡ã®åœŸæ›œæ—¥ã‚’è¨ˆç®—
          const weekend = new Date(today);
          const dayOfWeek = weekend.getDay();
          const daysUntilSaturday = (6 - dayOfWeek + 7) % 7 || 7; // ä»Šæ—¥ãŒåœŸæ›œãªã‚‰æ¥é€±
          weekend.setDate(weekend.getDate() + daysUntilSaturday);
          return formatDateForInput(weekend);

        default:
          return '';
      }
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸæ™‚ã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’è¨­å®š
    function initNextActionDateDropdown(deal) {
      const select = document.getElementById('slideNextActionDateSelect');
      const customInput = document.getElementById('slideNextActionDateCustom');
      const hiddenInput = document.getElementById('slideNextActionDate');

      if (!select) return;

      const storedValue = deal['æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥'] || '';

      // ãƒ‘ã‚¤ãƒ—åŒºåˆ‡ã‚Šã®ç‰¹æ®Šå€¤ã‚’ãƒã‚§ãƒƒã‚¯
      if (storedValue.includes('|waiting_reply')) {
        select.value = 'waiting_reply';
        customInput.style.display = 'none';
      } else if (storedValue.includes('|waiting_confirm')) {
        select.value = 'waiting_confirm';
        customInput.style.display = 'none';
      } else if (storedValue) {
        // é€šå¸¸ã®æ—¥ä»˜å€¤ã®å ´åˆã€ç›¸å¯¾æ—¥ä»˜ã«å¤‰æ›
        const actionDate = new Date(storedValue.split('|')[0]);
        actionDate.setHours(0, 0, 0, 0);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const diffDays = Math.round((actionDate - today) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
          select.value = 'today';
          customInput.style.display = 'none';
        } else if (diffDays === 1) {
          select.value = 'tomorrow';
          customInput.style.display = 'none';
        } else if (diffDays === 2) {
          select.value = '2days';
          customInput.style.display = 'none';
        } else if (diffDays === 3) {
          select.value = '3days';
          customInput.style.display = 'none';
        } else if (diffDays === 7) {
          select.value = '7days';
          customInput.style.display = 'none';
        } else if (actionDate.getDay() === 6) {
          select.value = 'weekend';
          customInput.style.display = 'none';
        } else {
          // ãã®ä»–ã¯ã€Œæ—¥ä»˜å…¥åŠ›ã€
          select.value = 'custom';
          customInput.style.display = 'block';
          customInput.value = formatDateForInput(storedValue.split('|')[0]);
        }
      } else {
        select.value = '';
        customInput.style.display = 'none';
      }

      hiddenInput.value = storedValue;
    }

    function closeDealSlidePanel() {
      document.getElementById('dealSlideOverlay').classList.remove('show');
      document.getElementById('dealSlidePanel').classList.remove('open');
      currentSlideDeal = null;
    }

    function saveDealFromSlide() {
      const leadId = document.getElementById('slideLeadId').value;

      const updateData = {
        'é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': document.getElementById('slideDealStatus').value,
        'æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³': document.getElementById('slideNextAction').value,
        'æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥': document.getElementById('slideNextActionDate').value,
        'å•†è«‡ãƒ¡ãƒ¢': document.getElementById('slideDealMemo').value,
        'å–ã‚Šæ‰±ã„ã‚¿ã‚¤ãƒˆãƒ«': document.getElementById('slideTitle').value,
        'è²©å£²å½¢æ…‹': document.getElementById('slideSaleType').value,
        'æœˆé–“è¦‹è¾¼ã¿é‡‘é¡': document.getElementById('slideAmount').value,
        'ç«¶åˆæ¯”è¼ƒä¸­': document.getElementById('slideCompeting').value,
        'å•†è«‡çµæœ': document.getElementById('slideResult').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          showToast('å•†è«‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          closeDealSlidePanel();
          // å•†è«‡ä¸€è¦§ã‚’æ›´æ–°
          google.script.run
            .withSuccessHandler(function(data) {
              cache.deals = data || [];
              filterDeals();
              updateSidebarBadges();
            })
            .getLeads('deal');
        })
        .withFailureHandler(function(e) {
          console.error('å•†è«‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || ''));
        })
        .updateLead('ãƒªãƒ¼ãƒ‰ç®¡ç†', leadId, updateData);
    }

    function formatDateForInput(dateValue) {
      if (!dateValue) return '';
      const date = new Date(dateValue);
      if (isNaN(date.getTime())) return '';
      return date.toISOString().split('T')[0];
    }

    // ========== ãƒªãƒ¼ãƒ‰è¿½åŠ  ==========
    function openAddLeadModal(type) {
      safeSetValue('addLeadType', type);
      safeSetText('addLeadModalTitle',
        type === 'in' ? 'æ–°è¦ãƒªãƒ¼ãƒ‰è¿½åŠ ï¼ˆINï¼‰' : 'æ–°è¦ãƒªãƒ¼ãƒ‰è¿½åŠ ï¼ˆOUTï¼‰');
      const form = document.getElementById('addLeadForm');
      if (form) form.reset();

      // ã€Œãã®ä»–ã€è©³ç´°å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetOtherDetails();

      // æµå…¥çµŒè·¯ã®selectã‚’åˆ‡ã‚Šæ›¿ãˆ
      const selectIn = document.getElementById('selectChannelIn');
      const selectOut = document.getElementById('selectChannelOut');
      if (type === 'in') {
        if (selectIn) { selectIn.style.display = 'block'; selectIn.name = 'æµå…¥çµŒè·¯'; }
        if (selectOut) { selectOut.style.display = 'none'; selectOut.name = ''; }
      } else {
        if (selectIn) { selectIn.style.display = 'none'; selectIn.name = ''; }
        if (selectOut) { selectOut.style.display = 'block'; selectOut.name = 'æµå…¥çµŒè·¯'; }
      }

      const modal = document.getElementById('addLeadModal');
      if (modal) modal.classList.add('active');
    }

    function closeAddLeadModal() {
      const modal = document.getElementById('addLeadModal');
      if (modal) modal.classList.remove('active');
    }

    function submitAddLead(e) {
      e.preventDefault();
      const type = safeGetValue('addLeadType');
      const leadType = type === 'in' ? 'ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰' : 'ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰';

      // æµå…¥çµŒè·¯ã®ã€Œãã®ä»–ã€å‡¦ç†
      const channelSelectId = type === 'in' ? 'selectChannelIn' : 'selectChannelOut';
      const channelValue = getOtherValue(channelSelectId, 'channelOtherInput');
      if (channelValue && channelValue.error) {
        showToastError('æµå…¥çµŒè·¯: ' + channelValue.error);
        return;
      }

      const formData = new FormData(e.target);
      const leadData = {};
      formData.forEach((value, key) => {
        if (value) leadData[key] = value;
      });

      // ã€Œãã®ä»–ã€ã®å€¤ã‚’ä¸Šæ›¸ã
      if (channelValue) {
        leadData['æµå…¥çµŒè·¯'] = channelValue;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(leadId) {
          hideLoading();
          showToast('ãƒªãƒ¼ãƒ‰ã€Œ' + leadId + 'ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
          closeAddLeadModal();

          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
          google.script.run
            .withSuccessHandler(function(data) {
              if (type === 'in') {
                cache.leadsIn = data;
                renderLeadsIn();
              } else {
                cache.leadsOut = data;
                renderLeadsOut();
              }
              updateSidebarBadges();
              updateKPIs();
            })
            .getLeads('lead', leadType);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToastError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .addNewLead(leadType, leadData);
    }

    // ========== ãƒªãƒ¼ãƒ‰è©³ç´° ==========
    let currentDetailLead = null;
    let currentDetailType = null;

    function openLeadDetail(leadId, type) {
      const leads = type === 'in' ? cache.leadsIn : cache.leadsOut;
      const lead = leads.find(l => l['ãƒªãƒ¼ãƒ‰ID'] === leadId);

      if (!lead) {
        showToastWarning('ãƒªãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      currentDetailLead = lead;
      currentDetailType = type;

      // ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼ã§è¡¨ç¤ºï¼ˆæ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã¨åŒã˜8è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
      let html = `
        <form id="leadDetailForm">
          <input type="hidden" id="detailLeadId" value="${lead['ãƒªãƒ¼ãƒ‰ID']}">
          <input type="hidden" id="detailLeadType" value="${type}">

          <!-- Row 1: é¡§å®¢å -->
          <div class="form-group">
            <label class="form-label">é¡§å®¢å *</label>
            <input type="text" class="form-input" id="detail_é¡§å®¢å" value="${escapeHtml(lead['é¡§å®¢å'] || '')}" required>
          </div>

          <!-- Row 2: å‘¼ã³æ–¹ï¼ˆè‹±èªï¼‰ | å›½ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div class="form-group">
              <label class="form-label">å‘¼ã³æ–¹ï¼ˆè‹±èªï¼‰</label>
              <input type="text" class="form-input" id="detail_å‘¼ã³æ–¹" value="${escapeHtml(lead['å‘¼ã³æ–¹ï¼ˆè‹±èªï¼‰'] || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">å›½</label>
              <select class="form-select" id="detail_å›½"></select>
            </div>
          </div>

          <!-- Row 3: æµå…¥çµŒè·¯ | SNS/é€£çµ¡æ‰‹æ®µ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div class="form-group">
              <label class="form-label">æµå…¥çµŒè·¯</label>
              <select class="form-select" id="detail_æµå…¥çµŒè·¯"></select>
            </div>
            <div class="form-group">
              <label class="form-label">SNS/é€£çµ¡æ‰‹æ®µ</label>
              <select class="form-select" id="detail_SNS"></select>
            </div>
          </div>

          <!-- Row 4: é›»è©±ç•ªå· | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div class="form-group">
              <label class="form-label">é›»è©±ç•ªå·</label>
              <input type="text" class="form-input" id="detail_é›»è©±ç•ªå·" value="${escapeHtml(lead['é›»è©±ç•ªå·'] || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">ãƒ¡ãƒ¼ãƒ«</label>
              <input type="email" class="form-input" id="detail_ãƒ¡ãƒ¼ãƒ«" value="${escapeHtml(lead['ãƒ¡ãƒ¼ãƒ«'] || '')}">
            </div>
          </div>

          <!-- Row 5: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL (full width) -->
          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL</label>
            <input type="url" class="form-input" id="detail_ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL" value="${escapeHtml(lead['ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL'] || '')}">
          </div>

          <!-- Row 6: æ¸©åº¦æ„Ÿ | æƒ³å®šè¦æ¨¡ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div class="form-group">
              <label class="form-label">æ¸©åº¦æ„Ÿ</label>
              <select class="form-select" id="detail_æ¸©åº¦æ„Ÿ"></select>
            </div>
            <div class="form-group">
              <label class="form-label">æƒ³å®šè¦æ¨¡</label>
              <select class="form-select" id="detail_æƒ³å®šè¦æ¨¡"></select>
            </div>
          </div>

          <!-- Row 7: é¡§å®¢ã‚¿ã‚¤ãƒ— | è¿”ä¿¡é€Ÿåº¦ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div class="form-group">
              <label class="form-label">é¡§å®¢ã‚¿ã‚¤ãƒ—</label>
              <select class="form-select" id="detail_é¡§å®¢ã‚¿ã‚¤ãƒ—"></select>
            </div>
            <div class="form-group">
              <label class="form-label">è¿”ä¿¡é€Ÿåº¦</label>
              <select class="form-select" id="detail_è¿”ä¿¡é€Ÿåº¦"></select>
            </div>
          </div>

          <!-- Row 8: CSãƒ¡ãƒ¢ (full width) -->
          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label">CSãƒ¡ãƒ¢</label>
            <textarea class="form-textarea" id="detail_CSãƒ¡ãƒ¢" placeholder="å¯¾å¿œå±¥æ­´ã€ãƒ¡ãƒ¢ãªã©">${escapeHtml(lead['CSãƒ¡ãƒ¢'] || '')}</textarea>
          </div>

          <!-- Footer with buttons -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
            <button type="button" class="btn" onclick="openMessageFromDetail()" style="background: #3b82f6; color: white;">ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª</button>
            <div style="display: flex; gap: 12px;">
              <button type="button" class="btn btn-secondary" onclick="closeLeadDetailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button type="button" class="btn btn-primary" onclick="saveLeadDetail()">ä¿å­˜</button>
            </div>
          </div>
        </form>
      `;

      document.getElementById('leadDetailContent').innerHTML = html;

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
      populateDetailDropdowns(lead, type);

      document.getElementById('leadDetailModal').classList.add('active');
    }

    function populateDetailDropdowns(lead, type) {
      // å›½
      setOptionsWithValue('detail_å›½', cache.dropdownOptions?.å›½ || [], lead['å›½']);

      // æµå…¥çµŒè·¯ (IN/OUTã§åˆ†ã‘ã‚‹)
      const channelOptions = type === 'in'
        ? (cache.dropdownOptions?.['æµå…¥çµŒè·¯ï¼ˆINï¼‰'] || cache.dropdownOptions?.æµå…¥çµŒè·¯ || [])
        : (cache.dropdownOptions?.['æµå…¥çµŒè·¯ï¼ˆOUTï¼‰'] || cache.dropdownOptions?.æµå…¥çµŒè·¯ || []);
      setOptionsWithValue('detail_æµå…¥çµŒè·¯', channelOptions, lead['æµå…¥çµŒè·¯']);

      // SNS/é€£çµ¡æ‰‹æ®µ
      setOptionsWithValue('detail_SNS', cache.dropdownOptions?.['SNS/é€£çµ¡æ‰‹æ®µ'] || ['WhatsApp', 'ãƒ¡ãƒ¼ãƒ«', 'Instagram', 'Messenger', 'Telegram', 'X', 'Discord', 'LINE', 'ãã®ä»–'], lead['SNS/é€£çµ¡æ‰‹æ®µ']);

      // æ¸©åº¦æ„Ÿ
      setOptionsWithValue('detail_æ¸©åº¦æ„Ÿ', cache.dropdownOptions?.æ¸©åº¦æ„Ÿ || [], lead['æ¸©åº¦æ„Ÿ']);

      // æƒ³å®šè¦æ¨¡
      setOptionsWithValue('detail_æƒ³å®šè¦æ¨¡', cache.dropdownOptions?.æƒ³å®šè¦æ¨¡ || [], lead['æƒ³å®šè¦æ¨¡']);

      // é¡§å®¢ã‚¿ã‚¤ãƒ—
      setOptionsWithValue('detail_é¡§å®¢ã‚¿ã‚¤ãƒ—', cache.dropdownOptions?.é¡§å®¢ã‚¿ã‚¤ãƒ— || [], lead['é¡§å®¢ã‚¿ã‚¤ãƒ—']);

      // è¿”ä¿¡é€Ÿåº¦
      setOptionsWithValue('detail_è¿”ä¿¡é€Ÿåº¦', cache.dropdownOptions?.è¿”ä¿¡é€Ÿåº¦ || [], lead['è¿”ä¿¡é€Ÿåº¦']);
    }

    function setOptionsWithValue(selectId, options, currentValue) {
      const select = document.getElementById(selectId);
      if (!select) return;

      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        if (opt === currentValue) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    function openMessageFromDetail() {
      const url = document.getElementById('detail_ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL')?.value;
      if (!url || url.trim() === '') {
        showToastWarning('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URLãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      window.open(url, '_blank');
    }

    function saveLeadDetail() {
      const leadId = document.getElementById('detailLeadId').value;
      const type = document.getElementById('detailLeadType').value;
      const sheetName = 'ãƒªãƒ¼ãƒ‰ç®¡ç†';  // çµ±åˆã‚·ãƒ¼ãƒˆ

      const customerName = document.getElementById('detail_é¡§å®¢å').value.trim();
      if (!customerName) {
        showToastWarning('é¡§å®¢åã¯å¿…é ˆã§ã™');
        return;
      }

      const updateData = {
        'é¡§å®¢å': customerName,
        'å‘¼ã³æ–¹ï¼ˆè‹±èªï¼‰': document.getElementById('detail_å‘¼ã³æ–¹').value.trim(),
        'å›½': document.getElementById('detail_å›½').value,
        'æµå…¥çµŒè·¯': document.getElementById('detail_æµå…¥çµŒè·¯').value,
        'é€£çµ¡æ‰‹æ®µ': document.getElementById('detail_SNS').value,
        'é›»è©±ç•ªå·': document.getElementById('detail_é›»è©±ç•ªå·').value.trim(),
        'ãƒ¡ãƒ¼ãƒ«': document.getElementById('detail_ãƒ¡ãƒ¼ãƒ«').value.trim(),
        'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL': document.getElementById('detail_ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URL').value.trim(),
        'æ¸©åº¦æ„Ÿ': document.getElementById('detail_æ¸©åº¦æ„Ÿ').value,
        'æƒ³å®šè¦æ¨¡': document.getElementById('detail_æƒ³å®šè¦æ¨¡').value,
        'é¡§å®¢ã‚¿ã‚¤ãƒ—': document.getElementById('detail_é¡§å®¢ã‚¿ã‚¤ãƒ—').value,
        'è¿”ä¿¡é€Ÿåº¦': document.getElementById('detail_è¿”ä¿¡é€Ÿåº¦').value,
        'CSãƒ¡ãƒ¢': document.getElementById('detail_CSãƒ¡ãƒ¢').value.trim()
      };

      google.script.run
        .withSuccessHandler(function(result) {
          showToast('ãƒªãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          closeLeadDetailModal();
          // ä¸€è¦§ã‚’æ›´æ–°
          if (type === 'in') {
            retryLoadLeads('in');
          } else {
            retryLoadLeads('out');
          }
        })
        .withFailureHandler(function(e) {
          console.error('ãƒªãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || ''));
        })
        .updateLead(sheetName, leadId, updateData);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function closeLeadDetailModal() {
      document.getElementById('leadDetailModal').classList.remove('active');
      currentDetailLead = null;
      currentDetailType = null;
    }

    // ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Box ==========
    function openMessageBox(url) {
      if (!url || url === '') {
        showToastWarning('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URLãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      window.open(url, '_blank');
    }

    // ========== ã‚¢ã‚µã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    function openAssignModal(leadId, customerName, type) {
      safeSetValue('assignLeadId', leadId);
      safeSetValue('assignLeadType', type);
      safeSetText('assignCustomerName', customerName);
      safeSetValue('assignStaffSelect', '');

      // æ‹…å½“è€…ä¸€è¦§ã‚’å–å¾—
      loadStaffListForAssign();

      const modal = document.getElementById('assignModal');
      if (modal) modal.classList.add('active');
    }

    function closeAssignModal() {
      const modal = document.getElementById('assignModal');
      if (modal) modal.classList.remove('active');
    }

    function loadStaffListForAssign() {
      google.script.run
        .withSuccessHandler(function(staffList) {
          const select = document.getElementById('assignStaffSelect');
          if (!select) return;
          select.innerHTML = '<option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>';
          if (staffList && staffList.length > 0) {
            staffList.forEach(staff => {
              const option = document.createElement('option');
              option.value = JSON.stringify({ id: staff.id, name: staff.name, discordId: staff.discordId });
              option.textContent = staff.name;
              select.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(e) {
          console.error('æ‹…å½“è€…ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('æ‹…å½“è€…ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getStaffListForAssign();
    }

    function confirmAssign() {
      const leadId = safeGetValue('assignLeadId');
      const type = safeGetValue('assignLeadType');
      const staffValue = safeGetValue('assignStaffSelect');

      if (!staffValue) {
        showToastWarning('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const staff = JSON.parse(staffValue);

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('ã‚¢ã‚µã‚¤ãƒ³ã—ã¾ã—ãŸ');
            closeAssignModal();
            // ä¸€è¦§ã‚’æ›´æ–°
            if (type === 'in') {
              retryLoadLeads('in');
            } else {
              retryLoadLeads('out');
            }
          } else {
            showToastError('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(e) {
          console.error('ã‚¢ã‚µã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('ã‚¢ã‚µã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || ''));
        })
        .assignLead(leadId, staff.id, staff.name);
    }

    // ========== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    function openArchiveModal(leadId, customerName, type) {
      safeSetValue('archiveLeadId', leadId);
      safeSetValue('archiveLeadType', type);
      safeSetText('archiveCustomerName', customerName);
      safeSetValue('archiveReasonSelect', '');
      safeSetValue('archiveCsMemo', '');

      const modal = document.getElementById('archiveModal');
      if (modal) modal.classList.add('active');
    }

    function closeArchiveModal() {
      const modal = document.getElementById('archiveModal');
      if (modal) modal.classList.remove('active');
    }

    function confirmArchive() {
      const leadId = safeGetValue('archiveLeadId');
      const type = safeGetValue('archiveLeadType');
      const reason = safeGetValue('archiveReasonSelect');
      const csMemo = safeGetValue('archiveCsMemo').trim();

      if (!reason) {
        showToastWarning('é›¢è„±ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!csMemo) {
        showToastWarning('CSãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ');
            closeArchiveModal();
            // ä¸€è¦§ã‚’æ›´æ–°
            if (type === 'in') {
              retryLoadLeads('in');
            } else {
              retryLoadLeads('out');
            }
          } else {
            showToastError('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(e) {
          console.error('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¨ãƒ©ãƒ¼:', e);
          showToastError('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || ''));
        })
        .archiveLeadToDropped(leadId, reason, csMemo);
    }

    // ========== ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ==========
    function showToast(message) {
      // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // æº–å‚™ä¸­ãƒˆãƒ¼ã‚¹ãƒˆ
    function showComingSoon(event) {
      event.preventDefault();
      event.stopPropagation();
      showToastWarning('ã“ã®æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
    }

    function showToastWarning(message) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #f59e0b;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    function showToastError(message) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = 'toast toast-error';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 4000);
    }

    // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
    function getRankBadgeClass(rank) {
      switch(rank) {
        case 'A': return 'badge-a';
        case 'B+': return 'badge-b-plus';
        case 'B': return 'badge-b';
        case 'B-': return 'badge-b-minus';
        case 'ä»®C': case 'ç¢ºå®šC': return 'badge-c';
        default: return 'badge-b';
      }
    }

    function getTempBadgeClass(temp) {
      switch(temp) {
        case 'é«˜': return 'badge-high';
        case 'ä¸­': return 'badge-medium';
        case 'ä½': return 'badge-low';
        default: return 'badge-medium';
      }
    }

    function formatDate(dateValue) {
      if (!dateValue) return '-';
      const date = new Date(dateValue);
      return date.toLocaleDateString('ja-JP');
    }

    function formatCurrency(value) {
      if (!value) return '-';
      return '$' + Number(value).toLocaleString();
    }

    // ========== ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒãƒƒã‚¸æ›´æ–° ==========
    function updateSidebarBadges() {
      // ãƒªãƒ¼ãƒ‰ï¼ˆINï¼‰: ä»Šæ—¥ç™»éŒ²ã®æœªã‚¢ã‚µã‚¤ãƒ³ï¼ˆé€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=æ–°è¦ï¼‰
      const todayNewIn = (cache.leadsIn || []).filter(function(lead) {
        return isToday(lead['ç™»éŒ²æ—¥']) && lead['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'æ–°è¦';
      }).length;

      const badgeIn = document.getElementById('badge-leads-in');
      if (badgeIn) {
        if (todayNewIn > 0) {
          badgeIn.textContent = todayNewIn;
          badgeIn.classList.add('show');
        } else {
          badgeIn.classList.remove('show');
        }
      }

      // ãƒªãƒ¼ãƒ‰ï¼ˆOUTï¼‰: ä»Šæ—¥ç™»éŒ²ã®æœªã‚¢ã‚µã‚¤ãƒ³
      const todayNewOut = (cache.leadsOut || []).filter(function(lead) {
        return isToday(lead['ç™»éŒ²æ—¥']) && lead['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'æ–°è¦';
      }).length;

      const badgeOut = document.getElementById('badge-leads-out');
      if (badgeOut) {
        if (todayNewOut > 0) {
          badgeOut.textContent = todayNewOut;
          badgeOut.classList.add('show');
        } else {
          badgeOut.classList.remove('show');
        }
      }

      // å•†è«‡ç®¡ç†: æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥ãŒä»Šæ—¥ä»¥å‰ã§æœªå¯¾å¿œ
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const overdueActions = (cache.deals || []).filter(function(deal) {
        if (!deal['æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥']) return false;
        const actionDate = new Date(deal['æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥']);
        actionDate.setHours(0, 0, 0, 0);
        const status = deal['é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
        return actionDate <= today && status !== 'æˆç´„' && status !== 'å¤±æ³¨' && status !== 'å¯¾è±¡å¤–';
      }).length;

      const badgeDeals = document.getElementById('badge-deals');
      if (badgeDeals) {
        if (overdueActions > 0) {
          badgeDeals.textContent = overdueActions;
          badgeDeals.classList.add('show');
        } else {
          badgeDeals.classList.remove('show');
        }
      }
    }

    function isToday(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      const date = new Date(dateStr);
      return date.toDateString() === today.toDateString();
    }

    // ========== ç®¡ç†è€…è¨­å®š ==========
    let permissionDefinitions = null;

    // ========== ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ==========
    let currentReportWeek = null;
    let currentReportMonth = null;

    function loadReportPage() {
      // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®åˆæœŸåŒ–
      google.script.run
        .withSuccessHandler(function(week) {
          currentReportWeek = week;
          safeSetText('reportWeekLabel', week + ' é€±');
          loadWeeklyReport();
        })
        .withFailureHandler(console.error)
        .getCurrentTargetWeek();

      // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®åˆæœŸåŒ–
      google.script.run
        .withSuccessHandler(function(month) {
          currentReportMonth = month;
          safeSetText('reportMonthLabel', month);
          loadMonthlyReport();
        })
        .withFailureHandler(console.error)
        .getCurrentTargetMonth();
    }

    function showReportTab(tab) {
      document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.report-tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      const reportEl = document.getElementById('report-' + tab);
      if (reportEl) reportEl.classList.add('active');
    }

    function changeReportWeek(direction) {
      const func = direction > 0 ? 'getNextWeekMonday' : 'getPrevWeekMonday';
      google.script.run
        .withSuccessHandler(function(newWeek) {
          currentReportWeek = newWeek;
          safeSetText('reportWeekLabel', newWeek + ' é€±');
          loadWeeklyReport();
        })
        .withFailureHandler(console.error)[func](currentReportWeek);
    }

    function changeReportMonth(direction) {
      const [year, month] = currentReportMonth.split('/').map(Number);
      const newDate = new Date(year, month - 1 + direction, 1);
      currentReportMonth = `${newDate.getFullYear()}/${String(newDate.getMonth() + 1).padStart(2, '0')}`;
      safeSetText('reportMonthLabel', currentReportMonth);
      loadMonthlyReport();
    }

    function loadWeeklyReport() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(data) {
          if (data.report) {
            safeSetValue('weeklyAchievements', data.report['ä»Šé€±ã®æˆæœ'] || '');
            safeSetValue('weeklyGoodPoints', data.report['è‰¯ã‹ã£ãŸç‚¹'] || '');
            safeSetValue('weeklyImprovements', data.report['æ”¹å–„ç‚¹'] || '');
            safeSetValue('weeklyNextGoals', data.report['æ¥é€±ã®ç›®æ¨™'] || '');
            safeSetValue('weeklyTroubles', data.report['å›°ã£ã¦ã„ã‚‹ã“ã¨'] || '');
            safeSetValue('weeklyBuddyQuestion', data.report['Buddyã¸ã®è³ªå•'] || '');
            safeSetText('weeklyReportStatus', 'ä¿å­˜æ¸ˆã¿');

            if (data.report['Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯']) {
              safeSetStyle('weeklyBuddyFeedback', 'display', 'block');
              safeSetText('weeklyBuddyFeedbackText', data.report['Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯']);
            } else {
              safeSetStyle('weeklyBuddyFeedback', 'display', 'none');
            }
          } else {
            const form = document.getElementById('weeklyReportForm');
            if (form) form.reset();
            safeSetText('weeklyReportStatus', 'æœªæå‡º');
            safeSetStyle('weeklyBuddyFeedback', 'display', 'none');
          }
        })
        .withFailureHandler(console.error)
        .getWeeklyReport(currentUser.staffId, currentReportWeek);
    }

    function loadMonthlyReport() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(data) {
          if (data.report) {
            safeSetValue('monthlyAchievements', data.report['ä»Šæœˆã®æˆæœ'] || '');
            safeSetValue('monthlyGoodPoints', data.report['è‰¯ã‹ã£ãŸç‚¹'] || '');
            safeSetValue('monthlyImprovements', data.report['æ”¹å–„ç‚¹'] || '');
            safeSetValue('monthlyNextGoals', data.report['æ¥æœˆã®ç›®æ¨™'] || '');
            safeSetText('monthlyReportStatus', 'ä¿å­˜æ¸ˆã¿');

            if (data.report['Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯']) {
              safeSetStyle('monthlyBuddyFeedback', 'display', 'block');
              safeSetText('monthlyBuddyFeedbackText', data.report['Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯']);
            } else {
              safeSetStyle('monthlyBuddyFeedback', 'display', 'none');
            }
          } else {
            const form = document.getElementById('monthlyReportForm');
            if (form) form.reset();
            safeSetText('monthlyReportStatus', 'æœªæå‡º');
            safeSetStyle('monthlyBuddyFeedback', 'display', 'none');
          }
        })
        .withFailureHandler(console.error)
        .getMonthlyReport(currentUser.staffId, currentReportMonth);
    }

    function submitWeeklyReport(e) {
      e.preventDefault();
      if (!currentUser || !currentUser.staffId) return;

      const reportData = {
        'ä»Šé€±ã®æˆæœ': document.getElementById('weeklyAchievements').value,
        'è‰¯ã‹ã£ãŸç‚¹': document.getElementById('weeklyGoodPoints').value,
        'æ”¹å–„ç‚¹': document.getElementById('weeklyImprovements').value,
        'æ¥é€±ã®ç›®æ¨™': document.getElementById('weeklyNextGoals').value,
        'å›°ã£ã¦ã„ã‚‹ã“ã¨': document.getElementById('weeklyTroubles').value,
        'Buddyã¸ã®è³ªå•': document.getElementById('weeklyBuddyQuestion').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            loadWeeklyReport();
          } else {
            showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          showToastError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .saveWeeklyReport(currentUser.staffId, currentReportWeek, reportData);
    }

    function submitMonthlyReport(e) {
      e.preventDefault();
      if (!currentUser || !currentUser.staffId) return;

      const reportData = {
        'ä»Šæœˆã®æˆæœ': document.getElementById('monthlyAchievements').value,
        'è‰¯ã‹ã£ãŸç‚¹': document.getElementById('monthlyGoodPoints').value,
        'æ”¹å–„ç‚¹': document.getElementById('monthlyImprovements').value,
        'æ¥æœˆã®ç›®æ¨™': document.getElementById('monthlyNextGoals').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            loadMonthlyReport();
          } else {
            showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          showToastError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .saveMonthlyReport(currentUser.staffId, currentReportMonth, reportData);
    }

    // ========== ãƒãƒƒã‚¸æ©Ÿèƒ½ ==========

    function loadBadges() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(data) {
          renderBadges(data);
        })
        .withFailureHandler(function(error) {
          console.error('ãƒãƒƒã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          safeSetHtml('badgeContainer', '<p class="no-data">ãƒãƒƒã‚¸ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>');
        })
        .getStaffBadges(currentUser.staffId);
    }

    // ãƒãƒƒã‚¸ç²å¾—çŠ¶æ…‹ã‚’ä¿å­˜
    function getSavedBadgeIds() {
      try {
        const saved = localStorage.getItem('earnedBadgeIds_' + (currentUser?.staffId || 'default'));
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        return [];
      }
    }

    function saveBadgeIds(badgeIds) {
      try {
        localStorage.setItem('earnedBadgeIds_' + (currentUser?.staffId || 'default'), JSON.stringify(badgeIds));
      } catch (e) {
        console.error('ãƒãƒƒã‚¸çŠ¶æ…‹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    // Confettiç™ºç«
    function fireBadgeConfetti() {
      if (typeof confetti !== 'function') return;

      // æœ€åˆã®çˆ†ç™º
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#ffd700', '#ffaa00', '#ff6b35', '#fff']
      });

      // å·¦å³ã‹ã‚‰è¿½åŠ 
      setTimeout(() => {
        confetti({
          particleCount: 50,
          angle: 60,
          spread: 55,
          origin: { x: 0 },
          colors: ['#ffd700', '#ffaa00']
        });
        confetti({
          particleCount: 50,
          angle: 120,
          spread: 55,
          origin: { x: 1 },
          colors: ['#ffd700', '#ffaa00']
        });
      }, 200);
    }

    // ãƒãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showBadgeModal(badge) {
      const modal = document.getElementById('badgeAchievementModal');
      const iconEl = document.getElementById('badgeModalIcon');
      const nameEl = document.getElementById('badgeModalName');
      const descEl = document.getElementById('badgeModalDescription');

      if (!modal || !iconEl || !nameEl || !descEl) return;

      iconEl.textContent = badge.icon;
      nameEl.textContent = badge.name;
      descEl.textContent = badge.description;

      modal.classList.add('show');
      fireBadgeConfetti();
    }

    function closeBadgeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('badgeAchievementModal');
      if (modal) modal.classList.remove('show');
    }

    // ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤ºã‚’æ›´æ–°
    function updateStreakDisplay(streak) {
      const displays = [
        { container: 'streakDisplay', count: 'streakCount' },
        { container: 'streakDisplayFull', count: 'streakCountFull' }
      ];

      displays.forEach(({ container, count }) => {
        const containerEl = document.getElementById(container);
        const countEl = document.getElementById(count);

        if (!containerEl || !countEl) return;

        if (streak >= 2) {
          countEl.textContent = streak;
          containerEl.style.display = 'flex';

          // é€£å‹æ•°ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
          if (streak >= 10) {
            containerEl.style.background = 'linear-gradient(135deg, #ff0000 0%, #ff6b35 100%)';
          } else if (streak >= 5) {
            containerEl.style.background = 'linear-gradient(135deg, #ff6b35 0%, #f7931e 100%)';
          } else {
            containerEl.style.background = 'linear-gradient(135deg, #f7931e 0%, #ffd93d 100%)';
          }
        } else {
          containerEl.style.display = 'none';
        }
      });
    }

    // æ–°ã—ã„ãƒãƒƒã‚¸ã‚’é †ç•ªã«è¡¨ç¤º
    let newBadgeQueue = [];
    let isShowingBadge = false;

    function processNewBadgeQueue() {
      if (isShowingBadge || newBadgeQueue.length === 0) return;

      isShowingBadge = true;
      const badge = newBadgeQueue.shift();
      showBadgeModal(badge);

      // 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã¦æ¬¡ã¸
      setTimeout(() => {
        closeBadgeModal();
        setTimeout(() => {
          isShowingBadge = false;
          processNewBadgeQueue();
        }, 500);
      }, 5000);
    }

    function queueNewBadge(badge) {
      newBadgeQueue.push(badge);
      processNewBadgeQueue();
    }

    function renderBadges(badgeData) {
      const container = document.getElementById('badgeContainer');
      const countDisplay = document.getElementById('badgeCountDisplay');
      const nextBadgeInfo = document.getElementById('nextBadgeInfo');

      if (countDisplay) countDisplay.textContent = `ï¼ˆ${badgeData.earnedCount}/${badgeData.totalCount}ï¼‰`;

      // ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤ºã‚’æ›´æ–°
      updateStreakDisplay(badgeData.winStreak || 0);

      // æ–°è¦ç²å¾—ãƒãƒƒã‚¸ã‚’æ¤œå‡º
      const savedBadgeIds = getSavedBadgeIds();
      const currentBadgeIds = badgeData.earned.map(b => b.id);
      const newBadges = badgeData.earned.filter(b => !savedBadgeIds.includes(b.id));

      // æ–°ã—ã„ãƒãƒƒã‚¸ãŒã‚ã‚Œã°ç¥ç¦
      if (newBadges.length > 0) {
        saveBadgeIds(currentBadgeIds);
        newBadges.forEach(badge => queueNewBadge(badge));
      }

      if (container) {
        if (badgeData.earned.length === 0) {
          container.innerHTML = '<p class="no-data">ã¾ã ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¦ã„ã¾ã›ã‚“ã€‚é ‘å¼µã‚ã†ï¼</p>';
        } else {
          let html = '';
          badgeData.earned.slice(0, 8).forEach(badge => {
            const isNew = newBadges.some(nb => nb.id === badge.id);
            html += `
              <div class="badge-item${isNew ? ' new-badge' : ''}" title="${badge.description}">
                <span class="badge-icon">${badge.icon}</span>
                <span class="badge-name">${badge.name}</span>
              </div>
            `;
          });
          container.innerHTML = html;
        }
      }

      // æ¬¡ã®ãƒãƒƒã‚¸æƒ…å ±
      google.script.run
        .withSuccessHandler(function(encouragement) {
          if (nextBadgeInfo && encouragement.nextBadge) {
            nextBadgeInfo.textContent = encouragement.nextBadge.message;
          }
        })
        .withFailureHandler(console.error)
        .getBuddyEncouragement(currentUser.staffId);
    }

    // ========== ã‚·ãƒ•ãƒˆç®¡ç† ==========
    let currentShiftWeek = null;
    let shiftTimeSlots = [];
    const weekdayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];

    function loadShiftPage() {
      // æ™‚é–“å¸¯ãƒªã‚¹ãƒˆã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(slots) {
          shiftTimeSlots = slots;
          initShiftWeek();
        })
        .withFailureHandler(function(error) {
          console.error('æ™‚é–“å¸¯å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          shiftTimeSlots = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30',
                          '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30',
                          '17:00', '17:30', '18:00'];
          initShiftWeek();
        })
        .getShiftTimeSlots();
    }

    function initShiftWeek() {
      google.script.run
        .withSuccessHandler(function(monday) {
          currentShiftWeek = monday;
          updateShiftWeekLabel();
          loadPersonalShift();
          if (currentUser && (currentUser.role === 'ãƒªãƒ¼ãƒ€ãƒ¼' || currentUser.role === 'ã‚ªãƒ¼ãƒŠãƒ¼' || currentUser.role === 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…')) {
            document.getElementById('shiftAdminSection').style.display = 'block';
            loadWeeklyShifts();
          }
        })
        .withFailureHandler(function(error) {
          console.error('é€±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getCurrentWeekMonday();
    }

    function changeShiftWeek(direction) {
      const func = direction > 0 ? 'getNextWeekMonday' : 'getPrevWeekMonday';
      google.script.run
        .withSuccessHandler(function(newWeek) {
          currentShiftWeek = newWeek;
          updateShiftWeekLabel();
          loadPersonalShift();
          if (document.getElementById('shiftAdminSection').style.display !== 'none') {
            loadWeeklyShifts();
          }
        })
        .withFailureHandler(function(error) {
          console.error('é€±å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
        })[func](currentShiftWeek);
    }

    function updateShiftWeekLabel() {
      safeSetText('shiftWeekLabel', currentShiftWeek + ' é€±');
    }

    function loadPersonalShift() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(data) {
          renderPersonalShiftGrid(data.shifts);
        })
        .withFailureHandler(function(error) {
          console.error('ã‚·ãƒ•ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getMyShift(currentUser.staffId, currentShiftWeek);
    }

    function renderPersonalShiftGrid(shifts) {
      const grid = document.getElementById('personalShiftGrid');
      let html = '';

      weekdayNames.forEach((day, index) => {
        const isWeekend = index >= 5;
        const existingShift = shifts.find(s => s['æ›œæ—¥'] === day);

        html += `
          <div class="shift-day-card">
            <div class="shift-day-header ${isWeekend ? 'weekend' : ''}">${day}</div>
            ${renderShiftTimeInputs(day, existingShift)}
          </div>
        `;
      });

      grid.innerHTML = html;
    }

    function renderShiftTimeInputs(day, existingShift) {
      let html = '';
      const slotOptions = '<option value="">-</option>' +
        shiftTimeSlots.map(t => `<option value="${t}">${t}</option>`).join('');

      for (let i = 1; i <= 3; i++) {
        const startVal = existingShift ? existingShift[`æ™‚é–“å¸¯${i}_é–‹å§‹`] || '' : '';
        const endVal = existingShift ? existingShift[`æ™‚é–“å¸¯${i}_çµ‚äº†`] || '' : '';

        html += `
          <div class="shift-time-slot">
            <label>æ™‚é–“å¸¯${i}</label>
            <div class="shift-time-row">
              <select id="shift-${day}-${i}-start" onchange="updateShiftEndOptions('${day}', ${i})">
                ${slotOptions.replace(`value="${startVal}"`, `value="${startVal}" selected`)}
              </select>
              <span>ã€œ</span>
              <select id="shift-${day}-${i}-end">
                ${slotOptions.replace(`value="${endVal}"`, `value="${endVal}" selected`)}
              </select>
            </div>
          </div>
        `;
      }

      return html;
    }

    function updateShiftEndOptions(day, slot) {
      const startSelect = document.getElementById(`shift-${day}-${slot}-start`);
      const endSelect = document.getElementById(`shift-${day}-${slot}-end`);
      const startVal = startSelect.value;

      if (!startVal) {
        endSelect.value = '';
        return;
      }

      // é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã®æ™‚é–“ã®ã¿é¸æŠå¯èƒ½ã«
      Array.from(endSelect.options).forEach(opt => {
        if (opt.value && opt.value <= startVal) {
          opt.disabled = true;
        } else {
          opt.disabled = false;
        }
      });
    }

    function savePersonalShift() {
      if (!currentUser || !currentUser.staffId) {
        showToastError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      const weeklyShifts = {};

      weekdayNames.forEach(day => {
        const shifts = {};
        let hasShift = false;

        for (let i = 1; i <= 3; i++) {
          const start = document.getElementById(`shift-${day}-${i}-start`).value;
          const end = document.getElementById(`shift-${day}-${i}-end`).value;

          if (start && end) {
            shifts[`æ™‚é–“å¸¯${i}`] = { é–‹å§‹: start, çµ‚äº†: end };
            hasShift = true;
          }
        }

        if (hasShift) {
          weeklyShifts[day] = shifts;
        }
      });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast(`ã‚·ãƒ•ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ${result.savedCount}ä»¶ï¼‰`);
            loadPersonalShift();
            if (document.getElementById('shiftAdminSection').style.display !== 'none') {
              loadWeeklyShifts();
            }
          } else {
            showToastError('ã‚·ãƒ•ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ã‚·ãƒ•ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          showToastError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .saveWeeklyShift(currentUser.staffId, currentShiftWeek, weeklyShifts);
    }

    function loadWeeklyShifts() {
      // æå‡ºçŠ¶æ³ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(status) {
          safeSetText('shiftSubmissionRate', status.submissionRate + '%');
          safeSetText('shiftSubmittedCount', status.submittedCount);
          safeSetText('shiftTotalCount', status.totalCount);
        })
        .withFailureHandler(console.error)
        .getShiftSubmissionStatus(currentShiftWeek);

      // é€±é–“ã‚·ãƒ•ãƒˆã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(data) {
          renderWeeklyShiftTable(data);
        })
        .withFailureHandler(function(error) {
          console.error('é€±é–“ã‚·ãƒ•ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          safeSetHtml('weeklyShiftTable', '<p class="no-data">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>');
        })
        .getWeeklyShifts(currentShiftWeek);
    }

    function renderWeeklyShiftTable(data) {
      const container = document.getElementById('weeklyShiftTable');

      if (!data.shifts || data.shifts.length === 0) {
        container.innerHTML = '<p class="no-data">ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      let html = `
        <table class="shift-table">
          <thead>
            <tr>
              <th>æ‹…å½“è€…</th>
              ${weekdayNames.map(d => `<th>${d}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
      `;

      data.shifts.forEach(staff => {
        html += `<tr><td class="staff-name">${staff.æ‹…å½“è€…å}</td>`;

        weekdayNames.forEach(day => {
          const dayShift = staff.shifts[day];
          html += '<td class="shift-cell">';

          if (dayShift) {
            ['æ™‚é–“å¸¯1', 'æ™‚é–“å¸¯2', 'æ™‚é–“å¸¯3'].forEach(slot => {
              if (dayShift[slot]) {
                html += `<span class="shift-time-badge">${dayShift[slot].é–‹å§‹}-${dayShift[slot].çµ‚äº†}</span>`;
              }
            });
          } else {
            html += '<span class="shift-empty">-</span>';
          }

          html += '</td>';
        });

        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function loadAdminSettings() {
      // é€šçŸ¥è¨­å®šã‚’èª­ã¿è¾¼ã¿
      google.script.run
        .withSuccessHandler(function(settings) {
          if (settings) {
            safeSetValue('adminDiscordWebhook', settings.discordWebhook || '');
            safeSetValue('adminPmoUrl', settings.pmoUrl || '');
            safeSetValue('adminGithubUrl', settings.githubUrl || '');

            if (settings.hasPassword) {
              safeSetText('passwordStatus', 'ç¾åœ¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚');
            } else {
              safeSetText('passwordStatus', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæœªè¨­å®šã§ã™ã€‚æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
              safeSetStyle('passwordStatus', 'color', '#c92a2a');
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('ç®¡ç†è€…è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        })
        .getAdminSettings();

      // æ¨©é™å®šç¾©ã‚’èª­ã¿è¾¼ã¿
      google.script.run
        .withSuccessHandler(function(defs) {
          permissionDefinitions = defs;
        })
        .getPermissionDefinitions();

      // å½¹å‰²ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      loadRoles();
    }

    function loadRoles() {
      google.script.run
        .withSuccessHandler(function(roles) {
          renderRolesTable(roles);
        })
        .withFailureHandler(function(error) {
          console.error('å½¹å‰²ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
          safeSetHtml('rolesTableBody',
            '<tr><td colspan="2" style="color: red;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>');
        })
        .getRoles();
    }

    function renderRolesTable(roles) {
      const tbody = document.getElementById('rolesTableBody');
      if (!roles || roles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2">å½¹å‰²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      tbody.innerHTML = roles.map(role => {
        const isOwner = role.name === 'ã‚ªãƒ¼ãƒŠãƒ¼';
        return `
          <tr>
            <td>${role.name}</td>
            <td>
              <button class="btn btn-primary" style="padding: 4px 12px; font-size: 12px; margin-right: 8px;" onclick="openRoleModal('${role.name}')">ç·¨é›†</button>
              ${!isOwner ? `<button class="btn btn-delete" style="padding: 4px 12px; font-size: 12px;" onclick="deleteRoleConfirm('${role.name}')">å‰Šé™¤</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    function saveNotificationSettings() {
      const settings = {
        discordWebhook: document.getElementById('adminDiscordWebhook').value.trim(),
        pmoUrl: document.getElementById('adminPmoUrl').value.trim(),
        githubUrl: document.getElementById('adminGithubUrl').value.trim()
      };

      showLoading();
      google.script.run
        .withSuccessHandler(function() {
          hideLoading();
          safeSetText('notificationSaveStatus', 'ä¿å­˜ã—ã¾ã—ãŸ');
          setTimeout(function() {
            safeSetText('notificationSaveStatus', '');
          }, 3000);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .saveNotificationSettings(settings);
    }

    function saveAdminPassword() {
      const newPassword = safeGetValue('adminNewPassword');
      const confirmPassword = safeGetValue('adminConfirmPassword');

      if (!newPassword) {
        showToastWarning('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (newPassword !== confirmPassword) {
        showToastWarning('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
        return;
      }

      if (newPassword.length < 4) {
        showToastWarning('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function() {
          hideLoading();
          safeSetValue('adminNewPassword', '');
          safeSetValue('adminConfirmPassword', '');
          safeSetText('passwordSaveStatus', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
          safeSetText('passwordStatus', 'ç¾åœ¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚');
          safeSetStyle('passwordStatus', 'color', '#666');
          setTimeout(function() {
            safeSetText('passwordSaveStatus', '');
          }, 3000);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToastError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .saveAdminPassword(newPassword);
    }

    function forceResetSettings() {
      const password = prompt('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (password === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            safeSetText('resetStatus', 'ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            safeSetStyle('resetStatus', 'color', 'green');
            setTimeout(function() {
              safeSetText('resetStatus', '');
            }, 3000);
          } else {
            safeSetText('resetStatus', result.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            safeSetStyle('resetStatus', 'color', '#c92a2a');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          safeSetText('resetStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
          safeSetStyle('resetStatus', 'color', '#c92a2a');
        })
        .forceResetWithPassword(password);
    }

    // ========== æ¨©é™ç®¡ç† ==========
    let currentEditRole = null;

    function openRoleModal(roleName) {
      currentEditRole = null;
      safeSetValue('roleOriginalName', '');
      safeSetValue('roleNameInput', '');

      const nameInput = document.getElementById('roleNameInput');

      if (roleName) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã®å½¹å‰²ã‚’èª­ã¿è¾¼ã¿
        safeSetText('roleEditModalTitle', 'æ¨©é™ç·¨é›†: ' + roleName);
        safeSetValue('roleOriginalName', roleName);
        safeSetValue('roleNameInput', roleName);

        // ã‚ªãƒ¼ãƒŠãƒ¼ã®å ´åˆã¯åå‰å¤‰æ›´ä¸å¯
        if (nameInput) {
          nameInput.disabled = (roleName === 'ã‚ªãƒ¼ãƒŠãƒ¼');
        }

        // å½¹å‰²ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        google.script.run
          .withSuccessHandler(function(roles) {
            const role = roles.find(r => r.name === roleName);
            if (role) {
              currentEditRole = role;
              renderPermissionCheckboxes(role.permissions);
            }
          })
          .getRoles();
      } else {
        // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
        safeSetText('roleEditModalTitle', 'æ–°è¦å½¹å‰²ä½œæˆ');
        if (nameInput) nameInput.disabled = false;
        renderPermissionCheckboxes({});
      }

      const modal = document.getElementById('roleEditModal');
      if (modal) modal.classList.add('active');
    }

    function closeRoleModal() {
      const modal = document.getElementById('roleEditModal');
      if (modal) modal.classList.remove('active');
      currentEditRole = null;
    }

    function renderPermissionCheckboxes(currentPermissions) {
      const container = document.getElementById('permissionGroups');

      if (!permissionDefinitions) {
        container.innerHTML = '<p style="color: #666;">æ¨©é™å®šç¾©ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
        return;
      }

      let html = '';
      Object.keys(permissionDefinitions).forEach(groupKey => {
        const group = permissionDefinitions[groupKey];
        html += `
          <div style="margin-bottom: 20px; padding: 12px; background: #e9ecef; border-radius: 4px;">
            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">${group.label}</h4>
        `;

        group.items.forEach(item => {
          const checked = currentPermissions[item.key] ? 'checked' : '';
          html += `
            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
              <input type="checkbox" id="perm_${item.key}" ${checked} style="margin-right: 8px;">
              ${item.label}
            </label>
          `;
        });

        html += '</div>';
      });

      container.innerHTML = html;
    }

    function saveRoleFromModal() {
      const name = document.getElementById('roleNameInput').value.trim();
      const originalName = document.getElementById('roleOriginalName').value;

      if (!name) {
        showToastWarning('å½¹å‰²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // æ¨©é™ã‚’åé›†
      const permissions = {};
      if (permissionDefinitions) {
        Object.keys(permissionDefinitions).forEach(groupKey => {
          permissionDefinitions[groupKey].items.forEach(item => {
            const checkbox = document.getElementById('perm_' + item.key);
            permissions[item.key] = checkbox ? checkbox.checked : false;
          });
        });
      }

      const roleData = {
        name: name,
        originalName: originalName || name,
        permissions: permissions
      };

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            closeRoleModal();
            loadRoles();
          } else {
            showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || ''));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .saveRole(roleData);
    }

    function deleteRoleConfirm(roleName) {
      if (!confirm('å½¹å‰²ã€Œ' + roleName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            loadRoles();
          } else {
            showToastError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || ''));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToastError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .deleteRole(roleName);
    }

    // ========== æ‹…å½“è€…ç®¡ç† ==========

    function loadStaffData() {
      // å½¹å‰²åä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆã¾ã èª­ã¿è¾¼ã‚“ã§ã„ãªã‘ã‚Œã°ï¼‰
      if (!cache.roleNames) {
        google.script.run
          .withSuccessHandler(function(names) {
            cache.roleNames = names;
            populateStaffRoleSelect();
          })
          .getRoleNames();
      }

      // æ‹…å½“è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      google.script.run
        .withSuccessHandler(function(data) {
          cache.staff = data;
          renderStaffTable();
        })
        .withFailureHandler(function(error) {
          console.error('æ‹…å½“è€…ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
          document.getElementById('staffTableBody').innerHTML =
            '<tr><td colspan="7" style="color: red;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
        })
        .getStaffWithRoles();
    }

    function populateStaffRoleSelect() {
      const select = document.getElementById('staffRole');
      if (!select || !cache.roleNames) return;

      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      cache.roleNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
    }

    function renderStaffTable() {
      const tbody = document.getElementById('staffTableBody');
      const staff = cache.staff;

      if (!staff || staff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px;">æ‹…å½“è€…ãŒã„ã¾ã›ã‚“</td></tr>';
        return;
      }

      let html = '';
      staff.forEach(s => {
        const isOwner = s['å½¹å‰²'] === 'ã‚ªãƒ¼ãƒŠãƒ¼';
        const statusBadge = s['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'æœ‰åŠ¹'
          ? '<span class="badge badge-high">æœ‰åŠ¹</span>'
          : '<span class="badge badge-low">ç„¡åŠ¹</span>';

        html += `
          <tr>
            <td>${s['æ‹…å½“è€…ID'] || '-'}</td>
            <td>${getStaffDisplayNameForIndex(s)}</td>
            <td>${s['ãƒ¡ãƒ¼ãƒ«'] || '-'}</td>
            <td>${s['Discord ID'] || '-'}</td>
            <td>${s['å½¹å‰²'] || '-'}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-primary" style="padding: 4px 12px; font-size: 12px; margin-right: 8px;" onclick="openStaffModal('${s['æ‹…å½“è€…ID']}')">ç·¨é›†</button>
              ${!isOwner ? `<button class="btn btn-delete" style="padding: 4px 12px; font-size: 12px;" onclick="deleteStaffConfirm('${s['æ‹…å½“è€…ID']}')">å‰Šé™¤</button>` : ''}
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    function openStaffModal(staffId) {
      // å½¹å‰²ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒæœªèª­ã¿è¾¼ã¿ã®å ´åˆã¯èª­ã¿è¾¼ã¿
      if (!cache.roleNames) {
        google.script.run
          .withSuccessHandler(function(names) {
            cache.roleNames = names;
            populateStaffRoleSelect();
            openStaffModalInternal(staffId);
          })
          .getRoleNames();
      } else {
        populateStaffRoleSelect();
        openStaffModalInternal(staffId);
      }
    }

    function openStaffModalInternal(staffId) {
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      safeSetValue('staffEditId', '');
      safeSetValue('staffIdDisplay', '');
      safeSetValue('staffNameJa', '');
      safeSetValue('staffNameEn', '');
      safeSetValue('staffEmail', '');
      safeSetValue('staffDiscordId', '');
      safeSetValue('staffRole', '');
      safeSetValue('staffStatus', 'æœ‰åŠ¹');
      safeSetValue('staffCandidateId', '');

      if (staffId) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        safeSetText('staffEditModalTitle', 'æ‹…å½“è€…ç·¨é›†');
        const staff = cache.staff.find(s => s['æ‹…å½“è€…ID'] === staffId);
        if (staff) {
          safeSetValue('staffEditId', staff['æ‹…å½“è€…ID']);
          safeSetValue('staffIdDisplay', staff['æ‹…å½“è€…ID']);
          // æ–°å½¢å¼ï¼ˆè‹—å­—/åå‰åˆ†é›¢ï¼‰ã¨æ—§å½¢å¼ï¼ˆæ°åçµ±åˆï¼‰ã®ä¸¡æ–¹ã«å¯¾å¿œ
          safeSetValue('staffNameJa', getStaffDisplayNameForIndex(staff));
          safeSetValue('staffNameEn', getStaffEnglishNameForIndex(staff));
          safeSetValue('staffEmail', staff['ãƒ¡ãƒ¼ãƒ«'] || '');
          safeSetValue('staffDiscordId', staff['Discord ID'] || '');
          safeSetValue('staffRole', staff['å½¹å‰²'] || '');
          safeSetValue('staffStatus', staff['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] || 'æœ‰åŠ¹');
          safeSetValue('staffCandidateId', staff['å…ƒå€™è£œè€…ID'] || '');
        }
      } else {
        // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
        safeSetText('staffEditModalTitle', 'æ‹…å½“è€…è¿½åŠ ');
        safeSetValue('staffIdDisplay', 'ï¼ˆè‡ªå‹•æ¡ç•ªï¼‰');
      }

      const modal = document.getElementById('staffEditModal');
      if (modal) modal.classList.add('active');
    }

    function closeStaffModal() {
      const modal = document.getElementById('staffEditModal');
      if (modal) modal.classList.remove('active');
    }

    function saveStaffFromModal() {
      const staffId = safeGetValue('staffEditId');
      const nameJa = safeGetValue('staffNameJa').trim();
      const nameEn = safeGetValue('staffNameEn').trim();
      const email = safeGetValue('staffEmail').trim();
      const discordId = safeGetValue('staffDiscordId').trim();
      const role = document.getElementById('staffRole').value;
      const status = document.getElementById('staffStatus').value;
      const candidateId = document.getElementById('staffCandidateId').value.trim();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!nameJa) {
        showToastWarning('æ°åï¼ˆæ—¥æœ¬èªï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!role) {
        showToastWarning('å½¹å‰²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // æ–°å½¢å¼ï¼ˆè‹—å­—/åå‰åˆ†é›¢ï¼‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      // æ—¥æœ¬èªåã‚’åˆ†å‰²ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚Œã°åˆ†å‰²ã€ãªã‘ã‚Œã°å…¨ä½“ã‚’åå‰ã¨ã—ã¦æ‰±ã†ï¼‰
      const jaNameParts = splitNameForSave(nameJa, 'ja');
      const enNameParts = splitNameForSave(nameEn, 'en');

      const staffData = {
        'è‹—å­—ï¼ˆæ—¥æœ¬èªï¼‰': jaNameParts.family,
        'åå‰ï¼ˆæ—¥æœ¬èªï¼‰': jaNameParts.given,
        'è‹—å­—ï¼ˆè‹±èªï¼‰': enNameParts.family,
        'åå‰ï¼ˆè‹±èªï¼‰': enNameParts.given,
        'ãƒ¡ãƒ¼ãƒ«': email,
        'Discord ID': discordId,
        'å½¹å‰²': role,
        'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': status,
        'å…ƒå€™è£œè€…ID': candidateId
      };

      showLoading();

      if (staffId) {
        // æ›´æ–°
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              closeStaffModal();
              loadStaffData();
            } else {
              showToastError('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || ''));
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showToastError('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .updateStaff(staffId, staffData);
      } else {
        // æ–°è¦è¿½åŠ 
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              showToast('æ‹…å½“è€…ã€Œ' + result.staffId + 'ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
              closeStaffModal();
              loadStaffData();
            } else {
              showToastError('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || ''));
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showToastError('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .addStaff(staffData);
      }
    }

    function deleteStaffConfirm(staffId) {
      if (!confirm('æ‹…å½“è€…ã€Œ' + staffId + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            loadStaffData();
          } else {
            showToastError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || ''));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToastError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .deleteStaff(staffId);
    }

    // ========== Buddyæ©Ÿèƒ½ ==========

    // Buddyã‚«ãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–
    function initBuddyCard(suffix) {
      suffix = suffix || '';
      if (!currentUser || !currentUser.staffName) return;

      // æ—¥æ›¿ã‚ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆå„ªå…ˆï¼‰
      google.script.run
        .withSuccessHandler(function(message) {
          if (message) {
            safeSetHtml('buddyMessage' + suffix, message.replace(/\n/g, '<br>'));
          }
        })
        .withFailureHandler(function(error) {
          console.error('æ—¥æ›¿ã‚ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getTodayBuddyMessage(currentUser.staffId);

      // åŸºæœ¬ã®Buddyãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ãªã©ï¼‰
      google.script.run
        .withSuccessHandler(function(data) {
          updateBuddyCard(data, suffix);
        })
        .withFailureHandler(function(error) {
          console.error('Buddyãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getBuddyData(currentUser.staffName);

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚µãƒãƒªãƒ¼ã‚‚å–å¾—
      loadBuddyDashboardSummary(suffix);
    }

    // Buddyãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚µãƒãƒªãƒ¼ã‚’èª­ã¿è¾¼ã‚€
    function loadBuddyDashboardSummary(suffix) {
      suffix = suffix || '';
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(summary) {
          renderBuddyDashboardSummary(summary, suffix);
        })
        .withFailureHandler(function(error) {
          console.error('Buddyã‚µãƒãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getBuddyDashboardSummary(currentUser.staffId);
    }

    // Buddyãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚µãƒãƒªãƒ¼ã‚’æç”»
    function renderBuddyDashboardSummary(summary, suffix) {
      suffix = suffix || '';

      if (!summary || !summary.success) return;

      // Buddyãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
      const messageEl = document.getElementById('buddyMessage' + suffix);
      if (summary.buddyMessage && messageEl) {
        messageEl.textContent = summary.buddyMessage;
      }

      // ç›®æ¨™ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
      const badgeEl = document.getElementById('buddyGoalBadge' + suffix);
      const progressBadgeEl = document.getElementById('buddyGoalProgress' + suffix);
      if (summary.progress !== null && badgeEl) {
        badgeEl.style.display = 'block';
        if (progressBadgeEl) progressBadgeEl.textContent = summary.progress + '%';
      }

      // ä»Šé€±ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¡¨ç¤º
      const focusSection = document.getElementById('buddyFocusSection' + suffix);
      const focusContent = document.getElementById('buddyFocusContent' + suffix);
      if (summary.weeklyFocus && focusSection) {
        focusSection.style.display = 'block';
        if (focusContent) focusContent.textContent = summary.weeklyFocus;
      }

      // é€²æ—ãƒãƒ¼ã‚’è¡¨ç¤º
      const progressSection = document.getElementById('buddyProgressSection' + suffix);
      const progressLabel = document.getElementById('buddyProgressLabel' + suffix);
      const progressFill = document.getElementById('buddyProgressFill' + suffix);

      if (summary.goal && summary.metrics && progressSection) {
        progressSection.style.display = 'block';
        const current = summary.metrics.closedWon || 0;
        const target = summary.goal['æˆç´„ç›®æ¨™'] || 0;
        if (progressLabel) progressLabel.textContent = current + '/' + target + 'ä»¶';

        const pct = summary.progress || 0;
        if (progressFill) {
          progressFill.style.width = Math.min(pct, 100) + '%';

          // é€²æ—ã«å¿œã˜ãŸè‰²
          progressFill.classList.remove('progress-low', 'progress-medium', 'progress-high');
          if (pct >= 80) {
            progressFill.classList.add('progress-high');
          } else if (pct >= 50) {
            progressFill.classList.add('progress-medium');
          } else if (pct > 0) {
            progressFill.classList.add('progress-low');
          }
        }
      }
    }

    // Buddyå£æ‰“ã¡ãƒšãƒ¼ã‚¸ã«ç§»å‹•
    function navigateToBuddyCoaching() {
      switchPage('buddy-coaching');
    }

    // Buddyã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
    function updateBuddyCard(data, suffix) {
      suffix = suffix || '';
      const messageEl = document.getElementById('buddyMessage' + suffix);
      const actionsSection = document.getElementById('buddyActionsSection' + suffix);
      const actionList = document.getElementById('buddyActionList' + suffix);

      // æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚µãƒãƒªãƒ¼ã§ä¸Šæ›¸ãã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
      if (messageEl && messageEl.textContent === 'èª­ã¿è¾¼ã¿ä¸­...') {
        messageEl.textContent = data.greeting || 'ãŠã¯ã‚ˆã†ã€ä»Šæ—¥ã‚‚ã‚ˆã‚ã—ãã€‚';
      }

      // ä»Šæ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      if (data.todayActions && data.todayActions.length > 0) {
        actionsSection.style.display = 'block';
        actionList.innerHTML = '';

        data.todayActions.forEach(function(action) {
          const li = document.createElement('li');
          li.className = 'buddy-action-item' + (action.urgent ? ' buddy-action-urgent' : '');
          li.innerHTML =
            '<span class="buddy-action-customer">' + action.customer + ':</span>' +
            '<span class="buddy-action-text">' + action.action + '</span>' +
            (action.urgent ? '<span class="buddy-action-badge urgent">ä»Šæ—¥æœŸé™</span>' : '');
          actionList.appendChild(li);
        });
      } else {
        actionsSection.style.display = 'none';
      }
    }

    // ========== ä¾å­˜æ€§UI: ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰è¡¨ç¤º ==========
    let completedReminders = new Set(); // å®Œäº†æ¸ˆã¿ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¿½è·¡
    const MAX_VISIBLE_REMINDERS = 5;

    function renderReminderCards(reminders) {
      const section = document.getElementById('buddyActionsSectionFull');
      const listContainer = document.getElementById('buddyActionListFull');
      const progressText = document.getElementById('reminderProgressText');
      const progressFill = document.getElementById('reminderProgressFill');
      const moreBtn = document.getElementById('reminderMoreBtn');
      const moreCount = document.getElementById('reminderMoreCount');

      if (!section || !listContainer) return;

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å¸¸ã«è¡¨ç¤ºï¼ˆå›ºå®šï¼‰
      section.style.display = 'block';
      listContainer.innerHTML = '';

      // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      if (!reminders || reminders.length === 0) {
        if (progressText) progressText.textContent = '0/0 å®Œäº†';
        if (progressFill) progressFill.style.width = '0%';
        listContainer.innerHTML = '<div class="reminder-empty">ç›´è¿‘ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å•†è«‡ç®¡ç†ã‹ã‚‰æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚</div>';
        if (moreBtn) moreBtn.style.display = 'none';
        return;
      }

      // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°
      const totalCount = reminders.length;
      const completedCount = Array.from(completedReminders).filter(id =>
        reminders.some(r => r.leadId === id)
      ).length;

      if (progressText) {
        progressText.textContent = completedCount + '/' + totalCount + ' å®Œäº†';
      }
      if (progressFill) {
        const percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        progressFill.style.width = percent + '%';
        // å®Œäº†åº¦ã«å¿œã˜ã¦è‰²ã‚’å¤‰åŒ–
        if (percent >= 100) {
          progressFill.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
        } else if (percent >= 50) {
          progressFill.style.background = 'linear-gradient(135deg, #3b82f6, #60a5fa)';
        }
      }

      // è¡¨ç¤ºã™ã‚‹ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆæœ€å¤§5ä»¶ï¼‰
      const visibleReminders = reminders.slice(0, MAX_VISIBLE_REMINDERS);
      const hiddenCount = reminders.length - MAX_VISIBLE_REMINDERS;

      visibleReminders.forEach((reminder, index) => {
        const isCompleted = completedReminders.has(reminder.leadId);
        const card = document.createElement('div');
        card.className = 'reminder-card priority-' + reminder.priority + (isCompleted ? ' completed' : '');
        card.id = 'reminder-' + reminder.leadId;

        // å„ªå…ˆåº¦ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³
        let priorityIcon = 'ğŸ“‹';
        if (reminder.waitingType === 'waiting_reply') priorityIcon = 'ğŸ’¬';
        else if (reminder.waitingType === 'waiting_confirm') priorityIcon = 'â“';
        else if (reminder.priority === 'overdue') priorityIcon = 'ğŸ”´';
        else if (reminder.priority === 'today') priorityIcon = 'â°';
        else if (reminder.priority === 'tomorrow') priorityIcon = 'ğŸ“…';
        else if (reminder.priority === 'week') priorityIcon = 'ğŸ“†';
        else if (reminder.priority === 'pending') priorityIcon = 'â³';

        card.innerHTML = `
          <div class="reminder-checkbox ${isCompleted ? 'checked' : ''}" onclick="toggleReminderComplete('${reminder.leadId}', event)">
            ${isCompleted ? 'âœ“' : ''}
          </div>
          <div class="reminder-content" onclick="openDealSlidePanelFromDashboard('${reminder.leadId}')">
            <div class="reminder-customer">${priorityIcon} ${escapeHtml(reminder.customer)}</div>
            <div class="reminder-action">${escapeHtml(reminder.action)}</div>
          </div>
          <div class="reminder-date priority-${reminder.priority}">${reminder.date}</div>
        `;
        listContainer.appendChild(card);
      });

      // ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³
      if (moreBtn && moreCount) {
        if (hiddenCount > 0) {
          moreBtn.style.display = 'block';
          moreCount.textContent = hiddenCount;
        } else {
          moreBtn.style.display = 'none';
        }
      }
    }

    function toggleReminderComplete(leadId, event) {
      event.stopPropagation();
      const card = document.getElementById('reminder-' + leadId);
      const checkbox = card ? card.querySelector('.reminder-checkbox') : null;

      if (completedReminders.has(leadId)) {
        completedReminders.delete(leadId);
        if (card) card.classList.remove('completed');
        if (checkbox) {
          checkbox.classList.remove('checked');
          checkbox.textContent = '';
        }
      } else {
        completedReminders.add(leadId);
        if (card) {
          card.classList.add('completing');
          setTimeout(() => {
            card.classList.remove('completing');
            card.classList.add('completed');
          }, 400);
        }
        if (checkbox) {
          checkbox.classList.add('checked');
          checkbox.textContent = 'âœ“';
        }

        // å®Œäº†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ: BuddyãŒè¤’ã‚ã‚‹
        showBuddyCompletionMessage();
      }

      // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
      updateReminderProgress();
    }

    function updateReminderProgress() {
      const listContainer = document.getElementById('buddyActionListFull');
      const progressText = document.getElementById('reminderProgressText');
      const progressFill = document.getElementById('reminderProgressFill');

      if (!listContainer) return;

      const allCards = listContainer.querySelectorAll('.reminder-card');
      const completedCards = listContainer.querySelectorAll('.reminder-card.completed');
      const totalCount = allCards.length;
      const completedCount = completedCards.length;

      if (progressText) {
        progressText.textContent = completedCount + '/' + totalCount + ' å®Œäº†';
      }
      if (progressFill) {
        const percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        progressFill.style.width = percent + '%';

        if (percent >= 100) {
          progressFill.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
          // å…¨å®Œäº†æ™‚ã®ç‰¹åˆ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
          showBuddyAllCompleteMessage();
        } else if (percent >= 50) {
          progressFill.style.background = 'linear-gradient(135deg, #3b82f6, #60a5fa)';
        }
      }
    }

    function showBuddyCompletionMessage() {
      const messages = [
        'ã„ã„ã­ï¼ä¸€ã¤å®Œäº†ã ã­ï¼',
        'ãã®èª¿å­ï¼',
        'ã‚„ã£ãŸã­ï¼é€²ã‚“ã§ã‚‹ã‚ˆï¼',
        'ä¸€æ­©å‰é€²ï¼',
        'ãƒŠã‚¤ã‚¹ï¼ç¶šã‘ã¦ã„ã“ã†ï¼'
      ];
      const message = messages[Math.floor(Math.random() * messages.length)];
      const messageEl = document.getElementById('buddyMessageFull');
      if (messageEl) {
        messageEl.textContent = message;
        messageEl.style.animation = 'buddyPulse 0.5s ease';
        setTimeout(() => { messageEl.style.animation = ''; }, 500);
      }
    }

    function showBuddyAllCompleteMessage() {
      const messageEl = document.getElementById('buddyMessageFull');
      if (messageEl) {
        messageEl.textContent = 'ğŸ‰ ã™ã”ã„ï¼ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯å…¨éƒ¨å®Œäº†ï¼å›ã¯æœ€é«˜ã ã­ï¼';
        messageEl.style.animation = 'buddyPulse 0.5s ease';
        setTimeout(() => { messageEl.style.animation = ''; }, 500);
      }
    }

    function showAllReminders() {
      // ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼šå…¨ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
      // ä»Šã¯ç°¡æ˜“å®Ÿè£…ï¼š5ä»¶â†’10ä»¶ã«æ‹¡å¼µ
      const listContainer = document.getElementById('buddyActionListFull');
      const moreBtn = document.getElementById('reminderMoreBtn');
      if (moreBtn) moreBtn.style.display = 'none';

      // loadFullPersonalMetrics ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å…¨ä»¶è¡¨ç¤º
      // å®Ÿè£…ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ã ã‘
    }

    // Buddyã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
    let currentAlertData = null;

    function checkBuddyAlertPopup() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(data) {
          if (data.showPopup) {
            currentAlertData = data;
            showBuddyAlertPopup(data);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getBuddyAlertPopup(currentUser.staffId);
    }

    function showBuddyAlertPopup(data) {
      const popup = document.getElementById('buddyAlertPopup');
      const header = document.getElementById('buddyAlertHeader');
      const levelEl = document.getElementById('buddyAlertLevel');
      const messageEl = document.getElementById('buddyAlertMessage');
      const customerEl = document.getElementById('alertCustomerName');
      const situationEl = document.getElementById('alertSituation');
      const countEl = document.getElementById('buddyAlertCount');
      const countNumEl = document.getElementById('alertCountNum');

      if (!popup) return;

      // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
      if (data.alertLevel === 'LEVEL3') {
        if (header) header.classList.add('level3');
        if (levelEl) levelEl.textContent = 'ç·Šæ€¥';
      } else {
        if (header) header.classList.remove('level3');
        if (levelEl) levelEl.textContent = 'æ³¨æ„';
      }

      if (messageEl) messageEl.textContent = data.message;
      if (customerEl) customerEl.textContent = data.alert.é¡§å®¢å || '-';

      // çŠ¶æ³ã‚’è¨­å®š
      if (situationEl) {
        if (data.alert.type === 'overdue_action') {
          situationEl.textContent = data.alert.è¶…éæ—¥æ•° + 'æ—¥æœŸé™è¶…é';
        } else if (data.alert.type === 'long_no_update') {
          situationEl.textContent = data.alert.æœªæ›´æ–°æ—¥æ•° + 'æ—¥é–“æœªæ›´æ–°';
        } else {
          situationEl.textContent = 'é«˜æ¸©åº¦ãƒªãƒ¼ãƒ‰åœæ»';
        }
      }

      // ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆæ•°ã‚’è¡¨ç¤º
      if (countEl) {
        if (data.totalUrgent > 1) {
          countEl.style.display = 'block';
          if (countNumEl) countNumEl.textContent = data.totalUrgent - 1;
        } else {
          countEl.style.display = 'none';
        }
      }

      popup.classList.add('active');
    }

    function closeBuddyAlertPopup() {
      const popup = document.getElementById('buddyAlertPopup');
      if (popup) popup.classList.remove('active');
      currentAlertData = null;
    }

    function handleAlertAction() {
      if (currentAlertData && currentAlertData.alert) {
        // ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèªæ¸ˆã¿ã«ãƒãƒ¼ã‚¯
        google.script.run.markAlertAsRead(currentAlertData.alert.ãƒªãƒ¼ãƒ‰ID);

        // å•†è«‡ç®¡ç†ãƒšãƒ¼ã‚¸ã«ç§»å‹•
        switchPage('deals');
      }
      closeBuddyAlertPopup();
    }

    // Buddyç›¸è«‡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openBuddyChat() {
      document.getElementById('buddyChatModal').classList.add('active');
      const input = document.getElementById('buddyChatInputModal');
      if (input) input.focus();
    }

    // Buddyç›¸è«‡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeBuddyChat() {
      document.getElementById('buddyChatModal').classList.remove('active');
    }

    // Buddyç›¸è«‡ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    function sendBuddyMessageModal() {
      const input = document.getElementById('buddyChatInputModal');
      if (!input) return;
      const message = input.value.trim();
      if (!message) return;

      const container = document.getElementById('buddyChatContainerModal');
      if (container) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'buddy-chat-message user';
        msgDiv.innerHTML = '<div class="buddy-chat-bubble user">' + escapeHtml(message) + '</div>';
        container.appendChild(msgDiv);
      }
      input.value = '';

      // Buddyå¿œç­”ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      google.script.run
        .withSuccessHandler(function(response) {
          if (container && response && response.success) {
            const replyDiv = document.createElement('div');
            replyDiv.className = 'buddy-chat-message';
            replyDiv.innerHTML = '<span class="buddy-chat-avatar">&#129492;</span><div class="buddy-chat-bubble buddy">' + escapeHtml(response.message) + '</div>';
            container.appendChild(replyDiv);
            container.scrollTop = container.scrollHeight;
          }
        })
        .withFailureHandler(function(e) {
          console.error('Buddyå¿œç­”ã‚¨ãƒ©ãƒ¼:', e);
        })
        .generateBuddyCoachingResponseWithKnowledge({
          mode: 'free_talk',
          userMessage: message,
          staffId: currentUser ? currentUser.staffId : '',
          staffName: currentUser ? currentUser.staffName : '',
          conversationLog: ''
        });
    }

    // ========== å•†è«‡ãƒ¬ãƒãƒ¼ãƒˆ V2 ==========

    // ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠè‚¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    var reportDropdownOptions = null;

    // å•†è«‡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openDealReportModal() {
      // å•†è«‡ä¸€è¦§ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¨­å®š
      const select = document.getElementById('reportDealSelect');
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      if (cache.deals && Array.isArray(cache.deals)) {
        cache.deals.forEach(function(deal) {
          // è‡ªåˆ†ã®æ‹…å½“å•†è«‡ã®ã¿è¡¨ç¤º
          if (currentUser && deal['æ‹…å½“è€…'] === currentUser.staffName) {
            const option = document.createElement('option');
            option.value = deal['ãƒªãƒ¼ãƒ‰ID'] || '';
            // é¡§å®¢åãŒæœªç™»éŒ²ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const customerName = deal['é¡§å®¢å'] || '(é¡§å®¢åæœªç™»éŒ²)';
            const leadId = deal['ãƒªãƒ¼ãƒ‰ID'] || '(IDä¸æ˜)';
            option.textContent = customerName + ' (' + leadId + ')';
            option.dataset.country = deal['å›½'] || '';
            option.dataset.products = deal['å–ã‚Šæ‰±ã„ã‚¿ã‚¤ãƒˆãƒ«'] || '';
            select.appendChild(option);
          }
        });
      }

      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reportDealStartDate').value = today;

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetDealReportForm();

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠè‚¢ã‚’å–å¾—
      if (!reportDropdownOptions) {
        google.script.run
          .withSuccessHandler(function(options) {
            reportDropdownOptions = options;
            initializeReportDropdowns(options);
          })
          .getDealReportDropdownOptions();
      } else {
        initializeReportDropdowns(reportDropdownOptions);
      }

      document.getElementById('dealReportModal').classList.add('active');
    }

    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    function initializeReportDropdowns(options) {
      // å›½ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
      var countrySelect = document.getElementById('reportCountry');
      var countrySelectExcluded = document.getElementById('reportCountryExcluded');
      countrySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      countrySelectExcluded.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (options.countries || []).forEach(function(c) {
        countrySelect.innerHTML += '<option value="' + c + '">' + c + '</option>';
        countrySelectExcluded.innerHTML += '<option value="' + c + '">' + c + '</option>';
      });

      // å–ã‚Šæ‰±ã„å•†æãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      var productsDiv = document.getElementById('reportProducts');
      var productsExcludedDiv = document.getElementById('reportProductsExcluded');
      productsDiv.innerHTML = '';
      productsExcludedDiv.innerHTML = '';
      (options.products || []).forEach(function(p) {
        var html = '<label class="checkbox-label"><input type="checkbox" value="' + p + '" onchange="onCheckboxChange(\'products\', this)"> ' + p + '</label>';
        productsDiv.innerHTML += html;
        productsExcludedDiv.innerHTML += html.replace('products', 'productsExcluded');
      });

      // è²©å£²å…ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      var channelsDiv = document.getElementById('reportSalesChannels');
      channelsDiv.innerHTML = '';
      (options.salesChannels || []).forEach(function(c) {
        channelsDiv.innerHTML += '<label class="checkbox-label"><input type="checkbox" value="' + c + '" onchange="onCheckboxChange(\'salesChannels\', this)"> ' + c + '</label>';
      });
    }

    // å•†è«‡é¸æŠæ™‚ã®å‡¦ç†
    function onDealSelect() {
      var select = document.getElementById('reportDealSelect');
      var option = select.options[select.selectedIndex];
      if (option && option.value) {
        // å›½ã‚’è‡ªå‹•è¨­å®š
        if (option.dataset.country) {
          document.getElementById('reportCountry').value = option.dataset.country;
          document.getElementById('reportCountryExcluded').value = option.dataset.country;
        }
      }
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†ï¼ˆãã®ä»–è¡¨ç¤ºåˆ‡æ›¿ï¼‰
    function onCheckboxChange(field, checkbox) {
      if (checkbox.value === 'ãã®ä»–') {
        var inputId = field === 'products' ? 'reportProductsOtherInput' : 'reportSalesChannelsOtherInput';
        document.getElementById(inputId).classList.toggle('visible', checkbox.checked);
      }
    }

    // å•†è«‡çµæœé¸æŠæ™‚ã®å‡¦ç†
    function selectDealResult(btn) {
      document.querySelectorAll('.report-result-btn').forEach(function(b) {
        b.classList.remove('selected');
      });
      btn.classList.add('selected');
      var result = btn.dataset.value;
      document.getElementById('reportDealResult').value = result;

      // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ‡æ›¿
      updateConditionalFields(result);

      // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('reportSubmitBtn').disabled = false;
    }

    // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ‡æ›¿
    function updateConditionalFields(result) {
      // å…¨ã¦ã‚’éè¡¨ç¤º
      document.getElementById('fieldsExcluded').style.display = 'none';
      document.getElementById('fieldsCommon').style.display = 'none';
      document.getElementById('fieldSuccessPoints').style.display = 'none';
      document.getElementById('fieldImprovements').style.display = 'none';
      document.getElementById('fieldNextActionDate').style.display = 'none';
      document.getElementById('fieldReapproachDate').style.display = 'none';
      document.getElementById('fieldPostponeReason').style.display = 'none';

      if (result === 'å¯¾è±¡å¤–') {
        document.getElementById('fieldsExcluded').style.display = 'block';
      } else {
        document.getElementById('fieldsCommon').style.display = 'block';
        if (result === 'æˆç´„') {
          document.getElementById('fieldSuccessPoints').style.display = 'block';
        } else if (result === 'å¤±æ³¨') {
          document.getElementById('fieldImprovements').style.display = 'block';
        } else if (result === 'è¿½å®¢') {
          document.getElementById('fieldNextActionDate').style.display = 'block';
        } else if (result === 'è¦‹é€ã‚Š') {
          document.getElementById('fieldReapproachDate').style.display = 'block';
          document.getElementById('fieldPostponeReason').style.display = 'block';
        }
      }
    }

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³é¸æŠ
    function selectOption(btn) {
      var field = btn.dataset.field;
      var value = btn.dataset.value;
      document.querySelectorAll('[data-field="' + field + '"]').forEach(function(b) {
        b.classList.remove('selected');
      });
      btn.classList.add('selected');
      if (field === 'customerType') {
        document.getElementById('reportCustomerType').value = value;
      } else if (field === 'frequency') {
        document.getElementById('reportFrequency').value = value;
      }
    }

    // è©•ä¾¡é¸æŠ
    function selectRating(type, btn) {
      var groupId = type === 'partnership' ? 'reportPartnershipGroup' : 'reportFeelingGroup';
      document.querySelectorAll('#' + groupId + ' .report-rating-btn').forEach(function(b) {
        b.classList.remove('selected');
      });
      btn.classList.add('selected');
      if (type === 'partnership') {
        document.getElementById('reportPartnership').value = btn.dataset.value;
      }
    }

    // æ‰‹å¿œãˆã‚’é¸æŠ
    function selectFeeling(btn) {
      document.querySelectorAll('.report-feeling-btn').forEach(function(b) {
        b.classList.remove('selected');
      });
      btn.classList.add('selected');
      document.getElementById('reportFeeling').value = btn.dataset.value;
    }

    // ä¸æ˜ãƒœã‚¿ãƒ³
    function setUnknown(fieldId) {
      document.getElementById(fieldId).value = 'ä¸æ˜';
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetDealReportForm() {
      document.getElementById('reportDealResult').value = '';
      document.getElementById('reportFeeling').value = '';
      document.getElementById('reportCustomerType').value = '';
      document.getElementById('reportFrequency').value = '';
      document.getElementById('reportPartnership').value = '';

      document.querySelectorAll('.report-result-btn, .report-feeling-btn, .report-option-btn, .report-rating-btn').forEach(function(btn) {
        btn.classList.remove('selected');
      });

      document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(function(cb) {
        cb.checked = false;
      });

      document.querySelectorAll('.other-detail-input').forEach(function(el) {
        el.classList.remove('visible');
      });

      document.getElementById('fieldsExcluded').style.display = 'none';
      document.getElementById('fieldsCommon').style.display = 'none';
      document.getElementById('buddyFeedbackContainer').style.display = 'none';
      document.getElementById('reportButtonArea').style.display = 'flex';
      document.getElementById('reportSubmitBtn').disabled = true;

      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('#dealReportForm textarea').forEach(function(ta) {
        ta.value = '';
      });
      document.querySelectorAll('#dealReportForm input[type="text"], #dealReportForm input[type="number"]').forEach(function(input) {
        if (input.id !== 'reportDealStartDate') input.value = '';
      });
    }

    // å•†è«‡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeDealReportModal() {
      document.getElementById('dealReportModal').classList.remove('active');
    }

    // é¸æŠã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’å–å¾—
    function getCheckedValues(containerId) {
      var values = [];
      document.querySelectorAll('#' + containerId + ' input[type="checkbox"]:checked').forEach(function(cb) {
        values.push(cb.value);
      });
      return values;
    }

    // å•†è«‡ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ï¼ˆV2ï¼‰
    function submitDealReportV2(event) {
      event.preventDefault();

      var dealId = document.getElementById('reportDealSelect').value;
      var dealResult = document.getElementById('reportDealResult').value;
      var dealStartDate = document.getElementById('reportDealStartDate').value;

      if (!dealId || !dealResult || !dealStartDate) {
        showToastWarning('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      var reportData = {
        dealId: dealId,
        dealResult: dealResult,
        dealStartDate: dealStartDate,
        submitDate: new Date().toISOString().split('T')[0],
        staffId: currentUser ? currentUser.staffId : null,
        staffName: currentUser ? currentUser.staffName : null
      };

      if (dealResult === 'å¯¾è±¡å¤–') {
        reportData.customerCountry = document.getElementById('reportCountryExcluded').value;
        reportData.products = getCheckedValues('reportProductsExcluded');
        reportData.excludeReason = document.getElementById('reportExcludeReason').value;
        if (!reportData.excludeReason) {
          showToastWarning('å¯¾è±¡å¤–ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
      } else {
        reportData.customerCountry = document.getElementById('reportCountry').value;
        reportData.products = getCheckedValues('reportProducts');
        reportData.salesChannels = getCheckedValues('reportSalesChannels');
        reportData.customerType = document.getElementById('reportCustomerType').value;
        reportData.orderAmount = document.getElementById('reportOrderAmount').value;
        reportData.purchaseFrequency = document.getElementById('reportFrequency').value;
        reportData.monthlyOrderEstimate = document.getElementById('reportMonthlyEstimate').value;
        reportData.partnershipLevel = document.getElementById('reportPartnership').value;
        reportData.dealFeeling = document.getElementById('reportFeeling').value;
        reportData.goodPoints = document.getElementById('reportGoodPoints').value;
        reportData.actionPlan = document.getElementById('reportActionPlan').value;
        reportData.conversationLog = document.getElementById('reportConversationLog').value;

        // ãã®ä»–å…¥åŠ›
        var productsOther = document.getElementById('reportProductsOther').value;
        if (productsOther) reportData.products.push(productsOther);
        var channelsOther = document.getElementById('reportSalesChannelsOther').value;
        if (channelsOther) reportData.salesChannels.push(channelsOther);

        // çµæœåˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        if (dealResult === 'æˆç´„') {
          reportData.successPoints = document.getElementById('reportSuccessPoints').value;
        } else if (dealResult === 'å¤±æ³¨') {
          reportData.improvements = document.getElementById('reportImprovements').value;
        } else if (dealResult === 'è¿½å®¢') {
          reportData.nextActionDate = document.getElementById('reportNextActionDate').value;
        } else if (dealResult === 'è¦‹é€ã‚Š') {
          reportData.reapproachDate = document.getElementById('reportReapproachDate').value;
          reportData.postponeReason = document.getElementById('reportPostponeReason').value;
        }

        // å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!reportData.goodPoints || !reportData.actionPlan) {
          showToastWarning('è‰¯ã‹ã£ãŸç‚¹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã¯å¿…é ˆã§ã™');
          return;
        }
      }

      showLoading();
      document.getElementById('reportSubmitBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();

          if (result.success) {
            // Buddyãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
            if (result.buddyFeedback && result.buddyFeedback.buddyMessage) {
              document.getElementById('buddyFeedbackText').textContent = result.buddyFeedback.buddyMessage;
              document.getElementById('buddyFeedbackContainer').style.display = 'block';
              document.getElementById('reportButtonArea').style.display = 'none';
            } else {
              showToast('å•†è«‡ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
              closeDealReportModal();
            }
          } else {
            document.getElementById('reportSubmitBtn').disabled = false;
            showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || ''));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('reportSubmitBtn').disabled = false;
          showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .saveDealReport(reportData);
    }

    // Buddyå£æ‰“ã¡é–‹å§‹
    function startBuddyWallHit() {
      closeDealReportModal();
      openBuddyChat();
    }

    // ========== ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¨˜éŒ² ==========

    // ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨˜éŒ²
    function recordLogin() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function() {
          console.log('ãƒ­ã‚°ã‚¤ãƒ³è¨˜éŒ²å®Œäº†');
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ­ã‚°ã‚¤ãƒ³è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        })
        .recordLogin(currentUser.staffId);
    }

    // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡ï¼ˆ15åˆ†ã”ã¨ï¼‰
    function startHeartbeat() {
      if (!currentUser || !currentUser.staffId) return;

      setInterval(function() {
        google.script.run.recordHeartbeat(currentUser.staffId);
      }, 15 * 60 * 1000); // 15åˆ†
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¨˜éŒ²ï¼ˆãƒšãƒ¼ã‚¸é›¢è„±æ™‚ï¼‰
    function setupLogoutRecording() {
      if (!currentUser || !currentUser.staffId) return;

      window.addEventListener('beforeunload', function() {
        // åŒæœŸçš„ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’è¨˜éŒ²ï¼ˆsendBeaconã‚’ä½¿ç”¨ï¼‰
        const data = JSON.stringify({ staffId: currentUser.staffId });
        navigator.sendBeacon && navigator.sendBeacon(
          'https://script.google.com/macros/s/YOUR_WEBAPP_URL/exec?action=logout',
          data
        );
      });
    }

    // ========== Buddyå£æ‰“ã¡æ©Ÿèƒ½ ==========
    let buddyCurrentMode = 'free_talk';
    let buddyConversationLog = [];
    let buddyGoalData = null;
    let buddyPerformanceData = null;

    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    function switchBuddyMode(mode) {
      buddyCurrentMode = mode;

      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.buddy-mode-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.mode === mode) {
          tab.classList.add('active');
        }
      });

      // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æ›´æ–°
      const guide = document.getElementById('guideContent');
      const goalSection = document.getElementById('buddyGoalSection');
      const reportSection = document.getElementById('buddyReportSection');

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆnullãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
      if (goalSection) goalSection.style.display = 'none';
      if (reportSection) reportSection.style.display = 'none';

      switch (mode) {
        case 'free_talk':
          if (guide) guide.innerHTML = '<h4>ğŸ’¬ ãƒ•ãƒªãƒ¼ãƒˆãƒ¼ã‚¯</h4><p>æ—¥å¸¸ã®ç›¸è«‡ã‚„è³ªå•ãªã©ã€ãªã‚“ã§ã‚‚æ°—è»½ã«è©±ã—ã‹ã‘ã¦ã­ï¼</p>';
          break;
        case 'goal_setting':
          if (guide) guide.innerHTML = '<h4>ğŸ¯ ç›®æ¨™è¨­å®š</h4><p>ä»Šæœˆã®æŒ¯ã‚Šè¿”ã‚Šã¨æ¥æœˆã®ç›®æ¨™ã‚’ä¸€ç·’ã«è€ƒãˆã‚ˆã†ï¼</p>';
          if (goalSection) goalSection.style.display = 'block';
          loadBuddyGoalData();
          break;
        case 'weekly_review':
          if (guide) guide.innerHTML = '<h4>ğŸ“Š é€±æ¬¡æŒ¯ã‚Šè¿”ã‚Š</h4><p>ä»Šé€±ã®æˆæœã‚’æŒ¯ã‚Šè¿”ã£ã¦ã€æ¥é€±ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºã‚ã‚ˆã†ï¼</p>';
          if (reportSection) reportSection.style.display = 'block';
          loadBuddyWeeklyReports();
          break;
      }
    }

    // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    function loadBuddyGoalData() {
      if (!currentUser || !currentUser.staffId) return;

      // ç¾åœ¨ã®ç›®æ¨™ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(goal) {
          buddyGoalData = goal;
          renderBuddyGoalCard(goal);
        })
        .withFailureHandler(function(e) {
          console.error('ç›®æ¨™å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getCurrentGoal(currentUser.staffId, 'æœˆæ¬¡');

      // å®Ÿç¸¾ã‚’å–å¾—
      const now = new Date();
      const period = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

      google.script.run
        .withSuccessHandler(function(metrics) {
          buddyPerformanceData = metrics;
          renderBuddyPerformanceCard(metrics);
        })
        .withFailureHandler(function(e) {
          console.error('å®Ÿç¸¾å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getPerformanceMetrics(currentUser.staffId, 'æœˆæ¬¡', period);
    }

    // ç›®æ¨™ã‚«ãƒ¼ãƒ‰ã‚’æç”»
    function renderBuddyGoalCard(goal) {
      const periodEl = document.getElementById('goalPeriod');
      const statusEl = document.getElementById('goalStatus');
      const closedTargetEl = document.getElementById('goalClosedTarget');
      const salesTargetEl = document.getElementById('goalSalesTarget');
      const actionEl = document.getElementById('goalActionText');
      const challengeEl = document.getElementById('goalChallengeText');

      if (goal) {
        periodEl.textContent = goal['å¯¾è±¡æœŸé–“'] || '-';
        statusEl.textContent = goal['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] || 'è¨­å®šä¸­';
        statusEl.className = 'goal-status ' + (goal['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'ç¢ºå®š' ? 'active' : '');
        closedTargetEl.textContent = (goal['æˆç´„ç›®æ¨™'] || 0) + 'ä»¶';
        salesTargetEl.textContent = formatCurrency(goal['å£²ä¸Šç›®æ¨™'] || 0);
        actionEl.textContent = 'ğŸ“Œ è¡Œå‹•ç›®æ¨™: ' + (goal['è¡Œå‹•ç›®æ¨™'] || 'æœªè¨­å®š');
        challengeEl.textContent = 'ğŸ¯ ãƒãƒ£ãƒ¬ãƒ³ã‚¸: ' + (goal['ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ¡ˆä»¶'] || 'æœªè¨­å®š');
      } else {
        periodEl.textContent = getCurrentPeriod();
        statusEl.textContent = 'æœªè¨­å®š';
        statusEl.className = 'goal-status';
        closedTargetEl.textContent = '-';
        salesTargetEl.textContent = '-';
        actionEl.textContent = 'ğŸ“Œ è¡Œå‹•ç›®æ¨™: æœªè¨­å®š';
        challengeEl.textContent = 'ğŸ¯ ãƒãƒ£ãƒ¬ãƒ³ã‚¸: æœªè¨­å®š';
      }
    }

    // å®Ÿç¸¾ã‚«ãƒ¼ãƒ‰ã‚’æç”»
    function renderBuddyPerformanceCard(metrics) {
      document.getElementById('perfClosedWon').textContent = metrics.closedWon || 0;
      document.getElementById('perfTotalRevenue').textContent = formatCurrency(metrics.totalRevenue || 0);
      document.getElementById('perfConversionRate').textContent = (metrics.conversionRate || 0) + '%';
      document.getElementById('perfInProgress').textContent = metrics.inProgress || 0;

      // ç›®æ¨™ã¨ã®é€²æ—ã‚’è¨ˆç®—
      if (buddyGoalData && buddyGoalData['æˆç´„ç›®æ¨™']) {
        const target = Number(buddyGoalData['æˆç´„ç›®æ¨™']);
        const current = metrics.closedWon || 0;
        const progressPct = Math.min(Math.round((current / target) * 100), 100);

        document.getElementById('goalProgressFill').style.width = progressPct + '%';
        document.getElementById('goalProgressText').textContent =
          'ç›®æ¨™ ' + target + 'ä»¶ ã«å¯¾ã—ã¦ ' + current + 'ä»¶ é”æˆ (' + progressPct + '%)';
      } else {
        document.getElementById('goalProgressFill').style.width = '0%';
        document.getElementById('goalProgressText').textContent = 'ç›®æ¨™æœªè¨­å®š';
      }
    }

    // ç¾åœ¨ã®æœŸé–“ã‚’å–å¾—
    function getCurrentPeriod() {
      const now = new Date();
      return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
    }

    // é€šè²¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatCurrency(value) {
      return 'Â¥' + Number(value).toLocaleString();
    }

    // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€
    function loadBuddyWeeklyReports() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(reports) {
          renderBuddyWeeklyReports(reports);
        })
        .withFailureHandler(function(e) {
          console.error('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getWeeklyReports(currentUser.staffId, 5);
    }

    // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ã‚’æç”»
    function renderBuddyWeeklyReports(reports) {
      const container = document.getElementById('weeklyReportList');

      if (!reports || reports.length === 0) {
        container.innerHTML = '<div class="empty-state">ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      let html = '';
      reports.forEach(report => {
        const submitDate = report['æå‡ºæ—¥æ™‚'] ? new Date(report['æå‡ºæ—¥æ™‚']).toLocaleDateString('ja-JP') : '-';
        html += `
          <div class="report-item" onclick="showReportDetail('${report['ãƒ¬ãƒãƒ¼ãƒˆID']}')">
            <div class="report-item-header">
              <span class="report-week">${report['å¯¾è±¡é€±'] || '-'}</span>
              <span class="report-date">${submitDate}</span>
            </div>
            <div class="report-preview">${report['ä»Šé€±ã®æˆæœ'] || 'å†…å®¹ãªã—'}</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°ã‚’è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
    function showReportDetail(reportId) {
      // TODO: ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å®Ÿè£…
      console.log('Report detail:', reportId);
    }

    // ç›®æ¨™ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openGoalEditModal() {
      // TODO: ç›®æ¨™ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å®Ÿè£…
      showToastWarning('ç›®æ¨™ç·¨é›†æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
    }

    // ========== éŸ³å£°å…¥åŠ›æ©Ÿèƒ½ ==========
    let voiceRecognition = null;
    let isRecording = false;

    function toggleVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('éŸ³å£°å…¥åŠ›ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      if (isRecording) {
        stopVoiceInput();
      } else {
        startVoiceInput();
      }
    }

    // éŸ³å£°å…¥åŠ›é–‹å§‹å‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜ï¼ˆé‡è¤‡é˜²æ­¢ç”¨ï¼‰
    let voiceInputBaseText = '';

    function startVoiceInput() {
      // æ—¢ã«éŒ²éŸ³ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆé‡è¤‡é–‹å§‹é˜²æ­¢ï¼‰
      if (isRecording || voiceRecognition) {
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      voiceRecognition = new SpeechRecognition();
      voiceRecognition.lang = 'ja-JP';
      voiceRecognition.continuous = false;
      voiceRecognition.interimResults = true;

      const btn = document.getElementById('voiceInputBtn');
      const input = document.getElementById('buddyChatInput');

      // é–‹å§‹æ™‚ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
      voiceInputBaseText = input ? input.value : '';

      voiceRecognition.onstart = function() {
        isRecording = true;
        if (btn) {
          btn.classList.add('recording');
          btn.textContent = 'â¹ï¸';
        }
        showToast('éŸ³å£°å…¥åŠ›ä¸­...ï¼ˆShiftã‚­ãƒ¼ã§ã‚‚æ“ä½œå¯èƒ½ï¼‰', 'info');
      };

      voiceRecognition.onresult = function(event) {
        if (!input) return;

        // æœ€æ–°ã®èªè­˜çµæœã‚’å–å¾—ï¼ˆä¸­é–“çµæœå«ã‚€ï¼‰
        let finalTranscript = '';
        let interimTranscript = '';

        for (let i = 0; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }

        // è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç¢ºå®š + ä¸­é–“ï¼‰
        const displayText = finalTranscript + interimTranscript;

        // ãƒ™ãƒ¼ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ ã—ã¦è¡¨ç¤ºï¼ˆé‡è¤‡ãªã—ï¼‰
        if (voiceInputBaseText && !voiceInputBaseText.endsWith(' ') && !voiceInputBaseText.endsWith('ã€€')) {
          input.value = voiceInputBaseText + ' ' + displayText;
        } else {
          input.value = voiceInputBaseText + displayText;
        }
        autoResizeTextarea(input);
      };

      voiceRecognition.onerror = function(event) {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        if (event.error === 'no-speech') {
          showToast('éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        } else if (event.error === 'not-allowed') {
          showToast('ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        } else if (event.error !== 'aborted') {
          showToast('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error, 'error');
        }
        stopVoiceInput();
      };

      voiceRecognition.onend = function() {
        // çµ‚äº†æ™‚ã€ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«æ›´æ–°
        if (input) {
          voiceInputBaseText = input.value;
        }
        stopVoiceInput();
      };

      voiceRecognition.start();
    }

    function stopVoiceInput() {
      if (voiceRecognition) {
        try {
          voiceRecognition.stop();
        } catch (e) {
          // æ—¢ã«åœæ­¢ã—ã¦ã„ã‚‹å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
        }
        voiceRecognition = null;
      }
      isRecording = false;
      const btn = document.getElementById('voiceInputBtn');
      if (btn) {
        btn.classList.remove('recording');
        btn.textContent = 'ğŸ¤';
      }
    }

    // Shiftã‚­ãƒ¼ã§éŸ³å£°å…¥åŠ›ã‚’åˆ¶å¾¡
    let shiftKeyVoiceActive = false;
    document.addEventListener('keydown', function(e) {
      // Buddyå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹æ™‚ã®ã¿Shiftã‚­ãƒ¼éŸ³å£°å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
      const activeEl = document.activeElement;
      const isBuddyInput = activeEl && (activeEl.id === 'buddyChatInput' || activeEl.id === 'buddyChatInputModal');

      if (e.key === 'Shift' && !e.repeat && isBuddyInput) {
        if (!isRecording) {
          shiftKeyVoiceActive = true;
          startVoiceInput();
        }
      }
    });

    document.addEventListener('keyup', function(e) {
      if (e.key === 'Shift' && shiftKeyVoiceActive) {
        shiftKeyVoiceActive = false;
        stopVoiceInput();
      }
    });

    // Buddyã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    function sendBuddyMessage() {
      const input = document.getElementById('buddyChatInput');
      if (!input) return;
      const message = input.value.trim();

      if (!message) return;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      addBuddyMessageToChat(message, true);
      input.value = '';
      autoResizeTextarea(input);

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const sendBtn = document.getElementById('buddySendBtn');
      if (sendBtn) sendBtn.disabled = true;

      // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
      const typingIndicator = document.getElementById('buddyTypingIndicator');
      if (typingIndicator) typingIndicator.style.display = 'inline';

      // ä¼šè©±ãƒ­ã‚°ã‚’æ›´æ–°
      buddyConversationLog.push({ role: 'user', content: message });
      const conversationLogStr = buddyConversationLog.slice(-10).map(m =>
        (m.role === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼: ' : 'Buddy: ') + m.content
      ).join('\n');

      // APIã‚’å‘¼ã³å‡ºã—
      google.script.run
        .withSuccessHandler(function(response) {
          const btn = document.getElementById('buddySendBtn');
          const indicator = document.getElementById('buddyTypingIndicator');
          if (btn) btn.disabled = false;
          if (indicator) indicator.style.display = 'none';

          if (response && response.success) {
            addBuddyMessageToChat(response.message, false);
            buddyConversationLog.push({ role: 'assistant', content: response.message });
          } else {
            addBuddyMessageToChat('ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ä¸€æ™‚çš„ã«ãŠè©±ã—ã§ããªã„çŠ¶æ…‹ã§ã™ã€‚', false);
          }
        })
        .withFailureHandler(function(e) {
          const btn = document.getElementById('buddySendBtn');
          const indicator = document.getElementById('buddyTypingIndicator');
          if (btn) btn.disabled = false;
          if (indicator) indicator.style.display = 'none';
          console.error('Buddyå¿œç­”ã‚¨ãƒ©ãƒ¼:', e);
          addBuddyMessageToChat('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚', false);
        })
        .generateBuddyCoachingResponseWithKnowledge({
          mode: buddyCurrentMode,
          userMessage: message,
          staffId: currentUser ? currentUser.staffId : '',
          staffName: currentUser ? currentUser.staffName : '',
          conversationLog: conversationLogStr
        });
    }

    // ãƒãƒ£ãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    function addBuddyMessageToChat(message, isUser) {
      const container = document.getElementById('buddyChatMessages');
      if (!container) return;
      const now = new Date();
      const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

      const messageDiv = document.createElement('div');
      messageDiv.className = 'buddy-message' + (isUser ? ' user-message' : '');
      messageDiv.innerHTML = `
        <div class="buddy-avatar">${isUser ? 'ğŸ‘¤' : 'ğŸ§”â€â™‚ï¸'}</div>
        <div class="buddy-message-content">
          <div class="buddy-message-text">${escapeHtml(message).replace(/\n/g, '<br>')}</div>
          <div class="buddy-message-time">${timeStr}</div>
        </div>
      `;

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ãƒãƒ³ãƒ‰ãƒ©
    function handleBuddyChatKeydown(event) {
      // Enterã§é€ä¿¡ã€Shift+Enterã§æ”¹è¡Œ
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendBuddyMessage();
      }

      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
      autoResizeTextarea(event.target);
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ãƒªã‚µã‚¤ã‚º
    function autoResizeTextarea(textarea) {
      if (!textarea) return;
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // ==========================================
    // æ—¥å ±æ©Ÿèƒ½
    // ==========================================

    // æ—¥å ±ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
    function initDailyReportPage() {
      if (!currentUser) return;

      const today = new Date();
      const dateStr = formatDateForDisplay(today);
      document.getElementById('dailyReportDateLabel').textContent = dateStr;

      // æœ¬æ—¥ã®å®Ÿç¸¾ã‚’å–å¾—
      loadTodayStats();

      // æ—¢å­˜ã®æ—¥å ±ã‚’ç¢ºèª
      loadTodayDailyReport();

      // å±¥æ­´ã‚’å–å¾—
      loadDailyReportHistory();
    }

    // è¡¨ç¤ºç”¨æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateForDisplay(date) {
      // å‹ãƒã‚§ãƒƒã‚¯è¿½åŠ 
      if (!date) return '-';
      if (typeof date === 'string') {
        date = new Date(date);
      }
      if (!(date instanceof Date) || isNaN(date.getTime())) {
        return '-';
      }
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const y = date.getFullYear();
      const m = (date.getMonth() + 1).toString().padStart(2, '0');
      const d = date.getDate().toString().padStart(2, '0');
      const w = weekdays[date.getDay()];
      return `${y}/${m}/${d}ï¼ˆ${w}ï¼‰`;
    }

    // æœ¬æ—¥ã®å®Ÿç¸¾ã‚’å–å¾—
    function loadTodayStats() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(stats) {
          if (stats) {
            document.getElementById('dailyStatsDeal').textContent = stats.dealCount || 0;
            document.getElementById('dailyStatsClosed').textContent = stats.closedCount || 0;
            document.getElementById('dailyStatsContact').textContent = stats.newContactCount || 0;
          }
        })
        .withFailureHandler(function(error) {
          console.error('æœ¬æ—¥ã®å®Ÿç¸¾å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getTodayStats(currentUser.staffId);
    }

    // ä»Šæ—¥ã®æ—¥å ±ã‚’å–å¾—
    function loadTodayDailyReport() {
      if (!currentUser || !currentUser.staffId) return;

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = (today.getMonth() + 1).toString().padStart(2, '0');
      const dd = today.getDate().toString().padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;

      google.script.run
        .withSuccessHandler(function(report) {
          if (report) {
            if (report.status === 'æå‡ºæ¸ˆ') {
              // æå‡ºæ¸ˆã¿è¡¨ç¤º
              showSubmittedDailyReport(report);
            } else {
              // ä¸‹æ›¸ãã‚’å¾©å…ƒ
              document.getElementById('dailyAchievement').value = report.achievement || '';
              document.getElementById('dailyUnachieved').value = report.unachieved || '';
              document.getElementById('dailyTrouble').value = report.trouble || '';
              document.getElementById('dailyLearning').value = report.learning || '';
              document.getElementById('dailyTomorrowPlan').value = report.tomorrowPlan || '';
              document.getElementById('dailyComment').value = report.comment || '';
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('æ—¥å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getDailyReport(currentUser.staffId, dateStr);
    }

    // æå‡ºæ¸ˆã¿æ—¥å ±ã‚’è¡¨ç¤º
    function showSubmittedDailyReport(report) {
      document.getElementById('dailyReportFormSection').style.display = 'none';
      document.getElementById('dailyReportSubmittedSection').style.display = 'block';

      // æå‡ºæ™‚åˆ»
      let submittedTime = report.submittedAt || '-';
      if (submittedTime && submittedTime.includes('T')) {
        const dt = new Date(submittedTime);
        submittedTime = `${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')} æå‡º`;
      }
      document.getElementById('dailyReportSubmittedTime').textContent = submittedTime;

      // å†…å®¹ã‚’è¡¨ç¤º
      document.getElementById('viewAchievement').textContent = report.achievement || '-';
      document.getElementById('viewUnachieved').textContent = report.unachieved || '-';
      document.getElementById('viewTrouble').textContent = report.trouble || '-';
      document.getElementById('viewLearning').textContent = report.learning || '-';
      document.getElementById('viewTomorrowPlan').textContent = report.tomorrowPlan || '-';
      document.getElementById('viewComment').textContent = report.comment || '-';
    }

    // æ—¥å ±å±¥æ­´ã‚’å–å¾—
    function loadDailyReportHistory() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(history) {
          renderDailyReportHistory(history || []);
        })
        .withFailureHandler(function(error) {
          console.error('æ—¥å ±å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          document.getElementById('dailyReportHistoryList').innerHTML =
            '<p style="color: #dc3545; text-align: center;">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        })
        .getDailyReportHistory(currentUser.staffId, 5);
    }

    // æ—¥å ±å±¥æ­´ã‚’æç”»
    function renderDailyReportHistory(history) {
      const container = document.getElementById('dailyReportHistoryList');

      if (!history || history.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">éå»ã®æ—¥å ±ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      let html = '<div class="daily-report-history">';
      history.forEach(function(report) {
        const statusBadge = report.status === 'æå‡ºæ¸ˆ'
          ? '<span class="badge-success">æå‡ºæ¸ˆ</span>'
          : '<span class="badge-warning">ä¸‹æ›¸ã</span>';

        html += `
          <div class="daily-report-history-item" onclick="showDailyReportDetail('${report.date}')">
            <div class="history-date">${report.date}</div>
            <div class="history-summary">${truncateText(report.achievement, 50)}</div>
            <div class="history-status">${statusBadge}</div>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šè©°ã‚
    function truncateText(text, maxLength) {
      if (!text) return '-';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    // æ—¥å ±è©³ç´°è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
    function showDailyReportDetail(date) {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(report) {
          if (report) {
            console.log('ã€' + report.date + 'ã®æ—¥å ±ã€‘', report);
            showToast(report.date + 'ã®æ—¥å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ç¢ºèªï¼‰');
          }
        })
        .withFailureHandler(function(error) {
          console.error('æ—¥å ±è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getDailyReport(currentUser.staffId, date);
    }

    // ä¸‹æ›¸ãä¿å­˜
    function saveDailyReportDraft() {
      if (!currentUser) {
        showToastError('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = (today.getMonth() + 1).toString().padStart(2, '0');
      const dd = today.getDate().toString().padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;

      const data = {
        staffId: currentUser.staffId,
        staffName: currentUser.staffName,
        date: dateStr,
        achievement: document.getElementById('dailyAchievement').value,
        unachieved: document.getElementById('dailyUnachieved').value,
        trouble: document.getElementById('dailyTrouble').value,
        learning: document.getElementById('dailyLearning').value,
        tomorrowPlan: document.getElementById('dailyTomorrowPlan').value,
        comment: document.getElementById('dailyComment').value,
        status: 'ä¸‹æ›¸ã'
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          } else {
            showToastError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          showToastError('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .saveDailyReport(data);
    }

    // æ—¥å ±æå‡º
    function submitDailyReport(event) {
      event.preventDefault();

      if (!currentUser) {
        showToastError('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      if (!confirm('æ—¥å ±ã‚’æå‡ºã—ã¾ã™ã‹ï¼Ÿ\næå‡ºå¾Œã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚')) {
        return;
      }

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = (today.getMonth() + 1).toString().padStart(2, '0');
      const dd = today.getDate().toString().padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;

      const data = {
        staffId: currentUser.staffId,
        staffName: currentUser.staffName,
        date: dateStr,
        achievement: document.getElementById('dailyAchievement').value,
        unachieved: document.getElementById('dailyUnachieved').value,
        trouble: document.getElementById('dailyTrouble').value,
        learning: document.getElementById('dailyLearning').value,
        tomorrowPlan: document.getElementById('dailyTomorrowPlan').value,
        comment: document.getElementById('dailyComment').value,
        status: 'æå‡ºæ¸ˆ'
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('æ—¥å ±ã‚’æå‡ºã—ã¾ã—ãŸ');
            // æå‡ºæ¸ˆã¿è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
            showSubmittedDailyReport(data);
            // å±¥æ­´ã‚’æ›´æ–°
            loadDailyReportHistory();
          } else {
            showToastError('æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          showToastError('æå‡ºã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .saveDailyReport(data);
    }

    // ==========================================
    // ãƒãƒ¼ãƒ æ—¥å ±ä¸€è¦§ï¼ˆãƒªãƒ¼ãƒ€ãƒ¼ãƒ»ç®¡ç†è€…å‘ã‘ï¼‰
    // ==========================================

    // ãƒãƒ¼ãƒ æ—¥å ±ä¸€è¦§ã®åˆæœŸåŒ–
    function initTeamDailyReportPage() {
      // ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸå€¤è¨­å®š
      const today = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(today.getDate() - 7);

      document.getElementById('dailyReportFilterFrom').value = formatDateForInput(weekAgo);
      document.getElementById('dailyReportFilterTo').value = formatDateForInput(today);

      // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’è¨­å®š
      populateDailyReportStaffFilter();

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadTeamDailyReports();
    }

    // æ—¥ä»˜ã‚’inputç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateForInputDaily(date) {
      // å‹ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
      if (!date) return '';
      if (typeof date === 'string') {
        date = new Date(date);
      }
      if (!(date instanceof Date) || isNaN(date.getTime())) {
        return '';
      }
      const yyyy = date.getFullYear();
      const mm = (date.getMonth() + 1).toString().padStart(2, '0');
      const dd = date.getDate().toString().padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¨­å®š
    function populateDailyReportStaffFilter() {
      const select = document.getElementById('dailyReportFilterStaff');
      if (!select) return;

      // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ä¿æŒ
      const currentValue = select.value;

      // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠè‚¢ã‚’è¿½åŠ 
      if (cache.dropdownOptions && cache.dropdownOptions.staffList) {
        cache.dropdownOptions.staffList.forEach(function(staff) {
          const option = document.createElement('option');
          option.value = staff.id;
          option.textContent = staff.name;
          select.appendChild(option);
        });
      }

      select.value = currentValue;
    }

    // ãƒãƒ¼ãƒ æ—¥å ±ã‚’å–å¾—
    function loadTeamDailyReports() {
      const dateFrom = document.getElementById('dailyReportFilterFrom').value;
      const dateTo = document.getElementById('dailyReportFilterTo').value;
      const filterStaff = document.getElementById('dailyReportFilterStaff').value;
      const filterTrouble = document.getElementById('dailyReportFilterTrouble').checked;

      google.script.run
        .withSuccessHandler(function(reports) {
          renderTeamDailyReports(reports || [], filterTrouble);
        })
        .withFailureHandler(function(error) {
          console.error('ãƒãƒ¼ãƒ æ—¥å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          document.getElementById('teamDailyReportBody').innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: #dc3545;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
        })
        .getTeamDailyReports(dateFrom, dateTo, filterStaff);
    }

    // ãƒãƒ¼ãƒ æ—¥å ±ã‚’æç”»
    function renderTeamDailyReports(reports, filterTrouble) {
      const tbody = document.getElementById('teamDailyReportBody');

      // å›°ã£ã¦ã„ã‚‹ã“ã¨ãƒ•ã‚£ãƒ«ã‚¿
      if (filterTrouble) {
        reports = reports.filter(function(r) { return r.hasTrouble; });
      }

      if (!reports || reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">è©²å½“ã™ã‚‹æ—¥å ±ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      let html = '';
      reports.forEach(function(report) {
        const troubleClass = report.hasTrouble ? 'trouble-highlight' : '';
        html += `
          <tr class="${troubleClass}">
            <td>${report.date}</td>
            <td>${report.staffName}</td>
            <td>${truncateText(report.achievement, 30)}</td>
            <td>${truncateText(report.trouble, 30) || '-'}</td>
            <td>${formatSubmittedTime(report.submittedAt)}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // æå‡ºæ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatSubmittedTime(submittedAt) {
      if (!submittedAt) return '-';
      if (submittedAt.includes('T')) {
        const dt = new Date(submittedAt);
        return `${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`;
      }
      return submittedAt.substring(11, 16);
    }

    // ========== ãŠçŸ¥ã‚‰ã›ã‚·ã‚¹ãƒ†ãƒ  ==========
    let currentNoticeId = null;
    let currentDuplicateLeadId = null;

    function toggleNotificationPanel() {
      const panel = document.getElementById('notification-panel');
      if (panel.style.display === 'none') {
        panel.style.display = 'flex';
        loadUnreadNotices();
      } else {
        panel.style.display = 'none';
      }
    }

    function closeNotificationPanel() {
      document.getElementById('notification-panel').style.display = 'none';
    }

    function loadUnreadNotices() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function(notices) {
          renderNotificationList(notices);
          updateNotificationBadge(notices.length);

          // æœªèª­ãŒã‚ã‚Œã°ãƒ‘ãƒãƒ«ã‚’è‡ªå‹•è¡¨ç¤ºï¼ˆåˆå›ã®ã¿ï¼‰
          if (notices.length > 0 && !sessionStorage.getItem('notificationShown')) {
            sessionStorage.setItem('notificationShown', 'true');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãŠçŸ¥ã‚‰ã›å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getUnreadNoticesForUser(currentUser.staffId);
    }

    function renderNotificationList(notices) {
      const list = document.getElementById('notification-list');
      list.innerHTML = '';

      if (notices.length === 0) {
        list.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">æ–°ã—ã„ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      notices.forEach(function(notice) {
        const typeIcon = {
          'é‡è¦': 'ğŸ”´',
          'ãŠçŸ¥ã‚‰ã›': 'ğŸŸ¡',
          'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹': 'ğŸ”§',
          'å€‹äºº': 'ğŸ”µ'
        }[notice.type] || 'ğŸ””';

        const item = document.createElement('div');
        item.className = 'notification-item';
        item.onclick = function() { showNoticeDetail(notice); };
        item.innerHTML = `
          <span class="notification-type">${typeIcon}</span>
          <div class="notification-content">
            <p class="notification-title">${notice.title}</p>
            <p class="notification-datetime">${formatDate(notice.datetime)}</p>
          </div>
          <span class="notification-new">NEW</span>
        `;
        list.appendChild(item);
      });

      document.getElementById('unread-count').textContent = notices.length;
    }

    function updateNotificationBadge(count) {
      const badge = document.getElementById('notification-count');
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }

    function showNoticeDetail(notice) {
      currentNoticeId = notice.id;

      document.getElementById('notice-detail-title').textContent = notice.title;
      document.getElementById('notice-detail-datetime').textContent = formatDate(notice.datetime);
      document.getElementById('notice-detail-body').innerHTML = (notice.body || '').replace(/\n/g, '<br>');

      const actionBtn = document.getElementById('notice-action-btn');
      if (notice.actionUrl) {
        actionBtn.textContent = notice.actionLabel || 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³';
        actionBtn.onclick = function() { window.open(notice.actionUrl, '_blank'); };
        actionBtn.style.display = 'inline-block';
      } else {
        actionBtn.style.display = 'none';
      }

      closeNotificationPanel();
      document.getElementById('notice-detail-modal').style.display = 'flex';
    }

    function markCurrentNoticeRead() {
      if (!currentUser || !currentUser.staffId || !currentNoticeId) return;

      google.script.run
        .withSuccessHandler(function() {
          closeModal('notice-detail-modal');
          loadUnreadNotices();
          showToast('ç¢ºèªã—ã¾ã—ãŸ');
        })
        .markNoticeAsRead(currentUser.staffId, currentNoticeId);
    }

    function markAllNoticesRead() {
      if (!currentUser || !currentUser.staffId) return;

      google.script.run
        .withSuccessHandler(function() {
          loadUnreadNotices();
          showToast('ã™ã¹ã¦æ—¢èª­ã«ã—ã¾ã—ãŸ');
        })
        .markAllNoticesAsRead(currentUser.staffId);
    }

    // ========== é‡è¤‡æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ  ==========
    function showDuplicateWarning(leadId) {
      currentDuplicateLeadId = leadId;

      google.script.run
        .withSuccessHandler(function(data) {
          if (data && data.found) {
            const sourceInfo = data.sourceInfo || {};
            document.getElementById('dup-customer-name').textContent = data.customerName || '-';
            document.getElementById('dup-company-name').textContent = data.companyName || '-';
            document.getElementById('dup-last-date').textContent = formatDate(sourceInfo.lastDate) || '-';
            document.getElementById('dup-last-status').textContent = sourceInfo.lastStatus || '-';
            document.getElementById('dup-last-staff').textContent = sourceInfo.lastStaff || '-';

            document.getElementById('duplicate-warning-modal').style.display = 'flex';
          }
        })
        .withFailureHandler(function(error) {
          console.error('é‡è¤‡æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getDuplicateInfoForLead(leadId);
    }

    function confirmAsNewLead() {
      if (!currentDuplicateLeadId) return;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeModal('duplicate-warning-modal');
            retryLoadLeads('in');
            retryLoadLeads('out');
            showToast('æ–°è¦ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ');
          }
        })
        .clearDuplicateFlagForLead(currentDuplicateLeadId);
    }

    function showDuplicateHistory() {
      // é‡è¤‡å…ƒã®ãƒªãƒ¼ãƒ‰IDãŒã‚ã‚Œã°ã€ãã®ãƒªãƒ¼ãƒ‰ã‚’è¡¨ç¤º
      // TODO: å®Ÿè£…ï¼ˆãƒªãƒ¼ãƒ‰è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ãï¼‰
      closeModal('duplicate-warning-modal');
      showToast('å±¥æ­´ç¢ºèªæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãŠçŸ¥ã‚‰ã›ã‚’ãƒã‚§ãƒƒã‚¯
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        if (currentUser && currentUser.staffId) {
          loadUnreadNotices();
        }
      }, 2000);
    });
  </script>

  </div><!-- /app-container -->

  <!-- ãƒãƒƒã‚¸ç²å¾—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="badgeAchievementModal" class="badge-modal-overlay" onclick="closeBadgeModal(event)">
    <div class="badge-modal" onclick="event.stopPropagation()">
      <div class="badge-modal-title">ğŸŠ ãƒãƒƒã‚¸ç²å¾—ï¼ ğŸŠ</div>
      <div id="badgeModalIcon" class="badge-modal-icon"></div>
      <div id="badgeModalName" class="badge-modal-name"></div>
      <div id="badgeModalDescription" class="badge-modal-description"></div>
      <button class="badge-modal-close" onclick="closeBadgeModal()">ã™ã”ã„ï¼</button>
    </div>
  </div>
</body>
</html>
