<script>
/**
 * ä¼šè©±ãƒ­ã‚°DB - JavaScript
 */

// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
let customers = [];
let currentCustomerId = null;
let conversationLogs = [];
let sentimentLabels = {};
let stats = {};

// ===== åˆæœŸåŒ– =====
let initError = false;

document.addEventListener('DOMContentLoaded', function() {
  loadInitialData();
});

function loadInitialData() {
  initError = false;

  // ã¾ãšsentimentLabelsã‚’èª­ã¿è¾¼ã‚€ï¼ˆã“ã‚Œã¯å¿…ãšæˆåŠŸã™ã‚‹ï¼‰
  google.script.run
    .withSuccessHandler(function(labels) {
      sentimentLabels = labels || {};
    })
    .withFailureHandler(function(err) {
      console.error('getSentimentLabels error:', err);
      sentimentLabels = {};
    })
    .getSentimentLabels();

  // ä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  loadDashboardStats();
  loadCustomersList();
  loadAllLogs();
}

// ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
function loadSentimentLabels() {
  google.script.run
    .withSuccessHandler(function(labels) {
      sentimentLabels = labels || {};
    })
    .withFailureHandler(function(err) {
      console.error('getSentimentLabels error:', err);
      sentimentLabels = {};
    })
    .getSentimentLabels();
}

function loadDashboardStats() {
  google.script.run
    .withSuccessHandler(function(data) {
      stats = data || {};
      renderStats();
      renderSentimentChart();
    })
    .withFailureHandler(function(err) {
      console.error('getDashboardStats error:', err);
      stats = {};
      checkSetupNeeded(err);
    })
    .getDashboardStats();
}

function loadCustomersList() {
  google.script.run
    .withSuccessHandler(function(data) {
      customers = data || [];
      renderCustomersList();
    })
    .withFailureHandler(function(err) {
      console.error('getCustomersList error:', err);
      customers = [];
      checkSetupNeeded(err);
    })
    .getCustomersList();
}

function loadAllLogs() {
  google.script.run
    .withSuccessHandler(function(logs) {
      conversationLogs = logs || [];
      renderConversation();
    })
    .withFailureHandler(function(err) {
      console.error('getAllLogs error:', err);
      conversationLogs = [];
      checkSetupNeeded(err);
    })
    .getAllLogs(50);
}

function checkSetupNeeded(err) {
  if (initError) return;
  if (err && err.message && err.message.includes('setupConversationLogSystem')) {
    initError = true;
    showSetupWarning();
  }
}

function showSetupWarning() {
  const container = document.querySelector('.main-content') || document.querySelector('.container');
  if (container) {
    container.innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">&#9888;</div>
        <h2 style="color: #ef4444; margin-bottom: 15px;">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™</h2>
        <p style="color: #666; margin-bottom: 20px;">
          ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>
          GASã‚¨ãƒ‡ã‚£ã‚¿ã§ <code>setupConversationLogSystem()</code> ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
        </p>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; max-width: 400px; margin: 0 auto;">
          <p style="font-size: 14px; margin-bottom: 10px;"><strong>æ‰‹é †:</strong></p>
          <ol style="font-size: 13px; color: #666; margin-left: 20px;">
            <li>GASã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã</li>
            <li>setupConversationLogSystem() ã‚’å®Ÿè¡Œ</li>
            <li>setInitialConfig({geminiApiKey: "your-key"}) ã§APIè¨­å®š</li>
            <li>ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰</li>
          </ol>
        </div>
      </div>
    `;
  }
}

function loadCustomerLogs(customerId) {
  currentCustomerId = customerId;

  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
  document.querySelectorAll('.customer-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.customerId === customerId) {
      item.classList.add('active');
    }
  });

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
  const customer = customers.find(c => c.customerId === customerId);
  document.getElementById('conversation-title').textContent =
    customer ? `${customer.customerName} ã¨ã®ä¼šè©±` : 'ä¼šè©±ãƒ­ã‚°';

  google.script.run
    .withSuccessHandler(function(logs) {
      conversationLogs = logs;
      renderConversation();
    })
    .getConversationLogs(customerId, 100);
}

// ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
function renderStats() {
  document.getElementById('stat-total-logs').textContent = stats.totalLogs || 0;
  document.getElementById('stat-today-logs').textContent = stats.todayLogs || 0;
  document.getElementById('stat-week-logs').textContent = stats.weekLogs || 0;
  document.getElementById('stat-customers').textContent = stats.totalCustomers || 0;
}

function renderSentimentChart() {
  const container = document.getElementById('sentiment-bars');
  if (!container) return;

  const breakdown = stats.sentimentBreakdown || {};
  const total = Object.values(breakdown).reduce((a, b) => a + b, 0) || 1;

  const labels = {
    'VERY_POSITIVE': { label: 'éå¸¸ã«ãƒã‚¸ãƒ†ã‚£ãƒ–', class: 'very-positive' },
    'POSITIVE': { label: 'ãƒã‚¸ãƒ†ã‚£ãƒ–', class: 'positive' },
    'NEUTRAL': { label: 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', class: 'neutral' },
    'NEGATIVE': { label: 'ãƒã‚¬ãƒ†ã‚£ãƒ–', class: 'negative' },
    'VERY_NEGATIVE': { label: 'éå¸¸ã«ãƒã‚¬ãƒ†ã‚£ãƒ–', class: 'very-negative' }
  };

  container.innerHTML = Object.entries(labels).map(([key, info]) => {
    const count = breakdown[key] || 0;
    const percentage = (count / total) * 100;
    return `
      <div class="sentiment-bar-item">
        <div class="sentiment-bar-label">${info.label}</div>
        <div class="sentiment-bar">
          <div class="sentiment-bar-fill ${info.class}" style="width: ${percentage}%"></div>
        </div>
        <div class="sentiment-bar-count">${count}</div>
      </div>
    `;
  }).join('');
}

function renderCustomersList() {
  const container = document.getElementById('customer-list');
  if (!container) return;

  if (customers.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>é¡§å®¢ãŒã„ã¾ã›ã‚“</p></div>';
    return;
  }

  container.innerHTML = customers.map(c => `
    <div class="customer-item ${c.customerId === currentCustomerId ? 'active' : ''}"
         data-customer-id="${c.customerId}"
         onclick="loadCustomerLogs('${c.customerId}')">
      <div class="customer-name">${c.customerName || 'åå‰ãªã—'}</div>
      <div class="customer-meta">
        <span>${c.customerId}</span>
        <span>ãƒ»</span>
        <span>${c.conversationCount || 0}ä»¶ã®ä¼šè©±</span>
      </div>
    </div>
  `).join('');
}

function renderConversation() {
  const container = document.getElementById('conversation-body');
  if (!container) return;

  if (conversationLogs.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ’¬</div>
        <p>ä¼šè©±ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
      </div>
    `;
    return;
  }

  // æ™‚ç³»åˆ—é †ã«ä¸¦ã¹ã‚‹ï¼ˆå¤ã„é †ï¼‰
  const sortedLogs = [...conversationLogs].reverse();

  container.innerHTML = sortedLogs.map(log => {
    const isOutgoing = log.messageType === 'é€ä¿¡';
    const sentimentClass = getSentimentClass(log.sentiment);
    const sentimentInfo = sentimentLabels[log.sentiment] || { label: log.sentiment, icon: 'ğŸ˜' };
    const channelClass = getChannelClass(log.channel);

    return `
      <div class="message ${isOutgoing ? 'outgoing' : ''}">
        <div class="message-avatar">
          ${isOutgoing ? 'ğŸ‘¤' : 'ğŸ¢'}
        </div>
        <div class="message-content">
          <div class="message-bubble">
            ${log.originalMessage}
          </div>
          ${log.translatedMessage && log.translatedMessage !== log.originalMessage ? `
            <div class="message-translation">
              ğŸŒ ${log.translatedMessage}
            </div>
          ` : ''}
          <div class="message-meta">
            <span class="channel-badge ${channelClass}">${log.channel || 'ãã®ä»–'}</span>
            <span class="sentiment-badge ${sentimentClass}">
              ${sentimentInfo.icon} ${sentimentInfo.label}
            </span>
            <span>${formatDateTime(log.timestamp)}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã¸
  container.scrollTop = container.scrollHeight;
}

// ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ =====
function sendMessage() {
  const input = document.getElementById('message-input');
  const typeSelect = document.getElementById('message-type');
  const channelSelect = document.getElementById('channel-select');

  const message = input.value.trim();
  if (!message) return;

  const customer = customers.find(c => c.customerId === currentCustomerId);

  const data = {
    customerId: currentCustomerId || 'UNKNOWN',
    customerName: customer?.customerName || 'ä¸æ˜',
    assigneeId: 'EMP-001',
    assigneeName: 'æ‹…å½“è€…',
    channel: channelSelect.value,
    messageType: typeSelect.value,
    message: message
  };

  input.value = '';
  input.disabled = true;

  google.script.run
    .withSuccessHandler(function(result) {
      input.disabled = false;
      if (result.success) {
        // æ–°ã—ã„ãƒ­ã‚°ã‚’è¿½åŠ 
        conversationLogs.unshift({
          logId: result.logId,
          customerId: data.customerId,
          customerName: data.customerName,
          assigneeId: data.assigneeId,
          assigneeName: data.assigneeName,
          channel: data.channel,
          messageType: data.messageType,
          originalMessage: data.message,
          translatedMessage: result.translatedMessage,
          sentiment: result.sentiment,
          sentimentScore: result.sentimentScore,
          timestamp: new Date().toISOString()
        });
        renderConversation();
        loadDashboardStats();
      } else {
        alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      input.disabled = false;
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    })
    .addConversationLog(data);
}

// ===== ä¼šè©±è¦ç´„ =====
function summarizeCurrentConversation() {
  if (!currentCustomerId) {
    alert('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  document.getElementById('summary-content').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  showModal('summary-modal');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        document.getElementById('summary-content').innerHTML = `
          <div class="summary-card">
            <h4>ä¼šè©±ã®è¦ç´„</h4>
            <div style="white-space: pre-wrap;">${result.summary}</div>
          </div>
        `;
      } else {
        document.getElementById('summary-content').innerHTML = `
          <div class="alert alert-error">è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}</div>
        `;
      }
    })
    .withFailureHandler(function(error) {
      document.getElementById('summary-content').innerHTML = `
        <div class="alert alert-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>
      `;
    })
    .summarizeConversation(currentCustomerId);
}

// ===== æ–°è¦ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« =====
function openNewLogModal() {
  document.getElementById('new-log-customer').value = currentCustomerId || '';
  showModal('new-log-modal');
}

function submitNewLog() {
  const customerId = document.getElementById('new-log-customer').value.trim();
  const customerName = document.getElementById('new-log-customer-name').value.trim();
  const channel = document.getElementById('new-log-channel').value;
  const messageType = document.getElementById('new-log-type').value;
  const message = document.getElementById('new-log-message').value.trim();

  if (!customerId || !message) {
    alert('é¡§å®¢IDã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¿…é ˆã§ã™');
    return;
  }

  const data = {
    customerId: customerId,
    customerName: customerName,
    channel: channel,
    messageType: messageType,
    message: message
  };

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        closeModal('new-log-modal');
        loadCustomersList();
        if (currentCustomerId === customerId) {
          loadCustomerLogs(customerId);
        }
        loadDashboardStats();
      } else {
        alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    })
    .addConversationLog(data);
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function getSentimentClass(sentiment) {
  const map = {
    'VERY_POSITIVE': 'positive',
    'POSITIVE': 'positive',
    'NEUTRAL': 'neutral',
    'NEGATIVE': 'negative',
    'VERY_NEGATIVE': 'negative'
  };
  return map[sentiment] || 'neutral';
}

function getChannelClass(channel) {
  const map = {
    'ãƒ¡ãƒ¼ãƒ«': 'email',
    'é›»è©±': 'phone',
    'ãƒãƒ£ãƒƒãƒˆ': 'chat',
    'å¯¾é¢': 'meeting'
  };
  return map[channel] || '';
}

function formatDateTime(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
}

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ« =====
function showModal(modalId) {
  document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// ===== å…¨é¡§å®¢è¡¨ç¤º =====
function showAllLogs() {
  currentCustomerId = null;
  document.querySelectorAll('.customer-item').forEach(item => {
    item.classList.remove('active');
  });
  document.getElementById('conversation-title').textContent = 'å…¨ã¦ã®ä¼šè©±ãƒ­ã‚°';
  loadAllLogs();
}

// ===== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ =====
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    const input = document.getElementById('message-input');
    if (document.activeElement === input) {
      e.preventDefault();
      sendMessage();
    }
  }
});
</script>
