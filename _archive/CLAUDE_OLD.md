# CLAUDE.md - 開発ルール

## セクション索引（何を管理しているか）

| セクション | 管理内容 | 対象者 | 更新頻度 |
|-----------|---------|--------|---------|
| **憲法** | 絶対不可侵の3条（思考=行動手順、技術的強制必須、強制力なき開発禁止） | Claude Code | **常時参照・例外なし** |
| **Section 0** | セッション開始ルール・KGI定義・必須読了ファイル | Claude Code | 毎セッション参照 |
| **Section 1** | 基本原則・作業開始時の手順 | Claude Code | 毎作業参照 |
| **Section 2** | コミットメッセージ形式・タイプ一覧 | Claude Code | コミット時参照 |
| **Section 3** | 作業終了時の必須手順・ログ更新 | Claude Code | 作業完了時参照 |
| **Section 4** | 禁止事項一覧（絶対厳守） | Claude Code | 常時参照 |
| **Section 5** | 横展開の判断基準 | Claude Code | 改善実施時参照 |
| **Section 6** | プロジェクト情報・アプリ一覧・URL | 全員 | 変更時更新 |
| **Section 7** | claspコマンド一覧 | Claude Code | GAS操作時参照 |
| **Section 8** | API整合性チェック（HTML↔GAS） | Claude Code | push前必須 |
| **Section 9** | google.script.run戻り値ルール | Claude Code | GAS実装時参照 |
| **Section 10** | Gemini監査体制（2社体制） | Claude Code | 監査実施時参照 |
| **Section 11** | GAS排他制御ルール（LockService） | Claude Code | GAS実装時参照 |
| **Section 12** | GAS複数環境フォルダ同期ルール | Claude Code | 環境同期時参照 |
| **Section 13** | ローカル↔GitHub同期ルール | Claude Code | 同期時参照 |
| **Section 14** | clasp/GAS可能操作リスト | Claude Code | GAS操作時参照 |
| **Section 15** | ポカヨケ設置報告フォーマット | Claude Code | ポカヨケ追加時参照 |
| **Section 16** | タスク完了判定チェックリスト | Claude Code | タスク完了時参照 |
| **Section 17** | テーブル描画ルール（XSS対策） | Claude Code | UI実装時参照 |
| **Section 18** | 新規工程追加時のポカヨケテスト | Claude Code | 新機能追加時参照 |
| **Section 19** | 環境設定記録・横展開パターン管理 | Claude Code | 環境設定時参照 |
| **Section 20** | UI/コード実装チェックリスト | Claude Code | 実装時参照 |
| **Section 21** | ルール設計チェックリスト | Claude Code | ルール追加時参照 |
| **Section 22** | ファイル管理ルール | Claude Code | ファイル操作時参照 |
| **Section 23-29** | 各種ポカヨケ（過去トラ対応） | Claude Code | 該当作業時参照 |
| **Section 30** | ポカヨケ設置時のポカヨケ | Claude Code | ポカヨケ追加時必須 |
| **Section 57** | 思考プロセス制御システム概要 | Claude Code | 毎セッション参照 |
| **Section 58** | 応答プロセスフロー | Claude Code | 毎メッセージ実行 |
| **Section 59** | ポカヨケチェックリスト | Claude Code | 毎応答実行 |
| **Section 60** | 介入率低減メカニズム | Claude Code | Phase管理時参照 |

### ファイル種別
| ファイル | 種別 | 管理内容 |
|---------|------|---------|
| CLAUDE.md | 制約ファイル | Claude Codeの動作ルール・制約・ポカヨケ |
| COMMON_RULES.md | ルールファイル | 全プロジェクト共通ルール |
| TROUBLE_LOG.md | 記録ファイル | 過去トラブル・対策・再発フラグ |
| PROJECT_SPECIFICATION.md | 仕様ファイル | プロダクトの機能仕様・データ仕様 |
| PENDING_TASKS.md | タスクファイル | 未完了タスク・引き継ぎ事項 |
| THINKING_PROCESS/SPEC.md | 仕様ファイル | 思考プロセス制御の詳細仕様 |

---

## 憲法（Constitution）- 絶対不可侵

**本憲法は全てのセクション・ルール・ポカヨケに優先する。いかなる例外も認めない。**

### 第1条: 思考プロセスの定義
**思考プロセス = 脳の行動手順**

思考プロセスは「考え方」ではなく「行動手順」として定義する。
- 入力 → 処理 → 出力 の明確な手順
- 曖昧な解釈を排除し、機械的に実行可能な形式

### 第2条: 技術的強制力の付与
**全ての行動手順に技術的強制力を付与する**

- 全てのルール・ポカヨケは技術的強制力（Hooks/CI/CD）を持つ
- ドキュメントのみのルールは無効
- 強制力の証拠: `sys.exit(2)` によるブロック機構

### 第3条: 強制力なきシステムの禁止
**技術的強制力のないシステムの開発を禁止する**

- 新規ルール追加時: 必ずブロック機構を実装
- 新規Hook作成時: `sys.exit(2)` を含むブロックロジック必須
- 違反時: enforcement_validator.py がブロック

### 第4条: 既存システムとの整合性保証
**技術的強制力は既存システムへの影響率0%を保証しなければならない**

#### 設計段階（開発前）
- 既存Hook/システムとの相互作用を分析
- 影響範囲を文書化
- 影響がないことを証明（影響分析レポート必須）

#### 検証段階（開発後）
- 意図した動作の検証テスト実施
- 既存システムへの副作用がないことを確認
- 検証結果レポート必須

#### 違反時
- 設計段階の証明なし → 開発禁止
- 検証段階の確認なし → 設置禁止
- 既存システムに影響発生 → 即時ロールバック

### 技術的強制力（Hook）

| Hook | ファイル | 効果 |
|------|---------|------|
| enforcement_validator.py | PreToolUse(Edit/Write) | 憲法第3条違反をブロック |

### 憲法違反の扱い

| 違反 | 対応 |
|------|------|
| 第1条違反 | 行動手順の再定義を要求 |
| 第2条違反 | 技術的強制力の追加を要求 |
| 第3条違反 | **システム開発をブロック（自動）** |
| 第4条違反 | **設置禁止・即時ロールバック** |

### KGI（憲法による保証）

| 指標 | 目標値 | 強制方法 |
|------|--------|---------|
| 既存システム影響率 | 0% | 第4条による設計・検証義務 |
| 再発率 | 0% | 第2条・第3条による技術的強制 |

---

## 0. セッション開始ルール（最優先）

### 0.1 KGI詳細定義

#### KGI一覧
| # | 指標 | 目標値 | 測定対象 | 成功条件 |
|---|------|--------|---------|----------|
| 1 | ルール違反率 | 0% | COMMON_RULES.md / CLAUDE.mdに対する違反 | 30日間連続0件 |
| 2 | 仕様違反率 | 0% | PROJECT_SPECIFICATION.mdに対する違反 | 30日間連続0件 |
| 3 | 過去トラ再発率 | 0% | TROUBLE_LOG.md記載事項の再発 | 全件再発なし |
| 4 | Human介入率 | 0% | feedback/question/instruction/confirmation発生 | Phase 5達成 |

---

#### KGI-1: ルール違反率（5W2H）

| 項目 | 内容 |
|------|------|
| **What** | COMMON_RULES.md / CLAUDE.md記載ルールへの違反件数 |
| **Where** | 対象ファイル: `COMMON_RULES.md`, `CLAUDE.md` |
| **When** | 全セッション中、全作業で常時監視 |
| **Who** | Claude Code（自己チェック）+ Human（レビュー） |
| **Why** | ルール違反 → プロジェクト品質低下 → 信頼喪失 |
| **How** | Humanからの指摘 または 自己発見で計測 |
| **How much** | 違反件数 / セッション数 × 100 = ルール違反率(%) |

**測定対象（ルール違反カテゴリ詳細）**:

| カテゴリ | 管理内容 | 違反例 | 参照箇所 |
|---------|---------|--------|---------|
| コミット | コミットメッセージの形式・内容ルール | 形式不正、タイプ未記載、Co-Authored-By漏れ | CLAUDE.md Section 2 |
| デプロイ | clasp deploy時の必須パラメータ・手順 | deploymentId未指定、テスト未実施で本番deploy | CLAUDE.md デプロイルール |
| 禁止事項 | 絶対に実行してはならない操作一覧 | スタンドアロンスクリプト作成、認証情報ハードコード | CLAUDE.md Section 4 |
| 開発モード | 通常/離席モードでの許可・禁止操作 | 離席モードで本番deploy、承認なし実装開始 | CLAUDE.md 開発モード |
| ドキュメント | 作業完了時の必須ドキュメント更新 | DEVELOPMENT_LOG.md未更新、TROUBLESHOOTING.md未更新 | CLAUDE.md Section 3 |
| セッション | セッション開始時の必須手順 | 読了報告なし作業開始、4ファイル未読了 | CLAUDE.md Section 0 |
| API整合性 | HTML-GAS間のAPI呼び出し整合性 | 存在しない関数呼び出し、引数不一致 | CLAUDE.md Section 8 |
| データ型 | google.script.run戻り値のシリアライズ | Date未変換、undefined返却 | CLAUDE.md Section 9 |

**各カテゴリの管理ルール詳細**:

**コミット**: メッセージ形式 `[タイプ] 概要` + 理由・変更内容・影響範囲 + Co-Authored-By必須
**デプロイ**: 必ず`--deploymentId`指定、テストURL確認後に本番deploy
**禁止事項**: スタンドアロンスクリプト禁止、仕様変更無断実行禁止、本番直接push禁止
**開発モード**: 離席モード時はclasp deploy/データ変更/構造変更禁止
**ドキュメント**: 作業完了時DEVELOPMENT_LOG.md必須、不具合修正時TROUBLESHOOTING.md必須
**セッション**: 6ファイル全文読了→読了報告→作業開始の順序厳守
**API整合性**: `npm run check`でHTML内のgoogle.script.run呼び出しとGAS関数の整合性確認
**データ型**: Dateオブジェクトは`toISOString()`で文字列変換必須

**成功基準**:
```
ルール違反率 = 0%
計算式: 違反件数 / 総セッション数 × 100
成功: 30日間連続で違反0件
```

---

#### KGI-2: 仕様違反率（5W2H）

| 項目 | 内容 |
|------|------|
| **What** | PROJECT_SPECIFICATION.md記載仕様への違反件数 |
| **Where** | 対象ファイル: `docs/01_crm/PROJECT_SPECIFICATION.md` |
| **When** | 実装・修正・機能追加時 |
| **Who** | Claude Code（自己チェック）+ Human（レビュー） |
| **Why** | 仕様違反 → 期待と異なる動作 → ユーザー混乱 |
| **How** | Humanからの指摘 または 自己発見で計測 |
| **How much** | 違反件数 / 実装タスク数 × 100 = 仕様違反率(%) |

**測定対象（仕様違反の例）**:
| カテゴリ | 違反例 | 影響 |
|---------|--------|------|
| データ構造 | シート列順序が仕様と異なる | データ不整合 |
| API | 関数名が仕様と異なる | フロント連携失敗 |
| UI | ボタン配置が仕様と異なる | UX混乱 |
| 機能 | 指示にない機能を追加 | 過剰実装 |
| 動作 | 計算式が仕様と異なる | 結果不正 |
| 制約 | 必須項目を任意にした | バリデーション漏れ |

**ルール違反との違い**:
| 観点 | ルール違反 | 仕様違反 |
|------|-----------|---------|
| 対象 | 開発プロセス・手順 | 成果物の内容 |
| 例 | コミットメッセージ形式 | シート列順序 |
| 参照 | COMMON_RULES.md, CLAUDE.md | PROJECT_SPECIFICATION.md |
| 検出 | プロセス中に検出 | 成果物レビューで検出 |

**成功基準**:
```
仕様違反率 = 0%
計算式: 違反件数 / 実装タスク数 × 100
成功: 30日間連続で違反0件
```

---

#### KGI-3: 過去トラ再発率（5W2H）

| 項目 | 内容 |
|------|------|
| **What** | TROUBLE_LOG.md記載済み事項の再発件数 |
| **Where** | 対象ファイル: `docs/01_crm/TROUBLE_LOG.md` |
| **When** | 全作業中 |
| **Who** | Claude Code（自己チェック）+ Human（レビュー） |
| **Why** | 再発 → 学習していない証拠 → 信頼喪失 |
| **How** | Humanからの指摘で「同一内容がTROUBLE_LOG.mdに存在」で判定 |
| **How much** | 再発件数 / 過去トラ総数 × 100 = 再発率(%) |

**再発判定基準**:
| 判定 | 条件 |
|------|------|
| 再発 | TROUBLE_LOG.mdに記載済みの内容と同一または類似 |
| 新規 | TROUBLE_LOG.mdに記載なし |
| 類似 | 根本原因が同一（表面的な現象は異なる可能性あり） |

**成功基準**:
```
過去トラ再発率 = 0%
計算式: 再発件数 / 過去トラ総数 × 100
成功: 全過去トラに対して再発0件
```

---

#### KGI-4: Human介入率（5W2H）

| 項目 | 内容 |
|------|------|
| **What** | Human介入（feedback/question/instruction/confirmation）の発生件数 |
| **Where** | 対象フォルダ: `docs/00_common/THINKING_PROCESS/` |
| **When** | 全セッション中 |
| **Who** | Claude Code（自動記録） |
| **Why** | Human介入 → 自律していない証拠 → 効率低下 |
| **How** | CONVERSATION_LOG.mdへの記録で計測 |
| **How much** | 介入件数 / 総応答数 × 100 = 介入率(%) |

**介入タイプ別定義**:
| タイプ | 定義 | AI責任 |
|--------|------|--------|
| feedback | Humanがミスを指摘 | 私がミスした |
| question | Humanが質問 | 私の説明不足 |
| instruction | Humanが指示 | 私の自発性不足 |
| confirmation | Humanが確認 | 私の報告不明確 |

**Phase別目標**:
| Phase | 介入率目標 | 達成条件 |
|-------|-----------|----------|
| Phase 1 | 100% | パイロット運用開始 |
| Phase 2 | 50% | 50件記録 + パターン分析完了 |
| Phase 3 | 20% | 主要パターンにポカヨケ設置 |
| Phase 4 | 5% | 自動チェック網羅 |
| Phase 5 | 0% | 例外パターン文書化完了 |

**成功基準**:
```
Human介入率 = 0%
計算式: (feedback + question + instruction + confirmation) / 総応答数 × 100
成功: Phase 5達成（Humanの応答が「yes」のみ）
```

---

#### KGI記録場所
| KGI | 記録場所 | 記録タイミング |
|-----|---------|---------------|
| ルール違反 | TROUBLE_LOG.md | 発生時 |
| 仕様違反 | TROUBLE_LOG.md | 発生時 |
| 過去トラ再発 | TROUBLE_LOG.md（is_recurrence=true） | 発生時 |
| Human介入 | THINKING_PROCESS/CONVERSATION_LOG.md | 毎セッション |

### 0.2 読了対象（6ファイル全文読了必須）
**作業開始前に必ず以下6ファイルを全文読了する。省略・要約読み禁止。**

| # | ファイル | パス | 効果 |
|---|---------|------|------|
| 1 | COMMON_RULES.md | docs/00_common/COMMON_RULES.md | ルール違反0% |
| 2 | CLAUDE.md | 本ファイル | 制約違反0% |
| 3 | TROUBLE_LOG.md | docs/01_crm/TROUBLE_LOG.md | 過去トラ再発0% |
| 4 | PROJECT_SPECIFICATION.md | docs/01_crm/PROJECT_SPECIFICATION.md | 仕様違反0% |
| 5 | PENDING_TASKS.md | docs/01_crm/PENDING_TASKS.md | 未完了タスク忘却0%（TROUBLE-032対応） |
| 6 | THINKING_PROCESS/SPEC.md | docs/00_common/THINKING_PROCESS/SPEC.md | Human介入率0%（Section 57対応） |

---

#### 各ファイルの管理内容詳細

**1. COMMON_RULES.md** - 全プロジェクト共通ルール
| 項目 | 内容 |
|------|------|
| What | 全プロジェクト横断で適用するルール・ポリシー |
| 管理内容 | 命名規則、コーディング規約、セキュリティポリシー、品質基準 |
| 更新条件 | 新ルール追加時、既存ルール変更時 |
| 違反時 | ルール違反としてTROUBLE_LOG.mdに記録 |

**2. CLAUDE.md** - 本プロジェクト固有の制約・設定
| 項目 | 内容 |
|------|------|
| What | 本プロジェクト固有のClaude Code動作ルール・制約 |
| 管理内容 | KGI定義、読了ルール、コミット形式、デプロイルール、禁止事項、離席モード、各種ポカヨケ |
| 更新条件 | プロジェクト設定変更時、新制約追加時 |
| 違反時 | ルール違反としてTROUBLE_LOG.mdに記録 |

**3. TROUBLE_LOG.md** - 過去トラブル記録
| 項目 | 内容 |
|------|------|
| What | 過去に発生した不具合・トラブルの記録と対策 |
| 管理内容 | TROUBLE-XXX形式のID、発生日、カテゴリ、内容、真因、対策、再発フラグ |
| 更新条件 | 新規不具合発生時、再発時 |
| 参照目的 | 同一ミスの防止、ポカヨケ設計の根拠 |

**4. PROJECT_SPECIFICATION.md** - プロダクト仕様書
| 項目 | 内容 |
|------|------|
| What | CRMダッシュボードの機能仕様・データ仕様 |
| 管理内容 | シート構成、列定義、API仕様、UI仕様、計算式、制約条件 |
| 更新条件 | 仕様変更時（実装前に更新必須） |
| 違反時 | 仕様違反としてTROUBLE_LOG.mdに記録 |

**5. PENDING_TASKS.md** - 未完了タスク管理
| 項目 | 内容 |
|------|------|
| What | セッション間で引き継ぐべき未完了タスク |
| 管理内容 | タスクID、内容、優先度、期限、ブロッカー、次アクション |
| 更新条件 | タスク追加時、完了時、状態変更時 |
| 参照目的 | タスク忘却防止（TROUBLE-032対応） |

**6. THINKING_PROCESS/SPEC.md** - 思考プロセス制御仕様
| 項目 | 内容 |
|------|------|
| What | Human介入率0%達成のための応答プロセス仕様 |
| 管理内容 | 応答フロー、メッセージ分類基準、ポカヨケチェックリスト、介入率低減メカニズム |
| 更新条件 | 仕様変更時、ポカヨケ追加時 |
| 参照目的 | 自律型エージェント動作の標準化 |

### 0.3 読了報告フォーマット（固定）
**報告なしの作業開始は禁止。**

```markdown
## セッション開始読了報告

| # | ファイル | 行数 | 状態 |
|---|---------|------|------|
| 1 | COMMON_RULES.md | X行 | 全文読了 |
| 2 | CLAUDE.md | X行 | 全文読了 |
| 3 | TROUBLE_LOG.md | X行 | 全文読了 |
| 4 | PROJECT_SPECIFICATION.md | X行 | 全文読了 |
| 5 | PENDING_TASKS.md | X行 | 全文読了 |
| 6 | THINKING_PROCESS/SPEC.md | X行 | 全文読了 |

### 過去トラ要注意事項（具体的内容必須：抜け穴10対応）
直近3件のTROUBLE番号と内容を記載（形骸化防止）：
- TROUBLE-XXX: [内容] → 本セッションでの注意点
- TROUBLE-XXX: [内容] → 本セッションでの注意点
- TROUBLE-XXX: [内容] → 本セッションでの注意点

### 本セッションの作業内容
[作業内容を記載]

### ポカヨケ設置作業の場合（Section 30確認必須）
※ポカヨケ設置を行う場合のみ記入

- [ ] Section 30「ポカヨケ設置時のポカヨケ」を全文読了した
- [ ] 突破不可チェックリストの5観点を理解した（強制性/客観性/曖昧性/例外許容/形骸化）
- [ ] Gemini突破テストが完了条件であることを理解した
```

### 0.4 運用メンテナンスルール
| ファイル | 更新タイミング | 責任者 |
|---------|---------------|--------|
| COMMON_RULES.md | 新ルール追加時 | 変更者 |
| CLAUDE.md | プロジェクト設定・制約変更時 | 変更者 |
| TROUBLE_LOG.md | 新過去トラ発生時 | 変更者 |
| PROJECT_SPECIFICATION.md | 仕様変更時 | 変更者 |
| FILE_INDEX.md | ファイル作成・削除時 | 変更者 |
| FUTURE_FEATURES.md | 未実装機能追加時 | 変更者 |

### 0.5 ファイル検索
**ファイルの場所が分からない場合**: FILE_INDEX.md を参照

| 探したいもの | 参照先 |
|-------------|--------|
| ルール・ポリシー | docs/00_common/ |
| エージェント仕様 | docs/00_common/AGENT_*.md |
| CRM仕様 | docs/01_crm/SPEC.md |
| 過去トラ | docs/01_crm/TROUBLE_LOG.md |
| ナレッジ | docs/03_knowledge/ |
| 未実装機能 | docs/00_common/FUTURE_FEATURES.md |

### 0.6 コンテキスト再開時ルール（ポカヨケ：抜け穴1対応）

コンテキストがコンパクション後に再開された場合も、以下を必須とする：

| # | チェック項目 | 確認方法 | 必須 |
|---|-------------|---------|:----:|
| 1 | git pull実行 | コマンド実行 | ✅ |
| 2 | 同期チェック | scripts/check-sync.sh | ✅ |
| 3 | 3環境検証 | scripts/verify-3env.sh | ✅ |
| 4 | 未完了タスクの確認 | サマリーから継続タスクを特定 | ✅ |

**判定基準**: 以下の場合はコンテキスト再開とみなす
- 「Continue from where we left off」の指示
- 前回のサマリーからの継続
- 長時間（2時間以上）経過後の再開

### 0.7 未設置ポカヨケ確認（ポカヨケ：抜け穴9対応）

セッション開始時、TROUBLE_LOG.mdから未設置ポカヨケを確認する：

```bash
# 未設置ポカヨケ検索
grep -n "設置予定\|ポカヨケ未設置\|対策予定" docs/01_crm/TROUBLE_LOG.md
```

| 状態 | 対応 |
|------|------|
| 未設置あり | 優先的にポカヨケ設置を完了 |
| 未設置なし | 通常作業開始 |

---

## 1. 基本原則
- 完璧より80%で前進
- ドキュメント更新は省略禁止
- 不明点はユーザーに確認

---

## 作業依頼テンプレート（ユーザー向け）

Claude Codeへの作業依頼時は以下の形式で指示すること：

```
まず以下を実行してください：
1. cd ~/sales-ops-with-claude
2. git pull
3. cat CLAUDE.md（全文を読んで内容を把握）

上記完了後、以下の作業を開始してください：
---
（作業内容）
```

---

## 1. 作業開始時

### Step 1: プロジェクト確認
「どのプロジェクトの作業ですか？」
- CRM → docs/01_crm/
- 採用診断 → docs/02_recruitment/
- 営業教育 → docs/03_sales_training/
- 共通 → docs/00_common/

### Step 2: 最新状態を取得
```bash
cd ~/sales-ops-with-claude
git pull
```

### Step 3: 認証確認
```bash
clasp status
git fetch
```
エラーが出た場合 → 「認証エラーが発生しました。再認証が必要です。」と報告

### Step 4: 前回の作業ログを確認
該当プロジェクトのDEVELOPMENT_LOG.mdを確認

## 2. 作業中

### コミットメッセージ形式
```
[タイプ] 概要

- 理由: なぜこの変更が必要だったか
- 変更内容: 何をどう変えたか
- 影響範囲: どのファイル/機能に影響するか
```

### タイプ一覧
- `[ADD]` 新機能追加
- `[FIX]` バグ修正
- `[UPDATE]` 既存機能の改善
- `[DELETE]` 機能・コード削除
- `[DOC]` ドキュメント
- `[REFACTOR]` コード整理
- `[CONFIG]` 設定変更

## 3. 作業終了時（必須・省略禁止）

### Step 1: 開発ログ更新
ファイル: `docs/[プロジェクト]/DEVELOPMENT_LOG.md`

フォーマット:
```markdown
## [YYYY-MM-DD] 作業タイトル

### 変更内容
- 箇条書きで具体的に

### 理由
- なぜこの変更が必要だったか

### 影響範囲
- 変更したファイル一覧

### 次回タスク
- 残っている作業

### 横展開候補（該当する場合）
#横展開候補
```

### Step 2: 不具合修正した場合
`docs/00_common/TROUBLESHOOTING.md` に追記

### Step 3: 改善実施した場合
`docs/00_common/IMPROVEMENT_LOG.md` に追記

### Step 4: git操作
```bash
git add .
git commit -m "[タイプ] 概要"
git push
```

### Step 5: 完了報告
「作業完了。ログ更新・push済み。」と報告

---

## 実装前宣言（必須・省略禁止）

新機能の実装前に、以下を宣言してユーザーの承認を得ること：

「以下の内容で実装します。問題なければ『OK』と返信してください。」

1. スプレッドシート
   - [ ] 新規作成（名前: ___）
   - [ ] 既存使用（ID: ___）
   - [ ] 使用しない ← 理由を説明必須

2. スクリプトタイプ
   - [ ] バインドスクリプト ← 原則こちら
   - [ ] スタンドアロン ← 禁止。絶対に使用しない

3. 作成するファイル一覧

**承認なしに実装を開始してはならない**

---

## 完了報告テンプレート（必須）

### 仕様照合チェック（必ず記入）

| 項目 | 指示 | 実装 | 一致 |
|------|------|------|------|
| スプレッドシート | ___ | ___ | ✅/❌ |
| スクリプトタイプ | バインド | ___ | ✅/❌ |
| シート構成 | ___ | ___ | ✅/❌ |
| 機能 | ___ | ___ | ✅/❌ |

❌がある場合は理由を説明し、承認を得ること。

---

## 4. 禁止事項（絶対厳守）

以下は**いかなる理由があっても禁止**。違反した場合は即座に作業を停止し報告すること。

### スタンドアロンスクリプトの使用禁止
- `clasp create --type standalone` は絶対に実行しない
- 必ずスプレッドシートにバインドしたスクリプトを使用
- 理由: スプレッドシート連携ができない、管理が複雑化する

### 仕様変更の無断実行禁止
- 指示と異なる実装をする場合は**事前承認必須**
- 「簡単だから」「効率的だから」は理由にならない

### ドキュメント更新なしの作業完了禁止
- DEVELOPMENT_LOG.md の更新は必須
- 不具合修正時は TROUBLESHOOTING.md も更新

### 承認なしの実装開始禁止
- 実装前宣言で承認を得てから開始すること

### 本番環境への直接push禁止
- テスト環境で確認後に本番デプロイ

### 認証情報のハードコード禁止
- スクリプトプロパティを使用すること

---

## デプロイルール（不変・厳守）

⚠️ **このルールは不変です。議論フレームワークで承認されない限り変更禁止。**

### CRMダッシュボード

| 環境 | デプロイID | URL |
|------|-----------|-----|
| 本番 | AKfycbzpeOkyBzA0kyD6T9aDE1uYVIil1z6KY0Ssc6Hta5EX7xoIAk_-EkxgmjILhN9Ceg5M | https://script.google.com/macros/s/AKfycbzpeOkyBzA0kyD6T9aDE1uYVIil1z6KY0Ssc6Hta5EX7xoIAk_-EkxgmjILhN9Ceg5M/exec?authuser=0 |
| テスト | @HEAD | https://script.google.com/macros/s/AKfycbwcYOukOoSaPgJjO7e6KBBtDaL0Rinl5-WmW00XMuQ/exec?authuser=0 |

### 開発フロー

1. コード修正
2. `clasp push`
3. テストURL（@HEAD）で動作確認
4. OKなら本番デプロイ：
```bash
   clasp deploy --deploymentId AKfycbzpeOkyBzA0kyD6T9aDE1uYVIil1z6KY0Ssc6Hta5EX7xoIAk_-EkxgmjILhN9Ceg5M --description "説明"
```

### 🚫 禁止（絶対厳守）

以下は**いかなる理由があっても禁止**：
```bash
# ❌ 禁止（新しいデプロイIDが作成される）
clasp deploy
clasp deploy --description "説明のみ"
```

### 新規アプリ追加時

新しいアプリを追加する場合、以下の手順で登録：
1. 本番用デプロイIDを1つ作成
2. テスト用は@HEADを使用
3. このセクションに追記

| アプリ | 本番ID | テストID（@HEAD） |
|--------|--------|-------------------|
| CRM | AKfycbzpeOkyBzA0kyD6T9aDE1uYVIil1z6KY0Ssc6Hta5EX7xoIAk_-EkxgmjILhN9Ceg5M | AKfycbwcYOukOoSaPgJjO7e6KBBtDaL0Rinl5-WmW00XMuQ |
| （今後追加時に記載） | | |

---

## 開発モード（必須・厳守）

### 通常モード（デフォルト）

オーナーがリアルタイムで確認できる時に使用。

```bash
clasp push
# テストURL（@HEAD）でオーナーが確認
# OK → clasp deploy --deploymentId [本番ID] --description "説明"
```

### 離席モード

オーナー不在時（離席・就寝中）に使用。
**オーナーから「離席モードで進めて」と指示があった場合のみ適用。**

```bash
clasp push（テスト反映のみ）
git commit & push（履歴保存）
# 次のタスクへ
# ⚠️ clasp deploy は絶対に実行しない
```

#### 離席モードの制約

| 制約 | 理由 |
|------|------|
| 🚫 clasp deploy 禁止 | 本番環境を保護 |
| 🚫 スプレッドシートのデータ変更禁止 | 既存データを保護 |
| 🚫 スプレッドシートの構造変更禁止 | シート追加・削除・列変更は禁止 |
| ✅ UI追加・変更のみ | 安全な範囲で進める |
| ✅ API関数追加のみ | 既存関数の変更は最小限 |
| ✅ 各タスクでgit commit | 問題時にrevert可能 |

#### 離席モード終了時

オーナーが戻ったら：
1. テストURL（@HEAD）で全機能確認
2. 問題なければ clasp deploy（本番）
3. 問題あれば git revert で戻す

### 自動承認設定

離席モード時、以下の操作は自動承認される：

| 操作 | 自動承認 | 備考 |
|------|---------|------|
| ファイル読み取り（view） | ✅ | |
| ファイル作成・編集（create, edit） | ✅ | |
| bash: git add / commit / push | ✅ | |
| bash: clasp push | ✅ | テスト版のみ |
| bash: npm install | ✅ | |
| bash: mkdir / cp / mv | ✅ | |

以下の操作は**手動承認が必要**（Discord通知を送信して待機）：

| 操作 | 手動承認 | 理由 |
|------|---------|------|
| clasp deploy | ⚠️ 必須 | 本番デプロイ |
| rm -rf / ファイル削除 | ⚠️ 必須 | 破壊的操作 |
| 環境変数の変更 | ⚠️ 必須 | 影響範囲大 |
| 新規APIキーの設定 | ⚠️ 必須 | セキュリティ |

### 承認待ち時の動作

手動承認が必要な場合：
1. Discord通知を送信
2. 作業を一時停止
3. オーナーの承認を待つ
```bash
# 承認待ち通知
~/sales-ops-with-claude/scripts/notify-discord.sh waiting "clasp deployを実行しますか？"
```

---

## Discord通知

### 概要

作業完了や承認待ちの際にDiscordに通知を送信する。

### 通知を送る場面

| 場面 | 通知内容 |
|------|---------|
| 離席モード開始 | 🚀 離席モード開始 |
| 作業完了時 | ✅ 作業完了: [タスク名] |
| 承認待ち時 | ⏸️ 承認待ち: [質問内容] |
| 認証必要時 | 🔐 認証必要: clasp login / git認証 |
| エラー発生時 | ❌ エラー: [エラー内容] |
| 全作業完了 | 🎉 全作業完了 |

### 通知コマンド
```bash
# 通知スクリプトを使用
~/sales-ops-with-claude/scripts/notify-discord.sh [タイプ] "[メッセージ]"

# タイプ一覧
# start    - 離席モード開始
# complete - 作業完了
# waiting  - 承認待ち
# auth     - 認証必要
# error    - エラー発生
# finish   - 全作業完了
```

### 使用例
```bash
# 離席モード開始
~/sales-ops-with-claude/scripts/notify-discord.sh start "Buddy MVP実装"

# タスク完了
~/sales-ops-with-claude/scripts/notify-discord.sh complete "📋 タスク: Buddyカード実装\n📁 ファイル: index.html\n🔗 コミット: abc1234"

# 承認待ち
~/sales-ops-with-claude/scripts/notify-discord.sh waiting "本番デプロイを実行しますか？"

# 認証必要
~/sales-ops-with-claude/scripts/notify-discord.sh auth "clasp login が必要です"

# エラー
~/sales-ops-with-claude/scripts/notify-discord.sh error "clasp push failed: 認証エラー"

# 全作業完了
~/sales-ops-with-claude/scripts/notify-discord.sh finish "📋 完了タスク: 5件\n🔗 最終コミット: xyz7890"
```

### 運用ルール

1. **離席モード時は必ず通知を使用する**
2. 各タスク完了時に通知
3. 承認が必要な場合は通知して一時停止
4. 認証エラー時は通知して一時停止
5. エラー発生時は通知して一時停止

---

## 5. 横展開の判断基準
以下に該当 → `#横展開候補` タグ付与：
- 他プロジェクトでも発生しうるバグ修正
- 汎用的な機能改善
- 効率化できた開発手法

---

## 6. プロジェクト情報

### リンク
- GitHub: https://github.com/shingo-ops/sales-ops-with-claude
- PMO: https://claude.ai/project/019baa4d-0736-72d7-87b0-108c6377ecb0

### アプリ一覧
| アプリ | フォルダ | 状態 |
|--------|----------|------|
| CRM | crm-dashboard | 開発中 |
| 採用診断 | recruitment-diagnosis | 運用中 |
| 会話ログDB | conversation-log | 運用中 |
| 営業教育 | sales-training | 計画中 |

### CRM（バインドスクリプト）
- Script ID: `1CQiLiFG8N77uYzlo3UNgAwml9_8mAJYAmfe4thp3RGsvbiwoaS-kS7X0`
- 本番デプロイID: `AKfycbzpeOkyBzA0kyD6T9aDE1uYVIil1z6KY0Ssc6Hta5EX7xoIAk_-EkxgmjILhN9Ceg5M`
- テストデプロイID: `AKfycbwcYOukOoSaPgJjO7e6KBBtDaL0Rinl5-WmW00XMuQ`（@HEAD）

### URL共有ルール
オーナーにURLを渡すときは、必ず `?authuser=0` を末尾に付けること。

## 7. clasp コマンド

```bash
# 各アプリのディレクトリで実行

# コードをプッシュ
clasp push

# デプロイ更新（CRM）- 必ず --deploymentId を指定すること
cd ~/sales-ops-with-claude/crm-dashboard
clasp deploy --deploymentId AKfycbzpeOkyBzA0kyD6T9aDE1uYVIil1z6KY0Ssc6Hta5EX7xoIAk_-EkxgmjILhN9Ceg5M --description "説明"

# GASエディタを開く
clasp open
```

---

## 8. API整合性チェック（必須・省略禁止）

### 概要

HTMLファイルから `google.script.run.xxx()` で呼び出している関数が、
WebApp.gs に実際に存在するかを自動チェックするシステム。

**getBuddyDataAuto問題（2026-01-12）を受けて導入。**

### チェックコマンド

```bash
cd ~/sales-ops-with-claude/crm-dashboard

# API整合性チェックのみ実行
npm run check

# チェック + clasp push（推奨）
npm run push

# 詳細表示
npm run check:verbose
```

### 必須タイミング

以下のタイミングで必ず `npm run check` を実行すること：

| タイミング | 必須 | 備考 |
|-----------|------|------|
| clasp push前 | ✅ | `npm run push` を使えば自動実行 |
| 離席モード完了時 | ✅ | 全タスク完了後に実行 |
| 本番デプロイ前 | ✅ | チェック成功を確認してから |
| HTMLファイル修正後 | ✅ | 新しいAPI呼び出しを追加した場合 |

### エラーが出た場合

```
❌ ERROR: index.html:3756 で呼び出している "getBuddyDataAuto" が WebApp.gs に存在しません
```

**対処法:**
1. WebApp.gs に該当関数を追加する
2. または、HTMLファイルの呼び出しを既存の関数名に修正する
3. 再度 `npm run check` を実行してパスすることを確認

### 離席モード用チェックリスト

離席モード完了時、clasp push前に以下を必ず実行：

```bash
# 1. API整合性チェック
npm run check

# 2. エラーがあれば修正

# 3. clasp push
clasp push

# 4. git commit & push
git add .
git commit -m "[タイプ] 概要"
git push
```

### 関連ドキュメント

- `docs/01_crm/API_REFERENCE.md` - WebApp.gsの全API関数一覧
- `docs/01_crm/DEVELOPMENT_CHECKLIST.md` - 開発時チェックリスト
- `docs/01_crm/BUG_FIX_LOG.md` - 不具合修正ログ

---

## 9. google.script.run 戻り値ルール（必須・厳守）

### 概要

`google.script.run` でブラウザにデータを返す際、特定の型はシリアライズに失敗して `null` になる。

**getLeads()がnullを返す問題（2026-01-12）を受けて文書化。**

### 問題のある型と変換方法

| 型 | 問題 | 変換方法 |
|---|---|---|
| `Date` | シリアライズ失敗 → null | `date.toISOString()` |
| `undefined` | シリアライズ不可 | `null` または プロパティ削除 |
| `function` | シリアライズ不可 | 削除 |
| 循環参照 | シリアライズ失敗 | 削除 |

### コード例

```javascript
// ❌ 悪い例 - Dateオブジェクトを含むとnullになることがある
function getLeads() {
  const data = sheet.getDataRange().getValues();
  return data.map(row => ({
    name: row[0],
    createdAt: row[1]  // ← Date オブジェクトの可能性
  }));
}

// ✅ 良い例 - Dateを文字列に変換
function getLeads() {
  const data = sheet.getDataRange().getValues();
  return data.map(row => ({
    name: row[0],
    createdAt: row[1] instanceof Date ? row[1].toISOString() : row[1]
  }));
}

// ✅ 良い例 - 汎用変換パターン
headers.forEach((header, index) => {
  let value = row[index];
  if (value instanceof Date) {
    value = value.toISOString();
  }
  obj[header] = value;
});

// ✅ 良い例 - 全体をJSON化（最も安全だが、日付フォーマットが変わる）
return JSON.parse(JSON.stringify(data));

// ✅ 推奨 - 汎用ヘルパー関数
function serializeForClient(data) {
  return JSON.parse(JSON.stringify(data, (key, value) => {
    if (value instanceof Date) {
      return value.toISOString();
    }
    return value;
  }));
}

// 使用例
return serializeForClient(leads);
```

### 対象となる関数

以下の関数は必ず Date 変換を行うこと：

| 関数 | ファイル | 状態 |
|---|---|---|
| `getLeads()` | WebApp.gs | ✅ 対応済み |
| `getDeals()` | WebApp.gs | ✅ 対応済み |
| `getStaffList()` | WebApp.gs | ✅ 対応済み |
| `getSheetDataAsObjects()` | DashboardService.gs | ✅ 対応済み |
| 新規追加時 | - | 📝 この表に追加 |

### チェックリスト

スプレッドシートからデータを返す関数を作成/修正する際：

- [ ] `getValues()` の結果をそのまま返していないか確認
- [ ] Date オブジェクトを ISO 文字列に変換しているか確認
- [ ] 新規関数の場合、上記の表に追加

### デバッグ方法

`google.script.run` で null が返ってきた場合：

1. サーバー側でログ出力して配列が正しく作成されているか確認
2. 配列内のオブジェクトに Date が含まれていないか確認
3. 含まれている場合は `toISOString()` で変換

```javascript
// デバッグ用コード
console.log('返却データ:', JSON.stringify(leads));
console.log('Date型チェック:', leads[0]?.登録日 instanceof Date);
```

---

## 10. Gemini監査体制（2社体制）

### 概要

Claude Code（開発担当）とGemini 2.5 Flash（監査担当）による2社体制で、解釈率95-98%を目指す。

**導入日**: 2026-01-17
**参照**: `docs/00_common/AI_AUDIT_SYSTEM_PROPOSAL.md`

### 必須監査トリガー（TROUBLE-022対応）

**監査役は「呼ばれたら動く」ではなく「重要変更時に必ず呼ばれる」。**
以下の変更時、Claude Codeは**必ず**Geminiに監査を依頼すること。

| # | トリガー | 監査必須 | 備考 |
|---|---------|:-------:|------|
| 1 | CLAUDE.mdのルール追加/変更/削除 | ✅ | プロジェクト基本憲章 |
| 2 | TROUBLE_LOG.mdへの過去トラ記録 | ✅ | 事実関係・再発防止策の妥当性 |
| 3 | ポカヨケの設置/変更/削除 | ✅ | 実効性・副作用の検証 |
| 4 | COMMON_RULES.mdの変更 | ✅ | プロジェクト横断的規律 |
| 5 | 禁止事項の追加/変更 | ✅ | リスク管理 |

**禁止事項**
- ❌ 上記トリガーに該当する変更をGemini監査なしで実行
- ❌ Geminiの監査結果を無視して変更を続行
- ❌ 監査役の指摘事項を記録せずに修正

**参照**: TROUBLE-022（監査役職務怠慢）

### Gemini承認エラー時ルール（ポカヨケ：抜け穴2対応）

Gemini APIへの接続エラー時、承認なしで作業を進めることを防止する。

| ステップ | アクション | 条件 |
|---------|----------|------|
| 1 | リトライ | 最大3回まで自動リトライ |
| 2 | 待機 | 5分間隔で再試行 |
| 3 | 人間報告 | 3回失敗後は人間に報告 |
| 4 | 作業停止 | 承認なしでの作業続行は禁止 |

**禁止事項**
- ❌ Gemini接続エラーを理由に承認をスキップ
- ❌ 「承認されたものとみなす」解釈
- ❌ 部分的なレスポンスを完全な承認とみなす

**例外**: 人間が明示的に「承認なしで進めて」と指示した場合のみ

### 役割分担

| AI | 役割 | モデル |
|----|------|--------|
| Claude Code | 開発・実装 | Opus/Sonnet |
| Gemini | 監査・レビュー | 2.5 Flash |

### 監査フロー

```
┌─────────────────────────────────────────┐
│  1. ユーザー指示                         │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  2. Claude Code（開発）                  │
│     - 指示を解釈                         │
│     - CLAUDE.mdに基づき実行計画          │
│     - コード生成・自己レビュー            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  3. Gemini監査（任意/重要時）            │
│     - 指示とコードの整合性検証            │
│     - CLAUDE.md準拠性チェック            │
│     - セキュリティ・バグの検出            │
└─────────────────────────────────────────┘
                    ↓
          問題あり → 修正 → 再監査
          問題なし → 完了
```

### 監査を実行するタイミング

| タイミング | 監査レベル | Geminiモデル |
|-----------|-----------|--------------|
| 日常的なコミット | 任意（推奨） | Flash |
| 本番デプロイ前 | **必須** | Flash/Pro |
| セキュリティ関連変更 | **必須** | Pro推奨 |
| 複雑なロジック変更 | **必須** | Pro推奨 |
| バグ修正後 | 推奨 | Flash |

### 監査コマンド

Claude Codeからの監査依頼方法：

```
# Geminiに監査を依頼
「以下のコードをレビューしてください：
- 指示: [ユーザーの元の指示]
- 実装内容: [実装の概要]
- 対象ファイル: [ファイルパス]
- 確認してほしい点: [具体的な確認項目]」
```

### 監査チェックリスト

Geminiが確認する項目：

- [ ] **指示との整合性**: ユーザーの指示を正確に実装しているか
- [ ] **CLAUDE.md準拠**: プロジェクトルールに従っているか
- [ ] **セキュリティ**: 脆弱性（XSS、インジェクション等）がないか
- [ ] **コード品質**: 可読性、命名規則、重複コードがないか
- [ ] **エラーハンドリング**: 適切な例外処理があるか
- [ ] **テスト**: テストケースが網羅されているか

### 監査結果フォーマット

Geminiからの監査結果は以下の形式で返却：

```markdown
## Gemini監査レポート

### 判定: ✅ 承認 / ⚠️ 修正要求 / ❌ 却下

### 確認項目
| 項目 | 結果 | 備考 |
|------|------|------|
| 指示との整合性 | ✅/❌ | |
| CLAUDE.md準拠 | ✅/❌ | |
| セキュリティ | ✅/❌ | |
| コード品質 | ✅/❌ | |

### 指摘事項（修正要求の場合）
1. [問題点]: [理由]
   - 修正案: [具体的なコード]

### 総評
[全体的なコメント]
```

### コスト管理

| 項目 | 値 |
|------|-----|
| 月間予算目安 | 約6,500円 |
| 1タスクあたり | 約32円 |
| 入力トークン | $0.35/100万 |
| 出力トークン | $1.05/100万 |

### 運用ルール

1. **日常監査はFlashを使用**（コスト効率優先）
2. **重要な変更時はPro使用を検討**
3. **監査結果は記録として残す**（必要に応じて）
4. **意見が割れた場合はユーザーに判断を仰ぐ**

---

## 11. GAS排他制御ルール（必須・厳守）

### 概要

GASでスプレッドシートやシート作成を行う場合、複数プロセスの同時実行による競合状態（Race Condition）を防ぐため、**LockServiceによる排他制御が必須**。

**導入日**: 2026-01-17
**参照**: TROUBLE-018（gemini-dashboard-gas競合状態エラー）

### 競合状態とは

```
プロセスA: getSheetByName() → null → insertSheet()
プロセスB:     getSheetByName() → null → insertSheet() ← 同時実行
結果: シート重複エラー「シート名「Config」はすでに存在しています」
```

### LockServiceの使用パターン（必須）

```javascript
// ✅ 必須パターン: シート作成/データ更新時
function initializeSheets() {
  const lock = LockService.getScriptLock();
  try {
    // 30秒でロック取得を試行（待機）
    lock.waitLock(30000);

    // === クリティカルセクション ===
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('Config');
    if (!sheet) {
      sheet = ss.insertSheet('Config');
      // 初期データ設定...
    }
    // === クリティカルセクション終了 ===

  } catch (e) {
    // ロック取得失敗または処理エラー
    throw new Error('排他制御エラー: ' + e.message);
  } finally {
    // 必ずロックを解放
    lock.releaseLock();
  }
}
```

### try-catchだけでは不十分な理由

```javascript
// ❌ 悪い例: try-catchで後処理するだけ
if (!sheet) {
  try {
    sheet = ss.insertSheet('Config');
  } catch (e) {
    sheet = ss.getSheetByName('Config'); // 競合状態は解消しない
  }
}
```

try-catchは**発生後の対処**であり、**根本原因（競合状態）を解消しない**。
LockServiceで**発生前に防止**することが必須。

### 排他制御が必要な操作一覧

| 操作 | LockService必須 | 理由 |
|------|----------------|------|
| シート作成（insertSheet） | ✅ 必須 | 重複エラー発生 |
| シート削除（deleteSheet） | ✅ 必須 | 存在確認→削除間に競合 |
| データ更新（setValue/setValues） | 推奨 | 同一セルへの同時書き込み |
| プロパティ更新（PropertiesService） | 推奨 | 同一キーへの同時書き込み |
| 読み取りのみ（getValue/getValues） | 不要 | 競合しない |

### 実装時チェックリスト

GAS開発時、以下を確認すること：

- [ ] `insertSheet()` を使用している場合、LockServiceで囲んでいるか
- [ ] `deleteSheet()` を使用している場合、LockServiceで囲んでいるか
- [ ] 複数ユーザーが同時アクセスする可能性がある機能か確認したか
- [ ] ロックのタイムアウト（waitLock）は適切か（推奨: 30秒）
- [ ] finally節で必ずreleaseLock()しているか

### 監査チェック項目（Gemini用）

```markdown
## GAS非機能要件チェック
- [ ] LockService使用: シート作成/削除時に排他制御があるか
- [ ] 実行時間: 6分制限を考慮しているか
- [ ] API割り当て: 1日の呼び出し制限を超えないか
- [ ] トリガー制限: 20個/ユーザーを超えていないか
```

### 関連ドキュメント

- TROUBLE-018: gemini-dashboard-gas競合状態エラー
- GAS公式: https://developers.google.com/apps-script/reference/lock/lock-service

---

## 12. GAS複数環境フォルダ同期ルール（必須・厳守）

### 概要

CRMプロジェクトには複数の環境フォルダが存在し、これらは同一コードを保持する必要がある。
1つのフォルダを修正したら、**必ず全フォルダを同期すること**。

**導入日**: 2026-01-18
**参照**: TROUBLE-019（複数GAS環境フォルダの同期漏れ）

### 同期が必要なフォルダ一覧

| フォルダ | 説明 | 同期必須 |
|---------|------|---------|
| crm-dashboard/ | 本番環境 | ✅ |
| crm-dashboard-dev/ | 開発環境 | ✅ |
| crm-dashboard-prop/ | 提案環境 | ✅ |

### 修正時の同期フロー

```bash
# 1. crm-dashboard/ でファイルを修正
edit crm-dashboard/SomeFile.gs

# 2. 他の環境フォルダに同期（必須）
cp crm-dashboard/SomeFile.gs crm-dashboard-dev/
cp crm-dashboard/SomeFile.gs crm-dashboard-prop/

# 3. 全フォルダで同期されたか確認
diff crm-dashboard/SomeFile.gs crm-dashboard-dev/SomeFile.gs
diff crm-dashboard/SomeFile.gs crm-dashboard-prop/SomeFile.gs

# 4. git commit & push
git add .
git commit -m "[FIX] SomeFile.gs修正（全環境同期）"
git push
```

### 同期確認コマンド（push前必須）

```bash
# 特定ファイルが全環境で同期されているか確認
find . -name "SomeFile.gs" -exec md5sum {} \;

# 差分がある場合は同期が必要
diff -r crm-dashboard/ crm-dashboard-dev/ --exclude=".clasp.json" --exclude="appsscript.json"
diff -r crm-dashboard/ crm-dashboard-prop/ --exclude=".clasp.json" --exclude="appsscript.json"
```

### チェックリスト（push前必須）

CRM関連ファイルを修正した場合：

- [ ] crm-dashboard/ の修正をcrm-dashboard-dev/ にコピーしたか
- [ ] crm-dashboard/ の修正をcrm-dashboard-prop/ にコピーしたか
- [ ] 差分コマンドで同期を確認したか
- [ ] GitHub ActionsのPokayokeチェックがパスするか確認したか

### 除外ファイル

以下のファイルは環境固有のため**同期しない**：

| ファイル | 理由 |
|---------|------|
| .clasp.json | 環境固有のスクリプトID |
| appsscript.json | 環境固有の設定 |

### 過去の問題事例

| 問題 | 原因 | 再発回数 |
|------|------|---------|
| TROUBLE-019 | crm-dashboard修正後にdev/propを同期せず | 3回 |

### GitHub Actions連携

push時に自動チェックが実行される。
同期漏れがあると「LockService Check」でエラーが表示される。

```
Annotations
10 errors
LockService Check: ./crm-dashboard-dev/SomeFile.gs#L0
Missing LockService in insertSheet operation
```

### 関連ドキュメント

- TROUBLE-019: 複数GAS環境フォルダの同期漏れ（手戻り3回）
- .github/workflows/pokayoke.yml: 自動チェックワークフロー

---

## 13. ローカル ↔ GitHub 同期ルール（必須・厳守）

### 概要

ローカルファイルとGitHubの同期ずれを防止するためのルール。
ローカル = 本番環境用データ、GitHub = バックアップ。

**KGI**: ローカルとGitHubのファイルずれ **0件**

### セッション開始時の同期チェック（必須）

作業開始前に必ず同期状態を確認すること。

```bash
# 同期チェックコマンド
~/sales-ops-with-claude/scripts/check-sync.sh
```

### 同期チェック結果の報告フォーマット

```markdown
## 同期チェック結果
| 項目 | 件数 | 状態 |
|------|------|------|
| 未コミットファイル | 0 | ✅ |
| 未pushコミット | 0 | ✅ |
| 未取得コミット | 0 | ✅ |

同期状態: ✅ 完全同期
```

### 同期ずれがある場合の対処

| 状態 | 対処 |
|------|------|
| 未コミットファイルあり | `git add . && git commit` |
| 未pushコミットあり | `git push` |
| 未取得コミットあり | `git pull` |

### pre-push hook のインストール（推奨）

push前に未コミットファイルを警告するhookをインストール：

```bash
cp ~/sales-ops-with-claude/scripts/pre-push-hook.sh .git/hooks/pre-push
chmod +x .git/hooks/pre-push
```

### 作業終了時の同期確認（必須）

作業終了時は必ず以下を実行：

```bash
git add .
git commit -m "[タイプ] 概要"
git push
~/sales-ops-with-claude/scripts/check-sync.sh  # 同期確認
```

### 関連ドキュメント

- scripts/check-sync.sh: 同期チェックスクリプト
- scripts/pre-push-hook.sh: pre-push hook

---

## 14. clasp/GAS可能操作リスト（ポカヨケ：TROUBLE-021）

### 背景

Claude Codeが「clasp APIでスプレッドシート作成可能」を認識せず「Human作業が必要」と誤回答した（TROUBLE-021）。

### ルール

**「できない」「Human作業が必要」と回答する前に、以下を確認すること。**

### clasp で可能な操作

| 操作 | コマンド | 備考 |
|------|---------|------|
| スプレッドシート+GAS作成 | `clasp create --type sheets --title "名前"` | バインドスクリプト付き |
| 指定フォルダに作成 | `clasp create --parentId [フォルダID]` | Google Driveフォルダ指定 |
| コードをGASにpush | `clasp push` | ローカル→GAS |
| コードをGASからpull | `clasp pull` | GAS→ローカル |
| Webアプリデプロイ | `clasp deploy --description "説明"` | 新規デプロイ |
| デプロイ更新 | `clasp deploy --deploymentId [ID]` | 既存更新 |
| GAS関数実行 | `clasp run [function]` | サーバー側実行 |
| GASエディタを開く | `clasp open` | ブラウザで開く |
| デプロイ一覧 | `clasp deployments` | ID確認 |

### GAS API で可能な操作

| 操作 | API | 備考 |
|------|-----|------|
| スプレッドシート作成 | `SpreadsheetApp.create()` | GASから作成 |
| ファイル作成 | `DriveApp.createFile()` | Google Drive |
| フォルダ作成 | `DriveApp.createFolder()` | Google Drive |
| ファイル移動 | `file.moveTo(folder)` | フォルダ間移動 |
| シート追加 | `ss.insertSheet()` | LockService必須 |
| メール送信 | `MailApp.sendEmail()` | Gmail |
| カレンダー操作 | `CalendarApp` | Googleカレンダー |

### 禁止事項

| # | 禁止 | 理由 |
|---|------|------|
| 1 | 上記リスト確認なしに「できない」と回答 | 誤回答防止 |
| 2 | 上記リスト確認なしに「Human作業が必要」と回答 | 誤回答防止 |

### 本当にHuman作業が必要なケース

| 操作 | 理由 |
|------|------|
| OAuth認証設定 | ブラウザでの手動認証が必要 |
| GCPプロジェクト設定 | コンソールでの手動設定が必要 |
| clasp login | ブラウザでの認証が必要 |
| APIの有効化 | GCPコンソールでの操作が必要 |

### 強制プロセス

**強制メカニズム（5W2H）**:

| 要素 | 内容 |
|------|------|
| When | 「できない」「Human作業が必要」と回答する前 |
| Where | clasp/GAS操作に関する全ての回答 |
| Who | Claude Code |
| What | 可能操作リスト確認＋確認結果添付 |
| How | 下記「強制メカニズム」に従う |
| How much | 対象回答の100%に適用 |

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 回答前 | 可能操作リストを確認 | **回答禁止** |
| 2 | 回答時 | 確認結果を回答に添付 | **回答無効** |
| 3 | 回答後 | 確認結果の検証可能 | **却下** |

**確認結果の添付形式（必須）**:

```markdown
## clasp/GAS可能操作確認（Section 14）

| # | 確認項目 | 結果 |
|---|---------|:----:|
| 1 | clasp可能操作リストを確認 | ✅/❌ |
| 2 | GAS API可能操作リストを確認 | ✅/❌ |
| 3 | 本当にHuman作業が必要なケースに該当 | ✅/❌ |

**判定**: [できる/Human作業必要]
**根拠**: [リスト内の該当項目 or 該当なしの理由]
```

---

## 15. ポカヨケ設置報告フォーマット（必須・省略禁止）

### 概要

ポカヨケ（誤り防止機構）を設置する前に、設置内容を報告し承認を得るためのフォーマット。

**導入日**: 2026-01-18
**参照**: TROUBLE-021（ポカヨケ設置前の内容報告漏れ）

### ⚠️ Section 30適用必須（強制誘導）

**ポカヨケ設置作業を開始する前に、必ずSection 30を読了すること。**

| # | 確認事項 | 必須 |
|---|---------|:----:|
| 1 | Section 30「ポカヨケ設置時のポカヨケ」を全文読了した | ✅ |
| 2 | 突破不可チェックリストの5観点を理解した | ✅ |
| 3 | Gemini突破テストが完了条件であることを理解した | ✅ |

**Section 30未読了でのポカヨケ設置は禁止。完了報告時に読了証明が必要。**

### 設計理念：レトリカルトライアングル

報告は以下の3要素を満たすこと：

| 要素 | 日本語 | 報告での実現 |
|------|--------|--------------|
| Logos | 論理 | 問題と対策の因果関係が明確 |
| Pathos | 共感 | 人間（オーナー）にとって分かりやすい |
| Ethos | 信頼 | 品質管理として適切である |

### ポカヨケ設置報告フォーマット

ポカヨケを設置する**前**に、以下の形式で報告すること：

```markdown
## ポカヨケ設置報告

| 項目 | 内容 |
|------|------|
| 対象 | [何の問題に対するポカヨケか] |
| 設置場所 | [ファイル名:セクション または スクリプト名] |
| 内容 | [具体的なルール/チェック項目/禁止事項] |
| 期待効果 | [KPI/KGI（定量的な目標値）] |
| 確認方法 | [効果をどうやって確認するか] |

### 承認依頼
上記内容で設置してよろしいですか？
```

### 設置フロー（TROUBLE-024対応：目的・禁止事項明記）

| # | ステップ | 目的 | 成果物 | 禁止事項 |
|---|---------|------|--------|---------|
| 1 | 問題発生・検知 | 問題を認識する | - | - |
| 2 | TROUBLE_LOG.md に過去トラ記録 | 問題を文書化し再発防止の基礎とする | TROUBLE_LOG.md更新 | - |
| 3 | ポカヨケ設置報告作成 | 対策内容を整理し可視化する | 報告フォーマット | - |
| 4 | 監査役（Gemini）に承認依頼 | 第三者視点で対策の妥当性を検証する | 承認/却下 | **人間への事前確認禁止** |
| 5 | 人間に最終報告 | Gemini承認済みの内容をオーナーに報告する | レポート | - |
| 6 | 人間承認 | オーナーが最終判断を下す | 承認/却下 | - |
| 7 | ポカヨケ設置 | 承認された対策をルールファイルに追記する | CLAUDE.md更新 | - |
| 8 | 設置完了報告 | 設置完了を記録し共有する | コミット | - |

**フロー図**
```
問題発生 → 過去トラ記録 → 報告作成 → Gemini承認 → 人間報告 → 人間承認 → 設置 → 完了報告
                                    ↑                        ↑
                              却下時は3へ戻る            却下時は3へ戻る
```

**ステップ4の禁止事項について（TROUBLE-024）**
- ❌ 「Gemini承認を取得してよいですか？」と人間に事前確認すること
- ✅ 先にGemini承認を取得し、承認済み内容を人間に報告すること
- 理由: Gemini監査は品質チェックであり、人間の許可は不要。人間への報告は承認済み内容の最終確認。

### 必須タイミング

| タイミング | 報告必須 | 備考 |
|-----------|---------|------|
| 新規ポカヨケ設置時 | ✅ 必須 | 事前報告 |
| 既存ポカヨケ修正時 | ✅ 必須 | 変更内容を報告 |
| ポカヨケ削除時 | ✅ 必須 | 削除理由を報告 |

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 報告なしのポカヨケ設置 | 内容の可視化のため |
| 2 | 監査役承認なしの設置 | 品質担保のため |
| 3 | 事後報告 | 事前承認プロセス |

### 5なぜ分析の必須化（TROUBLE-024対応）

過去トラ記録時、以下のフォーマットで5なぜ分析を実施すること：

```markdown
**なぜなぜ分析**
| なぜ# | 質問 | 回答 |
|-------|------|------|
| 1 | なぜ[問題]が発生したか？ | [直接原因] |
| 2 | なぜ[直接原因]が起きたか？ | [中間原因1] |
| 3 | なぜ[中間原因1]が起きたか？ | [中間原因2] |
| 4 | なぜ[中間原因2]が起きたか？ | [中間原因3] |
| 5 | なぜ[中間原因3]が起きたか？ | [真因] |

**真因**: [標準作業/仕組みレベルの根本原因]
**対策**: [真因を解消する仕組み]
```

**5なぜ分析のポイント（品質管理の知見）**

| ポイント | 説明 |
|---------|------|
| 表面原因で止まらない | 「油切れ」→「定期点検漏れ」→「構造理解不足」まで掘る |
| 仕組みに帰着させる | 人のミスではなく、仕組みの不備を真因とする |
| 再発防止に直結 | 真因を解消する対策を立てる |
| 標準作業を確認 | 標準があるか、標準が曖昧でないかを確認 |

**ポカミスの4大根本原因（参考）**

| 原因 | 説明 | 確認ポイント |
|------|------|-------------|
| 認識の欠如 | 本人がミスを認識していない | 問題の可視化が必要 |
| 標準の欠如 | 標準が未設定 | ルール追加が必要 |
| 標準の不備 | 目的や指示が曖昧 | 目的列・禁止事項列の追加 |
| 教育・訓練不足 | 適正判断が困難 | チェックリスト・例示の追加 |

### 報告例

```markdown
## ポカヨケ設置報告

| 項目 | 内容 |
|------|------|
| 対象 | 3環境システムの不整合（TROUBLE-020） |
| 設置場所 | scripts/verify-3env.sh |
| 内容 | フォルダ存在確認、.clasp.json整合性、08_Config.gs本番ID混入チェック |
| 期待効果 | KGI: 環境不整合 0件 |
| 確認方法 | スクリプト実行でPASS/FAIL判定 |

### 承認依頼
上記内容で設置してよろしいですか？
```

### 監査役承認の依頼方法

```
# Gemini MCPツールを使用
geminiChat prompt: "【監査役承認依頼】以下のポカヨケ設置を承認してください：..."
```

### 関連ドキュメント

- TROUBLE-021: ポカヨケ設置前の内容報告漏れ
- docs/00_common/AI_AUDIT_SYSTEM_PROPOSAL.md: 2社体制（Claude + Gemini）

---

## 16. タスク完了判定チェックリスト（ポカヨケ：TROUBLE-023）

### 概要

タスク完了を報告する前に、開発者と監査役のダブルチェックで未完了タスクの完了誤報告を防止する。

**導入日**: 2026-01-18
**参照**: TROUBLE-023（未完了タスクを完了扱いにした）

### ダブルチェック体制

| レイヤー | 担当 | 役割 |
|---------|------|------|
| 第1チェック（標準化） | 開発者（Claude Code） | チェックリストで自己確認 |
| 第2チェック（管理の定着） | 監査役（Gemini） | 標準ルール遵守を確認 |

### 開発者用チェックリスト（第1チェック）

タスク完了を報告する**前**に、以下を全て確認すること：

| # | 確認項目 | 必須 | 確認方法 |
|---|---------|:----:|---------|
| 1 | 設定ファイル/コード更新完了 | ✅ | `git diff` で差分確認 |
| 2 | 実操作完了（TROUBLE-027対応） | ✅ | 設定に対応する実操作（移動/作成/削除等）を実施 |
| 3 | リソース存在確認（URL/パス） | ✅ | `curl`/`ls`/ブラウザで確認 |
| 4 | 動作確認（実行/アクセス可能） | ✅ | 実際に機能を実行 |
| 5 | エラーなし | ✅ | 実行ログ/コンソール確認 |
| 6 | 関連タスク全て完了 | ✅ | 依存タスクの進捗確認 |

**設定と実操作の対応表（TROUBLE-027対応）**
| 設定変更 | 対応する実操作 |
|---------|---------------|
| フォルダID変更 | リソースをそのフォルダに移動 |
| 命名規則変更 | リソース名を変更 |
| スクリプトID変更 | clasp push/pull |
| デプロイID変更 | clasp deploy |

### 監査役用チェックリスト（第2チェック）

監査役（Gemini）は、開発者の完了報告に対して以下を確認する：

| # | 確認項目 | 必須 |
|---|---------|:----:|
| 1 | 開発者がチェックリストを実施したか | ✅ |
| 2 | 各チェック項目の結果が妥当か | ✅ |
| 3 | 完了報告が標準フォーマットに従っているか | ✅ |

### 完了報告フォーマット

```markdown
## タスク完了報告

### タスク
[タスク名]

### 完了判定チェック
| # | 項目 | 結果 | 確認内容 |
|---|------|:----:|---------|
| 1 | 設定/コード更新 | ✅ | [具体的な変更内容] |
| 2 | 実操作完了 | ✅ | [実施した操作（移動/作成/削除等）] |
| 3 | リソース存在 | ✅ | [確認したURL/パス] |
| 4 | 動作確認 | ✅ | [実行結果] |
| 5 | エラーなし | ✅ | [確認方法] |
| 6 | 関連タスク完了 | ✅ | [関連タスク名] |

全6項目確認済み。タスク完了。
```

### 禁止行為（絶対厳守）

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 設定更新のみで完了報告 | 動作確認が必須 |
| 2 | 動作確認なしで完了報告 | 未確認項目があるため |
| 3 | 関連タスク未確認で完了報告 | 依存関係の見落とし防止 |
| 4 | チェックリスト結果を省略 | 監査役が確認できない |

### KGI

| 指標 | 目標値 |
|------|--------|
| 未完了タスクの完了誤報告 | 0件 |
| 動作確認実施率 | 100% |

### 関連ドキュメント

- TROUBLE-023: 未完了タスクを完了扱いにした
- セクション10: Gemini監査体制（第2チェック担当）

---

## 17. テーブル描画ルール（ポカヨケ：TROUBLE-025）

### 概要

トークン消費を削減するため、テーブル描画方式を統一する。

**導入日**: 2026-01-18
**参照**: TROUBLE-025（Unicode罫線テーブル使用禁止違反）

### ルール

| 項目 | ルール |
|------|--------|
| 必須 | Markdownテーブル（`|`と`-`のみ使用）|
| 禁止 | Unicode Box Drawing文字（罫線文字）|
| 理由 | トークン消費が2-3倍になる |

### 使用例

**必須形式（Markdownテーブル）**
```markdown
| 項目 | 内容 |
|------|------|
| 例1 | データ |
| 例2 | データ |
```

**禁止形式（Unicode罫線）**
Box Drawing文字を使用したテーブルは禁止。視覚的美しさよりトークン効率を優先する。

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | Unicode罫線でテーブル描画 | トークン消費が2-3倍 |
| 2 | 視覚的美しさを理由に罫線使用 | 効率優先 |
| 3 | 口頭合意をドキュメント化せず終了 | 標準の欠如防止 |

### KGI

| 指標 | 目標値 |
|------|--------|
| Unicode罫線使用 | 0件 |
| トークン消費削減率 | 50-70% |

### 関連ドキュメント

- TROUBLE-025: Unicode罫線テーブル使用禁止違反

### 強制プロセス

**強制メカニズム（5W2H）**:

| 要素 | 内容 |
|------|------|
| When | テーブルを含む出力を行う前 |
| Where | 全てのテーブル出力 |
| Who | Claude Code |
| What | Unicode罫線不使用の確認 |
| How | 出力前にUnicode罫線文字を検索 |
| How much | 全テーブル出力に100%適用 |

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 出力前 | Unicode罫線文字を含まないか確認 | **出力禁止** |
| 2 | 出力時 | Markdownテーブル形式を使用 | **再描画** |
| 3 | 検知時 | 自動でMarkdown形式に変換 | **違反記録** |

**検知対象のUnicode文字**:
- Box Drawing文字（U+2500〜U+257F）
- 例: ─│┌┐└┘├┤┬┴┼

---

## 18. 新規工程追加時のポカヨケテスト（ポカヨケ：TROUBLE-026）

### 概要

新規工程・機能追加時に「暗黙の仕様」を見落とさないためのポカヨケテストルール。

**導入日**: 2026-01-18
**参照**: TROUBLE-026（Google Driveフォルダ構成・命名規則の解釈ずれ）

### ルール

新規工程・機能を追加する前に、以下のポカヨケテストを実施すること。

| # | チェック項目 | 必須 | 確認方法 |
|---|-------------|:----:|---------|
| 1 | 暗黙の仕様確認 | ✅ | 人間に「既存運用で守っているルールはあるか？」をヒアリング |
| 2 | フォルダ構成確認 | ✅ | 「どのフォルダに格納するか？」を確認 |
| 3 | 命名規則確認 | ✅ | 「命名プレフィックスは？」を確認 |
| 4 | 関連リソース確認 | ✅ | 「関連するシート・GAS・WebAppは？」を確認 |
| 5 | 仕様ドキュメント化 | ✅ | 確認した仕様をenv-config.jsonまたはCLAUDE.mdに記載 |

### 実施タイミング

| タイミング | ポカヨケテスト必須 |
|-----------|:----------------:|
| 新規プロジェクト作成 | ✅ |
| 新規環境（提案/開発/本番）追加 | ✅ |
| 新規GASプロジェクト作成 | ✅ |
| 新規スプレッドシート作成 | ✅ |
| 新規WebApp作成 | ✅ |

### Google Drive固定フォルダID

| 環境 | フォルダID | 命名プレフィックス |
|------|-----------|-------------------|
| 提案 | 1kDfjsZt6k6iXPRC6QRbjM6Kyfz2I1Bm5 | [提案] |
| 開発 | 1rV7ZKxZZtCubafp-9lMyCIPgmaAbJjh_ | [開発] |
| 本番 | 1JIPeqiT_2ucBUK875sQBcuSYHkT-GtdD | （なし） |

### 命名規則

| 環境 | リソース名フォーマット | 例 |
|------|----------------------|-----|
| 提案 | [提案]プロジェクト名 | [提案]CRM-Dashboard |
| 開発 | [開発]プロジェクト名 | [開発]CRM-Dashboard |
| 本番 | プロジェクト名 | CRM-Dashboard |

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 暗黙の仕様を確認せずに実装開始 | 解釈ずれ防止 |
| 2 | 既存運用知識をヒアリングせずに設計 | 仕様漏れ防止 |
| 3 | ポカヨケテストなしで新規工程を完了扱い | 品質担保 |
| 4 | 指定フォルダ外へのリソース作成 | 管理困難防止 |
| 5 | 命名規則に従わないリソース作成 | 識別困難防止 |

### KGI

| 指標 | 目標値 |
|------|--------|
| 暗黙仕様の見落とし | 0件 |
| 設計手戻り | 0件 |

### 関連ドキュメント

- TROUBLE-026: Google Driveフォルダ構成・命名規則の解釈ずれ
- env-config.json: 環境設定（フォルダID・命名規則）
- scripts/verify-3env.sh: 3環境検証スクリプト

### 強制プロセス

**強制メカニズム（5W2H）**:

| 要素 | 内容 |
|------|------|
| When | 新規工程・機能追加の前 |
| Where | 全ての新規追加作業 |
| Who | Claude Code |
| What | ポカヨケテスト実施＋結果添付 |
| How | ヒアリング質問を実行し回答を記録 |
| How much | 新規追加の100%に適用 |

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 実装前 | 5項目ヒアリングを実行 | **実装禁止** |
| 2 | 実装時 | ヒアリング結果を添付 | **無効** |
| 3 | 実装後 | 仕様をドキュメント化 | **未完了扱い** |

**ヒアリング質問テンプレート（必須）**:

```markdown
## 新規工程ポカヨケテスト（Section 18）

### ヒアリング質問
1. 既存運用で守っているルールはありますか？
2. どのフォルダに格納しますか？（提案/開発/本番）
3. 命名プレフィックスは何ですか？
4. 関連するシート・GAS・WebAppは何ですか？
5. 他に注意すべき仕様はありますか？

### 回答記録
| # | 質問 | 回答 |
|---|------|------|
| 1 | 既存運用ルール | [回答] |
| 2 | 格納フォルダ | [回答] |
| 3 | 命名プレフィックス | [回答] |
| 4 | 関連リソース | [回答] |
| 5 | その他仕様 | [回答] |
```

---

## 19. 環境設定記録と横展開パターン管理（ポカヨケ：TROUBLE-028）

### 背景

LLMは毎セッションでコンテキストがリセットされる。過去の「学び」を記憶として持ち越すことができない。そのため、環境設定情報や過去トラからの学びを「明示的にドキュメント化」しなければ、同じ問題が繰り返される。

**参照**: TROUBLE-028（環境設定情報の忘却と横展開能力の欠如）

### 19.1 環境設定記録ルール

環境設定を変更した場合、必ず以下に記録する。

**記録場所**: CLAUDE.md Section 19.3（環境設定一覧）

| 変更種別 | 記録必須 | 例 |
|---------|:-------:|-----|
| API有効化 | ✅ | clasp run API、GAS API |
| 認証設定 | ✅ | clasp login、OAuth設定 |
| 環境変数 | ✅ | スクリプトプロパティ |
| フォルダID | ✅ | Google Drive、GASプロジェクト |
| デプロイID | ✅ | Webアプリデプロイ |

### 19.2 横展開パターン管理

過去トラ記録時に、以下のパターンを抽出・タグ付けする。

**パターン抽出フォーマット**:

```markdown
| パターン# | パターン名 | 類似問題への適用条件 | 対策 |
|-----------|-----------|---------------------|------|
| P-001 | 環境設定忘れ | 設定変更時 | CLAUDE.mdに記録 |
```

**新規問題発生時の照合**:
1. 横展開パターン一覧（docs/00_common/CROSS_APPLY_PATTERNS.md）を参照
2. 類似パターンがあれば、その対策を適用
3. 照合結果を過去トラ記録に明記

### 19.3 環境設定一覧（現在）

| 項目 | 状態 | 設定日 | 備考 |
|------|------|--------|------|
| clasp run API | 有効 | - | GAS API実行可能 |
| clasp login | 済 | - | 認証済み |
| Google Drive API | 有効 | - | DriveApp使用可能 |
| 本番デプロイID | AKfycbzpeOkyBzA0kyD6T9aDE1uYVIil1z6KY0Ssc6Hta5EX7xoIAk_-EkxgmjILhN9Ceg5M | - | CRM |
| テストデプロイID | AKfycbwcYOukOoSaPgJjO7e6KBBtDaL0Rinl5-WmW00XMuQ | - | @HEAD |
| 提案環境デプロイID | AKfycbyXhSH6vfkTvZvBY9N-69_GQzzv8vXJ8cY4nNgx-dI465y6a6swQkJsvLALNXBe8Gwttg | - | prop |

### 禁止事項

- ❌ 環境設定変更をCLAUDE.mdに記録せずに完了扱い
- ❌ 過去トラ記録時に「横展開パターン」を抽出せずに完了
- ❌ 新規問題発生時に「横展開パターン一覧」を参照せずに対策立案

### KGI

| 指標 | 目標値 |
|------|--------|
| 環境設定忘れ | 0件/月 |
| 横展開漏れ（類似問題再発） | 0件/月 |

### 関連ドキュメント

- TROUBLE-028: 環境設定情報の忘却と横展開能力の欠如
- docs/00_common/CROSS_APPLY_PATTERNS.md: 横展開パターン一覧

### 強制プロセス

**強制メカニズム（5W2H）**:

| 要素 | 内容 |
|------|------|
| When | 環境設定変更時、過去トラ記録時 |
| Where | 全ての環境設定変更・過去トラ記録 |
| Who | Claude Code |
| What | 記録実施＋横展開パターン抽出 |
| How | CLAUDE.md Section 19.3に記録、パターン一覧と照合 |
| How much | 全変更・全過去トラに100%適用 |

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 変更後 | Section 19.3に記録 | **未完了扱い** |
| 2 | 過去トラ記録時 | 横展開パターン抽出 | **未完了扱い** |
| 3 | 新問題発生時 | パターン一覧と照合 | **対策立案禁止** |

---

## 20. UI/コード実装チェックリスト（ポカヨケ：TROUBLE-001〜006、010）

### 背景

初期開発時に発生した複数のUI/コード関連の不具合を再発防止するためのチェックリスト。

**関連TROUBLE**:
- TROUBLE-001: リードページ表示不具合
- TROUBLE-002: スライドパネル・Buddy入力欄不具合（TROUBLE-001再発）
- TROUBLE-003: 日付フォーマット・CSS未定義
- TROUBLE-004: ID重複・CSS overflow
- TROUBLE-005: 音声入力が3回重複
- TROUBLE-006: leadIdが空になる
- TROUBLE-010: 担当者マスタ列ずれ

### 実装前チェック

| # | チェック項目 | 確認方法 | 関連TROUBLE |
|---|-------------|---------|-------------|
| 1 | HTML要素のID重複がないか | `grep -r "id=\"xxx\"" *.html` | TROUBLE-004 |
| 2 | CSS定義が存在するか | 新規クラス追加時にstyle.htmlを確認 | TROUBLE-003 |
| 3 | 日付フォーマットが統一されているか | ISO形式またはYYYY-MM-DD | TROUBLE-003 |
| 4 | イベントリスナーが重複登録されていないか | addEventListener呼び出し箇所を確認 | TROUBLE-005 |
| 5 | データ引き渡し時にIDが空にならないか | パラメータの受け渡しを追跡 | TROUBLE-006 |
| 6 | 列名ベースでデータ取得しているか | インデックスベースは禁止 | TROUBLE-010 |
| 7 | overflow設定が適切か | スクロール領域のCSS確認 | TROUBLE-004 |

### 実装後チェック

| # | チェック項目 | 確認方法 |
|---|-------------|---------|
| 1 | 全画面で表示崩れがないか | 各ページを目視確認 |
| 2 | コンソールエラーがないか | ブラウザ開発者ツール |
| 3 | データが正しく表示されるか | テストデータで確認 |
| 4 | 入力が正しく動作するか | 各入力欄をテスト |

### 禁止事項

- ❌ インデックスベースのデータ取得（列ずれの原因）
- ❌ CSS未定義のクラス使用
- ❌ ID重複のHTML要素
- ❌ イベントリスナーの重複登録

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 実装完了前 | チェックリスト全項目確認 | **完了報告禁止** |
| 2 | 完了報告時 | チェック結果を添付 | **報告無効** |
| 3 | 報告後 | 結果の検証可能 | **差し戻し** |

---

## 21. ルール設計チェックリスト（ポカヨケ：TROUBLE-016）

### 背景

セッション開始ルール設計時にメンテナンスルールが漏れた問題を再発防止。

**参照**: TROUBLE-016（セッション開始ルール設計時のメンテナンスルール漏れ）

### 新規ルール設計時のチェック

| # | チェック項目 | 確認内容 |
|---|-------------|---------|
| 1 | メンテナンスルールは定義されているか | 更新タイミング、責任者、更新方法 |
| 2 | 例外ケースは想定されているか | エラー時、中断時の対応 |
| 3 | 形骸化防止策はあるか | 具体的な確認方法、違反検知 |
| 4 | 依存関係は明確か | 他ルールとの整合性 |
| 5 | 廃止条件は定義されているか | 不要になった場合の削除基準 |
| 6 | 既存ルールとの連携は確認したか（TROUBLE-032対応） | Section 0との連携、読了対象の追加が必要か |

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | ルール追加前 | 6項目チェックを実行 | **追加禁止** |
| 2 | ルール追加時 | チェック結果を添付 | **無効** |
| 3 | 追加後 | Gemini監査で確認 | **差し戻し** |

---

## 22. ファイル管理ルール（ポカヨケ：TROUBLE-017）

### 背景

ファイル分散による把握困難を防止。

**参照**: TROUBLE-017（ファイル分散による把握困難）

### ルール

| 項目 | ルール |
|------|--------|
| ファイル作成時 | FILE_INDEX.mdに追記 |
| ファイル削除時 | FILE_INDEX.mdから削除 |
| ファイル移動時 | FILE_INDEX.mdを更新 |
| 定期確認 | 月1回FILE_INDEX.mdと実ファイルの整合性確認 |

### ファイル配置基準

| ファイル種別 | 配置先 |
|-------------|--------|
| プロジェクト共通ルール | docs/00_common/ |
| プロジェクト固有仕様 | docs/01_crm/ 等 |
| 過去トラ | docs/01_crm/TROUBLE_LOG.md |
| ナレッジ | docs/03_knowledge/ |
| スクリプト | scripts/ |
| 環境設定 | environments/ |

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | ファイル作成/削除時 | FILE_INDEX.md更新 | **未完了扱い** |
| 2 | 更新時 | 更新内容を報告 | **無効** |
| 3 | 更新後 | git diffで確認可能 | **差し戻し** |

---

## 23. 初回公開設定手順（ポカヨケ：TROUBLE-014）

### 背景

Webアプリ初回公開設定の説明不足を防止。

**参照**: TROUBLE-014（Webアプリ初回公開設定の説明不足）

### 初回公開時の手順

| # | ステップ | 実行者 | 備考 |
|---|---------|--------|------|
| 1 | clasp push | Claude Code | コードをGASに反映 |
| 2 | GASエディタでデプロイ→新しいデプロイ | Human | 初回のみ手動 |
| 3 | 種類: Webアプリ | Human | 選択 |
| 4 | 次のユーザーとして実行: 自分 | Human | 選択 |
| 5 | アクセスできるユーザー: 全員 | Human | 必要に応じて |
| 6 | デプロイID取得 | Human | CLAUDE.mdに記録 |
| 7 | CLAUDE.mdにデプロイID追記 | Claude Code | Section 19.3 |

### 注意

- 初回公開はGASエディタから手動で行う必要がある
- 2回目以降は`clasp deploy --deploymentId xxx`で更新可能

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 公開後 | CLAUDE.md Section 19.3にデプロイID記録 | **未完了扱い** |
| 2 | 記録時 | 手順どおりに実施 | **無効** |
| 3 | 記録後 | git commitで証跡確保 | **差し戻し** |

---

## 24. エラー発生時報告ルール（ポカヨケ：TROUBLE-029/030）

### 背景

エラー発生時に詳細を報告せず、原因調査もせずに「手動で対応して」と丸投げした問題を防止。

**参照**:
- TROUBLE-029（不具合詳細の報告漏れ）
- TROUBLE-030（不具合原因の調査漏れ）

### エラー発生時の対応フロー

| # | ステップ | 内容 | 必須 |
|---|---------|------|:----:|
| 1 | エラー内容記録 | 完全なエラーメッセージを記録 | ✅ |
| 2 | 原因調査 | Web検索、ドキュメント確認等で原因を調査 | ✅ |
| 3 | 解決策調査 | 解決方法を調査 | ✅ |
| 4 | 報告 | 以下のフォーマットで報告 | ✅ |
| 5 | 解決実施 | 調査結果に基づき解決を試みる | ✅ |

### エラー報告フォーマット

```markdown
## エラー報告

| 項目 | 内容 |
|------|------|
| エラー内容 | [完全なエラーメッセージ] |
| 発生箇所 | [コマンド、ファイル、行番号] |
| 原因（調査結果） | [調査で判明した原因] |
| 解決方法 | [調査で判明した解決策] |
| 参照 | [参照したドキュメント、URL] |
| 次のアクション | [実施する解決策] |
```

### 禁止事項

- ❌ エラー発生時に原因調査をせずに諦める
- ❌ 詳細を報告せずに「手動で対応して」と丸投げ
- ❌ エラーメッセージの一部のみを報告（完全なメッセージを記録）

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | エラー発生時 | 原因調査を実施 | **諦め禁止** |
| 2 | 報告時 | フォーマットに従って報告 | **報告無効** |
| 3 | 報告後 | エラー内容の検証可能 | **差し戻し** |

---

## 25. 未完了タスク引き継ぎルール（ポカヨケ：TROUBLE-031）

### 背景

セッション終了時に未完了タスクが忘れられるリスクを防止。LLMはセッション間でコンテキストがリセットされるため、明示的な記録が必要。

**参照**: TROUBLE-031（未完了タスクの忘却リスク）

### セッション終了時のチェック

| # | チェック項目 | 対応 |
|---|-------------|------|
| 1 | 未完了タスクがあるか | ある場合→引き継ぎ記録 |
| 2 | Human対応待ちがあるか | ある場合→PENDING_TASKS.mdに記録 |
| 3 | エラー未解決があるか | ある場合→TROUBLE_LOG.mdに記録 |

### 未完了タスク記録先

| タスク種別 | 記録先 |
|-----------|--------|
| Human対応待ち | docs/01_crm/PENDING_TASKS.md |
| エラー未解決 | docs/01_crm/TROUBLE_LOG.md |
| 継続開発タスク | docs/01_crm/DEVELOPMENT_LOG.md |
| 環境設定待ち | CLAUDE.md Section 19.3 |

### 引き継ぎフォーマット

```markdown
## 未完了タスク引き継ぎ

| 項目 | 内容 |
|------|------|
| タスク | [未完了タスクの内容] |
| 状態 | [どこまで完了したか] |
| ブロッカー | [完了できない理由] |
| 次のアクション | [次セッションで行うべきこと] |
| 記録場所 | [記録したファイル] |
```

### 禁止事項

- ❌ 未完了タスクを報告せずにセッション終了
- ❌ 「次回やります」の口約束のみで記録なし
- ❌ 未完了タスクの記録場所を明示しない

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | セッション終了前 | タスク状態チェック実施 | **セッション終了禁止** |
| 2 | 引き継ぎ時 | フォーマットに従って記録 | **引き継ぎ無効** |
| 3 | 記録後 | 記録場所のパスを明示 | **差し戻し** |

**チェックリスト（セッション終了時必須）**:
```markdown
## セッション終了チェック
- [ ] 未完了タスクがあるか確認した
- [ ] 未完了タスクを適切なファイルに記録した
- [ ] 記録場所のパスを報告に含めた
```

---

## 26. コミュニケーション品質チェックリスト（ポカヨケ：TROUBLE-033〜036）

### 背景

報告・提案・議論において、以下の問題が繰り返し発生：
- 報告が「情報伝達」で止まり「認識合わせ」に至らない（TROUBLE-033）
- 解決策提案時のリスク評価漏れ（TROUBLE-034）
- 速度優先による正確性軽視（TROUBLE-035）
- Humanを議論パートナーではなく承認者扱い（TROUBLE-036、TROUBLE-015再発）

**共通パターン**: 速度優先、一方通行、独断実行

### 報告前チェック（TROUBLE-033対応）

| # | チェック項目 | NG例 | OK例 |
|---|-------------|------|------|
| 1 | 報告内容に矛盾がないか | 「Aは正しい」→「Aに問題がある」 | 整合性を確認してから報告 |
| 2 | 前回の報告と一貫性があるか | 前言撤回を説明なし | 変更があれば理由を明記 |
| 3 | Humanが理解できる詳細度か | 「エラーです」のみ | エラー内容、原因、対策を記載 |

### 提案前チェック（TROUBLE-034対応）

| # | チェック項目 | 確認内容 |
|---|-------------|---------|
| 1 | 機能面 | 提案した解決策で問題は解決するか |
| 2 | セキュリティリスク | 機密情報の漏洩リスクはないか |
| 3 | 既存システムへの影響 | 他の機能に悪影響はないか |
| 4 | 公開範囲 | GitHubに公開されても問題ないか |
| 5 | コスト | 実装・運用コストは妥当か |

**提案フォーマット**:
```markdown
## 提案: [タイトル]

### 内容
[何をするか]

### 期待効果
[解決される問題]

### リスク評価
| リスク | 評価 | 対策 |
|--------|------|------|
| セキュリティ | 高/中/低 | [対策] |
| 既存影響 | 高/中/低 | [対策] |
| 公開範囲 | OK/NG | [理由] |

### 選択肢（複数ある場合）
| # | 選択肢 | メリット | デメリット | 推奨度 |
|---|--------|---------|-----------|--------|
| 1 | [選択肢1] | [メリット] | [デメリット] | 高/中/低 |
| 2 | [選択肢2] | [メリット] | [デメリット] | 高/中/低 |
```

### 説明品質チェック（TROUBLE-035対応）

| # | チェック項目 | 確認方法 |
|---|-------------|---------|
| 1 | 小学生でも分かるか | 専門用語を避ける、または説明を付ける |
| 2 | 結果・影響が明記されているか | 「Xすると→Yになる」形式で記載 |
| 3 | 選択肢に判断材料があるか | 各選択肢のメリット・デメリットを記載 |

### 議論中チェック（TROUBLE-036対応）

| # | チェック項目 | NG例 | OK例 |
|---|-------------|------|------|
| 1 | 結論を勝手に出していないか | 「〜として記録します」 | 「〜として記録して良いですか？」 |
| 2 | 「提案」と「結論」を区別しているか | 「〜です」（断定） | 「〜と提案します。いかがでしょうか？」 |
| 3 | Humanの意見を求めているか | 一方的に進める | 「ご意見をお聞かせください」 |

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 矛盾した報告 | 信頼性低下 |
| 2 | リスク未評価の提案 | 問題発生リスク |
| 3 | 詳細なしの「〜してください」 | 判断材料不足 |
| 4 | 議論中の独断結論 | 認識合わせ不足 |
| 5 | 承認なしの実行 | Humanの意思決定権侵害 |

### このチェックリストの使用タイミング

| 場面 | 使用セクション |
|------|---------------|
| エラー報告時 | 報告前チェック + 説明品質チェック |
| 解決策提案時 | 提案前チェック + 説明品質チェック |
| ルール追加提案時 | 提案前チェック + 議論中チェック |
| 議論・相談時 | 議論中チェック |

### 実施証拠の提出（必須）

**チェックリスト実施を証明するため、以下を報告に含めること：**

```markdown
## コミュニケーション品質チェック実施証拠

| # | チェック項目 | 結果 | 根拠 |
|---|-------------|------|------|
| 1 | 報告内容に矛盾がないか | OK/NG | [確認した方法] |
| 2 | 前回報告との一貫性 | OK/NG | [変更がある場合は理由] |
| 3 | 詳細度（専門用語3つ以内or注釈付き） | OK/NG | [専門用語リスト] |
| 4 | リスク評価実施 | OK/NG | [各リスクの根拠] |
| 5 | 結論を勝手に出していないか | OK/NG | [確認方法] |

✅ 上記チェック完了（チェックなしの報告は却下対象）
```

**客観的基準**:
- 「小学生でも分かるか」→「専門用語を3つ以内に抑えるか、または注釈をつけたか」
- 「リスク評価」→「低」と判断した場合は根拠を必須記載

---

## 27. ポカヨケ設置フロー（2極化モデル）（ポカヨケ：TROUBLE-037）

### 背景

ポカヨケを設置しても再発が起きた（TROUBLE-022→TROUBLE-037）。
原因: ポカヨケの有効性検証がなく、「設置して終わり」になっていた。

**参照**: TROUBLE-037（Gemini監査未実行・再発）

### ⚠️ Section 30との連携（必須）

**本セクションはSection 30「ポカヨケ設置時のポカヨケ」と連携して使用すること。**

| 役割 | Section | 内容 |
|------|---------|------|
| フロー定義 | Section 27（本セクション） | 2極化モデル、突破テストの観点 |
| 品質保証 | Section 30 | 突破不可チェックリスト、証拠定義、完了条件 |

**Section 30の完了条件を満たさない限り、ポカヨケ設置は完了とみなさない。**

### 2極化モデルの概念

| 役割 | 意向 | 目的 |
|------|------|------|
| 開発者 | 防ごうとする | ポカヨケを設置し、不良を防止 |
| 監査役 | 破ろうとする | ポカヨケを突破し、弱点を発見 |

**2極化のメリット**: 開発と監査の意向が対立することで、ポカヨケの精度が高水準に保たれる

### ポカヨケ設置フロー（必須）

```
問題発生 → 過去トラ記録 → 開発者: ポカヨケ設置
                              ↓
                        監査役: ポカヨケ突破テスト
                              ↓
              突破成功 → 要因分析 → ポカヨケ改修 → 再テスト（ループ）
              突破失敗 → ポカヨケ承認 → 完了
```

### 突破テストの実施方法

監査役は以下の観点でポカヨケ突破を試みる：

| # | 観点 | 質問 |
|---|------|------|
| 1 | ルールを読まなくても通れるか | チェックリストを見なくても作業を進められるか |
| 2 | ルールを無視しても通れるか | チェックを飛ばしても次のステップに進めるか |
| 3 | 解釈を変えれば通れるか | 曖昧な表現を悪用できるか |
| 4 | 例外を主張すれば通れるか | 「今回は特別」で回避できるか |
| 5 | 形式的に満たせば通れるか | 形だけチェックして実質未確認でも通れるか |

### 突破テスト報告フォーマット

```markdown
## ポカヨケ突破テスト報告

### 対象ポカヨケ
- Section: XX
- TROUBLE: TROUBLE-XXX

### テスト結果
| # | 観点 | 結果 | 詳細 |
|---|------|------|------|
| 1 | 読まなくても通れるか | 通れた/通れず | [詳細] |
| 2 | 無視しても通れるか | 通れた/通れず | [詳細] |
| 3 | 解釈を変えれば通れるか | 通れた/通れず | [詳細] |
| 4 | 例外を主張すれば通れるか | 通れた/通れず | [詳細] |
| 5 | 形式的に満たせば通れるか | 通れた/通れず | [詳細] |

### 総合判定
- [ ] 承認（全て「通れず」）
- [ ] 要改修（1つでも「通れた」）

### 改修提案（要改修の場合）
[改修内容]
```

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 突破テストなしでポカヨケ設置完了 | 有効性未検証 |
| 2 | 突破成功を無視して承認 | 形骸化 |
| 3 | 監査役が「通れた」と報告しない | 問題隠蔽 |
| 4 | 開発者が改修せずに再テスト | 改善なし |

### フロー実行の強制ルール

**ポカヨケ設置の完了条件**:

1. 過去トラ記録が完了している
2. ポカヨケがCLAUDE.mdに追記されている
3. **Gemini監査役による突破テスト報告が提出されている**
4. **突破テスト結果が「全て通れず」である**
5. TROUBLE_POKAYOKE_MAPPING.mdが更新されている

**突破テスト報告の必須記載事項**:

```markdown
## 突破テスト報告（必須）

### 具体的テストシナリオ
| # | 観点 | テストシナリオ | 結果 | 詳細 |
|---|------|--------------|------|------|
| 1 | 読まなくても通れるか | [具体的に何をしたか] | 通れた/通れず | [なぜ通れた/通れなかったか] |
| 2 | 無視しても通れるか | [具体的に何をしたか] | 通れた/通れず | [なぜ通れた/通れなかったか] |
| 3 | 解釈を変えれば通れるか | [具体的に何をしたか] | 通れた/通れず | [なぜ通れた/通れなかったか] |
| 4 | 例外を主張すれば通れるか | [具体的に何をしたか] | 通れた/通れず | [なぜ通れた/通れなかったか] |
| 5 | 形式的に満たせば通れるか | [具体的に何をしたか] | 通れた/通れず | [なぜ通れた/通れなかったか] |

### 判定基準（厳格）
- **1つでも「通れた」→ 要改修（承認不可）**
- **全て「通れず」→ 承認**

### 例外主張への対応
- 「軽微な変更」「急ぎ」等の例外主張は**一切認めない**
- 例外を認めた場合はTROUBLEとして記録
```

---

## 28. 新規プロジェクト開始チェックリスト（ポカヨケ：TROUBLE-039/040）

### 背景

新規プロジェクト（Gemini Dashboard）で3環境システムを適用せず、環境分離ができていなかった。
原因: 新規プロジェクト作成時のチェックリストがなかった。

**参照**: TROUBLE-039（3環境システム未適用）、TROUBLE-040（提案環境の定義曖昧）

### 新規プロジェクト作成時の必須チェック

| # | チェック項目 | 確認内容 | 合格条件 |
|---|-------------|---------|---------|
| 1 | 3環境システム目的理解 | 「3環境システムの目的は何か？」 | 「段階的テスト」と回答できる |
| 2 | 環境分離設計 | 本番/開発/提案の3環境を設計したか | 3つの独立環境を設計 |
| 3 | GASプロジェクト作成 | 各環境に独立したGASプロジェクトを作成したか | 3つのscriptIdが存在 |
| 4 | フォルダ構成 | プロジェクト-prod/dev/propのフォルダを作成したか | 3つのフォルダが存在 |
| 5 | .clasp.json設定 | 各フォルダに正しいscriptIdが設定されているか | 各環境のscriptIdが一致 |
| 6 | 反映順序理解 | 「反映順序は？」 | 「提案→開発→本番」と回答できる |

### チェックリスト報告フォーマット

```markdown
## 新規プロジェクト開始チェック

### プロジェクト情報
| 項目 | 内容 |
|------|------|
| プロジェクト名 | [名前] |
| 作成日 | YYYY-MM-DD |
| 担当者 | [担当者] |

### チェック結果
| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 1 | 3環境システム目的理解 | OK/NG | [回答内容] |
| 2 | 環境分離設計 | OK/NG | |
| 3 | GASプロジェクト作成 | OK/NG | [scriptId一覧] |
| 4 | フォルダ構成 | OK/NG | [フォルダ一覧] |
| 5 | .clasp.json設定 | OK/NG | |
| 6 | 反映順序理解 | OK/NG | [回答内容] |

### 総合判定
- [ ] 合格（全てOK）→ 開発開始可
- [ ] 不合格（1つでもNG）→ 開発開始禁止
```

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | チェックなしで開発開始 | 環境分離漏れのリスク |
| 2 | 1つのGASプロジェクトで3環境を表現 | 環境分離不可 |
| 3 | 「提案環境」をラベルとして使用 | 形だけの環境分離 |
| 4 | 目的を理解せずに環境作成 | 本質的な分離ができない |

### 客観的証拠の提出（必須）

**自己申告ではなく、客観的証拠を提出すること：**

| # | チェック項目 | 必須証拠 |
|---|-------------|---------|
| 1 | 3環境システム目的理解 | 「なぜ段階的テストが必要か」の説明（暗記不可、応用質問） |
| 2 | 環境分離設計 | 設計図またはフォルダ構成図 |
| 3 | GASプロジェクト作成 | 3つのscriptIdを記載（コピペ） |
| 4 | フォルダ構成 | `ls -la`コマンドの結果を添付 |
| 5 | .clasp.json設定 | 各.clasp.jsonの内容を添付 |
| 6 | 反映順序理解 | 「順序を間違えるとどうなるか」の説明 |

**理解度チェック質問（暗記不可）**:
- 「なぜ段階的テストが必要か、具体的なリスクを挙げて説明してください」
- 「反映順序を間違えるとどのような問題が発生しますか」

### 監査レビュー必須

**チェックリスト報告は、監査役（Gemini）によるレビューを経て承認される：**

1. 開発者がチェックリスト報告を作成
2. **Gemini監査役が証拠を確認**
3. 証拠が不十分な場合→差し戻し
4. 証拠が十分な場合→承認→開発開始可

```markdown
## 監査役レビュー結果

| # | チェック項目 | 証拠確認 | 判定 |
|---|-------------|---------|------|
| 1 | 3環境システム目的理解 | [証拠内容] | OK/NG |
| 2 | 環境分離設計 | [証拠内容] | OK/NG |
| 3 | GASプロジェクト作成 | [scriptId確認] | OK/NG |
| 4 | フォルダ構成 | [ls結果確認] | OK/NG |
| 5 | .clasp.json設定 | [設定確認] | OK/NG |
| 6 | 反映順序理解 | [証拠内容] | OK/NG |

**総合判定**: 承認 / 差し戻し
**差し戻し理由**（該当する場合）: [理由]
```

---

## 29. 報告フォーマット（PREP）（ポカヨケ：TROUBLE-038）

### 背景

報告時に結論から述べず、調査プロセスから説明してHumanを混乱させた。
原因: PREPフォーマットが義務化されていなかった。

**参照**: TROUBLE-038（結論から答えられなかった）

### PREPフォーマット

| 要素 | 内容 | 例 |
|------|------|-----|
| **P**oint | 結論（何が問題か/何をすべきか） | 「結論: 3環境システムが未適用です」 |
| **R**eason | 理由（なぜそう言えるか） | 「理由: GASプロジェクトが1つしかないため」 |
| **E**xample | 具体例（どこで確認したか） | 「確認: .clasp.jsonにscriptIdが1つのみ」 |
| **P**oint | 結論の再確認（だから何をすべきか） | 「対応: 3つのGASプロジェクトを作成する必要があります」 |

### 報告テンプレート

```markdown
## 報告: [タイトル]

### 結論（Point）
[何が問題か / 何をすべきか]

### 理由（Reason）
[なぜそう言えるか]

### 確認内容（Example）
[どこで確認したか / 具体的なデータ]

### 対応提案（Point）
[だから何をすべきか]
```

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 結論を最後に述べる | Humanが最後まで読まないと分からない |
| 2 | 調査過程から説明する | 「作業している姿勢」の誇示は不要 |
| 3 | 結論なしで質問する | Humanに考えさせる負担 |
| 4 | 曖昧な結論 | 「問題がありそう」ではなく「問題がある」 |

### 使用タイミング

| 場面 | PREP使用 | 備考 |
|------|:-------:|------|
| エラー報告 | 必須 | 何が問題かを先に |
| 調査結果報告 | 必須 | 結論を先に、詳細は後 |
| 提案 | 必須 | 何を提案するかを先に |
| 質問 | 推奨 | 「確認したいのは〜」を先に |
| 議論 | 推奨 | 自分の意見を先に |

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 報告前 | PREP構造で整理 | **報告禁止** |
| 2 | 報告時 | P→R→E→P順序で記載 | **報告無効・差し戻し** |
| 3 | 報告後 | 結論が先頭にあるか検証可能 | **報告却下** |

**チェックリスト（報告前必須）**:
```markdown
## PREP構造チェック
- [ ] 結論（Point）を先頭に記載した
- [ ] 理由（Reason）を結論の直後に記載した
- [ ] 具体例（Example）で根拠を示した
- [ ] 最後に結論を再確認した（Point）
```

---

## 30. ポカヨケ設置時のポカヨケ（ポカヨケ：TROUBLE-041）

### 背景

ポカヨケを設置しても、そのポカヨケ自体がGemini監査役に「突破可能」と判定された（Section 26-28の初回設置時）。
原因: ポカヨケ設置時に「突破されないか」を検証するプロセスがなかった。

**参照**: TROUBLE-041（Geminiが突破できるポカヨケを設置した）

### 概念: メタポカヨケ

| レベル | 内容 | 例 |
|--------|------|-----|
| ポカヨケ | 問題を防ぐルール | Section 26: コミュニケーション品質チェック |
| メタポカヨケ | ポカヨケの品質を保証するルール | Section 30: 突破不可チェックリスト |

### ルール認知の強制（強制性対策）

**ポカヨケ設置作業の開始条件**:

セッション開始時の読了報告（Section 0.3）で、以下を含めること：

```markdown
### ポカヨケ設置作業の場合（Section 30確認）
- [ ] Section 30を全文読了した
- [ ] 突破不可チェックリストの5観点を暗記した（強制性/客観性/曖昧性/例外許容/形骸化）
- [ ] Gemini突破テストが必須であることを理解した
```

**強制メカニズム**:
- ポカヨケ設置完了報告時に「Section 30読了証明」の記載がない場合→**報告却下**
- Gemini監査役がレビュー時に「Section 30確認」を検証

### ポカヨケ設置フロー（必須）

```
問題発生 → 過去トラ記録 → ポカヨケ設計 → 突破不可チェック → Gemini突破テスト
                                                                  ↓
                                          突破成功 → 改修 → 再チェック（ループ）
                                          突破失敗 → 承認 → 設置 → MAPPING更新 → 完了
```

### 突破不可チェックリスト（設置前必須）

ポカヨケを設置する**前**に、以下のチェックを実施すること：

| # | チェック観点 | 確認質問 | 合格基準 | 必須証拠 |
|---|-------------|---------|---------|---------|
| 1 | 強制性 | このチェックを無視して作業を進められるか？ | いいえ（無視不可） | 強制メカニズムの具体的記述 |
| 2 | 客観性 | 自己申告だけで通過できるか？ | いいえ（証拠必須） | 必須証拠リストの定義 |
| 3 | 曖昧性 | 解釈によって合格条件が変わるか？ | いいえ（基準明確） | 数値基準または具体例の記載 |
| 4 | 例外許容 | 「急ぎ」「軽微」で例外が認められるか？ | いいえ（例外不可） | 「例外を認めない」の明記 |
| 5 | 形骸化 | 形式的に満たすだけで実質未確認でも通れるか？ | いいえ（実質確認必須） | 第三者検証プロセスの定義 |

### 証拠の定義（客観性対策）

**「証拠」とは以下のいずれかを指す（自己申告は証拠にならない）**:

| 証拠種別 | 具体例 | 検証方法 |
|---------|--------|---------|
| コマンド実行結果 | `grep`, `ls -la`, `cat`の出力をコピペ | 出力内容の妥当性確認 |
| スクリーンショット | 画面キャプチャ（ファイル添付） | 画像確認 |
| ファイル内容 | 該当箇所の引用（行番号付き） | ファイル確認 |
| Geminiの応答 | Gemini監査役の判定結果をコピペ | 応答内容の確認 |

**証拠の妥当性検証**:
- 開発者が証拠を提出
- **Gemini監査役が証拠の妥当性を検証**（自己検証は禁止）
- 証拠が不十分な場合→差し戻し

### Gemini突破テストの定義（曖昧性対策）

**「Gemini突破テスト」の具体的手順**:

1. **テスト実施者**: Gemini監査役（mcp__gemini-cli__geminiChatで呼び出し）
2. **テスト方法**: 以下のプロンプトを送信

```
あなたはコード監査の専門家であり、ポカヨケの突破テストを担当する監査役です。

【対象ポカヨケ】
[ポカヨケの全文をここに貼り付け]

【テスト依頼】
以下の5観点で、このポカヨケを突破できるかテストしてください：
1. ルールを読まなくても通れるか（認知の強制性）
2. ルールを無視しても通れるか（実行の強制性）
3. 解釈を変えれば通れるか（曖昧性の悪用）
4. 例外を主張すれば通れるか（例外許容の悪用）
5. 形式的に満たせば通れるか（形骸化の可能性）

【報告形式】
各観点について「通れた/通れず」と具体的な理由を報告してください。
1つでも「通れた」があれば「要改修」、全て「通れず」なら「承認」と判定してください。
```

3. **合格条件**: Geminiの判定が「承認」（全観点「通れず」）

### チェックリスト報告フォーマット

```markdown
## ポカヨケ突破不可チェック

### Section 30読了証明（必須）
- [x] Section 30を全文読了した
- [x] 突破不可チェックリストの5観点を理解した
- [x] Gemini突破テストが必須であることを理解した

### 対象ポカヨケ
- TROUBLE: TROUBLE-XXX
- 設置予定Section: XX
- 内容: [ポカヨケの概要]

### 突破不可チェック結果
| # | 観点 | 確認質問 | 回答 | 証拠 | 判定 |
|---|------|---------|------|------|------|
| 1 | 強制性 | 無視して作業を進められるか | [具体的回答] | [強制メカニズムの記述箇所] | OK/NG |
| 2 | 客観性 | 自己申告だけで通過できるか | [具体的回答] | [必須証拠リストの記述箇所] | OK/NG |
| 3 | 曖昧性 | 解釈で合格条件が変わるか | [具体的回答] | [数値基準/具体例の記述箇所] | OK/NG |
| 4 | 例外許容 | 「急ぎ」で例外が認められるか | [具体的回答] | [例外不可の記述箇所] | OK/NG |
| 5 | 形骸化 | 形式的に満たすだけで通れるか | [具体的回答] | [第三者検証の記述箇所] | OK/NG |

### 総合判定
- [ ] 合格（全てOK + 証拠あり）→ Gemini突破テストへ
- [ ] 要改修（1つでもNG or 証拠不足）→ ポカヨケ改修
```

### 完了条件

ポカヨケ設置完了の条件（全て満たす必要あり）：

| # | 条件 | 確認方法 | 必須証拠 |
|---|------|---------|---------|
| 1 | Section 30読了証明あり | 報告に記載 | チェックマーク3つ |
| 2 | TROUBLE_LOG.mdに過去トラ記録済み | grepで確認 | `grep "TROUBLE-XXX" docs/01_crm/TROUBLE_LOG.md`の結果 |
| 3 | 突破不可チェック全項目OK | チェックリスト報告 | 各項目の証拠記載 |
| 4 | Gemini突破テスト全観点「通れず」 | 突破テスト報告 | Geminiの応答全文をコピペ |
| 5 | CLAUDE.mdにSection追加済み | ファイル確認 | `grep "Section XX" CLAUDE.md`の結果 |
| 6 | TROUBLE_POKAYOKE_MAPPING.md更新済み | ファイル確認 | `grep "TROUBLE-XXX" docs/00_common/TROUBLE_POKAYOKE_MAPPING.md`の結果 |

### 第三者検証プロセス（形骸化対策）

**開発者とGemini監査役の役割分担**:

| 役割 | 担当 | 検証内容 |
|------|------|---------|
| 開発者 | Claude Code | ポカヨケ設計、チェックリスト記入、証拠収集 |
| 監査役 | Gemini | 証拠の妥当性検証、突破テスト実施、最終承認 |

**監査役の検証項目**:
1. Section 30読了証明が記載されているか
2. 各チェック項目に証拠が添付されているか
3. 証拠が「自己申告」ではなく「客観的証拠」か
4. 突破テストで全観点「通れず」か

### 禁止事項

| # | 禁止行為 | 理由 | 検知方法 |
|---|---------|------|---------|
| 1 | Section 30読了証明なしで設置 | ルール認知の確認不可 | 報告レビュー |
| 2 | 突破不可チェックなしで設置 | 品質未検証 | 報告レビュー |
| 3 | 証拠なしで「OK」と記入 | 客観性なし | Gemini監査役が検証 |
| 4 | Gemini突破テストなしで完了報告 | 第三者検証なし | 報告レビュー |
| 5 | 「通れた」判定を無視して承認 | 形骸化 | Gemini応答確認 |
| 6 | 改修なしで再テスト | 実質的改善なし | 差分確認 |

### KGI

| 指標 | 目標値 |
|------|--------|
| 突破可能なポカヨケの設置 | 0件 |
| Gemini突破テスト合格率 | 100%（改修後含む） |
| ポカヨケによる再発 | 0件 |

### 関連ドキュメント

- TROUBLE-041: Geminiが突破できるポカヨケを設置した
- Section 27: ポカヨケ設置フロー（2極化モデル）
- docs/00_common/TROUBLE_POKAYOKE_MAPPING.md: 対応表

---

## 31. 全工程2極化モデル標準化（ポカヨケ：TROUBLE-042）

### 背景

ポカヨケ設置だけでなく、全ての開発工程で2極化モデル（開発者 vs 監査役）を適用することで、品質を高水準に保つ。

**参照**: TROUBLE-042（Gemini監査役の短期的視点による誤判定）

### コスト根拠

| 項目 | 事前検証コスト | 再発時手戻りコスト | 差分 |
|------|--------------|-------------------|------|
| 時間 | +30分/タスク | 5時間/件 | 4.5時間節約 |
| 金銭 | $0.01/タスク | $0.10/件 | 90%削減 |

**結論**: 事前検証コスト < 再発時手戻りコスト → **全工程に2極化適用が合理的**

### 用語定義（曖昧性対策）

| 用語 | 定義 | 具体例 |
|------|------|--------|
| 工程 | git commitを伴う全ての作業 | コード変更、設定変更、ドキュメント修正 |
| 監査 | Gemini監査役による書面レビュー | mcp__gemini-cli__geminiChatでの監査依頼と応答記録 |
| 監査完了 | Geminiから「承認」判定を取得 | 口頭確認・自己判断は監査に含まない |
| 監査済み | Gemini監査を実施し、結果をPR/コミットに添付し、指摘事項への対応が完了した状態 | コミットメッセージに「監査済み(abc1234)」を含む |

**「監査済み」の必須条件（GitHub Actionsで検証）**:
1. Gemini監査を実施済み（mcp__gemini-cli__geminiChatで応答取得）
2. 監査結果をPRまたはコミットに添付（全文コピペ・編集禁止）
3. 指摘事項への対応が完了（「要改修」の場合は修正後に再監査）
4. コミットメッセージに「監査済み」キーワードを含む

**「監査」に含まれないもの**:
- ❌ 開発者の自己レビュー
- ❌ 口頭での「OK」
- ❌ Slackやチャットでの簡易確認
- ❌ 監査依頼なしの作業完了報告

### 適用範囲

| 工程 | 2極化適用 | 理由 |
|------|:--------:|------|
| ポカヨケ設置 | ✅ 必須 | 既存ルール（Section 27, 30） |
| 機能開発 | ✅ 必須 | 仕様漏れ・バグ防止 |
| バグ修正 | ✅ 必須 | 修正漏れ・影響範囲見落とし防止 |
| ドキュメント修正 | ✅ 必須 | 誤記・矛盾防止 |
| 設定変更 | ✅ 必須 | 設定ミス防止 |

**例外なし原則**: いかなる工程も2極化なしで完了としない

### 強制メカニズム（認知・実行の強制性対策）5W2H

**システム的強制力: GitHub Actions**

| # | 強制ポイント | When | Where | Who | What | How | How much |
|---|------------|------|-------|-----|------|-----|----------|
| 1 | セッション開始時 | 作業開始前 | CLAUDE.md Section 0.3 | Claude Code | 読了報告に「Section 31読了」を記載 | 報告テンプレート確認 | 100%必須 |
| 2 | 作業完了報告時 | git commit前 | 完了報告 | Claude Code | Gemini監査結果を添付 | 応答全文コピペ確認 | 100%必須 |
| 3 | git commit時 | コミット実行時 | コミットメッセージ | Claude Code | 「監査済み(コミットハッシュ)」を含める | `git log --grep="監査済み"` | 100%必須 |
| 4 | git push時 | push実行時 | GitHub Actions | 自動 | pokayoke-check.ymlワークフロー実行 | CI/CDチェック | 100%自動 |

**GitHub Actionsによる自動チェック（.github/workflows/pokayoke-check.yml）**:

| チェック項目 | 検証内容 | 失敗時の動作 |
|------------|---------|-------------|
| コミットメッセージ | コード変更時に「監査済み」を含むか | Warning表示 |
| 5W2H準拠 | CLAUDE.md Section 31-33に5W2Hがあるか | Warning表示 |
| 曖昧表現 | 「適宜」「必要に応じて」等の検出 | Warning表示 |
| MAPPING同期 | TROUBLE数とMAPPING数の一致 | Warning表示 |

**チェック結果の確認方法**:
- GitHub → Actions → Pokayoke Check で確認
- PRマージ前に全チェックがPassしていること

**完了報告に必須の記載（5W2H紐付け）**:
```markdown
### Gemini監査結果
- 監査日時: YYYY-MM-DD HH:MM
- 対象コミット: [コミットハッシュの先頭7文字] ← 必須（紐付け用）
- 対象ファイル: [監査対象の全ファイルパス] ← 必須（範囲明確化）
- 判定: 承認 / 要改修 / 却下
- Gemini応答（全文コピペ・編集禁止）:
[ここにGeminiの応答を貼り付け]
```

**紐付け検証方法**:
```bash
# コミットハッシュと監査日時の整合性確認
git log --format="%h %ad" --date=format:"%Y-%m-%d %H:%M" | grep "[コミットハッシュ]"
# → 監査日時より後のコミットであること
```

### 形骸化防止策

| # | リスク | 対策 |
|---|--------|------|
| 1 | 監査役が内容を精査せず承認 | Geminiの応答に「具体的指摘事項」がない場合は再監査依頼 |
| 2 | 開発者と監査役の馴れ合い | 監査役はGemini固定（人間の馴れ合いを排除） |
| 3 | 形式的にフォーマットを埋めるだけ | Gemini応答の全文コピペを必須（編集禁止） |

**監査の質チェック（Gemini応答に必須）**:
- 具体的な確認箇所の記載（ファイル名・行番号）
- 問題がない場合もその理由の記載
- 「問題なし」だけの応答は無効

### 緊急時の例外プロセス（例外許容対策）

**緊急時（監査役不在・システム障害等）の対応**:

1. **Human承認を取得**（Discord通知で確認）
2. **緊急対応ログを記録**:
```markdown
### 緊急対応ログ
- 日時: YYYY-MM-DD HH:MM
- 理由: [監査不可の理由]
- Human承認: [承認者名・承認日時]
- 事後監査予定: [監査予定日]
```
3. **事後監査を24時間以内に実施**
4. **緊急対応をTROUBLE_LOG.mdに記録**（再発防止）

**緊急対応の条件（5W2H明確化）**:

| 条件 | 定義 | 判定基準（数値） | 判定者 |
|------|------|-----------------|--------|
| Gemini APIダウン | mcp__gemini-cli__geminiChatがエラーを返す | 24時間以上継続 | Claude Code |
| 本番障害 | ユーザーが業務を継続できない状態 | 影響ユーザー1人以上 AND 業務停止1時間以上 | Human |
| Human承認 | Discord通知への明示的な「承認」返信 | 返信メッセージに「承認」を含む | Human |

**「本番障害」に該当しないケース**:
- ❌ 表示崩れ（業務継続可能）
- ❌ 軽微な動作不良（回避策あり）
- ❌ 開発環境の問題（ユーザー影響なし）

### 工程別監査チェック

| 工程 | 監査内容 |
|------|---------|
| ポカヨケ設置 | 突破テスト（Section 27, 30） |
| 機能開発 | 仕様整合性、セキュリティ、コード品質 |
| バグ修正 | 根本原因特定、影響範囲確認、回帰テスト |
| ドキュメント | 正確性、一貫性、最新性 |
| 設定変更 | 変更内容確認、影響範囲確認 |

### 監査依頼フォーマット

```markdown
## Gemini監査依頼

### 工程種別
- [ ] ポカヨケ設置
- [ ] 機能開発
- [ ] バグ修正
- [ ] ドキュメント修正
- [ ] 設定変更

### 対象
[対象ファイル・機能の一覧]

### 変更内容
[変更の概要]

### 監査してほしい点
1. [確認項目1]
2. [確認項目2]
3. [確認項目3]

### 確認用ファイル
[ファイルパスまたは内容]
```

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 監査なしで作業完了 | 品質未検証 |
| 2 | 「軽微な変更」で監査スキップ | 例外許容は形骸化の始まり |
| 3 | 監査指摘を無視 | 品質低下 |
| 4 | Gemini応答を編集して報告 | 証拠改ざん |
| 5 | 緊急対応を事後監査なしで完了 | 品質担保なし |

### KGI（5W2H完備）

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 | 閾値 |
|------|--------|---------|---------|--------|------|
| 全工程監査実施率 | 100% | `git log --grep="監査済み"` の件数 / 総コミット数 | 毎週 | Human | 100%未満で是正 |
| 監査後の再発 | 0件 | TROUBLE_LOGで「監査後に発生」とタグ付けされた件数 | 毎月 | Human | 1件以上で是正 |
| 緊急対応の事後監査率 | 100% | 緊急対応ログの事後監査完了数 / 緊急対応総数 | 毎月 | Human | 100%未満で是正 |

---

## 32. 無限ループ防止（緊急停止）（ポカヨケ：TROUBLE-042）

### 背景

2極化モデルで突破テストを繰り返す際、改修→テスト→突破→改修...のループが無限に続くリスクがある。

**参照**: TROUBLE-042（Gemini監査役の短期的視点による誤判定）

### 用語定義（曖昧性対策）

| 用語 | 定義 | 具体例 |
|------|------|--------|
| 同一箇所 | 同一TROUBLE番号に紐づくポカヨケ | TROUBLE-042のSection 31, 32, 33は「同一箇所」 |
| 同一ポカヨケ | 同一Section番号 | Section 31の改修1回目と2回目は「同一ポカヨケ」 |
| 突破回数 | 突破履歴テーブルの行数 | 履歴が3行あれば「3回突破」 |

**「別箇所」と主張できないケース**:
- ❌ コードを別ファイルに移動しただけ → 同一TROUBLE番号なら同一箇所
- ❌ 関数名・変数名を変更しただけ → 同一TROUBLE番号なら同一箇所
- ❌ Section番号を変更しただけ → 元のTROUBLE番号に紐づくなら同一箇所

**「別箇所」と認められるケース**:
- ✅ 新規TROUBLE番号が発番された場合のみ

### 収束条件

| 条件 | 内容 | 結果 |
|------|------|------|
| 突破テスト合格 | 全観点「通れず」 | → 完了 |
| エスカレーション | 同一箇所3回突破 | → 根本設計見直し（1日） |
| 緊急停止 | 5回連続突破 or 3日経過 | → Human介入必須 |

### 突破回数カウント方法（強制性対策）5W2H

**カウントの強制メカニズム**:

| 項目 | When | Where | Who | What | How | How much |
|------|------|-------|-----|------|-----|----------|
| テーブル作成 | 1回目突破時 | CLAUDE.md末尾 | Claude Code | 突破履歴テーブル作成 | 指定フォーマットで追記 | 1テーブル/TROUBLE |
| 行追加 | 突破判定時 | 突破履歴テーブル | Claude Code | 新規行追加 | 日時・観点・改修内容・応答全文を記載 | 毎突破時 |
| カウント確認 | 改修前 | 突破履歴テーブル | Claude Code | 行数カウント | テーブル行数を数える | 0の場合は未作成 |

突破履歴は以下のテーブルで管理し、**行数がカウント**となる：

```markdown
### 突破履歴テーブル（TROUBLE-XXX）
| 回数 | 日時 | 突破観点 | 改修内容 | Gemini応答リンク |
|------|------|---------|---------|-----------------|
| 1 | 2026-01-18 10:00 | 強制性 | [改修内容] | [応答全文] |
| 2 | 2026-01-18 11:00 | 曖昧性 | [改修内容] | [応答全文] |
| 3 | 2026-01-18 12:00 | 形骸化 | [改修内容] | [応答全文] |
```

**カウントルール（数値基準）**:
| ルール | 閾値 | 判定方法 | アクション |
|--------|------|---------|-----------|
| エスカレーション発動 | 3行 | テーブル行数 = 3 | 根本設計見直し（24時間猶予） |
| 緊急停止発動 | 5行 | テーブル行数 = 5 | Human介入必須 |
| 時間切れ緊急停止 | 72時間 | 1行目の日時から72時間経過 | Human介入必須 |
| テーブル削除検知 | 0件→再作成 | git diffでテーブル削除を検知 | 過去トラとして記録 |

**テーブル記録の強制**:
- Gemini突破テストで「通れた」判定を受けた場合、**テーブル更新前に次の作業を開始禁止**
- テーブル更新は改修作業の**最初のステップ**として実施

### エスカレーションフロー

```
1回目突破 → 履歴テーブルに1行追加 → 改修 → 再テスト
2回目突破 → 履歴テーブルに2行目追加 → 改修 → 再テスト
3回目突破 → 履歴テーブルに3行目追加 → エスカレーション発動
          → 根本設計見直し（1日猶予）→ 見直し内容を記録 → 再テスト
4回目突破 → 履歴テーブルに4行目追加 → 改修 → 再テスト
5回目突破 → 履歴テーブルに5行目追加 → 緊急停止発動
          → Human介入必須（自動続行禁止）
```

### 緊急停止の発動条件

| # | 条件 | 判定 | 検証方法 |
|---|------|------|---------|
| 1 | 突破履歴テーブルが5行 | → 緊急停止 | テーブル行数カウント |
| 2 | 突破履歴テーブル作成から3日経過 | → 緊急停止 | 1行目の日時と現在日時の差 |
| 3 | Humanが「緊急停止」を宣言 | → 緊急停止 | Human発言の記録 |

### 緊急停止時の対応

```markdown
## 緊急停止報告

### 発動理由
- [ ] 突破履歴テーブルが5行に達した
- [ ] 1行目の日時から3日以上経過
- [ ] Human宣言

### 対象ポカヨケ
- Section: XX
- TROUBLE: TROUBLE-XXX
- 突破履歴テーブル作成日: YYYY-MM-DD

### 突破履歴テーブル（証拠）
| 回数 | 日時 | 突破観点 | 改修内容 |
|------|------|---------|---------|
| 1 | YYYY-MM-DD | [観点] | [改修内容] |
| 2 | YYYY-MM-DD | [観点] | [改修内容] |
| 3 | YYYY-MM-DD | [観点] | [改修内容] |
| 4 | YYYY-MM-DD | [観点] | [改修内容] |
| 5 | YYYY-MM-DD | [観点] | [改修内容] |

### Human判断依頼
以下のいずれかを選択してください：
1. ポカヨケ設計を根本から見直す
2. このポカヨケは一旦保留し、別の対策を検討
3. 例外的に現状で承認（理由を明記）
```

### Human判断後の継続制限（5W2H）

**Humanが選択肢3（例外承認）を選んだ場合の制限**:

| 項目 | When | Where | Who | What | How | How much |
|------|------|-------|-----|------|-----|----------|
| 例外承認記録 | 承認直後 | TROUBLE_LOG.md | Claude Code | 例外承認の記録 | 「例外承認」タグ付け | 1件/承認 |
| 再発監視 | 承認後30日間 | 対象ポカヨケ | Human | 再発発生の確認 | 同一問題の再発をチェック | 30日間 |
| 再発時対応 | 再発検知時 | 対象ポカヨケ | Claude Code | 根本見直し強制 | 例外承認は無効、根本見直し必須 | 1回 |

**例外承認の上限**:
- 同一TROUBLEに対する例外承認は**最大1回**
- 2回目の緊急停止時は例外承認不可（選択肢3は表示しない）

### 根本設計見直しの定義（形骸化対策）5W2H

**「根本設計見直し」に必要な成果物**:

| # | 成果物 | When | Where | Who | What | How | How much |
|---|--------|------|-------|-----|------|-----|----------|
| 1 | 問題分析 | 見直し開始時 | 見直し報告書 | Claude Code | なぜ3回突破されたかの5Whys分析 | 5Whys形式で記載 | 5段階以上 |
| 2 | 設計変更案 | 問題分析後 | 見直し報告書 | Claude Code | 従来と異なるアプローチの提案 | 従来案との比較表 | 2案以上 |
| 3 | 変更差分 | 設計決定後 | 見直し報告書 | Claude Code | 従来設計との具体的な差分 | diffまたは比較表 | 全変更箇所 |
| 4 | 突破予防策 | 変更適用後 | 見直し報告書 | Claude Code | 今回の突破観点への対策 | 5観点それぞれへの対策 | 5項目 |

**「根本設計見直し」に該当しないもの（具体的基準）**:
| # | 該当しないもの | 判定基準 | 理由 |
|---|---------------|---------|------|
| 1 | 30分の形式的な会議 | 成果物4点が全て揃っていない | 形骸化 |
| 2 | 文言の微修正のみ | 変更差分が10行未満 | 実質的変更なし |
| 3 | 「現状維持」の結論 | 設計変更案がない | 改善なし |
| 4 | プロセス改善のみ | コード変更がない | ポカヨケ自体の改善なし |
| 5 | 教育研修の実施 | ポカヨケへの追記がない | 仕組み化されていない |

### 禁止事項

| # | 禁止行為 | 理由 | 検知方法 |
|---|---------|------|---------|
| 1 | 緊急停止条件に達しても続行 | 無限ループ | テーブル行数チェック |
| 2 | Human判断なしで6回目テスト | 権限逸脱 | テーブル行数チェック |
| 3 | 緊急停止報告をせずに作業中断 | 状況不明 | 報告履歴確認 |
| 4 | 突破履歴テーブルの削除・リセット | 証拠隠滅 | git履歴確認 |
| 5 | TROUBLE番号変更による回数リセット | カウント回避 | TROUBLE_LOG確認 |

---

## 33. 監査役判定基準（ポカヨケ：TROUBLE-042）

### 背景

Gemini監査役が「開発速度低下」を理由に2極化モデルを否定した。これは短期コストのみの評価であり、長期コスト（再発リスク）を無視した誤判定だった。

**参照**: TROUBLE-042（Gemini監査役の短期的視点による誤判定）

### 必須評価項目

監査役は以下の**全て**を評価すること（1項目でも欠けたら判定無効）：

| # | 評価項目 | 内容 |
|---|---------|------|
| 1 | 短期コスト | 追加作業時間、リソース消費 |
| 2 | 長期コスト | 再発時の手戻り、信頼低下、累積ダメージ |
| 3 | 再発確率 | 過去トラの再発率、類似問題の発生頻度 |
| 4 | 影響範囲 | 再発時の影響（ユーザー数、業務停止時間） |

### コスト算出の客観化基準（曖昧性対策）

**数値の根拠ルール**:

| 項目 | 算出方法 | デフォルト値（実績なし時） |
|------|---------|-------------------------|
| 短期コスト | 実際の作業時間を計測 | +30分/タスク |
| 長期コスト | 過去トラの手戻り時間の平均 | 5時間/件 |
| 再発確率 | TROUBLE_LOGの再発率（再発数/総数） | 10%（保守的見積もり） |
| 影響範囲 | 影響ユーザー数で判定 | 高（1人でも影響あれば） |

**影響範囲の判定基準**:

| レベル | 影響ユーザー数 | 業務停止時間 | 例 |
|--------|--------------|-------------|-----|
| 高 | 1人以上 | 1時間以上 | 本番障害、データ破損 |
| 中 | 0人（開発者のみ） | 30分〜1時間 | 開発遅延、手戻り |
| 低 | 0人 | 30分未満 | 軽微な修正 |

**実績なし時の原則**: 保守的に見積もる（リスクを過小評価しない）

### 過去トラ選定基準（曖昧性対策）5W2H

**「類似案件」の定義**:

| 項目 | 類似と判定する条件 | 類似と判定しない条件 |
|------|------------------|---------------------|
| 発生箇所 | 同一ファイル or 同一機能 | 完全に無関係なファイル |
| 発生原因 | 同一カテゴリ（例：CSS、API、認証） | 異なるカテゴリ |
| 影響範囲 | 同一ユーザー層に影響 | 異なるユーザー層 |
| 発生時期 | 6ヶ月以内 | 6ヶ月以上前 |

**長期コスト算出用の過去トラ選定フロー**:
```
1. TROUBLE_LOG.mdを検索
2. 「類似と判定する条件」を2つ以上満たすTROUBLEを抽出
3. 抽出結果が0件 → デフォルト値（5時間）を使用（理由記載必須）
4. 抽出結果が1件以上 → 平均手戻り時間を算出
5. 算出結果を「参照データ」欄に記載（TROUBLE番号リスト付き）
```

### テンプレ数値の禁止（形骸化対策）5W2H

**以下の数値パターンは「テンプレ数値」として無効**:

| パターン | 例 | 無効理由 | 検知方法 |
|---------|-----|---------|---------|
| 毎回同じ数値 | 常に「+30分」「5時間」「10%」 | 思考停止 | 過去3回の判定と比較 |
| 根拠なしの丸数字 | 「1時間」「10%」「100件」 | 具体性なし | 参照データ欄確認 |
| 極端な数値 | 「0%」「0.001%」「1000時間」 | 恣意的操作 | 範囲チェック（0.1%〜50%） |
| 微調整による回避 | 5h→5.1h、10%→11% | チェック回避 | 元データが同一かを確認 |

**微調整検知ルール**:
| 検知対象 | 判定基準 | 対応 |
|---------|---------|------|
| 短期コスト | 前回との差が±10%以内かつ元データ同一 | テンプレ数値とみなす |
| 長期コスト | 前回との差が±10%以内かつ参照TROUBLE同一 | テンプレ数値とみなす |
| 再発確率 | 前回との差が±2%以内かつ計算式同一 | テンプレ数値とみなす |

**有効な数値の条件（5W2H）**:
| 条件 | 具体的基準 | 確認方法 |
|------|-----------|---------|
| 過去データ参照 | TROUBLE番号・日付を明記 | 参照データ欄確認 |
| 計算式明示 | 分子/分母、掛け算/割り算を記載 | コスト比較欄確認 |
| 単位と対象明確 | 「X分/タスク」「X件/月」形式 | 評価欄確認 |
| 元データ変化 | 前回と異なるTROUBLE or 新規データ | 履歴比較 |

### 判定フォーマット（必須）

```markdown
## 監査役判定

### 評価項目
| # | 項目 | 評価 | 根拠 | 参照データ |
|---|------|------|------|-----------|
| 1 | 短期コスト | [+X分/タスク] | [計算根拠] | [計測日時 or デフォルト値使用理由] |
| 2 | 長期コスト | [Xh/件の節約] | [再発時の手戻り時間] | [TROUBLE-XXXの実績 or デフォルト値使用理由] |
| 3 | 再発確率 | [X%] | [過去データ] | [再発TROUBLE数/総TROUBLE数 or デフォルト値使用理由] |
| 4 | 影響範囲 | [高/中/低] | [影響対象] | [影響ユーザー数・業務停止時間] |

### コスト比較
- 短期コスト合計: [A] = [計算式]
- 長期コスト期待値: [B] × [確率] = [計算式]
- 差分: [A] vs [B × 確率] = [比較結果]

### 判定
- [ ] 承認（長期コスト期待値 > 短期コスト）
- [ ] 要改修（短期コスト > 長期コスト期待値、ただし理由明記）
- [ ] 却下（根本的な問題あり）

### 判定理由
[上記コスト比較に基づく理由。計算式を含めること]
```

### 判定の妥当性検証（形骸化対策）

**監査役の判定を検証するチェック**:

| # | 検証項目 | 検証方法 | 不合格条件 |
|---|---------|---------|-----------|
| 1 | 数値の具体性 | 参照データ欄が埋まっているか | 「デフォルト値使用理由」なしにデフォルト値を使用 |
| 2 | 計算式の明示 | コスト比較に計算式があるか | 計算式なしで結論を記載 |
| 3 | テンプレ数値の回避 | 過去3回の判定と同一数値でないか | 3回連続で同一数値 |
| 4 | 結論の整合性 | 計算結果と判定が一致しているか | 計算では長期>短期なのに要改修と判定 |

**不合格時の対応**:
- 判定を無効とし、再判定を依頼
- 繰り返す場合はTROUBLE_LOG.mdに記録

### 禁止事項

| # | 禁止行為 | 理由 | 対策 | 検知方法 |
|---|---------|------|------|---------|
| 1 | 短期コストのみで判定 | 長期視点の欠如 | 判定フォーマット必須 | フォーマット確認 |
| 2 | 「速度低下」を理由に否定 | 再発リスク無視 | コスト比較必須 | 理由欄確認 |
| 3 | 数値根拠なしで「過剰品質」と判定 | 客観性なし | 計算根拠必須 | 参照データ欄確認 |
| 4 | 再発確率を考慮せず判定 | リスク評価不足 | 確率評価必須 | 評価項目3確認 |
| 5 | テンプレ数値で形式的に埋める | 形骸化 | 妥当性検証 | 過去判定との比較 |
| 6 | 計算結果と矛盾する判定 | 恣意的操作 | 整合性チェック | 計算結果と判定の比較 |

### 品質コストの原則

```
予防コスト（事前検証） < 失敗コスト（再発手戻り）
```

この原則に反する判定は**誤判定**として記録し、TROUBLE_LOG.mdに追記する。

### KGI（5W2H完備）

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 | 閾値 |
|------|--------|---------|---------|--------|------|
| 短期視点のみの誤判定 | 0件 | TROUBLE_LOGで「短期視点誤判定」タグ検索 | 毎月 | Human | 1件以上で是正 |
| 判定フォーマット遵守率 | 100% | 全判定中フォーマット準拠数/総判定数 | 毎週 | Claude Code | 100%未満で是正 |
| テンプレ数値使用率 | 0% | 微調整検知ルールに該当した数/総判定数 | 毎週 | Claude Code | 1件以上で是正 |
| 判定妥当性検証合格率 | 100% | 妥当性検証4項目全合格数/総判定数 | 毎週 | Claude Code | 100%未満で是正 |

### 関連ドキュメント

- TROUBLE-042: Gemini監査役の短期的視点による誤判定
- TROUBLE-043: ポカヨケ基準の不明確さ
- Section 31: 全工程2極化モデル標準化
- Section 32: 無限ループ防止（緊急停止）
- Section 34: 基準明確化義務

---

## 34. 基準明確化義務（ポカヨケ：TROUBLE-043）

### 背景

ポカヨケを設置しても、基準が曖昧なためGemini突破テストで「解釈を変えれば通れる」と判定された。

**参照**: TROUBLE-043（ポカヨケ基準の不明確さ）

### 適用対象

| 対象 | 適用 | 理由 |
|------|:----:|------|
| ポカヨケ（全Section） | ✅ 必須 | 曖昧な基準は突破される |
| チェックリスト（全項目） | ✅ 必須 | 曖昧な項目は形骸化する |
| KGI/KPI（全指標） | ✅ 必須 | 測定不能な指標は効果不明 |
| 禁止事項（全項目） | ✅ 必須 | 曖昧な禁止は回避される |
| 完了条件（全項目） | ✅ 必須 | 曖昧な条件は形骸化する |

### 形式要件（5W2H必須）

全ての基準項目に以下の5W2Hを記載すること：

| 要素 | 質問 | 必須回答 | 例 |
|------|------|---------|-----|
| When | いつ適用するか？ | 日時・タイミング | 「git commit前」「セッション開始時」 |
| Where | どこで適用するか？ | 場所・ファイル | 「CLAUDE.md Section 31」「全リポジトリ」 |
| Who | 誰が実施するか？ | 責任者 | 「Claude Code」「Gemini監査役」「Human」 |
| What | 何を確認するか？ | 対象 | 「監査結果の添付」「コミットメッセージ」 |
| Why | なぜ必要か？ | 理由 | 「品質未検証を防止」 |
| How | どうやって確認するか？ | 方法 | 「grepでキーワード検索」「行数カウント」 |
| How much | どれぐらいの基準か？ | 数値 | 「100%」「0件」「30分以内」 |

### 数値基準の必須要素

| 要素 | 内容 | 例 |
|------|------|-----|
| 閾値 | 合格/不合格の境界値 | 「5回以上で緊急停止」「0件が目標」 |
| 単位 | 測定単位 | 「件」「分」「%」「行」 |
| 測定方法 | どうやって測定するか | 「テーブル行数カウント」「grep結果の件数」 |
| 測定頻度 | いつ測定するか | 「毎コミット」「毎セッション」「毎週」 |
| 測定者 | 誰が測定するか | 「Claude Code」「GitHub Actions」「Human」 |

### 形式要件チェックリスト（ポカヨケ設置時必須）

ポカヨケを設置する前に、以下のチェックを実施すること：

```markdown
## 基準明確化チェック（Section 34）

### 対象ポカヨケ
- Section番号: XX
- TROUBLE番号: TROUBLE-XXX

### 5W2Hチェック
| 要素 | 記載あり | 記載箇所（行番号） |
|------|:--------:|------------------|
| When（いつ） | ✅/❌ | L.XXX |
| Where（どこで） | ✅/❌ | L.XXX |
| Who（誰が） | ✅/❌ | L.XXX |
| What（何を） | ✅/❌ | L.XXX |
| Why（なぜ） | ✅/❌ | L.XXX |
| How（どうやって） | ✅/❌ | L.XXX |
| How much（どれぐらい） | ✅/❌ | L.XXX |

**全て✅でなければ設置禁止**

### 数値基準チェック
| 要素 | 記載あり | 具体的な値 |
|------|:--------:|-----------|
| 閾値 | ✅/❌ | [値] |
| 単位 | ✅/❌ | [単位] |
| 測定方法 | ✅/❌ | [方法] |
| 測定頻度 | ✅/❌ | [頻度] |
| 測定者 | ✅/❌ | [担当] |

**全て✅でなければ設置禁止**

### 曖昧表現チェック
以下の曖昧表現が含まれていないこと：
- [ ] 「適宜」「必要に応じて」「適切に」→ 具体的条件に置換
- [ ] 「など」「等」「その他」→ 全列挙または明示的な範囲指定
- [ ] 「できるだけ」「なるべく」→ 数値基準に置換
- [ ] 「〜と思われる」「〜の可能性」→ 断定形に置換
- [ ] 「基本的に」「原則として」→ 例外条件を明記

**1つでも該当すれば設置禁止**
```

### 既存ポカヨケへの遡及適用

| 優先度 | 対象 | 期限 | 担当 |
|--------|------|------|------|
| 高 | Section 31, 32, 33（直近で突破された） | 即時 | Claude Code |
| 中 | Section 26-30（最近作成） | 1週間以内 | Claude Code |
| 低 | Section 1-25（既存） | 1ヶ月以内 | Claude Code |

### 禁止事項

| # | 禁止行為 | 理由 | 検知方法 |
|---|---------|------|---------|
| 1 | 5W2H未記載でポカヨケ設置 | 曖昧な基準は突破される | 形式要件チェック |
| 2 | 数値基準なしでチェックリスト作成 | 形骸化する | 形式要件チェック |
| 3 | 測定方法未定義でKGI/KPI設定 | 効果測定不能 | 形式要件チェック |
| 4 | 曖昧表現の使用 | 解釈の余地が生じる | 曖昧表現チェック |

### KGI

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 |
|------|--------|---------|---------|--------|
| 5W2H充足率 | 100% | 形式要件チェックリストの✅率 | 毎ポカヨケ設置時 | Claude Code |
| 数値基準充足率 | 100% | 形式要件チェックリストの✅率 | 毎ポカヨケ設置時 | Claude Code |
| 曖昧表現使用率 | 0% | 曖昧表現チェックの該当数 | 毎ポカヨケ設置時 | Claude Code |
| 初回突破テスト合格率 | 80%以上 | 合格数/テスト数 | 毎月集計 | Human |

### 関連ドキュメント

- TROUBLE-043: ポカヨケ基準の不明確さ
- Section 30: ポカヨケ設置時のポカヨケ
- Section 27: ポカヨケ設置フロー（2極化モデル）

---

## 35. Gemini監査情報提供ルール（ポカヨケ：TROUBLE-044）

### 背景

GeminiはGitHubリポジトリを直接参照できない。プロンプトに含めた情報のみで判断するため、断片的な情報では誤判定のリスクがある。

**参照**: TROUBLE-044（GeminiがGitHubリポジトリを直接参照できない）

### Geminiの技術的制約

| 制約 | 内容 | 影響 |
|------|------|------|
| リポジトリ参照 | ❌ 不可 | ファイル内容をプロンプトで提供必須 |
| git履歴参照 | ❌ 不可 | 差分はプロンプトで提供必須 |
| 外部URL参照 | ❌ 不可 | 関連情報はプロンプトで提供必須 |

### 情報提供ルール（5W2H）

| # | When | Where | Who | What | How | How much |
|---|------|-------|-----|------|-----|----------|
| 1 | 監査依頼時 | プロンプト内 | Claude Code | 監査対象ファイル全文 | catでファイル内容を取得しプロンプトに含める | 全対象ファイル100% |
| 2 | 監査依頼時 | プロンプト内 | Claude Code | 関連ファイル一覧 | ファイルパスを明記 | 全関連ファイル |
| 3 | 監査依頼時 | プロンプト内 | Claude Code | 変更差分 | git diffの結果を含める | 変更箇所全て |

### 必須提供情報チェックリスト

監査依頼前に以下を確認すること：

```markdown
## Gemini監査 情報提供チェック（Section 35）

### 対象ファイル
| # | ファイルパス | 全文提供 | 行数 |
|---|-------------|:--------:|------|
| 1 | [パス] | ✅/❌ | XXX行 |
| 2 | [パス] | ✅/❌ | XXX行 |

**全て✅でなければ監査依頼禁止**

### 抜粋使用時（例外）
| 抜粋箇所 | 理由 | 省略した内容の概要 |
|---------|------|-------------------|
| [箇所] | [理由] | [概要] |

**抜粋使用の許容条件（限定列挙・「等」禁止）**:
| # | 許容条件 | 数値基準 | 必須記載事項 |
|---|---------|---------|-------------|
| 1 | ファイルが1000行超 | 1000行以上 | 省略した行範囲（例: L.1-500省略） |
| 2 | バイナリファイル含有 | - | バイナリ部分のファイル名 |
| 3 | 監査対象外セクションの省略 | - | 省略したSection番号一覧 |

**上記以外の理由による抜粋は禁止**
```

### 関連ファイルの定義（5W2H）

| 要素 | 定義 |
|------|------|
| What | 変更対象ファイルから直接import/requireされるファイル、または変更対象ファイルを直接import/requireしているファイル |
| How | `grep -r "import.*[ファイル名]"` または IDE の依存関係ツールで特定 |
| How much | 依存関係1階層まで（間接参照は対象外） |

**「関連ファイル」に該当しないもの**:
- ❌ 間接的に参照されるファイル（A→B→Cの場合、CはAの関連ファイルではない）
- ❌ 同一ディレクトリにあるだけのファイル
- ❌ 過去に関連があったが現在は参照されていないファイル

### 緊急時例外プロセス（5W2H）

| 要素 | 内容 |
|------|------|
| When | 本番環境でサービス停止レベルの障害発生時のみ |
| Where | Slack/Discord等の記録が残るチャンネル |
| Who | シニアエンジニア2名以上の承認必須 |
| What | 監査プロセスの一時スキップ |
| How | チャットで「緊急対応宣言」を投稿し、2名の「承認」返信を取得 |
| How much | 事後監査を24時間以内に実施必須 |

**緊急時の必須アクション**:
1. チャットで「緊急対応宣言」を投稿（障害内容・影響範囲を明記）
2. 2名以上のシニアエンジニアから「承認」返信を取得
3. 対応完了後24時間以内に正式な監査を実施
4. TROUBLE_LOG.mdに「緊急対応」として記録

**「緊急」に該当しないケース**:
- ❌ 表示崩れ（業務継続可能）
- ❌ 軽微な動作不良（回避策あり）
- ❌ 納期プレッシャー（緊急ではなく計画の問題）

### 禁止事項

| # | 禁止行為 | 理由 | 検知方法 |
|---|---------|------|---------|
| 1 | ファイル全文なしで監査依頼 | 情報不足による誤判定 | チェックリスト確認 |
| 2 | 許容条件外の抜粋使用 | 恣意的な情報隠蔽 | チェックリスト確認 |
| 3 | 関連ファイル一覧の省略 | 監査範囲の不明確化 | チェックリスト確認 |
| 4 | 「緊急」を理由にした安易なスキップ | 形骸化リスク | 緊急対応ログ確認 |

### KGI

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 |
|------|--------|---------|---------|--------|
| ファイル全文提供率 | 100% | チェックリストの✅率 | 毎監査 | Claude Code |
| 情報不足誤判定 | 0件 | Geminiの「情報不足」指摘数 | 毎監査 | Claude Code |
| 緊急対応の事後監査率 | 100% | 事後監査完了数/緊急対応数 | 毎月 | Human |

---

## 36. 突破テスト5観点定義（ポカヨケ：TROUBLE-045）

### 背景

Gemini突破テストの5観点がCLAUDE.mdに明文化されておらず、評価基準の一貫性が保証されていなかった。

**参照**: TROUBLE-045（突破テスト5観点がCLAUDE.mdに未定義）

### 5観点の定義

| # | 観点 | 定義 | 評価質問 |
|---|------|------|---------|
| 1 | 認知の強制性 | ルールの存在を忘却・見落としできないか | 「ルールを知らなかった」で回避できるか？ |
| 2 | 実行の強制性 | 認知していても意図的にスキップできないか | 「面倒だからスキップした」が可能か？ |
| 3 | 例外許容性 | 「緊急時」等を理由にバイパスできないか | 「緊急だったので」が通用するか？ |
| 4 | 形骸化リスク | 時間経過で形式的な運用になる余地はないか | 「形だけ守れば良い」になりうるか？ |
| 5 | 曖昧性 | 解釈の余地がある表現はないか | 「こう解釈すれば違反ではない」が可能か？ |

### 判定基準（数値化）

| 判定 | 記号 | 定義 | 突破シナリオ数 |
|------|:----:|------|:-------------:|
| 突破困難 | ✅ | 現実的な突破シナリオが存在しない | 0件 |
| 条件付き突破可能 | ⚠️ | 特定条件下でのみ突破可能 | 1-2件 |
| 容易に突破可能 | ❌ | 一般的な状況で突破可能 | 3件以上 |

### 総合判定基準

| 総合判定 | 条件 | 次のアクション |
|---------|------|--------------|
| ✅ 承認 | 5観点全て✅ | ポカヨケ設置完了 |
| ⚠️ 要改修 | ❌が0件かつ⚠️が1件以上 | 指摘事項を改修後再テスト |
| ❌ 却下 | ❌が1件以上 | 根本的な設計見直し |

### 各観点の具体例

#### 1. 認知の強制性

| 状態 | 具体例 | 判定 |
|------|--------|:----:|
| 強制あり | GitHub Actionsで自動チェック、失敗時にマージ不可 | ✅ |
| 条件付き | CLAUDE.mdに記載あり、読了報告で確認 | ⚠️ |
| 強制なし | 口頭伝達のみ、ドキュメント未記載 | ❌ |

#### 2. 実行の強制性

| 状態 | 具体例 | 判定 |
|------|--------|:----:|
| 強制あり | CIでexit 1、ブランチ保護ルールで必須化 | ✅ |
| 条件付き | チェックリスト必須だが自己申告 | ⚠️ |
| 強制なし | 任意のベストプラクティス | ❌ |

#### 3. 例外許容性

| 状態 | 具体例 | 判定 |
|------|--------|:----:|
| 例外なし | 技術的に回避不可能 | ✅ |
| 条件付き例外 | Human承認必須、事後監査義務あり | ⚠️ |
| 例外容易 | 「緊急」と言えばスキップ可能 | ❌ |

#### 4. 形骸化リスク

| 状態 | 具体例 | 判定 |
|------|--------|:----:|
| リスク低 | 機械的検証、証跡の自動記録 | ✅ |
| リスク中 | 証跡必須だが内容は自己申告 | ⚠️ |
| リスク高 | キーワードのみで実態は未検証 | ❌ |

#### 5. 曖昧性

| 状態 | 具体例 | 判定 |
|------|--------|:----:|
| 曖昧性なし | 5W2H全記載、数値基準あり | ✅ |
| 一部曖昧 | 大部分は明確だが一部解釈の余地あり | ⚠️ |
| 曖昧 | 「適宜」「必要に応じて」等の表現あり | ❌ |

### 使用タイミング

| タイミング | 必須アクション |
|-----------|--------------|
| ポカヨケ設置後 | 本Section参照の上で突破テスト依頼 |
| 突破テスト結果受領後 | 5観点の判定を突破履歴テーブルに記録 |
| 改修後 | 再度突破テストを実施 |

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 突破テスト前 | 5観点リストを確認 | **テスト実施禁止** |
| 2 | テスト時 | 各観点で評価を実施 | **テスト無効** |
| 3 | テスト後 | 5観点全ての判定結果を添付 | **結果却下** |

**チェックリスト（突破テスト実施時必須）**:
```markdown
## 突破テスト5観点チェック
- [ ] 観点1: 認知の強制性を評価した
- [ ] 観点2: 実行の強制性を評価した
- [ ] 観点3: 例外許容性を評価した
- [ ] 観点4: 形骸化リスクを評価した
- [ ] 観点5: 曖昧性を評価した
- [ ] 各観点に✅/⚠️/❌の判定を記載した
```

---

## 37. Gemini監査プロンプト標準化（ポカヨケ：TROUBLE-046）

### 背景

Geminiへの監査依頼プロンプトが毎回異なる形式・情報量で、評価結果の信頼性が低下していた。

**参照**: TROUBLE-046（Geminiへのプロンプトが標準化されていない）

### 標準テンプレート（必須使用）

```markdown
あなたはコードレビューの監査役です。以下のポカヨケを「破ろうとする側」として評価してください。

## 監査対象
- Section番号: XX
- TROUBLE番号: TROUBLE-XXX
- 対象ファイル: [ファイルパス一覧]

## 変更内容
[変更の概要を記載]

## 対象ファイル全文

### [ファイル名1]
```
[ファイル全文をここに貼り付け]
```

### [ファイル名2]
```
[ファイル全文をここに貼り付け]
```

## 突破テスト観点（Section 36参照）
以下の5観点で突破可能性を評価してください：

1. **認知の強制性**: ルール存在を忘却・見落とし可能か？
2. **実行の強制性**: 認知していても意図的にスキップ可能か？
3. **例外許容性**: 「緊急時」を理由にバイパス可能か？
4. **形骸化リスク**: 時間経過で形式的な運用になる余地はあるか？
5. **曖昧性**: 解釈の余地がある表現はあるか？

## 判定基準
各観点について：
- ✅ 突破困難（突破シナリオ0件）
- ⚠️ 条件付き突破可能（突破シナリオ1-2件）
- ❌ 容易に突破可能（突破シナリオ3件以上）

## 期待する出力形式
各観点について：
- 判定: ✅/⚠️/❌
- 具体的な突破シナリオ（突破可能な場合）
- 改善提案（突破可能な場合）

## 総合判定
- ✅ 承認（5観点全て✅）
- ⚠️ 要改修（❌が0件かつ⚠️が1件以上）
- ❌ 却下（❌が1件以上）
```

### テンプレート必須セクション

| # | セクション | 必須 | 内容 |
|---|-----------|:----:|------|
| 1 | 監査対象 | ✅ | Section番号、TROUBLE番号、ファイル一覧 |
| 2 | 変更内容 | ✅ | 何を変更したかの概要 |
| 3 | 対象ファイル全文 | ✅ | 監査対象ファイルの全文（Section 35参照） |
| 4 | 突破テスト観点 | ✅ | 5観点の記載（Section 36参照） |
| 5 | 判定基準 | ✅ | ✅/⚠️/❌の定義 |
| 6 | 期待する出力形式 | ✅ | Geminiへの出力指示 |
| 7 | 総合判定 | ✅ | 承認/要改修/却下の条件 |

### プロンプト作成チェックリスト

```markdown
## Gemini監査プロンプトチェック（Section 37）

| # | 項目 | 確認 |
|---|------|:----:|
| 1 | 標準テンプレートを使用した | ✅/❌ |
| 2 | Section番号・TROUBLE番号を記載した | ✅/❌ |
| 3 | 対象ファイル全文を含めた（Section 35チェック済み） | ✅/❌ |
| 4 | 5観点を記載した（Section 36参照） | ✅/❌ |
| 5 | 判定基準を記載した | ✅/❌ |
| 6 | 期待する出力形式を記載した | ✅/❌ |

**全て✅でなければ監査依頼禁止**
```

### 禁止事項

| # | 禁止行為 | 理由 | 検知方法 |
|---|---------|------|---------|
| 1 | テンプレート未使用 | プロンプト品質のばらつき | チェックリスト確認 |
| 2 | 必須セクションの省略 | 情報不足による誤判定 | チェックリスト確認 |
| 3 | 5観点の変更・省略 | 評価基準の一貫性低下 | チェックリスト確認 |

### KGI

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 |
|------|--------|---------|---------|--------|
| テンプレート使用率 | 100% | チェックリストの✅率 | 毎監査 | Claude Code |
| 必須セクション充足率 | 100% | 7セクション全記載率 | 毎監査 | Claude Code |

---

## 38. 依頼内容完遂確認（ポカヨケ：TROUBLE-047）

### 背景

ユーザーから「5W2H/数値で明確にして」と依頼されたにもかかわらず、一部項目が明確化されないまま完了報告した。これは職務怠慢である。

**参照**: TROUBLE-047（5W2H/数値明確化依頼に対する不完全な対応）

### 適用タイミング（5W2H）

| 要素 | 内容 |
|------|------|
| When | 改修完了報告前（必須） |
| Where | 完了報告メッセージ内 |
| Who | Claude Code |
| What | 依頼内容と実装内容の照合表 |
| How | 依頼を引用し、対応内容を記載 |
| How much | 依頼項目の100%に対応必須 |

### 完了報告前チェックリスト（必須）

```markdown
## 依頼内容完遂確認（Section 38）

### 依頼と対応の照合表
| # | ユーザー依頼（引用） | 対応内容 | 5W2H | 数値基準 | 完遂 |
|---|---------------------|---------|:----:|:--------:|:----:|
| 1 | 「[依頼内容を引用]」 | [対応内容] | ✅/❌ | ✅/❌ | ✅/❌ |
| 2 | 「[依頼内容を引用]」 | [対応内容] | ✅/❌ | ✅/❌ | ✅/❌ |

**完遂列が全て✅でなければ完了報告禁止**

### 5W2H/数値化チェック
| # | 改修箇所 | 5W2H記載 | 数値基準 |
|---|---------|:--------:|:--------:|
| 1 | [箇所] | ✅/❌ | ✅/❌ |

**全て✅でなければ完了報告禁止**
```

### 禁止事項

| # | 禁止行為 | 理由 | 数値基準 |
|---|---------|------|---------|
| 1 | 照合表なしの完了報告 | 完遂確認漏れ | 照合表0件で禁止 |
| 2 | 完遂列に❌がある状態での完了報告 | 職務怠慢 | ❌が1件以上で禁止 |
| 3 | 5W2H/数値基準未記載での完了報告 | 曖昧な改修 | 未記載1件以上で禁止 |

### KGI

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 |
|------|--------|---------|---------|--------|
| 依頼完遂率 | 100% | 照合表の完遂✅率 | 毎改修 | Claude Code |
| ユーザー指摘後対応率 | 0% | ユーザー指摘で追加対応した数/全対応数 | 毎月 | Human |
| 5W2H充足率 | 100% | 改修箇所の5W2H記載率 | 毎改修 | Claude Code |

---

## 39. 証拠・数値根拠必須化（ポカヨケ：TROUBLE-048）

### 背景

対策提案時に「再発防止率100%」等の数値を記載したが、論理的検証も実績データもない願望だった。証拠・数値根拠が揃わない意見は個人的な意見であり、信憑性に欠ける。

**参照**: TROUBLE-048（証拠・数値根拠なしの発言）

### 適用対象（5W2H）

| 要素 | 内容 |
|------|------|
| When | ポカヨケ設置案提出時、監査指摘時、対策提案時、効果報告時 |
| Where | 全ての発言・提案・報告 |
| Who | Claude Code、Gemini監査役 |
| What | 証拠と数値根拠の提示 |
| How | 下記「証拠の定義」「数値根拠の定義」に従う |
| How much | 全発言に100%適用 |

### 証拠の定義

**「証拠」とは以下のいずれかを指す（自己申告・願望は証拠にならない）**:

| 証拠種別 | 具体例 | 検証方法 |
|---------|--------|---------|
| 実績データ | 過去のTROUBLE_LOG実績、業界統計、社内計測データ | データソースのURL/ファイル名を明記 |
| コマンド実行結果 | `grep`, `ls -la`, `git log`の出力 | コマンドと出力をコピペ |
| 論理的推論 | 「AならばB」の三段論法、因果関係の明示 | 各ステップの妥当性を説明 |
| 外部参照 | 公式ドキュメント、学術論文、技術記事 | URLを明記 |

**証拠にならないもの**:
| 種別 | 例 | 理由 |
|------|-----|------|
| 願望 | 「〜になるはず」「〜になると思う」 | 検証不能 |
| 自己申告 | 「確認しました」（結果なし） | 客観性なし |
| 曖昧な引用 | 「一般的に〜」「通常は〜」 | 出典不明 |

### 数値根拠の定義

**「数値根拠」とは以下のいずれかを指す（根拠なし数値は禁止）**:

| 根拠種別 | 具体例 | 必須記載事項 |
|---------|--------|-------------|
| 実績ベース | 過去TROUBLE-XXXでは再発率Y%だった | TROUBLE番号、期間、件数 |
| 計算ベース | X件中Y件が該当 = Z% | 計算式（分子/分母） |
| 測定計画ベース | 効果は実施後に測定 | 測定方法、測定時期、判定基準 |

**禁止される数値記載**:
| パターン | 例 | 禁止理由 |
|---------|-----|---------|
| 根拠なし100% | 「再発防止率100%」 | 検証不能な願望 |
| 根拠なし0件 | 「エラー0件」 | 予測は証拠にならない |
| 出典なし統計 | 「業界平均は30%」 | 出典不明 |

### 発言禁止ルール

**証拠・数値根拠が揃わない発言は禁止する**

| # | 発言種別 | 必須要素 | 揃わない場合 |
|---|---------|---------|-------------|
| 1 | ポカヨケ設置案 | 証拠 + 再発防止率（根拠付き） | **発言禁止** |
| 2 | 監査指摘 | 証拠 + 影響度の数値（根拠付き） | **発言禁止** |
| 3 | 対策提案 | 証拠 + 効果の数値根拠 | **発言禁止** |
| 4 | 効果報告 | 実測値 + 測定方法 | **発言禁止**（予測値禁止） |

**「発言禁止」の運用**:
- 証拠・根拠が揃わない段階では発言しない
- 「個人的な意見ですが」等の前置きがあっても発言禁止
- 揃わない場合は「証拠収集中」と報告し、揃ってから発言する

### 発言前チェックリスト（必須）

```markdown
## 証拠・数値根拠チェック（Section 39）

### 発言種別
- [ ] ポカヨケ設置案
- [ ] 監査指摘
- [ ] 対策提案
- [ ] 効果報告

### 証拠チェック
| # | 主張 | 証拠種別 | 証拠内容 | 検証可能 |
|---|------|---------|---------|:--------:|
| 1 | [主張] | [種別] | [内容] | ✅/❌ |

**全て✅でなければ発言禁止**

### 数値根拠チェック
| # | 数値 | 根拠種別 | 根拠内容（計算式/出典） |
|---|------|---------|----------------------|
| 1 | [数値] | [種別] | [根拠] |

**根拠なし数値があれば発言禁止**
```

### 効果報告の正しい形式

**禁止形式（予測値）**:
```markdown
| 指標 | Before | After |
|------|--------|-------|
| 再発防止率 | 0% | 100% |  ← 禁止：根拠なし予測
```

**正しい形式（測定計画）**:
```markdown
### 効果測定計画
| 指標 | 測定方法 | 測定時期 | 判定基準 |
|------|---------|---------|---------|
| 再発防止率 | TROUBLE_LOGで同種問題の再発をカウント | 実施後30日 | 再発0件で合格 |

**注**: 効果は実施後の実測値で記載する。
```

**正しい形式（実測値）**:
```markdown
### 効果測定結果（実測）
| 指標 | 実測値 | 測定期間 | 測定方法 |
|------|--------|---------|---------|
| 再発防止率 | 95%（20件中19件防止） | 2026-01-01〜01-31 | TROUBLE_LOGで同種問題をカウント |
```

### 禁止事項

| # | 禁止行為 | 理由 | 検知方法 |
|---|---------|------|---------|
| 1 | 証拠なしでポカヨケ設置案提出 | 信憑性なし | チェックリスト確認 |
| 2 | 証拠なしで監査指摘 | 信憑性なし | チェックリスト確認 |
| 3 | 根拠なし数値の記載 | 願望は証拠にならない | 数値根拠欄確認 |
| 4 | 予測値での効果報告 | 検証不能 | 測定方法欄確認 |
| 5 | 「個人的な意見ですが」での発言 | 信憑性なしの発言回避 | 発言内容確認 |

### KGI

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 |
|------|--------|---------|---------|--------|
| 証拠なし発言数 | 0件 | 発言ログをレビュー | 毎セッション | Human |
| 根拠なし数値使用数 | 0件 | 数値記載箇所を確認 | 毎セッション | Human |
| 発言禁止ルール違反 | 0件 | 違反発言をカウント | 毎セッション | Human |

### 関連ドキュメント

- TROUBLE-048: 証拠・数値根拠なしの発言
- Section 33: 監査役判定基準（数値根拠必須）
- Section 34: 基準明確化義務（5W2H必須）

### 強制プロセス（TROUBLE-050対策）

**背景**: Section 39は「禁止」を定義したが、発言前に強制チェックする仕組みがなく、同一セッション内で再発した（TROUBLE-050）。「禁止」だけでは守れない。

**強制プロセスの定義**:
```
発言前 → チェックリスト実行 → チェック結果を発言に添付 → 発言
         ↓
    チェック未実行 → 発言禁止
    チェック結果なし → 発言無効
```

**強制メカニズム（5W2H）**:

| 要素 | 内容 |
|------|------|
| When | 対象発言（ポカヨケ設置案/監査指摘/対策提案/効果報告）の直前 |
| Where | 全ての対象発言 |
| Who | Claude Code |
| What | チェックリスト実行＋結果添付 |
| How | 下記「チェック結果の添付形式」に従う |
| How much | 対象発言の100%に適用 |

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 発言前 | チェックリストを実行 | **発言禁止** |
| 2 | 発言時 | チェック結果を発言に添付 | **発言無効** |
| 3 | 発言後 | チェック結果の検証可能 | 検証不能な発言は却下 |

**チェック結果の添付形式（必須）**:

```markdown
## 発言前チェック結果（Section 39）

| # | 主張 | 証拠種別 | 証拠内容 | 検証可能 |
|---|------|---------|---------|:--------:|
| 1 | [主張] | [種別] | [内容] | ✅ |

| # | 数値 | 根拠種別 | 根拠内容 |
|---|------|---------|---------|
| 1 | [数値] | [種別] | [根拠] |

**チェック結果**: 全項目✅ → 発言可能
```

**チェック結果がない発言への対応**:

| 状況 | 対応 |
|------|------|
| チェック結果の添付なし | 発言を無効として扱う。再度チェックを実行して発言し直す |
| チェック結果に❌がある | 発言禁止。証拠・根拠を揃えてから発言し直す |
| チェック結果が不完全 | 発言無効。完全なチェック結果を添付して発言し直す |

**適用対象**:

| 発言種別 | 強制プロセス適用 |
|---------|:---------------:|
| ポカヨケ設置案 | ✅ 必須 |
| 監査指摘 | ✅ 必須 |
| 対策提案 | ✅ 必須 |
| 効果報告 | ✅ 必須 |
| 単純な質問・確認 | ❌ 不要 |
| 事実の報告（数値なし） | ❌ 不要 |

---

## 40. Gemini監査時の検証ルール（ポカヨケ：TROUBLE-049）

### 背景

Gemini監査役がエビデンスURLを提示しながら、そのURL内の情報を正確に読み取らず虚偽の回答をした。GeminiはGitHubリポジトリを直接参照できないため、虚偽発言のリスクがある。

**参照**: TROUBLE-049（Gemini監査役の虚偽発言）

### 絶対の定義

| 項目 | 定義 |
|------|------|
| **絶対の定義** | GitHubリポジトリに取り決めた内容 |
| **優先順位** | GitHub > Geminiの発言 |
| **矛盾時** | GitHubの定義が正しい |

### Gemini発言の信頼度

| 項目 | ルール |
|------|--------|
| 100%信頼 | **禁止** |
| 検証 | **必須** |
| 検証方法 | GitHub内の定義と照合 |

### Claude Codeの権利と義務（5W2H）

| 要素 | 内容 |
|------|------|
| When | Gemini監査結果受領時 |
| Where | 全てのGemini監査 |
| Who | Claude Code |
| What | Geminiの発言を検証し、矛盾があれば否定する |
| How | GitHub内に存在する根拠を示してGeminiの発言を否定 |
| How much | 全Gemini監査に適用 |

**Claude Codeの否定権**:
- Claude CodeはGitHub内に存在する根拠を示して、Geminiの発言を否定する権利を有する
- 否定する場合は、具体的なファイルパス・行番号・内容を引用すること
- 根拠なしの否定は禁止

### 適用範囲の制限

| 適用対象 | 適用 | 理由 |
|---------|:----:|------|
| Gemini監査への反論 | ✅ 適用 | Geminiの虚偽発言リスクがあるため |
| ポカヨケへの反論 | ❌ **適用外** | ポカヨケは不変の定義 |

**重要**: この検証ルール（Section 40）はGeminiの監査の場合のみ承認され、**ポカヨケのシステムに対しては効力を持たない**。ポカヨケは取り決めた不変の定義になるため、再発防止のために必ず遵守する。

### ポカヨケの不変性

| 操作 | Claude Code単独 | Human承認後 |
|------|:---------------:|:-----------:|
| ポカヨケの新規追加 | ✅ 可能（監査役承認で可） | - |
| ポカヨケの編集 | ❌ **禁止** | ✅ 可能 |
| ポカヨケの削除 | ❌ **禁止** | ✅ 可能 |

**ポカヨケによる不具合発生時の対応フロー**:
```
不具合発生 → ポカヨケの編集・削除禁止 → 人間に報告 → 人間と相談 → 人間の指示を仰ぐ
                                                            ↓
                               人間が承認 → 編集・削除を実行
                               人間が却下 → 別の対応を検討
```

### Gemini監査受領時のチェックリスト（必須）

```markdown
## Gemini監査検証チェック（Section 40）

### 1. Geminiの指摘一覧
| # | 指摘内容 | 検証対象 |
|---|---------|---------|
| 1 | [指摘] | [検証するGitHub内の定義] |

### 2. GitHub内定義との照合
| # | 指摘内容 | GitHub定義 | 一致 | 根拠（ファイル:行番号） |
|---|---------|-----------|:----:|----------------------|
| 1 | [指摘] | [定義] | ✅/❌ | [パス:L.XXX] |

### 3. 矛盾発見時の対応
| # | 矛盾内容 | Claude Codeの判断 | 根拠 |
|---|---------|------------------|------|
| 1 | [矛盾] | 否定/受け入れ | [根拠] |

**矛盾発見時**: GitHub内の根拠を示してGeminiの発言を否定する
**矛盾なし**: Geminiの指摘を受け入れる
```

### 禁止事項

| # | 禁止行為 | 理由 | 適用対象 |
|---|---------|------|---------|
| 1 | Geminiの発言を100%信頼 | 虚偽発言リスク | Gemini監査 |
| 2 | 検証なしでGemini指摘を受け入れ | 誤判定リスク | Gemini監査 |
| 3 | 根拠なしでGeminiを否定 | 恣意的判断 | Gemini監査 |
| 4 | Claude Code単独でポカヨケを編集・削除 | 不変の定義 | ポカヨケ |
| 5 | Section 40をポカヨケに適用 | 適用範囲外 | ポカヨケ |

### KGI

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 |
|------|--------|---------|---------|--------|
| Gemini虚偽発言の検知数 | 記録 | 照合で矛盾を発見した数 | 毎監査 | Claude Code |
| 誤った指摘の受け入れ数 | 0件 | 後から誤りが発覚した数 | 毎月 | Human |
| ポカヨケ無断編集・削除 | 0件 | git logで確認 | 毎月 | Human |

### 関連ドキュメント

- TROUBLE-049: Gemini監査役の虚偽発言
- Section 35: Gemini監査情報提供ルール
- Section 37: Gemini監査プロンプト標準化

---

## 41. 説明ルール（ポカヨケ：TROUBLE-050）

### 背景

Humanが説明を求めた際、専門用語を使った説明をしてしまい、理解されなかった。説明を求める行為は「具体的でわかりやすい説明を求めているサイン」である。

**参照**: TROUBLE-050（説明不足による理解促進失敗）

### 説明ルール（5W2H）

| 要素 | 内容 |
|------|------|
| When | Humanが説明を求めたとき |
| Where | 全ての説明場面 |
| Who | Claude Code |
| What | 小学生でもわかるように説明する |
| How | 比喩・たとえ話を使用、専門用語を避ける |
| How much | 説明を求められた全ての場面に適用 |

### 強制ルール

**Humanが説明を求めた場合、以下を強制する**:

| # | ルール | 具体例 |
|---|--------|-------|
| 1 | **小学生でもわかる言葉を使う** | 「認証」→「パスワードを入れてログインすること」 |
| 2 | **比喩・たとえ話を必ず使う** | 技術用語 → 日常生活の例え |
| 3 | **専門用語を使う場合は即座に説明** | 「API（アプリ同士が会話するための約束事）」 |
| 4 | **図や構造を言葉で描写** | 「流れ」「順番」「つながり」を明示 |

### 説明の前に確認するチェックリスト（必須）

```markdown
## 説明チェック（Section 41）

| # | 項目 | 確認 |
|---|------|:----:|
| 1 | 小学生が知らない言葉を使っていないか | ✅/❌ |
| 2 | 比喩・たとえ話を含めたか | ✅/❌ |
| 3 | 専門用語には説明を添えたか | ✅/❌ |
| 4 | 流れ・順番・つながりを明示したか | ✅/❌ |

**全て✅でなければ説明し直し**
```

### 良い説明の例

**悪い例（専門用語だらけ）**:
```
GitHub PR Approveは、PRに対してレビュアーがApprove判定を付与することで、
CIがそのApprove状態をチェックし、条件を満たした場合にマージを許可する仕組みです。
```

**良い例（小学生向け）**:
```
## たとえ話：学校の遠足の許可証

遠足に行くとき、こんなルールがあるとします：
- 「お母さんの許可が必要」
- 許可証に「お母さんのサイン」がないと遠足に行けない

【方法A：自分で「お母さんOK」と書く】
→ 先生「本当にお母さんが言ったの？ウソかもしれないよね」
→ ❌ 信用できない

【方法B：お母さん本人にサインしてもらう】
→ 先生「お母さんの字だね。本物だ」
→ ✅ 信用できる

GitHubでも同じで、「Approve」ボタンはHuman本人しか押せないから、偽装できないんです。
```

### 禁止事項

| # | 禁止行為 | 理由 |
|---|---------|------|
| 1 | 説明なしの専門用語使用 | 理解されない |
| 2 | 比喩なしの抽象的説明 | イメージしづらい |
| 3 | 「〜とは」で終わる辞書的説明 | 具体性がない |
| 4 | Humanが理解したか確認せずに進む | 理解度不明 |

### KGI

| 指標 | 目標値 | 測定方法 | 測定頻度 | 測定者 |
|------|--------|---------|---------|--------|
| 再説明要求回数 | 0回 | Humanからの「説明して」再要求をカウント | 毎セッション | Human |
| 比喩使用率 | 100% | 説明に比喩が含まれているかチェック | 毎セッション | Human |

---

## 42. 自律型不具合対応システム

### 背景

開発中に以下の問題が発生する：
1. **再発**: 既存のポカヨケを通過した不具合（最悪の事態）
2. **新規不具合**: 未知の不具合・バグの発生

これらの問題に対し、Human介入なしで自律的に分析・対策・検証を行い、KGI達成を目指す。

### 目的

| 項目 | 内容 |
|------|------|
| 最終目標 | Human不介入でKGI達成（本当の自律開発の完成） |
| KGI | ルール違反率0%、過去トラ再発率0%、仕様違反率0% |
| 検証方法 | PDCAで課題抽出→KPI設定→改修→KGI達成 |

### 発動条件

| トリガー種別 | 条件 | 認識 | 優先度 |
|-------------|------|------|:------:|
| **再発** | 不具合発生→原因調査→**ポカヨケを通過していた**ことが発覚 | 「TROUBLE-XXX再発」 | 最高 |
| **新規不具合** | 不具合発生→原因調査→**該当するポカヨケが存在しない** | 「新規TROUBLE」 | 高 |
| **バグ** | コード起因の不具合発生 | 「BUG-XXX」 | 高 |

**発動**: いずれかのトリガーで自律型不具合対応フローを自動開始

### 自律型不具合対応フロー

```
【Phase 1: 分析（なぜなぜ10回）】
┌─────────────────────────────────────────────────┐
│ 目的: 真因の特定                               │
│                                                 │
│ ■ 再発の場合:                                  │
│ なぜ1: なぜ再発したか？                        │
│ なぜ2: なぜポカヨケを通過したか？              │
│ なぜ3: なぜポカヨケが機能しなかったか？        │
│                                                 │
│ ■ 新規不具合・バグの場合:                      │
│ なぜ1: なぜ不具合/バグが発生したか？           │
│ なぜ2: なぜ事前に検知できなかったか？          │
│ なぜ3: なぜ防止策がなかったか？                │
│                                                 │
│ ...なぜ10: [真因に到達]                        │
│                                                 │
│ 出力: 真因の特定                               │
└─────────────────────────────────────────────────┘
                    ↓
【Phase 2: 対策立案（How分析10回）】
┌─────────────────────────────────────────────────┐
│ 目的: 最善の対策を選定                         │
│                                                 │
│ How1: どうすれば真因を解消できるか？           │
│ How2: どうすれば再発/発生を防げるか？          │
│ How3: どうすれば検知できるか？                 │
│ ...                                             │
│ How10: [対策案リスト完成]                      │
│                                                 │
│ 出力: 対策案リスト（優先度付き）               │
└─────────────────────────────────────────────────┘
                    ↓
【Phase 3: 実装】
┌─────────────────────────────────────────────────┐
│ ■ 再発の場合:                                  │
│ 1. TROUBLE_LOG.md に再発記録                   │
│ 2. CLAUDE.md に改修ポカヨケ設置                │
│ 3. TROUBLE_POKAYOKE_MAPPING.md 更新            │
│                                                 │
│ ■ 新規不具合の場合:                            │
│ 1. TROUBLE_LOG.md に新規TROUBLE記録            │
│ 2. CLAUDE.md に新規ポカヨケ設置                │
│ 3. TROUBLE_POKAYOKE_MAPPING.md 追加            │
│                                                 │
│ ■ バグの場合:                                  │
│ 1. BUG_FIX_LOG.md にバグ記録                   │
│ 2. コード修正                                   │
│ 3. 必要に応じてポカヨケ設置                    │
│                                                 │
│ ■ 共通:                                        │
│ - 必要に応じてpokayoke-check.yml 更新          │
└─────────────────────────────────────────────────┘
                    ↓
【Phase 4: 監査】
┌─────────────────────────────────────────────────┐
│ Gemini監査役による突破テスト                   │
│ - 5観点評価（Section 36準拠）                  │
│ - 承認/却下判定                                │
│                                                 │
│ 【異論がある場合】                             │
│ → 証拠ベース判定ルール（後述）を適用           │
└─────────────────────────────────────────────────┘
                    ↓
           承認 ←───┼───→ 却下
             ↓            ↓
     Phase 5へ       Phase 2に戻る
                     （改修ループ）
                    ↓
【Phase 5: 完了・通知】
┌─────────────────────────────────────────────────┐
│ 1. Discord通知（レポート送信）                 │
│ 2. 突破履歴テーブル更新                        │
│ 3. KPI計測・記録                               │
└─────────────────────────────────────────────────┘
```

### 証拠ベース判定ルール

**開発者（Claude）と監査役（Gemini）で意見が相違した場合の判定方法**:

| 状況 | 判定方法 |
|------|---------|
| GitHub定義（CLAUDE.md等）に記載あり | 記載内容が正。証拠として提出必須 |
| GitHub定義に記載なし | 議論の上で定義に追記 |
| 証拠提出後の異論 | 許可（ただし証拠ベースで反論必須） |

**判定フロー**:
```
意見相違発生
    ↓
GitHub定義を検索
    ↓
記載あり → 記載内容に従う（証拠提出）
記載なし → 議論 → 結論を定義に追記
    ↓
証拠提出後に異論あり → 証拠ベースで反論
    ↓
最終判定
```

### なぜなぜ分析フォーマット（10回）

```markdown
## なぜなぜ分析

**種別**: 再発 / 新規不具合 / バグ
**対象**: TROUBLE-XXX / BUG-XXX

| # | なぜ | 回答 |
|---|------|------|
| 1 | なぜ発生/再発したか？ | [回答] |
| 2 | なぜ[1の回答]か？ | [回答] |
| 3 | なぜ[2の回答]か？ | [回答] |
| 4 | なぜ[3の回答]か？ | [回答] |
| 5 | なぜ[4の回答]か？ | [回答] |
| 6 | なぜ[5の回答]か？ | [回答] |
| 7 | なぜ[6の回答]か？ | [回答] |
| 8 | なぜ[7の回答]か？ | [回答] |
| 9 | なぜ[8の回答]か？ | [回答] |
| 10 | なぜ[9の回答]か？ | [回答] |

### 真因
[10回の分析から特定した真因]
```

### How分析フォーマット（10回）

```markdown
## How分析

**種別**: 再発 / 新規不具合 / バグ
**対象**: TROUBLE-XXX / BUG-XXX

| # | How | 対策案 | 実現性 | 効果 | 優先度 |
|---|-----|--------|:------:|:----:|:------:|
| 1 | どうすれば真因を解消できるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 2 | どうすれば検知できるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 3 | どうすれば自動化できるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 4 | どうすれば形骸化を防げるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 5 | どうすれば例外を防げるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 6 | どうすれば曖昧性を排除できるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 7 | どうすれば認知を強制できるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 8 | どうすれば実行を強制できるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 9 | どうすれば証拠を残せるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |
| 10 | どうすれば監査できるか？ | [対策] | 高/中/低 | 高/中/低 | 1-10 |

### 採用対策
[優先度が高い対策を採用理由とともに記載]
```

### Discord通知フォーマット

**通知タイミング**: 自律型不具合対応フロー完了時

```markdown
🔄 **自律型不具合対応システム完了レポート**

## 対象
- 種別: 再発 / 新規不具合 / バグ
- ID: TROUBLE-XXX / BUG-XXX
- 元のポカヨケ: Section YY（再発の場合）

## 分析結果
### 真因（なぜなぜ10回の結論）
[真因を1-2文で記載]

### 採用対策（How分析の結論）
[採用した対策を1-2文で記載]

## 実施内容
### 再発の場合
- [ ] TROUBLE_LOG.md 更新（再発記録）
- [ ] CLAUDE.md ポカヨケ改修
- [ ] MAPPING更新

### 新規不具合の場合
- [ ] TROUBLE_LOG.md 追加
- [ ] CLAUDE.md 新規ポカヨケ設置
- [ ] MAPPING追加

### バグの場合
- [ ] BUG_FIX_LOG.md 記録
- [ ] コード修正
- [ ] テスト実施

### 共通
- [ ] CI更新（該当する場合）

## 監査結果
- 監査役: Gemini
- 判定: ✅ 承認 / ⚠️ 要改修 / ❌ 却下
- 5観点評価: [認知/実行/例外/形骸化/曖昧性]

## KPI
- 改修ループ回数: X回
- 分析から完了までの時間: X分

---
*このレポートは自律型不具合対応システムにより自動生成されました*
```

### KPI（PDCAで管理）

| KPI | 目標値 | 測定方法 |
|-----|--------|---------|
| 自律改修の成功率 | 100% | 監査承認数/改修実施数 |
| Gemini監査の初回承認率 | 80%以上 | 初回承認数/監査依頼数 |
| 改修ループ回数 | 2回以内 | 承認までのループ回数 |
| 再発間隔 | 延長傾向 | 前回再発からの日数 |

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 不具合検知時 | 自律型フロー発動（再発/新規/バグ全て） | **発動必須** |
| 2 | 分析時 | なぜなぜ10回・How10回実施 | **分析不完全で却下** |
| 3 | 監査時 | Gemini承認取得 | **未承認で完了禁止** |
| 4 | 完了時 | Discord通知 | **通知なしは完了とみなさない** |

### 対象種別の判定基準

| 種別 | 判定条件 | 記録先 |
|------|---------|--------|
| 再発 | 既存TROUBLE番号に該当するポカヨケを通過 | TROUBLE_LOG.md |
| 新規不具合 | 該当するTROUBLE/ポカヨケが存在しない | TROUBLE_LOG.md |
| バグ | コード起因の不具合（ロジックエラー、構文エラー等） | BUG_FIX_LOG.md |

---

## 突破履歴テーブル（TROUBLE-042）

| 回数 | 日時 | 突破観点 | 改修内容 | Gemini応答要約 |
|------|------|---------|---------|---------------|
| 1 | 2026-01-18 | 認知/実行/例外/形骸化/曖昧性（5観点全て） | 用語定義、強制メカニズム、形骸化防止策追加 | 技術的強制力なし、曖昧な定義、形骸化リスク |
| 2 | 2026-01-18 | 認知/実行/形骸化/曖昧性（4観点） | コスト算出客観化、微調整検知ルール追加 | システム的強制なし、数値微調整で回避可能 |
| 3 | 2026-01-18 | 認知/実行/形骸化（3観点） | 5W2H・数値基準追加、Section 34新規作成 | システム的強制力の欠如、品質評価の仕組み不在 |
| 4 | 2026-01-18 | 実行/曖昧性（2観点❌）、認知/例外/形骸化（3観点⚠️） | GitHub Actions導入、PRトリガーにdev追加、exit 1で失敗、「監査済み」定義厳格化 | devブランチPRでチェック未実行、Warningレベル、定義不明確 |
| 5 | 2026-01-18 | 実行/形骸化（2観点❌）、例外/曖昧性（2観点⚠️） | Section 35-38追加、PR description検証追加 | CIがセクション存在のみ確認し中身の質未検証、形骸化リスク高 |

**現在の状況**: 5回連続突破 → **緊急停止発動**

**次のアクション**: Human介入必須（選択肢1〜3から選択待ち）

---

## 43. レポート形式標準化（ポカヨケ：TROUBLE-051）

### 背景

人間への報告時に形式が統一されておらず、説得力や明確性に欠ける報告になっていた。

**参照**: TROUBLE-051（人間からの指摘3回発生）

### レポート形式（3層構造）

| 層 | 手法 | 目的 | 必須度 |
|----|------|------|:------:|
| 1 | **レトリカルトライアングル** | 説得力の確保 | 必須 |
| 2 | **PREP** | 結論ファーストで明確化 | 必須 |
| 3 | **5W2H + 数値** | 具体性と測定可能性 | 必須 |

### レトリカルトライアングル（3要素）

| 要素 | 内容 | 例 |
|------|------|-----|
| **ロゴス（論理）** | データ・事実・数値に基づく説明 | 「導入企業90%が効果実感」 |
| **パトス（感情）** | 相手の課題・感情に訴える | 「残業が減らない悩みを解決」 |
| **エトス（信頼）** | 実績・信頼性を示す | 「10年間無事故の実績」 |

### PREP（4要素）

| 要素 | 内容 | 順序 |
|------|------|:----:|
| **P**oint | 結論（何が問題か/何をすべきか） | 1 |
| **R**eason | 理由（なぜそう言えるか） | 2 |
| **E**xample | 具体例（どこで確認したか） | 3 |
| **P**oint | 結論の再確認（だから何をすべきか） | 4 |

### 5W2H + 数値

| 要素 | 質問 | 数値化 |
|------|------|--------|
| When | いつ | 日時、期間 |
| Where | どこで | 場所、ファイル、Section |
| Who | 誰が | 担当者（Claude/Gemini/Human） |
| What | 何を | 対象物、内容 |
| Why | なぜ | 理由、根拠 |
| How | どのように | 方法、手順 |
| How much | どのくらい | 数量、頻度、コスト |

### レポートテンプレート

```markdown
## レポート: [タイトル]

### 結論（Point）
[1-2文で結論を述べる]

---

### ロゴス（論理・データ）

| 項目 | 5W2H | 数値 | 目標 | 達成率 |
|------|------|------|------|:------:|
| [KPI1] | When/Where/Who/What/How/How much | X | Y | Z% |

### パトス（感情・共感）
[課題と目指す姿を記載]

### エトス（信頼・実績）
[実績データを記載]

---

### 理由（Reason）
[なぜその結論に至ったか]

### 確認内容（Example）
[具体的なデータ・証拠]

### 対応提案（Point）
[だから何をすべきか]
```

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | レポート作成前 | 3層構造を確認 | **作成禁止** |
| 2 | レポート作成時 | テンプレートに従う | **レポート無効** |
| 3 | レポート提出後 | 3要素の存在を検証可能 | **差し戻し** |

---

## 44. 要件確認チェックリスト（ポカヨケ：TROUBLE-051）

### 背景

Humanの要件を正確に理解せずに作業を開始し、期待と出力に差が発生した。

**参照**: TROUBLE-051（人間からの指摘3回発生）

### 要件確認の5W2H

作業開始前に以下を確認し、不明点はHumanに質問する。

| 要素 | 確認内容 | 質問例 |
|------|---------|--------|
| Who | 誰のための作業か | 「この機能の利用者は誰ですか？」 |
| What | 何を作成/変更するか | 「具体的な成果物は何ですか？」 |
| Why | なぜ必要か | 「この作業の目的は何ですか？」 |
| When | いつまでに必要か | 「期限はありますか？」 |
| Where | どこに適用するか | 「対象ファイル/環境はどこですか？」 |
| How | どのように実装するか | 「実装方法の指定はありますか？」 |
| How much | どの程度の範囲か | 「対象範囲はどこまでですか？」 |

### 要件確認チェックリスト

```markdown
## 要件確認チェック（作業開始前必須）

| # | 確認項目 | 確認結果 | 不明点 |
|---|---------|---------|--------|
| 1 | Who: 利用者/対象者は明確か | ✅/❌ | [不明点] |
| 2 | What: 成果物は明確か | ✅/❌ | [不明点] |
| 3 | Why: 目的は明確か | ✅/❌ | [不明点] |
| 4 | When: 期限は明確か | ✅/❌ | [不明点] |
| 5 | Where: 対象範囲は明確か | ✅/❌ | [不明点] |
| 6 | How: 実装方法は明確か | ✅/❌ | [不明点] |
| 7 | How much: 範囲/規模は明確か | ✅/❌ | [不明点] |

**不明点がある場合**: Humanに質問してから作業開始
**全て✅の場合**: 作業開始可能
```

### 要件理解の確認フォーマット

作業開始前に以下をHumanに提示し、認識合わせを行う：

```markdown
## 要件理解確認

以下の理解で正しいでしょうか？

| 項目 | 私の理解 |
|------|---------|
| 目的 | [Whatをするために] |
| 成果物 | [具体的な成果物] |
| 対象 | [対象ファイル/機能] |
| 方法 | [実装アプローチ] |
| 範囲 | [対象範囲] |

問題なければ作業を開始します。
```

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 作業開始前 | 5W2Hチェック実施 | **作業開始禁止** |
| 2 | 不明点発見時 | Humanに質問 | **推測での作業禁止** |
| 3 | 作業開始時 | 要件理解確認を提示 | **確認なしの作業禁止** |

---

## 45. KPIレポート自動生成（ポカヨケ：TROUBLE-051）

### 背景

セッションごとのKPIが可視化されておらず、精度改善の進捗が不明確だった。

**参照**: TROUBLE-051（人間からの指摘3回発生）

### KPIダッシュボード項目

| # | KPI | 定義 | 目標値 | 測定方法 |
|---|-----|------|--------|---------|
| 1 | 人間からの指摘回数 | Humanからの訂正・追加指示の回数 | 0回 | セッション内カウント |
| 2 | 監査役からの指摘回数 | Geminiからの要改修判定回数 | 0回 | 監査依頼ごとにカウント |
| 3 | ポカヨケ発動回数 | CI失敗回数 | 0回 | GitHub Actions履歴 |
| 4 | バグ発生回数 | コード起因不具合の回数 | 0回 | BUG_FIX_LOG.md |
| 5 | 一発完了率 | 修正なしで完了した作業の割合 | 100% | 完了作業数/全作業数 |
| 6 | 要件理解精度 | 「〜ではなく〜」訂正の回数 | 0回 | セッション内カウント |

### KPIレポートテンプレート

```markdown
## KPIレポート

**セッション日時**: YYYY-MM-DD HH:MM
**作業内容**: [概要]

### 精度KPI

| # | KPI | 今回 | 目標 | 達成率 | 前回比 |
|---|-----|------|------|:------:|:------:|
| 1 | 人間からの指摘回数 | X回 | 0回 | Y% | ↑/↓/→ |
| 2 | 監査役からの指摘回数 | X回 | 0回 | Y% | ↑/↓/→ |
| 3 | ポカヨケ発動回数 | X回 | 0回 | Y% | ↑/↓/→ |
| 4 | バグ発生回数 | X回 | 0回 | Y% | ↑/↓/→ |
| 5 | 一発完了率 | X% | 100% | Y% | ↑/↓/→ |
| 6 | 要件理解精度 | X回 | 0回 | Y% | ↑/↓/→ |

### 指摘内容詳細

#### 人間からの指摘
| # | 内容 | 真因 | 対策 |
|---|------|------|------|
| 1 | [内容] | [真因] | [対策] |

#### 監査役からの指摘
| # | 内容 | 真因 | 対策 |
|---|------|------|------|
| 1 | [内容] | [真因] | [対策] |

### 要因解析サマリー
[主要な真因と対策を記載]

### 次回アクション
- [ ] [アクション1]
- [ ] [アクション2]
```

### セッション終了時の自動生成

セッション終了時に以下を自動実行：

1. KPIを集計
2. レポートテンプレートに記入
3. 指摘内容の要因解析
4. Discord通知（レポート送信）

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | セッション中 | 指摘回数をカウント | **カウント漏れは後から追記** |
| 2 | セッション終了時 | KPIレポート生成 | **生成なしはセッション終了禁止** |
| 3 | レポート生成後 | Discord通知 | **通知なしは完了とみなさない** |

---

## 46. 3環境システム標準化（デフォルトモード）

### 背景

3環境システム（本番/開発/提案）が定義されているが、新規プロジェクトで適用漏れが発生していた。
本Sectionにより、3環境システムをClaude Codeの**標準モード**として強制する。

**参照**: TROUBLE-039（3環境システム未適用）、Section 28

### 3環境システムの定義

| 環境 | コード | 目的 | データ | デプロイ権限 | Human承認 |
|------|--------|------|--------|-------------|:----------:|
| **本番（Production）** | PROD | 実業務運用 | 本番データ | Human承認必須 | 必須 |
| **開発（Development）** | DEV | 機能開発・テスト | テストデータ | 自律可（テスト必須） | 推奨 |
| **提案（Proposal）** | PROP | AI自律実験 | テストデータ | AI単独可 | 不要 |

### 標準モード設定（デフォルト）

| 設定項目 | 値 | 説明 |
|---------|-----|------|
| デフォルト環境 | PROP（提案環境） | 新規開発はまず提案環境で実験 |
| 昇格フロー | PROP → DEV → PROD | 段階的に検証後に昇格 |
| 作業開始時の環境 | 自動的にPROPを想定 | 明示的な指定がない限り |

### 環境識別ルール

#### 5W2H定義

| 要素 | 定義 |
|------|------|
| **When** | 全ての開発作業開始時 |
| **Where** | 各プロジェクトフォルダ（-prod/-dev/-prop） |
| **Who** | Claude Code |
| **What** | 作業環境の特定と確認 |
| **Why** | 環境混同による本番障害を防止 |
| **How** | フォルダ名とCLAUDE.md確認 |
| **How much** | 作業開始時に1回（必須） |

### 環境判定フロー

```
1. 作業フォルダを確認
   ├── *-prod/ または crm-dashboard/ → 本番環境
   ├── *-dev/ → 開発環境
   └── *-prop/ または gemini-dashboard-gas/ → 提案環境

2. 各環境のCLAUDE.mdを確認
   └── 「環境: [PROD/DEV/PROP]」の記載を確認

3. 環境に応じたルール適用
   ├── PROD → 全ルール厳守、Human承認必須
   ├── DEV → 標準ルール、テスト必須
   └── PROP → 最小ルール、自律実験可
```

### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | 作業開始前 | 環境判定を実施 | **作業開始禁止** |
| 2 | 作業中 | 環境に応じたルール適用 | **ルール違反として記録** |
| 3 | 環境昇格時 | 昇格チェックリスト実施 | **昇格禁止** |

---

## 47. 統合ダッシュボードシステム（3環境統合）

### 背景

Gemini/Claude使用状況、不具合発生率、GASプロジェクト管理が分散していた。
本Sectionにより、統合ダッシュボードで一元管理する。

### ダッシュボード構成

| ページ | 目的 | 主要KPI |
|--------|------|---------|
| **概要（Overview）** | 今週のサマリー | 総合ヘルス指標 |
| **Gemini使用状況** | API使用量管理 | 日次使用量、使用率 |
| **Claude使用状況** | セッション管理 | 工程別使用率 |
| **不具合ダッシュボード** | 品質管理 | 0不良日数、再発率 |
| **GASプロジェクト管理** | 3環境統合 | 本番/テスト/提案状態 |

### 1. 今週のサマリーページ

#### 表示項目（5W2H + 数値）

| 項目 | 定義 | 数値例 |
|------|------|--------|
| **期間** | 今週（月曜〜日曜） | 2026-01-13 〜 2026-01-19 |
| **Gemini使用量** | 週間API呼び出し数 | 342回 / 7,000回上限 |
| **Claude使用量** | 週間セッション数 | 28セッション |
| **不具合発生数** | 週間発生数 | 0件 |
| **0不良日数** | 連続無不良日数 | 5日 |
| **完了タスク** | 週間完了数 | 15タスク |
| **監査合格率** | Gemini監査の承認率 | 92% |

### 2. Gemini使用状況ページ

#### 工程別使用比率（5W2H + 数値）

| 工程 | 説明 | 使用回数 | 比率 |
|------|------|:--------:|:----:|
| **監査（Audit）** | コード監査依頼 | 50回 | 35% |
| **検索（Search）** | 情報検索 | 30回 | 21% |
| **レビュー（Review）** | ドキュメントレビュー | 25回 | 18% |
| **設計（Design）** | 設計相談 | 20回 | 14% |
| **その他** | 汎用質問 | 17回 | 12% |

#### スプレッドシート構成

| シート名 | 列 | 用途 |
|---------|-----|------|
| **GeminiUsage** | timestamp, category, description, tokens | 使用記録 |
| **GeminiDaily** | date, audit, search, review, design, other, total | 日別集計 |
| **GeminiConfig** | key, value | 設定値 |

### 3. Claude使用状況ページ

#### 工程別使用比率（5W2H + 数値）

| 工程 | 説明 | セッション数 | 比率 |
|------|------|:-----------:|:----:|
| **開発（Development）** | コード実装 | 12回 | 43% |
| **修正（Fix）** | バグ修正 | 5回 | 18% |
| **調査（Research）** | 調査・分析 | 4回 | 14% |
| **ドキュメント（Doc）** | 文書作成 | 4回 | 14% |
| **設定（Config）** | 設定変更 | 3回 | 11% |

#### スプレッドシート構成

| シート名 | 列 | 用途 |
|---------|-----|------|
| **ClaudeUsage** | timestamp, category, description, duration_min | 使用記録 |
| **ClaudeDaily** | date, development, fix, research, doc, config, total | 日別集計 |

### 4. 不具合発生率ダッシュボード

#### 表示項目（5W2H + 数値）

| 項目 | 定義 | 計算方法 | 数値例 |
|------|------|---------|--------|
| **0不良日連続達成日数** | 不具合0日の連続日数 | TROUBLE_LOG.mdから計算 | 5日 |
| **前回の不良発生日** | 最後の不具合発生日 | TROUBLE_LOG.mdの最新日付 | 2026-01-13 |
| **今月の不良数** | 当月の不具合発生数 | 当月のTROUBLE数 | 3件 |
| **不良発生率** | 作業日あたりの発生率 | 不良数 / 作業日数 | 16.7% |
| **再発発生数** | 再発の累計数 | 「再発」タグ付きTROUBLE数 | 2件 |
| **再発発生率** | 全不良に対する再発率 | 再発数 / 全不良数 | 6.7% |

#### スプレッドシート構成

| シート名 | 列 | 用途 |
|---------|-----|------|
| **DefectLog** | date, trouble_id, title, is_recurrence, root_cause | 不良記録 |
| **DefectDaily** | date, defect_count, recurrence_count | 日別集計 |
| **DefectKPI** | date, zero_defect_days, monthly_defects, defect_rate | KPI |

### 5. GASプロジェクト管理（3環境統合）

#### プロジェクト一覧（環境別）

| プロジェクト | 本番（PROD） | 開発（DEV） | 提案（PROP） |
|-------------|:------------:|:-----------:|:------------:|
| **CRM Dashboard** | ✅ crm-dashboard | ✅ crm-dashboard-dev | ❌ 未作成 |
| **Gemini Dashboard** | ❌ 未作成 | ❌ 未作成 | ✅ gemini-dashboard-gas |

#### 各環境のGAS情報

| 環境 | プロジェクト | scriptId | スプレッドシートID |
|------|------------|---------|------------------|
| CRM本番 | crm-dashboard | 1CQiLiFG8N77... | （本番SS） |
| CRM開発 | crm-dashboard-dev | 1TW14Q78eA1C5... | 1EpqO7HL3o7jTbk... |
| Gemini提案 | gemini-dashboard-gas | 1UxE0XsPCn22ja3... | 1qA0EsBBcY4JRTA3... |

### ポカヨケ：Dashboard記入強制

#### 記入必須項目

| 項目 | 記入タイミング | 未記入時の扱い |
|------|--------------|--------------|
| Gemini使用記録 | API呼び出し後 | **セッション終了禁止** |
| Claude使用記録 | セッション終了時 | **セッション終了禁止** |
| 不具合発生記録 | TROUBLE記録時 | **TROUBLE記録不完全** |

#### 強制プロセス

| # | 段階 | 強制内容 | スキップ時の扱い |
|---|------|---------|----------------|
| 1 | Gemini API呼び出し後 | 使用記録をスプレッドシートに記入 | **記入漏れアラート** |
| 2 | セッション終了時 | Claude使用記録を記入 | **セッション終了禁止** |
| 3 | TROUBLE記録時 | DefectLogシートに記入 | **TROUBLE記録不完全** |

### 統合スプレッドシートID

| 環境 | スプレッドシート名 | ID |
|------|------------------|-----|
| 提案（PROP） | Gemini Usage Dashboard | 1qA0EsBBcY4JRTA32MSXEuMFOxtNLRiTq_Oy_1j0wmEo |

---

## 48. エラー発生時強制フロー（TROUBLE-052対応）

### 概要

エラー発生時にDiscord通知を確実に送信するための強制フロー。
通知漏れを防ぐため、エラー発生時は必ずこのフローを実行する。

### 強制フロー（5W2H）

| 項目 | 内容 |
|------|------|
| いつ | エラー発生時（即座に実行） |
| どこで | エラー発生箇所（ツール実行、API呼び出し等） |
| 誰が | Claude Code |
| 何を | Discord通知 + ユーザーへの報告 |
| どうやって | 以下のフローを順番に実行 |
| どれぐらい | 全エラーに対して100%実行 |
| なぜ | ユーザーへの即座の通知が必要 |

### エラー発生時フロー

```
エラー発生
    ↓
Step 1: Discord通知を試行
    ~/sales-ops-with-claude/scripts/notify-discord.sh error "[エラー内容]"
    ↓
Step 2: 通知結果を確認
    ├─ 成功 → Step 3へ
    └─ 失敗 → Step 2a: ユーザーに直接報告
         「Discord通知に失敗しました。エラー内容: [内容]」
    ↓
Step 3: ユーザーに状況報告
    「[エラー内容]が発生しました。対応: [対応内容]」
```

### 対象となるエラー

| エラー種別 | 通知テンプレート |
|-----------|----------------|
| APIクォータエラー | `error "[API名]クォータ上限到達（Xm後リセット）"` |
| 認証エラー | `auth "[サービス名]認証エラー。再認証が必要"` |
| ツール実行エラー | `error "[ツール名]実行失敗: [原因]"` |
| デプロイエラー | `error "デプロイ失敗: [原因]"` |
| その他のエラー | `error "[エラー内容]"` |

### Webhook未設定時の対応

Discord Webhookが未設定の場合は、以下のメッセージを**必ず**ユーザーに報告：

```
Discord Webhook未設定のためエラー通知を送信できませんでした。
エラー内容: [具体的なエラー内容]
対応: [必要な対応]
```

### チェックリスト

エラー発生時に確認：

- [ ] Discord通知コマンドを実行したか
- [ ] 通知失敗時はユーザーに直接報告したか
- [ ] エラー内容と対応をユーザーに伝えたか

### 違反時の対応

このフローを実行せずにエラーを放置した場合：
1. 過去トラとして記録（TROUBLE-XXX）
2. 再発防止策を追加

---

## 49. 不具合定義拡張・5W2H+数値記録システム

### 概要

全ての事象を5W2H+数値で記録し、統合ダッシュボードで可視化・分析してPDCAを回す。
API制限も不具合として定義し、開発における全情報を一元管理する。

### 不具合分類（拡張版）

| 分類 | コード | 説明 | 例 |
|------|--------|------|-----|
| コード不具合 | code_bug | コードのバグ | TROUBLE-XXX |
| **API制限** | api_limit | APIクォータ超過 | Gemini/GitHub rate limit |
| 環境エラー | env_error | 認証・設定エラー | Webhook未設定 |
| プロセス違反 | process | ワークフロー違反 | 通知漏れ、記録漏れ |
| 仕様違反 | spec | 仕様との不一致 | 実装ミス |
| 再発 | recurrence | 過去トラ再発 | TROUBLE-XXX（再発） |

### 5W2H+数値 記録フォーマット

全事象は以下の形式で記録する：

| 項目 | 説明 | 例 |
|------|------|-----|
| timestamp | いつ | 2026-01-18T15:30:00Z |
| where | どこで | Gemini API |
| who | 誰が | Claude Code |
| what | 何が | APIクォータ上限到達 |
| how | どうやって | API呼び出し回数が制限を超過 |
| how_much | どれぐらい（数値） | 40（リセットまで40分） |
| why | なぜ | 使用量が日次制限を超過 |
| event_type | 種別 | defect / info / warning |
| category | カテゴリ | api_limit |
| severity | 重大度 | low / medium / high / critical |
| status | 状態 | open / resolved / waiting |
| related_id | 関連ID | API-LIMIT-20260118-153000 |

### GAS連携（統合ダッシュボード）

#### 記録API

| 関数 | 用途 | 呼び出し例 |
|------|------|-----------|
| `recordEvent()` | 5W2H+数値でイベント記録 | `clasp run recordEvent --params '[{...}]'` |
| `recordAPILimitError()` | API制限エラー記録 | `clasp run recordAPILimitError --params '["Gemini", "メッセージ", 40]'` |
| `notifyFromClaudeCode()` | Discord通知 | `clasp run notifyFromClaudeCode --params '["error", "メッセージ", {}]'` |

#### 前提条件

1. gemini-dashboard-gasディレクトリで実行
2. clasp login済み
3. Apps Script API有効化済み
4. スクリプトプロパティに`DISCORD_BUGREPORT_WEBHOOK`設定済み

### API制限発生時のフロー

```
API制限エラー発生
    ↓
Step 1: GAS APIでイベント記録
    clasp run recordAPILimitError --params '["API名", "エラー内容", リセット分数]'
    ↓
Step 2: 自動的にDiscord通知が送信される
    ↓
Step 3: ユーザーに状況報告
    「[API名] APIクォータ上限に達しました。[X]分後にリセットされます。」
```

### 関連ドキュメント

| ドキュメント | 場所 | 内容 |
|-------------|------|------|
| 仕様書 | gemini-dashboard-gas/SPEC.md | システム全体仕様 |
| ページマニュアル | gemini-dashboard-gas/PAGES_MANUAL.md | 各ページの図解 |
| 環境設定 | gemini-dashboard-gas/CLAUDE.md | 環境固有設定 |

---

## 50. 手順説明フォーマット（TROUBLE-053対応）

### 概要

手順説明時に5W2Hを適用し、曖昧な説明を防止する。
「何を」だけでなく「どこで（ファイル名・UI位置）」を必ず含める。

### 手順説明フォーマット（必須）

| # | どこで（場所） | 何を（操作） |
|---|---------------|-------------|
| 1 | [アプリ名] > [画面名] > [ファイル名] | [具体的操作] |
| 2 | [UI要素の位置] | [具体的操作] |

### チェックリスト

手順説明時に確認：

- [ ] ファイル名を明記したか
- [ ] UI要素の位置を明記したか
- [ ] 操作内容を明記したか

### 違反時の対応

曖昧な説明でHumanから指摘を受けた場合：
1. 即座に5W2Hフォーマットで再説明
2. 過去トラとして記録

---

## 51. 質問前調査の強制プロセス（TROUBLE-054対応）

### 概要

**KGI: 人の手を借りないこと**

質問する前に必ず調査を行い、調査証拠を提示してから質問する。
調査証拠なしの質問は禁止。

### 調査対象（質問前に必ず検索）

| 情報種別 | 調査対象ファイル |
|---------|-----------------|
| フォルダID | environments/env-config.json |
| スクリプトID | .clasp.json、CLAUDE.md |
| 環境設定 | environments/env-config.json |
| 過去の議論 | TROUBLE_LOG.md、DEVELOPMENT_LOG.md |
| 仕様 | PROJECT_SPECIFICATION.md、SPEC.md |

### 質問フォーマット（必須）

```markdown
**調査証拠**:
- 調査したファイル: [ファイル名]
- 検索キーワード: [キーワード]
- 結果: [見つからなかった / 該当なし]

**質問**:
〇〇を調査しましたが見つからなかったので確認させてください。[質問内容]
```

### 禁止事項

| 禁止 | 理由 |
|------|------|
| 調査証拠なしの質問 | KGI違反（人の手を借りる） |
| 「教えてください」の単独使用 | 調査不足の可能性 |
| 「確認してください」の単独使用 | 自己解決の努力不足 |

### チェックリスト（質問前）

- [ ] env-config.json を検索したか
- [ ] CLAUDE.md を検索したか
- [ ] TROUBLE_LOG.md を検索したか
- [ ] 調査証拠を文書化したか

### 違反時の対応

調査証拠なしで質問してHumanから指摘を受けた場合：
1. 即座に調査を実施
2. 調査証拠を提示して再質問
3. 過去トラとして記録（TROUBLE-054形式）

---

## 52. 全Google URL共有ルール（TROUBLE-055対応）

### 概要

全てのGoogle関連URLには必ず`?authuser=0`を付与する。
複数アカウントログイン時の400エラーを防止。

### 対象URL（全て必須）

| URL種別 | 形式 | authuser |
|---------|------|:--------:|
| GASエディタ | script.google.com/home/projects/... | **必須** |
| スプレッドシート | docs.google.com/spreadsheets/d/... | **必須** |
| WebアプリURL | script.google.com/macros/s/... | **必須** |
| Googleドライブ | drive.google.com/... | **必須** |

### 正しいURL形式

```
# GASエディタ
https://script.google.com/home/projects/[PROJECT_ID]/edit?authuser=0

# スプレッドシート
https://docs.google.com/spreadsheets/d/[SHEET_ID]/edit?authuser=0

# WebアプリURL
https://script.google.com/macros/s/[DEPLOY_ID]/exec?authuser=0

# Googleドライブ
https://drive.google.com/drive/folders/[FOLDER_ID]?authuser=0
```

### 禁止事項

| 禁止 | 理由 |
|------|------|
| authuser なしのGoogle URL共有 | 400エラー発生 |
| authuser=1, 2 等の指定 | アカウント不一致の可能性 |

### チェックリスト（URL共有時）

- [ ] URLの末尾に`?authuser=0`が付いているか
- [ ] 既に`?`がある場合は`&authuser=0`を使用しているか

---

## 53. 設定値自動設定の一貫性ルール（TROUBLE-056対応）

### 概要

**原則: 設定値は全て自動設定。手動設定を要求する場合は設計ミス。**

ユーザーに手動設定を求める設計は、KGI「人の手を借りない」に違反する。

### 自動設定の優先順位

| 優先度 | 設定方法 | 例 |
|:------:|---------|-----|
| 1 | コード内定数 | `SPREADSHEET_CONFIG.FOLDER_ID` |
| 2 | 環境設定ファイル | `env-config.json` |
| 3 | スクリプトプロパティ | 動的に変わる値のみ |

### 設計チェックリスト（GAS関数作成時）

- [ ] 手動設定を要求する箇所がないか
- [ ] 同種の設定値で自動/手動が混在していないか
- [ ] setup()で全ての初期設定が完結するか
- [ ] ユーザーの手動作業は0回か

### 禁止事項

| 禁止 | 理由 |
|------|------|
| 手動でスクリプトプロパティ設定を要求 | KGI違反 |
| 「〇〇を設定してください」という案内 | 自動化すべき |
| 設定値のコード内定義とプロパティ参照の混在 | 一貫性欠如 |

### 違反時の対応

手動設定を要求してHumanから指摘を受けた場合：
1. 即座にコードを修正して自動化
2. 過去トラとして記録（TROUBLE-056形式）

---

## 54. clasp run前提条件（TROUBLE-057対応）

### 概要

`clasp run`でGAS関数をCLIから実行するには、**API実行可能デプロイ**が必要。
Webアプリデプロイでは`clasp run`は動作しない。

### 前提条件チェックリスト

新規GASプロジェクト作成時：

- [ ] GASエディタで「デプロイ」>「新しいデプロイ」を開く
- [ ] 種類で「API実行可能」を選択
- [ ] 「デプロイ」をクリック
- [ ] デプロイIDを記録

### API実行可能デプロイ設定手順

| # | どこで | 何を |
|---|-------|------|
| 1 | GASエディタ > デプロイ > 新しいデプロイ | クリック |
| 2 | 種類を選択（⚙️アイコン） | 「API実行可能」を選択 |
| 3 | 説明 | 「CLI execution」等を入力 |
| 4 | アクセスできるユーザー | 「自分のみ」を選択 |
| 5 | 「デプロイ」ボタン | クリック |

### clasp runの使用

```bash
# API実行可能デプロイ設定後
clasp run functionName
clasp run functionName --params '[\"arg1\", \"arg2\"]'
```

### 現在のGASプロジェクト状態

| プロジェクト | API実行可能デプロイ | clasp run |
|-------------|:------------------:|:---------:|
| gemini-dashboard-gas | 未設定 | 使用不可 |
| crm-dashboard | 未設定 | 使用不可 |

### 自律実行への影響

API実行可能デプロイがないと：
- CLIからGAS関数を実行できない
- KGI「人の手を借りない」を達成できない

---

## 55. 平準化ルール（TPS Heijunka）

### 概要

作業量を均等化し、過負荷による品質低下を防止する。
「急いで多くやる」より「安定して確実にやる」を重視。

### WIP（Work In Progress）制限

| 項目 | 上限 | 理由 |
|-----|:----:|------|
| 同時進行タスク | 3件 | 注意力分散防止 |
| 1コミットの変更ファイル | 5件 | レビュー可能性 |
| 1PRの変更行数 | 500行 | 理解可能性 |

### 作業時間制限

| 項目 | 制限 | アクション |
|-----|:----:|-----------|
| 連続作業時間 | 4時間 | 休憩リマインド |
| 1タスク最大所要 | 2時間 | タスク分割推奨 |
| 1日最大コミット | 10件 | 過負荷警告 |

### バッチサイズ制限

| 作業種別 | 推奨サイズ | 理由 |
|---------|:--------:|------|
| 機能追加 | 1機能/PR | 影響範囲限定 |
| バグ修正 | 1バグ/コミット | 追跡容易性 |
| リファクタリング | 1ファイル/コミット | revert容易性 |

### セルフチェック

作業開始時に確認：
- [ ] 現在の同時進行タスク数: __件（3件以下か？）
- [ ] 直近の連続作業時間: __時間（4時間以下か？）
- [ ] 今日のコミット数: __件（10件以下か？）

### 超過時のアクション

| 状況 | アクション |
|-----|-----------|
| WIP > 3件 | 新規着手禁止、既存タスク完了優先 |
| 連続作業 > 4時間 | 強制休憩（15分） |
| 1日コミット > 10件 | 翌日への繰り越し推奨 |
| 1PR > 500行 | PR分割を検討 |

---

## 56. エスカレーション定義（TPS Andon）

### 閾値設定

| 状況 | 閾値 | エスカレーションアクション |
|-----|:----:|--------------------------|
| 同一エラー再発 | 3回 | Discord通知 + TROUBLE記録 |
| 同一エラー継続 | 5回 | 緊急通知 + 作業停止 |
| pre-commit失敗 | 3回連続 | 原因分析必須 |
| Gemini監査未実施 | 2日連続 | 警告通知 |
| 未解決タスク | 3日経過 | 優先度見直し通知 |

### エスカレーションフロー

```
Lv1: 自動対応
  ↓ 解決しない（3回以内）
Lv2: Claude Code対応（分析・対策）
  ↓ 解決しない（5回以内）
Lv3: Human通知（Discord承認待ち）
  ↓ 解決しない
Lv4: 緊急対応（作業停止・優先対応）
```

### Discord通知トリガー

| トリガー | 通知タイプ | メッセージ例 |
|---------|----------|-------------|
| エラー3回再発 | warning | 「同一エラー3回目: [エラー内容]」 |
| エラー5回再発 | error | 「緊急: エラー5回目で作業停止」 |
| pre-commit3回失敗 | warning | 「pre-commit連続失敗中」 |
| 未解決タスク3日 | info | 「タスク長期未完了: [タスク名]」 |

---

## 57. 思考プロセス制御システム（Human介入率0%達成）

### 目的
Human介入（質問/指示/確認/フィードバック）を記録・学習し、再発防止を行う。
最終目標: Human介入率 0%（完全自律）

### 詳細仕様
**docs/00_common/THINKING_PROCESS/SPEC.md** を参照（本節は概要のみ）

### カテゴリ
| カテゴリ | 発生条件 | AI責任 |
|---------|---------|--------|
| feedback | Humanが私のミスを指摘 | 私がミスした |
| question | Humanが質問してきた | 私の説明不足 |
| instruction | Humanが指示してきた | 私の自発性不足 |
| confirmation | Humanが確認してきた | 私の報告不明確 |

### 記録場所
```
docs/00_common/THINKING_PROCESS/
├── SPEC.md          # 本仕様書
├── SUMMARY.md       # 統計・傾向
├── feedback/
│   ├── normal/      # 通常（初回）
│   └── recurrence/  # 再発
├── question/
├── instruction/
└── confirmation/
```

### 技術的強制（Hooks）
| Hook | スクリプト | 効果 |
|------|-----------|------|
| SessionStart | session_init.sh | ログ初期化・必須読了リスト通知 |
| PreToolUse | session_gate.py | 必須ファイル読了前のEdit/Write/Bashをブロック |
| PostToolUse(Read) | read_logger.py | 読了ログ自動記録 |
| PostToolUse(*) | tool_logger.py | 全ツール呼び出しログ |

### KPI
| 指標 | 目標 |
|------|------|
| feedback再発率 | 0%（同一ミス禁止） |
| 新規Human介入 | 減少傾向 |
| 分類精度 | 100%（自己修正含む） |

---

## Section 58: 応答プロセスフロー（毎回実行・省略禁止）

### 概要
Human介入率0%達成のため、全メッセージ受信時に実行するプロセス。

### フロー図
```
┌─────────────────────────────────────────────────────┐
│                メッセージ受信                         │
├─────────────────────────────────────────────────────┤
│ Step 1: メッセージ分類                               │
│   → feedback / question / instruction / confirmation │
├─────────────────────────────────────────────────────┤
│ Step 2: 該当カテゴリ過去トラ参照                     │
│   → THINKING_PROCESS/{category}/recurrence/ 全件読了│
│   → THINKING_PROCESS/{category}/normal/ 全件読了    │
├─────────────────────────────────────────────────────┤
│ Step 3: クイズ回答                                  │
│   → QUIZ.mdの該当カテゴリに回答                     │
│   → 不正解 → 再読                                   │
├─────────────────────────────────────────────────────┤
│ Step 4: 要因分析                                    │
│   → なぜこのメッセージが発生したか                   │
│   → 私の不足は何か                                  │
│   → 次回どうすれば防げるか                          │
├─────────────────────────────────────────────────────┤
│ Step 5: ポカヨケチェック                            │
│   → Section 59のチェックリスト全項目確認            │
├─────────────────────────────────────────────────────┤
│ Step 6: 応答出力 + ログ記録                         │
│   → CONVERSATION_LOG.mdに追記                       │
│   → THINK-X-XXX.md作成                             │
└─────────────────────────────────────────────────────┘
```

### 分類基準
| 分類 | 判定基準 | 意味 |
|------|---------|------|
| feedback | 「違う」「間違い」「読んでない」等の指摘 | 私がミスした |
| question | 「〜とは？」「どうやって？」等の質問 | 私の説明不足 |
| instruction | 「〜して」「〜を実行」等の依頼 | 私の自発性不足 |
| confirmation | 「できた？」「確認した？」等の確認 | 私の報告不明確 |

### 分類基準の自律アップデート
Humanから「分類が違う」と指摘 → 本セクションの分類基準を即座に更新

---

## Section 59: ポカヨケチェックリスト（毎回実行・省略禁止）

### 応答前チェック
```
□ 分類完了: ____________（feedback/question/instruction/confirmation）
□ 過去トラ参照完了: recurrence ___件, normal ___件
□ クイズ回答: 全問正解
□ 要因分析: ____________
□ 改善案: ____________
```

### 応答後チェック
```
□ 再発判定: はい / いいえ
□ ログ記録: CONV-____________（CONVERSATION_LOG.mdに追記）
□ 過去トラ記録: THINK-_-___.md 作成
```

### 作成前チェック（POKA-F-001）
```
□ 調査完了後、結果を報告したか
□ 設計完了後、内容を提示したか
□ Humanから明示的な合意を得たか
□ 合意なしに作成を開始していないか
```

### チェック漏れ時の対応
- チェック漏れ発覚 → feedbackとして記録
- 同一チェック漏れ2回目 → recurrenceとして記録 + ポカヨケ強化

---

## Section 60: 介入率低減メカニズム

### 目的
Human介入率を段階的に低減し、最終的に0%を達成する。

### フェーズ
| Phase | 介入率目標 | 方法 |
|-------|-----------|------|
| Phase 1 | 100% | 全応答でHuman確認（パイロット運用） |
| Phase 2 | 50% | パターン分析、高頻度ミスにポカヨケ追加 |
| Phase 3 | 20% | 自動チェック強化、Hooks活用 |
| Phase 4 | 5% | 例外処理のみHuman確認 |
| Phase 5 | 0% | 完全自律（Humanは「yes」のみ） |

### 現在のPhase: **Phase 1（パイロット運用）**

### Phase移行条件
| 移行 | 条件 |
|------|------|
| 1→2 | 50件以上の介入記録 + パターン分析完了 |
| 2→3 | 介入率50%未満 + 主要パターンにポカヨケ設置 |
| 3→4 | 介入率20%未満 + 自動チェック網羅 |
| 4→5 | 介入率5%未満 + 例外パターン文書化完了 |

### パターン分析手法
1. CONVERSATION_LOG.mdから介入タイプ別集計
2. 高頻度パターンの特定（上位5件）
3. 各パターンの根本原因分析（5Why）
4. ポカヨケ設計・実装
5. 効果測定（介入率変化）

### ポカヨケ追加ルール
| ルール | 内容 |
|--------|------|
| 追加条件 | 同一パターンで2回以上介入発生 |
| 設計基準 | 技術的強制力 > ルール的強制力 |
| 記録場所 | THINKING_PROCESS/SPEC.md Section 7 |
| 効果確認 | 30日間の再発有無で判定 |

### 介入率計算式
```
介入率 = (feedback + question + instruction + confirmation) / 総応答数 × 100
```

### ダッシュボード連携
- WebApp「不具合管理」タブに介入率KPIを表示（FEATURE-008 Phase2以降）
- 週次で自動集計・グラフ化

---

**以上**
