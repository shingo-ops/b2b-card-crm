# CLAUDE.md - CRMダッシュボード プロジェクト定義

## 最終更新: 2026-01-15
## 3者合意: Human ✅ / Claude Code ✅ / Claude ✅

---

## 共通ドキュメント参照（必ず確認）

> **共通ルール**: [COMMON_RULES.md](../docs/00_common/COMMON_RULES.md)
> **エージェント仕様**: [docs/00_common/AGENT_*.md](../docs/00_common/)
> **プロジェクト仕様**: [docs/01_crm/](../docs/01_crm/)
> **過去トラ**: [docs/01_crm/TROUBLE_LOG.md](../docs/01_crm/TROUBLE_LOG.md)

---

# 1. プロジェクト概要

B2B営業システムのCRMダッシュボード。
GAS Webアプリとして実装し、Google スプレッドシートをデータベースとして使用。

## 1.1 技術スタック

| 項目 | 内容 |
|------|------|
| フロントエンド | GAS Webアプリ（HTML/CSS/JavaScript） |
| バックエンド | Google Apps Script |
| データベース | Google スプレッドシート |
| 認証 | Googleアカウント認証 |

## 1.2 基本方針

- **Single Source of Truth**: リード管理シートがメインDB
- **列数上限**: 60列まで（これ以上は既存列の削除/統合とセットで検討）
- **In-placeアーカイブ**: データはシート移動せず、ステータス変更で管理

---

# 2. データ構造定義

## 2.1 シート一覧

| # | シート名 | 用途 | 状態 |
|---|----------|------|------|
| 1 | リード管理 | メインDB（Single Source of Truth） | **✅ 確定** |
| 2 | 担当者マスタ | 担当者情報 | 仮 |
| 3 | 設定 | プルダウン選択肢 | 仮 |
| 4 | 権限設定 | 役割権限 | 仮 |
| 5 | 目標設定 | KPI目標 | 仮 |
| 6 | テンプレート | メッセージテンプレート | 仮 |
| 7 | 週次レポート | 週次報告 | 仮（別途議論） |
| 8 | 月次レポート | 月次報告 | 仮（別途議論） |
| 9 | シフト | シフト管理 | 仮 |
| 10 | Buddy対話ログ | AI対話履歴（統合版） | 仮 |
| 11 | 会話ログ | 顧客会話ログ | 仮 |
| 12 | 専門用語辞書 | 翻訳辞書 | 仮 |
| 13 | お知らせ | 通知 | 仮 |
| 14 | 既読管理 | 既読状態 | 仮 |
| 15 | Buddy日替わりメッセージ | 日替わりメッセージ設定 | 仮 |
| 16 | ログイン履歴 | ユーザーログイン記録 | 仮 |

**削除済**: 目標設定_壁打ち（Buddy対話ログに統合）

---

## 2.2 リード管理シート 列構成（確定版）

### サマリー

| カテゴリ | 列数 | 列番号 |
|----------|------|--------|
| 基本情報 | 4列 | 1-4 |
| CS記入 | 15列 | 5-19 |
| アサイン・担当 | 5列 | 20-24 |
| 営業（商談中） | 13列 | 25-37 |
| 営業（レポート） | 13列 | 38-50 |
| アーカイブ | 2列 | 51-52 |
| Buddy・AI | 1列 | 53 |
| 会話ログ連携 | 3列 | 54-56 |
| 重複管理 | 4列 | 57-60 |
| **合計** | **60列** | |

---

### カテゴリ1: 基本情報（4列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 1 | リードID | システム | 自動採番 |
| 2 | 登録日 | システム | 自動 |
| 3 | リード種別 | CS | IN/OUT |
| 4 | シート更新日 | システム | 自動 |

---

### カテゴリ2: CS記入（15列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 5 | 流入経路 | CS | プルダウン |
| 6 | 顧客名 | CS | テキスト |
| 7 | 呼び方（英語） | CS/営業 | テキスト |
| 8 | 国 | CS | プルダウン |
| 9 | メール | CS | テキスト |
| 10 | 電話番号 | CS | テキスト |
| 11 | 連絡手段 | CS | プルダウン |
| 12 | メッセージURL | CS | テキスト |
| 13 | 初回接触日 | CS | 日付 |
| 14 | 温度感 | CS/営業 | プルダウン |
| 15 | 想定規模 | CS/営業 | プルダウン |
| 16 | 顧客タイプ | CS/営業 | プルダウン |
| 17 | 返信速度 | CS/営業 | プルダウン |
| 18 | CSメモ | CS | テキスト |
| 19 | 問い合わせ回数 | システム | 重複検知用 |

---

### カテゴリ3: アサイン・担当（5列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 20 | 進捗ステータス | システム/CS/営業 | プルダウン（自動入力ルールあり） |
| 21 | 担当者 | CS/リーダー | プルダウン |
| 22 | 担当者ID | システム | 自動 |
| 23 | アサイン日 | システム | 自動 |
| 24 | 最終対応者ID | システム | 最後に対応した人 |

**進捗ステータス自動入力ルール:**
- 新規追加時 → 「新規」
- アサイン時 → 「アサイン確定」

---

### カテゴリ4: 営業（商談中）（13列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 25 | 見込度 | システム | 自動計算（商談情報から算出） |
| 26 | 次回アクション | 営業 | テキスト |
| 27 | 次回アクション日 | 営業 | プルダウン（旧：再アプローチ日を統合） |
| 28 | 商談メモ | 営業 | テキスト |
| 29 | 相手の課題 | 営業 | テキスト |
| 30 | 取り扱いタイトル | 営業 | 複数選択プルダウン |
| 31 | 販売形態 | 営業 | プルダウン |
| 32 | 月間見込み金額 | 営業 | 数値 |
| 33 | 1回の発注金額 | 営業 | 数値 |
| 34 | 購入頻度 | 営業 | プルダウン |
| 35 | 競合比較中 | 営業 | プルダウン |
| 36 | 商談の手応え | 営業 | プルダウン |
| 37 | アラート確認日 | システム | 自動 |

---

### カテゴリ5: 営業（レポート）（13列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 38 | 商談結果 | 営業 | プルダウン |
| 39 | 対象外理由 | 営業 | プルダウン |
| 40 | 失注理由 | 営業 | プルダウン |
| 41 | 初回取引日 | 営業 | 日付 |
| 42 | 初回取引金額 | 営業 | 数値 |
| 43 | 累計取引金額 | システム | 自動計算 |
| 44 | Good Point | 営業 | テキスト（商談ごとの振り返り） |
| 45 | More Point | 営業 | テキスト（商談ごとの振り返り） |
| 46 | 反省と今後の抱負 | 営業 | テキスト（商談ごとの振り返り） |
| 47 | レポート提出日 | システム | 自動 |
| 48 | レポート確認者 | リーダー | プルダウン |
| 49 | レポート確認日 | システム | 自動 |
| 50 | レポートコメント | リーダー | テキスト |

---

### カテゴリ6: アーカイブ（2列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 51 | アーカイブ日 | システム | 自動 |
| 52 | アーカイブ理由 | CS | プルダウン |

---

### カテゴリ7: Buddy・AI（1列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 53 | Buddyフィードバック | システム | AIからのFB |

---

### カテゴリ8: 会話ログ連携（3列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 54 | 会話要約 | システム | 自動 |
| 55 | 最終会話日時 | システム | 自動 |
| 56 | 会話数 | システム | 自動 |

---

### カテゴリ9: 重複管理（4列）

| 列# | 列名 | 入力者 | 備考 |
|-----|------|--------|------|
| 57 | 重複フラグ | システム | 自動 |
| 58 | 重複元リードID | システム | 自動 |
| 59 | 重複確認日 | CS | 日付 |
| 60 | 重複確認者 | システム | 自動 |

---

# 3. 進捗ステータス定義

## 3.1 ステータス一覧（確定）

| ステータス | 段階 | 説明 |
|-----------|------|------|
| 新規 | リード | 登録直後 |
| 対応中 | リード | CSが対応中 |
| 対象外 | リード | リード段階で対象外判定 |
| アサイン確定 | 商談 | 営業にアサイン完了 |
| 商談中 | 商談 | 商談進行中 |
| 見積もり提示 | 商談 | 見積書送付済み |
| 成約 | 完了 | 契約締結 |
| 失注 | 完了 | 失注確定 |
| 追客 | 完了 | 再アプローチ対象 |
| アーカイブ | 完了 | 対応終了 |

**重要**: コード内で「アサイン済」は使用禁止。「アサイン確定」を使用すること。

---

# 4. 環境情報

## 4.1 開発環境の定義

### デプロイURL構成

| 環境 | URL種別 | URL | 用途 |
|------|---------|-----|------|
| **開発** | `/dev`（ヘッドデプロイ） | https://script.google.com/a/macros/treasureislandjp.com/s/AKfycbwcYOukOoSaPgJjO7e6KBBtDaL0Rinl5-WmW00XMuQ/dev?authuser=0 | push後即反映、再デプロイ不要 |
| **本番** | 固定デプロイID | （リリース時に作成） | バージョン管理、安定性重視 |

### 運用ルール

| 操作 | 開発環境 | 本番環境 |
|------|----------|----------|
| コード反映 | `clasp push` のみ | `clasp deploy` 必須 |
| 確認URL | `/dev` | 固定ID `/exec` |
| 自律実行 | ✅ OK | ❌ 人間承認必須 |

### デプロイの違い

```
/dev（ヘッドデプロイ）
├── 常に最新コードを実行
├── clasp push 後、即座に反映
└── 開発・テストに最適

固定デプロイID（/exec）
├── 特定バージョンで固定
├── 明示的に clasp deploy が必要
└── 本番運用に最適
```

## 4.2 スプレッドシート

| 環境 | ID | URL |
|------|-----|-----|
| **開発** | `1G4ffyH8Abiki0861CjRvGiO_Ks_8wMiZKaWfujcOzvs` | [開く](https://docs.google.com/spreadsheets/d/1G4ffyH8Abiki0861CjRvGiO_Ks_8wMiZKaWfujcOzvs/edit) |
| **本番** | `1kF-o4jCrbQePktWaFEBvWhJJjRXhkuw5-AcISa4ClAk` | [開く](https://docs.google.com/spreadsheets/d/1kF-o4jCrbQePktWaFEBvWhJJjRXhkuw5-AcISa4ClAk/edit) |

## 4.3 GASエディタ

| 項目 | URL |
|------|-----|
| GASプロジェクト | https://script.google.com/u/0/home/projects/1CQiLiFG8N77uYzlo3UNgAwml9_8mAJYAmfe4thp3RGsvbiwoaS-kS7X0/edit |

## 4.4 環境切り替え（スプレッドシート参照先）

### スクリプトプロパティ設定

| プロパティ名 | 開発環境 | 本番環境 |
|-------------|----------|----------|
| `ENVIRONMENT` | `development` | `production` |
| `DEV_SPREADSHEET_ID` | `1G4ffyH8Abiki0861CjRvGiO_Ks_8wMiZKaWfujcOzvs` | （不要） |

### 切り替え関数

| 関数名 | ファイル | 行 | 用途 |
|--------|----------|-----|------|
| `setEnvironment(env)` | Config.gs | 38 | 環境切り替え |
| `showCurrentEnvironment()` | Config.gs | 89 | 現在環境の表示 |
| `getEnvironment()` | Config.gs | 29 | 現在環境の取得 |

**注意**: GASエディタから直接実行する場合は、スクリプトプロパティで `ENVIRONMENT` を設定する。

## 4.5 URL発行ルール

**全てのURLに `?authuser=0` を必ず付ける**

```
✅ 正しい例:
https://script.google.com/.../dev?authuser=0

❌ 間違い例:
https://script.google.com/.../dev
```

## 4.6 GAS環境分離の注意点

### SpreadsheetApp.getUi() の挙動

**重要**: `SpreadsheetApp.getUi()` はスクリプトプロパティの `ENVIRONMENT` 設定を**無視**する。

| メソッド | 参照先 |
|----------|--------|
| `getSpreadsheet()` | ENVIRONMENT設定に基づくスプレッドシート |
| `SpreadsheetApp.getUi()` | GASエディタを開いた元のスプレッドシート |

### 実際の動作パターン

```
本番スプレッドシートからGASエディタを開いた場合:
├── getSpreadsheet() → 開発スプレッドシート（ENVIRONMENT=development時）
├── SpreadsheetApp.getUi() → 本番スプレッドシートのUI
└── 結果: ダイアログは本番に表示、変更は開発に適用
```

### 対処法

1. **UI表示は気にしない**: データ操作先が正しければ問題なし
2. **開発スプレッドシートから開く**: UI表示も開発側にしたい場合
3. **ログで確認**: 関数実行前に `Logger.log()` で操作対象IDを出力
4. **ダイアログに環境名を明記**: ダイアログメッセージに「[開発]」「[本番]」を含める

### ダイアログ環境名明記ルール

ダイアログを表示する関数では、操作対象の環境を**メッセージ内に明記**する。

```javascript
// ✅ OK: 環境名を明記
const env = getEnvironment();
const envLabel = env === 'development' ? '[開発]' : '[本番]';
ui.alert(envLabel + ' シートセットアップが完了しました');

// ❌ NG: 環境名がない
ui.alert('シートセットアップが完了しました');
```

**発見日**: 2026-01-14

---

# 5. 開発ルール

## 5.1 列変更の厳格ルール

### 禁止事項
- ❌ 1つのシートだけ列を変更する
- ❌ 列の順序を変更する（末尾追加のみ許可）
- ❌ コード内で「アサイン済」を使用する（「アサイン確定」を使用）

### 許可条件
- ✅ 全ての連動シートに同時追加
- ✅ 末尾に追加
- ✅ Config.gsを同時更新
- ✅ grepで影響箇所を確認後に変更

### 列変更時の必須手順
1. 影響を受けるシートを全て特定
2. 影響を受けるGASファイルを全て特定（grep）
3. Config.gsのHEADERS定義を確認
4. 全ての対象シートを**同時に**変更
5. 変更後にgrep確認（旧列名が0件であること）

## 5.2 本番デプロイルール

### 必須フロー
1. 開発環境で実装完了
2. `runAllTests()` が全てPASS
3. 人間に完了報告
4. 人間が動作確認
5. 人間の承認
6. 本番デプロイ実行

### 厳守事項
- ⚠️ 本番デプロイは必ず人間の承認後に実行
- ❌ 自律的な本番デプロイは禁止
- ✅ 開発環境でのテストデプロイは自律実行OK

---

# 6. 変更履歴

| 日付 | 変更内容 | 合意状況 |
|------|----------|----------|
| 2026-01-14 | リード管理シート列構成確定（60列） | 3者合意 ✅ |
| 2026-01-14 | 見込度をCS記入→営業（商談中）に移動 | 3者合意 ✅ |
| 2026-01-14 | 再アプローチ日→次回アクション日に統合 | 3者合意 ✅ |
| 2026-01-14 | 商談の手応えを営業（レポート）→営業（商談中）に移動 | 3者合意 ✅ |
| 2026-01-14 | Good Point, More Point, 反省と今後の抱負を追加 | 3者合意 ✅ |
| 2026-01-14 | 列数上限60列を設定 | 3者合意 ✅ |
| 2026-01-14 | 目標設定_壁打ちシートを削除（Buddy対話ログに統合） | 3者合意 ✅ |
| 2026-01-14 | 進捗ステータス定義確定（「アサイン済」禁止） | 3者合意 ✅ |

---

# 7. 今後の議論予定

| 項目 | 内容 | 優先度 |
|------|------|--------|
| 設定シート | プルダウン選択肢の定義（リード管理改修後） | 高 |
| Buddy対話ログ | 列構成の確定 | 中 |
| 週次/月次レポート | 列構成・記入項目の確定 | 中 |
| ログイン履歴 | 列構成と実装方式の確定 | 中 |
| その他シート | 列構成の確定 | 低 |

---

# 8. 関連ドキュメント

| ドキュメント | 内容 | 重要度 |
|-------------|------|--------|
| COMMON_RULES.md | 全プロジェクト共通定義 | ★★★★★ |
| **DEPENDENCY_UI_SPEC.md** | **依存性UI設計仕様書（心理学的根拠・Buddy設計）** | **★★★★★** |
| BUDDY_LOG.md | Buddy成長記録・バージョン管理 | ★★★★☆ |
| TROUBLE_LOG.md | CRM固有の過去トラ | ★★★★☆ |
| COMMON_RULES_TROUBLE_LOG.md | 共通過去トラ | ★★★☆☆ |

---

**以上**
