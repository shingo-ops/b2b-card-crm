# CRM 開発チェックリスト

## 概要
新機能追加・バグ修正時に確認すべき項目のチェックリストです。
Phase 1〜6の大規模改修で発生した問題を踏まえて作成しました。

---

## 新機能追加時のチェックリスト

### HTMLファイル修正時

- [ ] 新しい`google.script.run.関数名()`呼び出しを追加した場合
  - [ ] WebApp.gsに対応する関数が存在するか確認
  - [ ] 関数名のスペルが完全に一致しているか確認
  - [ ] 引数の数と型が一致しているか確認

- [ ] テンプレート変数（`<?= 変数名 ?>`）を使用する場合
  - [ ] doGet()で該当変数を設定しているか確認
  - [ ] 変数名のスペルが一致しているか確認

- [ ] 新しいモーダルを追加した場合
  - [ ] モーダル閉じるハンドラ（Escキー、オーバーレイクリック）が動作するか確認
  - [ ] closeAllModals()またはcloseAllModalsIndex()に追加したか確認

### GASファイル修正時

- [ ] 関数名を変更した場合
  - [ ] 呼び出し元のHTMLファイルも更新したか確認
  - [ ] API_REFERENCE.mdを更新したか確認

- [ ] 関数を削除した場合
  - [ ] 呼び出し元がないか全ファイルを検索して確認

- [ ] 新しい関数を追加した場合
  - [ ] API_REFERENCE.mdに追記したか確認
  - [ ] checkPermission()による権限チェックが必要か検討

- [ ] シートのヘッダー構造を変更した場合
  - [ ] Config.gsのHEADERS定義を更新したか確認
  - [ ] SetupIntegratedSheet.gsのヘッダー定義を更新したか確認
  - [ ] 列インデックスを使用している全箇所を確認

### Config.gs修正時

- [ ] DROPDOWN_COLUMNSを変更した場合
  - [ ] DEFAULT_DROPDOWN_OPTIONSも更新したか確認
  - [ ] populateDropdowns()で新しい項目を設定しているか確認

- [ ] HEADERSを変更した場合
  - [ ] 列数の変更があればaddIntegratedLead()等も更新

---

## デプロイ前チェックリスト

### 必須確認

- [ ] clasp pushが成功する（構文エラーなし）
- [ ] テストデプロイで全ページを開く
  - [ ] ダッシュボード（index.html）
  - [ ] リード（IN）（leads.html?page=leads-in）
  - [ ] リード（OUT）（leads.html?page=leads-out）
  - [ ] 商談管理（deals.html）
  - [ ] 担当者管理（staff.html）

- [ ] ブラウザのコンソールでエラーがないか確認
  - [ ] TypeError: xxx is not a function → 関数が存在しない
  - [ ] ReferenceError: xxx is not defined → 変数が未定義

### 機能確認

- [ ] リード追加が動作する
- [ ] リード一覧が表示される
- [ ] リード編集が動作する
- [ ] 商談一覧が表示される
- [ ] 担当者一覧が表示される
- [ ] Buddyカードが表示される

---

## バグ発生時の対応フロー

### 1. 問題の切り分け

```
エラーメッセージを確認
  ↓
クライアント側エラー？ or サーバー側エラー？
  ↓
クライアント側: ブラウザコンソールを確認
サーバー側: GASエディタの実行ログを確認
```

### 2. よくあるエラーと対処

| エラー | 原因 | 対処 |
|--------|------|------|
| `xxx is not a function` | 関数が存在しない | WebApp.gsに関数を追加 or 呼び出し名を修正 |
| `xxx is not defined` | 変数が未定義 | テンプレート変数の設定を確認 |
| `権限がありません` | checkPermissionで弾かれた | 権限設定を確認 |
| `シートが見つかりません` | シート名が違う | CONFIG.SHEETSの設定を確認 |

### 3. 修正後の確認

- [ ] 修正したコードをデプロイ
- [ ] 問題が解消されたか確認
- [ ] 関連機能に影響がないか確認
- [ ] BUG_FIX_LOG.mdに記録

---

## コードレビューチェックリスト

### セキュリティ

- [ ] ユーザー入力値を直接使用していないか（SQLインジェクション対策）
- [ ] checkPermission()で適切な権限チェックをしているか
- [ ] 機密情報（API Key等）がコードにハードコードされていないか

### パフォーマンス

- [ ] 不要なシート全体取得をしていないか
- [ ] ループ内でシートアクセスをしていないか（バッチ処理を使用）
- [ ] 大量データを一度に返していないか

### 保守性

- [ ] 関数名・変数名が分かりやすいか
- [ ] マジックナンバーを使用していないか（定数化）
- [ ] 重複コードがないか（共通化を検討）

---

## 更新履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-01-12 | 初版作成（getBuddyDataAuto問題を受けて） |
