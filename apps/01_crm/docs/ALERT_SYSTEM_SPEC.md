# アラートシステム仕様書

## 最終更新: 2026-01-11
## バージョン: 1.0
## ステータス: 設計完了、実装待ち

---

# 1. 概要

## 1.1 目的

営業ダッシュボードの目的は、単なるデータの可視化ではなく、**営業が次のアクションを適切に取れる状態を作ること**である。

そのために、以下の自動検知・通知システムを実装する。

## 1.2 運用ルール（自動化対象）

| # | ルール | 自動化 |
|---|--------|--------|
| 1 | ネクストアクション2営業日以内に設定 | ✅ |
| 2 | 商談フェーズの更新促進 | ✅ |
| 3 | 滞留案件の検知 | ✅ |
| 4 | アサイン後の対応開始確認 | ✅ |
| 5 | モチベーション低下の検知 | ✅ |

---

# 2. ネクストアクション管理

## 2.1 検知条件

| 状態 | 条件 | 担当 |
|------|------|------|
| 未設定 | ネクストアクション日が空 | GAS → Discord + Buddy |
| 期限超過 | ネクストアクション日から2営業日以上経過 | GAS → Discord + Buddy |

## 2.2 通知タイミング

| タイミング | 処理 |
|-----------|------|
| 毎日9:00 | 日次バッチで検知 → Discord通知 |
| ログイン時 | Buddyカードに表示 |

## 2.3 Discord通知フォーマット
```
⚠️ 【ネクストアクション確認】

📋 未設定: 2件
・ABC社（担当: 田中）
・DEF社（担当: 佐藤）

⏰ 2営業日超過: 3件
・GHI社（担当: 田中）3日経過
・JKL社（担当: 鈴木）4日経過
・MNO社（担当: 佐藤）5日経過

👉 本日中にネクストアクションを設定してください
```

## 2.4 Buddyの声かけ
```
🧔‍♂️ 田中くん、おはよう。

📋 確認したいことがあるんだけど、
ABC社とGHI社のネクストアクションがまだ決まってないみたい。

今日中に次のアクションを決められそう？
何か困ってることがあれば教えて。

[ 💬 相談する ]  [ ✅ 今日設定する ]
```

---

# 3. 滞留案件の検知

## 3.1 検知条件（ハイブリッド式）

| 経過日数 | 担当 | アクション |
|---------|------|-----------|
| 同一フェーズ3日以上 | Buddy | 声かけ |
| 同一フェーズ7日以上 | GAS | Discord通知 |

## 3.2 Buddyの声かけ（3日）
```
🧔‍♂️ 田中くん、ABC社の商談だけど、
「提案中」のまま3日経ってるみたい。

何か進展あった？
もし止まってるなら、何がボトルネックになってるか教えて。

[ 💬 相談する ]  [ ✅ フェーズ更新する ]
```

## 3.3 Discord通知（7日）
```
⚠️ 【滞留案件アラート】

以下の商談が7日以上同一フェーズで停滞しています。

📋 滞留案件: 2件
・ABC社（担当: 田中）「提案中」10日経過
・DEF社（担当: 佐藤）「見積中」8日経過

👉 商談フェーズの確認・更新をお願いします
```

---

# 4. アサイン後の対応開始確認

## 4.1 検知条件

| 条件 | 内容 |
|------|------|
| 対象 | アサインが決まったが対応開始していない案件 |
| 期限 | アサイン後の次のシフト日（営業日）中 |
| 検知 | 次のシフト日が終わっても対応なし |

## 4.2 シフト日を営業日として換算

```javascript
function getNextWorkDay(staffId, assignDate) {
  const shifts = getShiftSchedule(staffId);

  // アサイン日以降の最初のシフト日を取得
  for (let i = 1; i <= 7; i++) {
    const checkDate = addDays(assignDate, i);
    if (isShiftDay(staffId, checkDate, shifts)) {
      return checkDate;
    }
  }
  return null;
}
```

## 4.3 対応の定義

| 状態 | 判定 |
|------|------|
| 対応あり | 商談ステータスが「初回連絡」以降に変更 |
| 対応なし | 商談ステータスが「未対応」のまま |

## 4.4 表示・通知フロー
```
アサイン決定
    │
    ↓ 次のシフト日
タスクとしてダッシュボードに表示
    │
    ↓ その日中に対応なし
Buddyが介入（リマインド）
    │
    ↓ 翌営業日も対応なし
GASがDiscord通知
```

## 4.5 Buddyのリマインド
```
🧔‍♂️ 田中くん、

ABC社がアサインされてるんだけど、
まだ初回連絡ができてないみたい。

今日中に連絡できそう？
何か準備が必要なら教えて。

[ 💬 相談する ]  [ ✅ 今日連絡する ]
```

---

# 5. モチベーションアラート

## 5.1 検知条件

| レベル | 条件 | アクション |
|--------|------|-----------|
| 🟢 良好 | 70点以上 | 通常対応 |
| 🟡 注意 | 50-69点 | Buddyが寄り添い強化 |
| 🔴 要対応 | 50点未満 | オーナー/リーダーにDiscord通知 |
| ⚫ 緊急 | 30点未満 or 急激な低下（先週比-20以上） | 即時Discord通知 |

## 5.2 検知タイミング

| タイミング | 処理 |
|-----------|------|
| 週次（月曜） | モチベーションスコア算出 → アラートチェック |
| 対話時 | 感情分析 → 急激な変化を検知 |

## 5.3 Discord通知（要対応）
```
⚠️ 【モチベーションアラート】

担当者: 田中太郎
現在スコア: 45点（🔴 要対応）
先週比: -15

📝 最新の対話:
「最近うまくいかなくて...」

👉 1on1ミーティングを推奨します
```

## 5.4 Discord通知（緊急）
```
🚨 【緊急】モチベーション急低下

担当者: 田中太郎
現在スコア: 28点（⚫ 緊急）
先週比: -25（急激な低下）

📝 最新の対話:
「もう無理かもしれない...」

👉 至急対応をお願いします
```

## 5.5 Buddyの寄り添い強化（注意レベル）
```
🧔‍♂️ 田中くん、最近どう？

何か気になることとか、話したいことがあれば
いつでも聞くよ。

無理しすぎてない？

[ 💬 話を聞いてほしい ]  [ 大丈夫 ]
```

---

# 6. GAS実装

## 6.1 日次バッチ（毎日9:00）

```javascript
function dailyAlertBatch() {
  // 1. ネクストアクション未設定/超過チェック
  const nextActionAlerts = checkNextActionDates();

  // 2. 滞留案件チェック（7日以上）
  const stagnantAlerts = checkStagnantDeals(7);

  // 3. アサイン後未対応チェック
  const unhandledAlerts = checkUnhandledAssignments();

  // 4. Discord通知
  if (nextActionAlerts.length > 0) {
    sendNextActionAlert(nextActionAlerts);
  }
  if (stagnantAlerts.length > 0) {
    sendStagnantDealAlert(stagnantAlerts);
  }
  if (unhandledAlerts.length > 0) {
    sendUnhandledAssignmentAlert(unhandledAlerts);
  }
}
```

## 6.2 週次バッチ（毎週月曜9:00）

```javascript
function weeklyAlertBatch() {
  // 1. モチベーションスコア算出
  const staffList = getAllActiveStaff();

  staffList.forEach(staff => {
    const score = calculateMotivationScore(staff.id);
    saveMotivationLog(staff.id, score);

    // 2. アラートチェック
    if (score.total < 30 || score.weeklyChange < -20) {
      sendUrgentMotivationAlert(staff, score);
    } else if (score.total < 50) {
      sendMotivationAlert(staff, score);
    }
  });
}
```

## 6.3 トリガー設定

| トリガー | 関数 | 時間 |
|---------|------|------|
| 時間主導 | dailyAlertBatch | 毎日9:00 |
| 時間主導 | weeklyAlertBatch | 毎週月曜9:00 |
| 時間主導 | checkInactiveUsers | 1時間ごと |

---

# 7. スクリプトプロパティ

| プロパティ名 | 用途 |
|-------------|------|
| DISCORD_ALERT_WEBHOOK | アラート通知用Webhook |
| GEMINI_API_KEY | Gemini API用 |

---

# 8. 更新履歴

| 日付 | バージョン | 更新内容 |
|------|-----------|----------|
| 2026-01-11 | 1.0 | 初版作成 |
