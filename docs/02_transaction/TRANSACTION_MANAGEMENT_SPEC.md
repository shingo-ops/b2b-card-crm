# 取引管理システム仕様書

## 最終更新: 2026-01-12
## バージョン: 1.0
## ステータス: 棚卸し完了、設計待ち

---

# 1. 概要

## 1.1 スプレッドシート情報

| 項目 | 内容 |
|------|------|
| 実際のシート名 | 取引管理シートver4.1 (test) |
| スプレッドシートID | 18GWuJ7lD-S_lL7fefWdKa7HMlOsBmMeHgRP36lvSQMk |
| URL | https://docs.google.com/spreadsheets/d/18GWuJ7lD-S_lL7fefWdKa7HMlOsBmMeHgRP36lvSQMk/edit |
| シート数 | 31 |

## 1.2 用途

- 請求書作成・管理
- 売上データ管理
- 在庫管理
- 送料計算（FedEx/DHL/UPS）
- 仕入れ管理
- 顧客マスタ管理

---

# 2. シート構成

## 2.1 シート一覧

| # | シート名 | gid | データ行数 | 列数 | 用途 |
|---|---------|-----|-----------|-----|------|
| 1 | 📝請求書作成 | 1761617187 | 157行 | 30列 | 請求書作成・管理 |
| 2 | 📊売上データ | 600397303 | 896行 | 156列 | **メイン取引データ（特殊構造）** |
| 3 | Stock List | 1186337887 | 179行 | 15列 | 在庫リスト（英語版） |
| 4 | 📦在庫 | 2036676823 | 997行 | 12列 | 在庫管理 |
| 5 | M_Product | 548021217 | 204行 | 15列 | 商品マスタ |
| 6 | M_Customer | 884228295 | 52行 | 40列 | 顧客マスタ |
| 7 | M_仕入元 | 580576840 | 45行 | 10列 | 仕入元マスタ |
| 8 | FedEx_ShippingRates | 264167304 | 1889行 | 24列 | FedEx送料テーブル |
| 9 | DHL_ShippingRates | 1214726714 | 3286行 | 11列 | DHL送料テーブル |
| 10 | UPS_ShippingRates | 1195813452 | 3192行 | 25列 | UPS送料テーブル |
| 11 | M_Zones | 833993881 | 623行 | 5列 | 配送ゾーンマスタ |
| 12 | ImportLog | 185207178 | 5行 | 5列 | インポートログ |
| 13 | フォーマット | 74688869 | 47行 | 8列 | 各種フォーマット定義 |
| 14 | Commercial Invoice | 645231413 | 58行 | 18列 | 通関用インボイス |
| 15 | Copy of Commercial Invoice | 193920841 | 58行 | 18列 | インボイスコピー |
| 16 | ⚙️設定 | 1159512127 | 30行 | 48列 | システム設定 |
| 17 | 📋仕入れリスト | 1123262060 | 912行 | 28列 | 仕入れ管理 |
| 18 | 出力 | 1244714431 | 297行 | 14列 | データ出力用 |
| 19 | 🗃️古物台帳 | 1079795576 | 0行 | - | 古物営業法対応（未使用） |
| 20 | 90_SystemAgents | 1741619298 | 7行 | 4列 | システムエージェント設定 |
| 21 | 91_SystemSpecs | 1191312353 | 0行 | 4列 | システム仕様（未使用） |
| 22 | 99_Changelog | 592347949 | 0行 | 4列 | 変更履歴（未使用） |
| 23 | raw_顧客回答 | 856212204 | 3行 | 22列 | 顧客回答データ |
| 24 | 📤発送通知 | 1555931377 | 1行 | 2列 | 発送通知 |
| 25 | 発送通知作業用 | 1739041503 | 6行 | 6列 | 発送通知作業 |
| 26 | 仕様書 | 1565134403 | 73行 | 9列 | システム仕様書 |
| 27 | ここから保留のシート→→ | 1367594053 | 0行 | - | セパレータ |
| 28 | 📊月別担当者別集計 | 861733982 | 0行 | 4列 | 月別集計（未使用） |
| 29 | 月次売上表 | 425495761 | 0行 | - | 月次売上（未使用） |
| 30 | レビュー依頼 | 782459864 | 3行 | 2列 | レビュー依頼管理 |
| 31 | 📤メッセージ | 449357575 | 12行 | 12列 | メッセージテンプレート |

## 2.2 シート分類

| カテゴリ | シート |
|---------|--------|
| メインデータ | 📊売上データ、📝請求書作成、📋仕入れリスト |
| 在庫 | 📦在庫、Stock List |
| マスタ | M_Product、M_Customer、M_仕入元、M_Zones |
| 送料テーブル | FedEx_ShippingRates、DHL_ShippingRates、UPS_ShippingRates |
| 帳票 | Commercial Invoice、フォーマット |
| システム | ⚙️設定、90_SystemAgents、91_SystemSpecs、99_Changelog |
| 通知 | 📤発送通知、📤メッセージ、発送通知作業用 |
| 未使用/保留 | 🗃️古物台帳、月次売上表、📊月別担当者別集計 |

---

# 3. 特殊構造シート: 📊売上データ

## 3.1 構造概要

| 項目 | 内容 |
|------|------|
| gid | 600397303 |
| データ行数 | 896行 |
| 列数 | 156列 |
| 表示ヘッダー | 6行目 |
| GAS用ヘッダー | 4行目（プレフィックス付き） |

## 3.2 行構造

| 行 | 内容 |
|----|------|
| 1行目 | 記入期間ラベル |
| 2行目 | 期間表示「【2025年1月1日 〜 2025年12月31日】」 |
| 3行目 | （空白または補助情報） |
| **4行目** | **GAS用ヘッダー（プレフィックス付き）** |
| 5行目 | （空白または補助情報） |
| **6行目** | **表示用ヘッダー（人間用）** |
| 7行目以降 | データ行 |

## 3.3 フェーズ構造

| フェーズ | プレフィックス | 列範囲 | 列数 | 内容 |
|---------|---------------|--------|-----|------|
| 取引状況 | 取引状況 | A-Z | 26列 | ステータス、担当者、取引先、商品、請求書、支払い |
| 発送情報 | 発送情報 | AA-CG | 59列 | 顧客情報、住所、梱包、ラベル、Ship&Co連携 |
| 仕入れ情報 | 仕入れ情報 | CH-CT | 13列 | 仕入れ担当、仕入元、金額、送り状 |
| 予約販売情報 | 予約販売情報 | CU-DE | 11列 | 予約請求書、発売日、デポジット |
| トラブル情報 | トラブル情報 | DF-DS | 14列 | トラブル対応、返金、返送 |
| 売上情報 | 売上情報 | DT-EZ | 33列 | 売上高、原価、利益、各種手数料 |

## 3.4 主要ヘッダー（4行目 / 6行目）

### 取引状況フェーズ

| 4行目（GAS用） | 6行目（表示用） |
|---------------|----------------|
| 取引状況ステータス | ステータス |
| 取引状況トラブル | トラブル |
| 取引状況コメント | コメント |
| 取引状況受注担当者 | 受注担当者 |
| 取引状況営業担当者 | 営業担当者 |
| 取引状況取引先名 | 取引先名 |
| 取引状況カテゴリ | カテゴリ |
| 取引状況商品名 | 商品名 |
| 取引状況状態 | 状態 |
| 取引状況請求書内容 | 請求書内容 |
| 取引状況数量 | 数量 |
| 取引状況請求書番号 | 請求書番号 |
| 取引状況請求書リンク | 請求書リンク |
| 取引状況合計 | 合計 |
| 取引状況単価 | 単価 |
| 取引状況関税 | 関税 |
| 取引状況送料 | 送料 |
| 取引状況決済 | 決済 |
| 取引状況通貨 | 通貨 |
| 取引状況KEY | KEY |
| 取引状況支払い名義 | 支払い名義 |
| 取引状況請求書発行日 | 請求書発行日 |
| 取引状況支払期日 | 支払期日 |
| 取引状況支払確認日 | 支払確認日 |
| 取引状況為替レート | 為替レート |
| 取引状況為替手数料 | 為替手数料 |

### 発送情報フェーズ（主要項目）

| 4行目（GAS用） | 6行目（表示用） |
|---------------|----------------|
| 発送情報顧客ID | 顧客ID |
| 発送情報受取人氏名 | 受取人氏名 |
| 発送情報電話番号 | 電話番号 |
| 発送情報メールアドレス | メールアドレス |
| 発送情報住所1 | 住所1 |
| 発送情報都市名 | 都市名 |
| 発送情報国名 | 国名 |
| 発送情報重量(g) | 重量(g) |
| 発送情報運送状番号 | 運送状番号 |

### 売上情報フェーズ（主要項目）

| 4行目（GAS用） | 6行目（表示用） |
|---------------|----------------|
| 売上情報売上高 | 売上高 |
| 売上情報仕入れ費用 | 仕入れ費用 |
| 売上情報売上原価 | 売上原価 |
| 売上情報売上総利益 | 売上総利益 |
| 売上情報営業利益 | 営業利益 |
| 売上情報営業利益率 | 営業利益率 |

## 3.5 GASでの参照方法

```javascript
// 4行目を取得してオブジェクト変換
const sheet = SpreadsheetApp.openById('18GWuJ7lD-S_lL7fefWdKa7HMlOsBmMeHgRP36lvSQMk')
  .getSheetByName('📊売上データ');
const lastColumn = sheet.getLastColumn();
const lastRow = sheet.getLastRow();

// ヘッダー取得（4行目）
const headers = sheet.getRange(4, 1, 1, lastColumn).getValues()[0];

// データ取得（7行目以降）
const dataRows = sheet.getRange(7, 1, lastRow - 6, lastColumn).getValues();

// プレフィックスでフェーズを判定
function getPhase(headerName) {
  if (headerName.startsWith('取引状況')) return 'transaction';
  if (headerName.startsWith('発送情報')) return 'shipping';
  if (headerName.startsWith('仕入れ情報')) return 'procurement';
  if (headerName.startsWith('予約販売情報')) return 'preorder';
  if (headerName.startsWith('トラブル情報')) return 'trouble';
  if (headerName.startsWith('売上情報')) return 'sales';
  return 'other';
}

// ヘッダーからプレフィックスを除去して表示名を取得
function getDisplayName(headerName) {
  const phases = ['取引状況', '発送情報', '仕入れ情報', '予約販売情報', 'トラブル情報', '売上情報'];
  for (const phase of phases) {
    if (headerName.startsWith(phase)) {
      return headerName.substring(phase.length);
    }
  }
  return headerName;
}
```

---

# 4. 既存GAS機能

⚠️ バインドスクリプトの詳細は、スプレッドシートを開いて「拡張機能」→「Apps Script」で確認してください。

## 4.1 推定される機能（シート構成から）

| 機能 | 根拠 |
|------|------|
| 請求書作成 | 📝請求書作成シート、Commercial Invoiceシート |
| 発送通知 | 📤発送通知シート、発送通知作業用シート |
| メッセージテンプレート | 📤メッセージシート |
| 送料計算 | FedEx/DHL/UPS_ShippingRatesシート |
| インポート | ImportLogシート |

---

# 5. CRMとの連携ポイント

| CRMの項目 | 取引管理の項目 | 連携方法 |
|----------|---------------|---------|
| 成約時 | 📊売上データ | 成約時に取引レコード作成 |
| 顧客情報 | M_Customer | 顧客ID紐付け |
| 商談中の在庫確認 | 📦在庫 | リアルタイム参照 |
| 見積もり | 送料テーブル | 送料計算API |

---

# 6. アプリ化の優先順位（案）

| 優先度 | 機能 | 理由 |
|--------|------|------|
| 🔴 高 | 請求書作成 | 日常業務で頻繁に使用 |
| 🔴 高 | 在庫確認 | 商談中に即座に確認したい |
| 🔴 高 | 送料計算 | 見積もり時に必要 |
| 🟡 中 | 売上データ参照 | レポート・分析に使用 |
| 🟡 中 | 発送通知 | 効率化の余地あり |
| 🟢 低 | 仕入れ管理 | 現状で運用可能 |
| 🟢 低 | 古物台帳 | 法的要件だが頻度低 |

---

# 7. 注意事項

1. **📊売上データの特殊構造**
   - データ取得時は **7行目以降** を対象とする
   - ヘッダーマッピングは **4行目** を使用（プレフィックス付き）
   - 表示用ヘッダーは **6行目**（プレフィックスなし）

2. **大容量シート**
   - 送料テーブルは合計8,000行以上
   - パフォーマンスに注意

3. **マスタテーブル**
   - `M_` プレフィックスはマスタデータを示す
   - 変更時は影響範囲を確認

---

# 8. 更新履歴

| 日付 | バージョン | 更新内容 |
|------|-----------|----------|
| 2026-01-12 | 1.0 | 初版作成（棚卸し結果） |
