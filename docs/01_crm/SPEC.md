# CRM ダッシュボード 詳細仕様書

## 最終更新: 2026-01-10
## バージョン: 1.0
## ステータス: Phase 1 実装完了

---

# 1. システム概要

## 1.1 目的

B2B営業（トレーディングカード輸出）のリード管理から商談成約までを一元管理するCRMシステム。

## 1.2 解決する課題

| 課題 | 解決策 |
|------|--------|
| インバウンド/アウトバウンドが別管理 | 統合スプレッドシート + リード種別で区別 |
| アサイン漏れ | Discord通知で即座に担当者へ連絡 |
| フォローアップ漏れ | 48時間リマインド自動通知 |
| 見込み客の優先順位が不明確 | 見込度自動計算（A〜確定C） |
| 成約/失注データの埋もれ | 自動アーカイブで整理 |

## 1.3 技術スタック

| 項目 | 技術 |
|------|------|
| フロントエンド | HTML/CSS/JavaScript（GAS Webアプリ） |
| バックエンド | Google Apps Script |
| データベース | Google スプレッドシート |
| 認証 | Googleアカウント認証 |
| 通知 | Discord Webhook |
| ランニングコスト | 0円 |

---

# 2. スプレッドシート構成

## 2.1 基本情報

| 項目 | 値 |
|------|-----|
| スプレッドシートID | `1kF-o4jCrbQePktWaFEBvWhJJjRXhkuw5-AcISa4ClAk` |
| Script ID | `1CQiLiFG8N77uYzlo3UNgAwml9_8mAJYAmfe4thp3RGsvbiwoaS-kS7X0` |
| URL | https://docs.google.com/spreadsheets/d/1kF-o4jCrbQePktWaFEBvWhJJjRXhkuw5-AcISa4ClAk/edit?authuser=0 |

## 2.2 シート構成（14シート）

```
CRMスプレッドシート
│
├─ 【リード管理】
│   ├── リード一覧（IN）       ← インバウンドのアサイン前
│   └── リード一覧（OUT）      ← アウトバウンドのアサイン前
│
├─ 【商談管理】
│   ├── 商談管理               ← アサイン後（IN/OUT統合）
│   ├── アーカイブ             ← 成約/失注した商談
│   ├── 商談レポート           ← 商談結果レポート保存先
│   └── 会話ログ（商談用）     ← 商談の会話記録
│
├─ 【AI機能】
│   └── Buddy対話ログ          ← AIコーチ対話履歴
│
├─ 【マスタ・設定】
│   ├── 担当者マスタ           ← 営業担当者情報
│   ├── 設定                   ← 入力規則、プルダウン選択肢
│   ├── 権限設定               ← 役割別権限マトリクス
│   ├── 目標設定               ← KPI目標管理
│   └── 通知設定               ← Discord Webhook設定
│
├─ 【その他】
│   ├── ダッシュボード         ← 分析用（Phase 2）
│   └── テンプレート           ← メッセージテンプレート
```

## 2.3 データフロー

```
[新規問い合わせ]
       ↓
┌──────────────────┐
│ リード一覧（IN）  │ ← インバウンド（Instagram, Email等）
│ リード一覧（OUT） │ ← アウトバウンド（営業からアプローチ）
└──────────────────┘
       ↓ 担当者アサイン + 「アサイン待ち」
       ↓ → Discord通知（NSASSIGN_DISCORDWEBHOOK）
┌──────────────────┐
│    商談管理       │ ← リード種別（IN/OUT）で区別
└──────────────────┘
       ↓ 48時間更新なし
       ↓ → Discord通知（NSREMIND_DISCORDWEBHOOK）
       ↓
       ↓ ステータス「成約」or「失注」
       ↓
┌──────────────────┐
│   アーカイブ      │
└──────────────────┘
```

---

# 3. 列構成詳細

## 3.1 リード一覧（IN/OUT）共通 - 22列

| 列 | 列名 | 入力者 | 説明 |
|----|------|--------|------|
| A | リードID | 自動 | LD-00001形式 |
| B | 登録日 | 自動 | リード作成日 |
| C | 流入経路 | CS | Instagram DM, Email等 |
| D | 会社名 | CS | 顧客の会社名 |
| E | 顧客名 | CS | 担当者名 |
| F | 呼び方（英語） | CS | テンプレート用（例: John） |
| G | 国 | CS | USA, UK等 |
| H | メール | CS | 連絡先 |
| I | 電話番号 | CS | 連絡先 |
| J | SNS/連絡手段 | CS | Discord, Instagram等 |
| K | メッセージURL | CS | やり取りのURL |
| L | 初回接触日 | CS | 最初に連絡した日 |
| M | 温度感 | CS | 高/中/低 |
| N | 想定規模 | CS | 大口/中規模/小口/不明 |
| O | 顧客タイプ | CS | 信頼重視/価格重視/不明 |
| P | 返信速度 | CS | 24h以内/48h以内/3日以上/未返信 |
| Q | 見込度 | 自動 | A/B+/B/B-/仮C/確定C |
| R | 備考 | CS | 自由記入 |
| S | 担当者 | CS | アサイン先（プルダウン） |
| T | 担当者ID | 自動 | Discord ID（自動入力） |
| U | 進捗 | CS | 未対応/連絡中/ヒアリング中/アサイン待ち/対象外 |
| V | シート更新日 | 自動 | 最終編集日時 |

## 3.2 商談管理 - 37列

| 列 | 列名 | 入力者 | 説明 |
|----|------|--------|------|
| A | リードID | 継承 | リード一覧から |
| B | リード種別 | 自動 | インバウンド/アウトバウンド |
| C | アサイン日 | 自動 | 商談管理に移行した日 |
| D-V | （リード情報） | 継承 | リード一覧の列を継承 |
| W | 商談ステータス | 営業 | 初回連絡/提案中/見積中/クロージング/成約/失注/保留 |
| X | 次回アクション | 営業 | 次にやること |
| Y | 次回アクション日 | 営業 | 期限 |
| Z | 商談メモ | 営業 | 進捗記録 |
| AA | 相手の課題 | 営業 | ヒアリング内容 |
| AB | 取り扱いタイトル | 営業 | Pokemon, One Piece等 |
| AC | 販売形態 | 営業 | 実店舗/EC/ライブ配信/複合/不明 |
| AD | 月間見込み金額 | 営業 | 予想月商 |
| AE | 初回取引日 | 営業 | 成約日 |
| AF | 初回取引金額 | 営業 | 成約金額 |
| AG | 累計取引金額 | 自動 | 合計金額 |
| AH | 競合比較中 | 営業 | はい/いいえ/不明 |
| AI | 通知確認 | 自動 | Discord送信結果 |
| AJ | シート更新日 | 自動 | 最終編集日時 |
| AK | 備考2 | 営業 | 追加備考 |

## 3.3 アーカイブ - 39列

商談管理の全列 + 以下2列：

| 列 | 列名 | 入力者 | 説明 |
|----|------|--------|------|
| AL | アーカイブ日 | 自動 | アーカイブした日 |
| AM | アーカイブ理由 | 自動 | 成約/失注/手動アーカイブ |

## 3.4 担当者マスタ - 8列

| 列 | 列名 | 説明 |
|----|------|------|
| A | 担当者ID | EMP-001形式 |
| B | 氏名（日本語） | 田中太郎 |
| C | 氏名（英語） | Taro Tanaka（テンプレート用） |
| D | メール | 連絡先 |
| E | Discord ID | 通知用（18桁の数字） |
| F | 役割 | CS/営業/管理者 |
| G | ステータス | 有効/無効 |
| H | 元候補者ID | 採用診断との連携用 |

---

# 4. 自動化機能

## 4.1 アサイン移行（AssignService.gs）

### トリガー
- **手動実行**：カスタムメニュー「🎯 CRM」→「➡️ アサイン移行」

### 実行条件
- リード一覧（IN）またはリード一覧（OUT）シートで実行
- 「担当者」列と「担当者ID」列が両方入力済み
- 「進捗」列が「アサイン待ち」

### 処理内容
1. 対象行を抽出
2. 商談管理シートに行を追加
   - 「リード種別」を自動設定（インバウンド/アウトバウンド）
   - 「アサイン日」を自動設定（当日）
   - 「商談ステータス」を「初回連絡」に設定
3. 元シートから行を削除
4. Discord通知を送信

### Discord通知フォーマット
```
@担当者
📥 新規アサイン
**顧客名** 様（LD-00001）が担当になりました。
商談管理シートをご確認ください。
```

## 4.2 48時間リマインド（ReminderService.gs）

### トリガー
- **時間主導**：1時間ごとに自動実行

### 実行条件
- 商談管理シートの商談
- 商談ステータスが「初回連絡」「提案中」「見積中」「クロージング」
- シート更新日から48時間経過

### Discord通知フォーマット
```
@担当者
⏰ リマインド
**顧客名** 様（LD-00001）の商談が「提案中」のまま48時間経過しています。
状況を確認して対応をお願いします🤲
```

## 4.3 見込度自動計算（ProspectRank.gs）

### トリガー
- **onEdit**：温度感/想定規模/顧客タイプ/返信速度/月間見込み金額の編集時

### 判定ロジック

#### C条件（1つでもあれば減点）
- 返信速度が「3日以上」または「未返信」
- 想定規模が「小口」
- 月間見込み金額が10万円未満
- 顧客タイプが「価格重視」かつ温度感が「低」

#### 判定マトリクス
| ランク | 条件 | 対応方針 |
|--------|------|----------|
| **A** | 信頼重視 + 大口 + 24h以内 | 最優先対応 |
| **B+** | 価格重視 + 大口 + 24h以内 | 価値訴求で転換 |
| **B+** | 信頼重視 + 大口 + 返信遅め | 優先対応 |
| **B** | 信頼重視 + 中規模/小口 | 通常対応 |
| **B-** | 価格重視 + 中規模/小口 | テスト取引提案 |
| **仮C** | 不明要素あり or C条件1-2個 | 追加ヒアリング |
| **確定C** | C条件3個以上 | お断りテンプレート |

## 4.4 自動アーカイブ（ArchiveService.gs）

### トリガー
- **onEdit**：商談ステータスが「成約」または「失注」に変更時

### 処理内容
1. 商談管理の行データを取得
2. アーカイブシートに追加
   - 「アーカイブ日」を自動設定
   - 「アーカイブ理由」を設定（成約/失注）
3. 商談管理から行を削除
4. トースト通知を表示

### 手動アーカイブ
- カスタムメニュー「📦 選択行をアーカイブ」で任意の行をアーカイブ可能
- アーカイブ理由は「手動アーカイブ」

### アーカイブから復元
- カスタムメニュー「♻️ アーカイブから復元」で商談管理に戻す
- 商談ステータスは「保留」にリセット

## 4.5 シート更新日自動記録（Triggers.gs）

### トリガー
- **onEdit**：対象シートの任意のセル編集時

### 対象シート
- リード一覧（IN）
- リード一覧（OUT）
- 商談管理

### 処理内容
- 編集された行の「シート更新日」列に現在日時を自動入力
- 更新日列自体の編集は無視（無限ループ防止）

## 4.6 担当者ID自動入力（Triggers.gs）

### トリガー
- **onEdit**：「担当者」列の編集時

### 対象シート
- リード一覧（IN）
- リード一覧（OUT）

### 処理内容
1. 担当者名から担当者マスタを検索
2. 該当するDiscord IDを「担当者ID」列に自動入力

---

# 5. Discord Webhook設定

## 5.1 スクリプトプロパティ

| プロパティ名 | 用途 | 送信タイミング |
|-------------|------|---------------|
| **NSASSIGN_DISCORDWEBHOOK** | アサイン通知 | リード→商談移行時 |
| **NSREMIND_DISCORDWEBHOOK** | リマインド通知 | 48時間更新なし時（1時間ごとチェック） |

## 5.2 推奨チャンネル構成

```
Discord サーバー
├── #crm-アサイン    ← NSASSIGN_DISCORDWEBHOOK
└── #crm-リマインド  ← NSREMIND_DISCORDWEBHOOK
```

---

# 6. Webアプリ

## 6.1 デプロイ情報

| 環境 | Deployment ID |
|------|---------------|
| 本番 | AKfycby0KA0YQU67azLGSrnLLzWTnh1tf2SObBg4-6FaRC5esAF5IdZbqShr3LHlsJbdHkmlVw |
| テスト | AKfycbwGUUcdUs_L-a4c9Ux9PBPuX9X6t5YMGVnlInL5RGOq63a2QfaJUgIbNdV4ylcN0Xou2g |

## 6.2 URL

| 環境 | URL |
|------|-----|
| 本番 | https://script.google.com/macros/s/AKfycby0KA0YQU67azLGSrnLLzWTnh1tf2SObBg4-6FaRC5esAF5IdZbqShr3LHlsJbdHkmlVw/exec?authuser=0 |
| テスト | https://script.google.com/macros/s/AKfycbwGUUcdUs_L-a4c9Ux9PBPuX9X6t5YMGVnlInL5RGOq63a2QfaJUgIbNdV4ylcN0Xou2g/exec?authuser=0 |

## 6.3 ページ構成

| ページ | パラメータ | 機能 |
|--------|-----------|------|
| ダッシュボード | `?page=dashboard` | KPI表示、ステータス別集計 |
| リード（IN） | `?page=leads-in` | インバウンドリード一覧・追加 |
| リード（OUT） | `?page=leads-out` | アウトバウンドリード一覧・追加 |
| 商談管理 | `?page=deals` | 商談一覧・フィルター |
| 担当者管理 | `?page=staff` | 担当者一覧表示 |

---

# 7. カスタムメニュー

スプレッドシートの「🎯 CRM」メニュー：

```
🎯 CRM
├── 📋 初期設定              → initializeSpreadsheet()
├── ─────────────────
├── ➡️ アサイン移行          → menuRunAssignMigration()
├── ─────────────────
├── 📦 選択行をアーカイブ     → manualArchive()
├── ♻️ アーカイブから復元     → restoreFromArchive()
├── ─────────────────
├── 🔄 見込度を再計算（全件） → recalculateAllProspectRanks()
├── ─────────────────
├── ⚙️ 設定
│   ├── 🕐 トリガー設定      → setupTriggers()
│   ├── 🗑️ トリガー削除      → removeTriggers()
│   └── 📜 トリガー一覧      → listTriggers()
├── ─────────────────
└── 🌐 Webアプリを開く       → openWebApp()
```

---

# 8. ファイル構成

```
crm-dashboard/
├── .clasp.json          # clasp設定（Script ID）
├── appsscript.json      # GASプロジェクト設定
│
├── Code.gs              # メインエントリーポイント
│                        # - onOpen()：カスタムメニュー
│                        # - addNewLead()：リード追加
│                        # - updateLead()：リード更新
│                        # - getLeads()：リード取得
│                        # - getStaffList()：担当者取得
│
├── Config.gs            # 設定・定数
│                        # - CONFIG：シート名、閾値等
│                        # - DROPDOWN_OPTIONS：プルダウン選択肢
│                        # - HEADERS：ヘッダー定義
│                        # - getDiscordWebhook()
│                        # - getRemindWebhook()
│
├── SheetService.gs      # スプレッドシート操作
│                        # - initializeSpreadsheet()：初期設定
│                        # - createSheets()：シート作成
│                        # - setHeaders()：ヘッダー設定
│                        # - setDataValidations()：入力規則
│                        # - generateNextLeadId()：ID生成
│
├── AssignService.gs     # アサイン移行
│                        # - runAssignMigration()：移行実行
│                        # - buildDealsRow()：商談行構築
│                        # - sendAssignNotification()：Discord通知
│
├── ReminderService.gs   # リマインド通知
│                        # - checkAndRemind()：48時間チェック
│                        # - sendRemindNotification()：Discord通知
│                        # - checkActionDateRemind()：アクション日通知（Phase 2）
│
├── ProspectRank.gs      # 見込度計算
│                        # - calculateProspectRank()：判定ロジック
│                        # - updateProspectRankOnEdit()：編集時更新
│                        # - recalculateAllProspectRanks()：全件再計算
│
├── ArchiveService.gs    # アーカイブ
│                        # - archiveOnStatusChange()：自動アーカイブ
│                        # - buildArchiveRow()：アーカイブ行構築
│                        # - manualArchive()：手動アーカイブ
│                        # - restoreFromArchive()：復元
│
├── Triggers.gs          # トリガー管理
│                        # - onEditTrigger()：編集時処理
│                        # - updateSheetTimestamp()：更新日記録
│                        # - autoFillStaffId()：担当者ID自動入力
│                        # - setupTriggers()：トリガー設定
│
├── WebApp.gs            # Webアプリ
│                        # - doGet()：ページ表示
│                        # - doPost()：API処理
│                        # - getDashboardKPIs()：KPI取得
│
└── html/
    ├── index.html       # ダッシュボード
    ├── leads.html       # リード一覧（IN/OUT共通）
    ├── deals.html       # 商談管理
    ├── staff.html       # 担当者管理
    └── css/
        └── style.html   # スタイルシート
```

---

# 9. 入力規則（プルダウン）

## 9.1 リード関連

| 項目 | 選択肢 |
|------|--------|
| 流入経路 | Instagram DM, Facebook, WhatsApp, Email, Discord, 紹介, 展示会, その他 |
| 国 | USA, Canada, UK, Germany, France, Australia, Philippines, Thailand, Malaysia, Singapore, Indonesia, Hong Kong, Taiwan, Korea, China, その他 |
| 温度感 | 高, 中, 低 |
| 想定規模 | 大口, 中規模, 小口, 不明 |
| 顧客タイプ | 信頼重視, 価格重視, 不明 |
| 返信速度 | 24h以内, 48h以内, 3日以上, 未返信 |
| 進捗 | 未対応, 連絡中, ヒアリング中, アサイン待ち, 対象外 |

## 9.2 商談関連

| 項目 | 選択肢 |
|------|--------|
| 商談ステータス | 初回連絡, 提案中, 見積中, クロージング, 成約, 失注, 保留 |
| 取り扱いタイトル | Pokemon, One Piece, Yu-Gi-Oh, Dragon Ball, Weiss Schwarz, 複数, その他 |
| 販売形態 | 実店舗, EC, ライブ配信, 複合, 不明 |
| 競合比較中 | はい, いいえ, 不明 |

## 9.3 担当者関連

| 項目 | 選択肢 |
|------|--------|
| 役割 | CS, 営業, 管理者 |
| ステータス | 有効, 無効 |

---

# 10. トリガー一覧

| 関数名 | 種類 | タイミング |
|--------|------|-----------|
| onEditTrigger | インストーラブル onEdit | セル編集時 |
| checkAndRemind | 時間主導 | 1時間ごと |

---

# 11. 今後の実装予定

## Phase 2（運用開始後）

| 機能 | 説明 |
|------|------|
| テンプレート自動生成 | [Name], [Your Name]を自動置換 |
| 次回アクション日リマインド | 期限当日の朝に通知 |
| ダッシュボード強化 | グラフ表示、期間フィルター |

## Phase 3（データ蓄積後）

| 機能 | 説明 |
|------|------|
| 週次レポート自動生成 | 毎週月曜にDiscord投稿 |
| 重複チェック | 同じメール/会社名でアラート |
| 会話ログDB連携 | 顧客との会話履歴表示 |

---

# 12. 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| COMMON_RULES.md | 親プロジェクト共通ルール |
| CRM_PROJECT_MASTER.md | CRMプロジェクトマスター |
| README.md | セットアップ手順 |

---

# 更新履歴

| 日付 | バージョン | 更新内容 |
|------|-----------|----------|
| 2026-01-10 | 1.0 | 初版作成。Phase 1 実装完了 |
