# トラブルシューティングガイド

## 概要
GAS Web アプリケーション開発で発生しやすい問題と解決策をまとめたドキュメントです。

## よくある問題

### 1. Web アプリが真っ白になる

**症状**: ページを開くと何も表示されない

**原因と解決策**:
1. **HTMLファイルのパス問題**
   - GASは相対パスを認識しない場合がある
   - `HtmlService.createTemplateFromFile('ファイル名')` でファイル名のみ指定

2. **JavaScript エラー**
   - ブラウザの開発者ツール（F12）でコンソールを確認
   - `google.script.run` の呼び出しが正しいか確認

3. **サーバーサイド関数が存在しない**
   - 呼び出している関数がGASに定義されているか確認

### 2. ナビゲーションが動作しない

**症状**: リンクをクリックしても画面遷移しない

**原因と解決策**:
1. **相対URL問題**
   - GAS iframe内では相対URLが無効になる場合がある
   - 絶対URLを使用するか、SPA化を検討

2. **SPA化の推奨**
   - ページ遷移をJavaScriptで制御
   - データはキャッシュして再利用

### 3. デプロイ後に変更が反映されない

**症状**: コードを更新してもWebアプリに反映されない

**原因と解決策**:
1. **デプロイIDの確認**
   - `clasp deploy --deploymentId <ID>` で既存デプロイを更新
   - 新規デプロイだとURLが変わる

2. **キャッシュのクリア**
   - ブラウザのキャッシュをクリア
   - シークレットモードでテスト

### 4. 権限エラー

**症状**: 「承認が必要です」エラー

**原因と解決策**:
1. **スクリプトの再承認**
   - GASエディタから関数を手動実行
   - 承認ダイアログで許可

2. **appsscript.json の確認**
   - 必要なスコープが設定されているか確認

## clasp コマンド

```bash
# ログイン
clasp login

# プッシュ
clasp push --force

# デプロイ更新
clasp deploy --deploymentId <ID> --description "説明"

# デプロイ一覧
clasp deployments
```

---

## [2026-01-11] 仕様と異なる実装が発生（PMO通知システム）

### 発生プロジェクト
PMO通知システム

### 症状
当初の仕様では「スプレッドシートで通知設定を管理」だったが、スタンドアロンスクリプトが作成された

### 原因
1. CLAUDE.mdを読み込まずに作業を開始した
2. 実装前の仕様確認プロセスがなかった
3. 禁止事項（スタンドアロン禁止）が守られなかった

### 解決策
1. CLAUDE.mdに「実装前宣言」ルールを追加
2. 「完了報告テンプレート」で仕様照合チェックを義務化
3. 禁止事項を強化・明確化
4. 作業依頼テンプレートでCLAUDE.md読み込みを強制

### 横展開
全プロジェクトで適用必須
- 作業開始時は必ずCLAUDE.mdを読む
- 実装前に仕様宣言して承認を得る
- スタンドアロンスクリプトは絶対禁止

### 教訓
「ルールを作る」と「ルールが守られる」は別。ルールを守らせる仕組みが必要。

#横展開候補

---

## [2026-01-11] デプロイID混乱・本番に反映されない

### 発生プロジェクト
CRMダッシュボード

### 症状
clasp push & deploy を実行したが、本番URLでアクセスしても最新コードが反映されない

### 原因
1. `clasp deploy` を引数なしで実行 → 新しいデプロイIDが作成された
2. 複数のデプロイIDが乱立（@12〜@20）
3. どれが本番かわからなくなった

### 解決策
1. 本番用デプロイIDを1つに確定（@20）
2. テスト用は@HEADを使用
3. 古いデプロイ（@12〜@19）を削除
4. ドキュメント（CLAUDE.md、COMMON_RULES.md、CRM_PROJECT_MASTER.md）を更新

### 再発防止
- デプロイルールを「不変のルール」として確定
- 引数なしの `clasp deploy` を禁止
- 新規アプリ追加時も同じルールを適用
- 議論フレームワークで承認されない限りルール変更禁止

### 横展開
全プロジェクトで適用必須

#横展開候補

---

---

## [2026-01-12] google.script.run が null を返す（Date シリアライズ問題）

### 発生プロジェクト
CRMダッシュボード

### 症状
- `getLeads()` をブラウザから呼び出すと `null` が返る
- GASエディタで直接実行すると正常に動作する
- `withSuccessHandler` は呼ばれるが、data が null

### 原因
1. スプレッドシートの `getValues()` は日付セルを JavaScript `Date` オブジェクトで返す
2. `Date` オブジェクトを含む配列を `google.script.run` で返すとシリアライズに失敗する場合がある
3. シリアライズ失敗時、データ全体が `null` になる

### 解決策
Date オブジェクトを ISO 文字列に変換してから返す：

```javascript
// 修正前
lead[header] = row[index];

// 修正後
let value = row[index];
if (value instanceof Date) {
  value = value.toISOString();
}
lead[header] = value;
```

### 修正したファイル
- `WebApp.gs`: getLeads(), getStaffList(), getDeals()
- `DashboardService.gs`: getSheetDataAsObjects()

### 再発防止
- CLAUDE.md にルール追加（セクション9）
- スプレッドシートからデータを返す関数は必ず Date 変換を行う
- 新規関数追加時は対象関数テーブルに追記

### デバッグ方法
1. サーバー側で `console.log(JSON.stringify(data))` でデータを確認
2. Date オブジェクトが含まれていないか確認
3. 診断関数 `diagnosticGetLeadsSteps()` を使用

### 横展開
全プロジェクトで適用必須
- スプレッドシートからデータを返す関数は必ず Date 変換を行う

#横展開候補

---

## 更新履歴
| 日付 | 変更内容 |
|------|----------|
| 2026-01-12 | google.script.run null問題（Date シリアライズ）を追加 |
| 2026-01-11 | デプロイID混乱の不具合事例を追加 |
| 2026-01-11 | 仕様乖離の不具合事例を追加 |
| 2026-01-11 | 初版作成 |
