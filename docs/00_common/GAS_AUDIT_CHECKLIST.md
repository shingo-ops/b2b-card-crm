# GAS監査チェックリスト（Gemini用）

## 概要

Gemini（監査担当）がGASコードをレビューする際に使用するチェックリスト。
機能要件と非機能要件の両面から品質を確認する。

**導入日**: 2026-01-17
**参照**: TROUBLE-018（GAS非機能要件の監査漏れ）

---

## 監査フロー

```
1. Claude Codeが実装完了を報告
2. Geminiが本チェックリストで監査
3. 問題があれば修正要求
4. 問題なければ承認
5. Humanがデプロイ承認
```

---

## 監査チェックリスト

### 1. 機能要件チェック

| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 1.1 | ユーザー指示を正確に実装しているか | ✅/❌ | |
| 1.2 | 仕様書の機能一覧を全て実装しているか | ✅/❌ | |
| 1.3 | 画面・UI設計通りに実装しているか | ✅/❌ | |
| 1.4 | データ構造が仕様通りか | ✅/❌ | |
| 1.5 | API関数が仕様通りか | ✅/❌ | |

---

### 2. 排他制御チェック（TROUBLE-018対応）

| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 2.1 | `insertSheet()`使用箇所にLockServiceがあるか | ✅/❌/N/A | |
| 2.2 | `deleteSheet()`使用箇所にLockServiceがあるか | ✅/❌/N/A | |
| 2.3 | `LockService.getScriptLock()`を使用しているか | ✅/❌/N/A | |
| 2.4 | `waitLock()`のタイムアウトは適切か（推奨30秒） | ✅/❌/N/A | |
| 2.5 | `finally`節で`releaseLock()`しているか | ✅/❌/N/A | |
| 2.6 | try-catchだけで競合状態に対処していないか | ✅/❌ | |

**LockService正しいパターン:**
```javascript
const lock = LockService.getScriptLock();
try {
  lock.waitLock(30000);
  // クリティカルセクション
} catch (e) {
  throw new Error('排他制御エラー: ' + e.message);
} finally {
  lock.releaseLock();
}
```

---

### 3. GAS実行制限チェック

| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 3.1 | 処理が6分以内に完了する設計か | ✅/❌ | |
| 3.2 | 長時間処理は分割されているか | ✅/❌/N/A | |
| 3.3 | トリガー数が20個/ユーザーを超えていないか | ✅/❌/N/A | |
| 3.4 | API呼び出し回数の制限を考慮しているか | ✅/❌ | |
| 3.5 | バッチ処理（setValues等）を活用しているか | ✅/❌ | |

---

### 4. google.script.run戻り値チェック

| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 4.1 | Dateオブジェクトを返していないか | ✅/❌ | |
| 4.2 | Dateを返す場合、toISOString()変換しているか | ✅/❌/N/A | |
| 4.3 | undefinedを返していないか | ✅/❌ | |
| 4.4 | 循環参照を含むオブジェクトを返していないか | ✅/❌ | |

**正しいパターン:**
```javascript
// ❌ 悪い例
return { date: new Date() };

// ✅ 良い例
return { date: new Date().toISOString() };
```

---

### 5. セキュリティチェック

| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 5.1 | XSS対策：innerHTMLではなくtextContentを使用 | ✅/❌ | |
| 5.2 | 認証情報はスクリプトプロパティに保存 | ✅/❌/N/A | |
| 5.3 | ユーザー入力のバリデーションがある | ✅/❌/N/A | |
| 5.4 | SQLインジェクション対策（該当する場合） | ✅/❌/N/A | |
| 5.5 | CORS設定は適切か | ✅/❌/N/A | |

---

### 6. コード品質チェック

| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 6.1 | 適切なエラーハンドリングがある | ✅/❌ | |
| 6.2 | 変数名・関数名が明確 | ✅/❌ | |
| 6.3 | コメントが適切 | ✅/❌ | |
| 6.4 | 重複コードがない | ✅/❌ | |
| 6.5 | マジックナンバーを使用していない | ✅/❌ | |

---

### 7. CLAUDE.md準拠チェック

| # | チェック項目 | 結果 | 備考 |
|---|-------------|------|------|
| 7.1 | バインドスクリプトを使用しているか | ✅/❌ | |
| 7.2 | スタンドアロンスクリプトを使用していないか | ✅/❌ | |
| 7.3 | 禁止事項に違反していないか | ✅/❌ | |
| 7.4 | デプロイルールに準拠しているか | ✅/❌ | |

---

## 監査結果フォーマット

```markdown
## Gemini監査レポート

### 基本情報
- 監査日時: YYYY-MM-DD HH:MM
- 対象: [機能名/ファイル名]
- 監査者: Gemini 2.5 Flash/Pro

### 監査結果サマリー

| カテゴリ | 結果 | 指摘数 |
|---------|------|--------|
| 機能要件 | ✅/❌ | X件 |
| 排他制御 | ✅/❌ | X件 |
| GAS実行制限 | ✅/❌ | X件 |
| 戻り値 | ✅/❌ | X件 |
| セキュリティ | ✅/❌ | X件 |
| コード品質 | ✅/❌ | X件 |
| CLAUDE.md準拠 | ✅/❌ | X件 |

### 指摘事項

#### 重大（修正必須）
1. [ファイル:行番号] 問題内容
   - 修正案:

#### 軽微（推奨）
1. [ファイル:行番号] 問題内容
   - 修正案:

### 総合判定
- ✅ 承認 / ⚠️ 修正要求 / ❌ 却下

### コメント
[全体的なコメント]
```

---

## 判定基準

| 判定 | 条件 |
|------|------|
| ✅ 承認 | 全カテゴリでチェック通過、または軽微な指摘のみ |
| ⚠️ 修正要求 | 重大な指摘あり、修正後に再監査 |
| ❌ 却下 | 設計レベルの問題あり、仕様から見直し |

---

## 関連ドキュメント

- CLAUDE.md セクション11: GAS排他制御ルール
- GAS_SPEC_TEMPLATE.md: GAS機能仕様書テンプレート
- TROUBLE-018: GAS競合状態エラー
- TROUBLE_LOG.md: 過去トラ記録
