# TPS設計思想書

**作成日**: 2026-01-19
**目的**: トヨタ生産方式（TPS）に基づく開発ワークフローの設計原則を文書化

---

## 1. 役割分担の原則

### 1.1 Claude Code と Human の分離

| 対象 | Claude Code | Human |
|------|:-----------:|:-----:|
| **インターフェース** | GitHub (CLI) | WebApp (GUI) |
| **参照情報** | Markdown files | ダッシュボード |
| **操作** | コード・ドキュメント編集 | 確認・承認 |
| **通知受信** | Hook経由 | Discord・WebApp |

### 1.2 情報の配置原則

| 情報種別 | GitHub (Claude用) | WebApp (Human用) |
|---------|:-----------------:|:----------------:|
| 理念・ビジョン | BUSINESS_CONTEXT.md | ビジネスコンテキスト画面 |
| ルール | CLAUDE.md, COMMON_RULES.md | KPIダッシュボード |
| 過去トラ | TROUBLE_LOG.md | 過去トラ一覧画面 |
| ポカヨケ | TROUBLE_POKAYOKE_MAPPING.md | ポカヨケ状況画面 |
| KGI/KPI | Section 0.1 | Overview画面 |
| 稼働状況 | git log | 稼働状況画面 |
| 外部API | EXTERNAL_API_REFERENCE.md | API仕様画面 |
| 設定ポリシー | settings.local.json | 設定管理画面 |

**原則**: 同じ情報でも、Claude用とHuman用で最適な形式で提供する。

---

## 2. TPS 7原則の適用

### 2.1 見える化（Mieruka）

**定義**: 問題・状況を誰でも即座に把握できる状態

| 適用先 | 実装方法 | KPI |
|--------|---------|-----|
| GitHub | README, CLAUDE.md | ルール参照率 |
| WebApp | KPIダッシュボード | 画面表示項目数 |
| 通知 | Discord Webhook | 通知到達率 |

### 2.2 ワンサイクル設計

**定義**: 発見→対策→検証→横展開を1サイクルで完結

```
発見 → 記録 → 分析 → 対策 → 検証 → 横展開
  │      │      │      │      │       │
  │      │      │      │      │       └─ CROSS_APPLY_PATTERNS.md
  │      │      │      │      └─ Gemini監査（自動）
  │      │      │      └─ ポカヨケ設置
  │      │      └─ V5フォーマット（5 Whys）
  │      └─ TROUBLE_LOG.md
  └─ Human指摘 / 自動検出
```

**完了条件**: 6ステップすべて完了でサイクル終了

### 2.3 自働化（Jidoka）

**定義**: 異常を検知したら自動停止し、人に知らせる

| チェック | 強制力 | トリガー |
|---------|:------:|---------|
| pre-commit hook | **強制停止** | git commit時 |
| Branch Protection | **強制停止** | git push時 |
| session-start-check | 警告 | セッション開始時 |
| session-end-check | 警告 | セッション終了時 |

### 2.4 アンドン（Andon）

**定義**: 異常発生時にリアルタイムで通知

| 状況 | 通知先 | 通知内容 |
|------|--------|---------|
| エラー発生 | Discord | エラー詳細 + 対処案 |
| 再発検知 | Discord | 再発回数 + Issue URL |
| 承認待ち | Discord | 承認依頼内容 |
| 作業完了 | Discord | 完了サマリー |

### 2.5 平準化（Heijunka）

**定義**: 作業量を均等化し、過負荷を防止

| 制限項目 | 上限 | 理由 |
|---------|:----:|------|
| 1セッション最大作業時間 | 4時間 | 集中力維持 |
| 同時進行タスク（WIP） | 3件 | 品質確保 |
| 1日最大コミット数 | 10件 | レビュー可能性 |
| 1タスク最大変更ファイル | 5件 | 影響範囲管理 |

### 2.6 標準化（Hyojunka）

**定義**: 作業手順を統一し、品質を安定化

| 対象 | 標準文書 | 強制機構 |
|------|---------|---------|
| 開発ルール | CLAUDE.md | session-start-check |
| 共通ルール | COMMON_RULES.md | pre-commit hook |
| 過去トラ記録 | V5フォーマット | session-end-check |
| API設計 | SPEC.md | npm run check |

### 2.7 カイゼン（Kaizen）

**定義**: 継続的に改善を繰り返す

| サイクル | 頻度 | 内容 |
|---------|------|------|
| 日次 | 毎日 | KPI確認、小改善 |
| 週次 | 毎週 | 振り返り、中改善 |
| 月次 | 毎月 | 大改善、仕組み見直し |

---

## 3. 強制力レベルの設計基準

### 3.1 レベル定義

| レベル | 名称 | 動作 | 適用基準 |
|:------:|------|------|---------|
| 0 | 情報 | ログ記録のみ | 統計目的 |
| 1 | 警告 | 通知表示 | 推奨事項 |
| 2 | 確認 | 承認待ち | 重要判断 |
| 3 | **強制停止** | 処理中断 | 品質必須事項 |

### 3.2 適用マトリクス

| チェック項目 | 影響度 | 復旧難易度 | 強制力 |
|-------------|:------:|:---------:|:------:|
| 必須ファイル存在 | 高 | 低 | Lv3 |
| 危険コードパターン | 高 | 中 | Lv3 |
| API整合性 | 高 | 中 | Lv3 |
| 過去トラ記録確認 | 中 | 低 | Lv1 |
| Gemini監査実施 | 中 | 低 | Lv1 |
| セッション読了報告 | 低 | 低 | Lv1 |

### 3.3 昇格条件

警告（Lv1）から強制停止（Lv3）に昇格する条件：

| 条件 | 昇格理由 |
|------|---------|
| 同一警告3回連続 | 改善されていない |
| 再発検知 | 対策が機能していない |
| 本番影響あり | リスクが高い |

---

## 4. 自動化範囲の設計

### 4.1 自動化すべき領域

| フェーズ | 自動化対象 | 実装方法 |
|---------|-----------|---------|
| Plan | タスク分解 | TodoWrite |
| Do | コード生成 | Claude Code |
| Check | 静的解析 | npm run check |
| Check | 監査 | Gemini MCP |
| Act | ポカヨケ設置 | Edit tool |

### 4.2 人間判断が必要な領域

| 判断項目 | 理由 | 通知方法 |
|---------|------|---------|
| 本番デプロイ | 影響範囲大 | Discord承認待ち |
| 仕様変更 | ビジネス判断 | Discord確認 |
| 緊急対応 | 優先度判断 | Discord即時通知 |
| 新規機能承認 | 方針判断 | 実装前宣言 |

---

## 5. KGI/KPI体系

### 5.1 KGI（最終目標）

| 指標 | 目標値 | 測定方法 |
|------|:------:|---------|
| ルール違反率 | 0% | pre-commit失敗数/コミット数 |
| 過去トラ再発率 | 0% | 再発数/総過去トラ数 |
| 仕様違反率 | 0% | 仕様不一致数/実装数 |

### 5.2 KPI（先行指標）

| 指標 | 目標値 | 測定方法 |
|------|:------:|---------|
| 0不良日連続達成 | 30日 | 最終不具合からの経過日数 |
| Gemini監査実施率 | 100% | 監査数/重要変更数 |
| ポカヨケ設置率 | 100% | 設置数/過去トラ数 |
| セッション読了率 | 100% | 読了報告数/セッション数 |

---

## 6. エスカレーション定義

### 6.1 閾値設定

| 状況 | 閾値 | アクション |
|------|:----:|-----------|
| 同一エラー再発 | 3回 | Discord通知 |
| 同一エラー継続 | 5回 | 緊急通知 + Issue作成 |
| 作業時間超過 | 4時間 | 休憩リマインド |
| 未解決タスク | 3日 | 優先度見直し通知 |

### 6.2 エスカレーションフロー

```
Lv1: 自動対応（ログ記録、軽微な修正）
  ↓ 解決しない
Lv2: Claude Code対応（分析、対策実装）
  ↓ 解決しない
Lv3: Human通知（Discord承認待ち）
  ↓ 解決しない
Lv4: 緊急対応（作業停止、優先対応）
```

---

## 7. 運用ルール

### 7.1 本文書の更新タイミング

| トリガー | 更新内容 |
|---------|---------|
| 新規TPS原則適用時 | 該当セクション追加 |
| 強制力レベル変更時 | Section 3更新 |
| KPI追加時 | Section 5更新 |
| エスカレーション変更時 | Section 6更新 |

### 7.2 参照ルール

- Claude Code: セッション開始時に本文書を参照
- Human: WebAppのKPI画面で数値を確認

---

**以上**
