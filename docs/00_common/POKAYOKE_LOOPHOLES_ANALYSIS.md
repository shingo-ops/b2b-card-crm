# ポカヨケシステム抜け穴分析

**作成日**: 2026-01-18
**目的**: 自律開発におけるポカヨケシステムの抜け穴を特定し、対策を講じる

---

## 1. 特定された抜け穴一覧

| # | 抜け穴 | 発生条件 | 関連TROUBLE | 深刻度 |
|---|--------|---------|-------------|--------|
| 1 | コンテキスト再開時のスキップ | セッションがコンパクションから再開 | - | 高 |
| 2 | Gemini承認のネットワークエラー | API接続エラー時に承認をスキップ | - | 高 |
| 3 | 設定のみ更新で完了扱い | 設定変更後に実操作を忘れる | TROUBLE-027 | 高 |
| 4 | 口頭合意の未ドキュメント化 | 会話で合意したがCLAUDE.md未追記 | TROUBLE-025 | 高 |
| 5 | 新規工程のポカヨケテストスキップ | 新規追加時に暗黙仕様を確認しない | TROUBLE-026 | 高 |
| 6 | 未完了タスクの完了扱い | 動作確認なしで完了報告 | TROUBLE-023 | 高 |
| 7 | 設置フローの解釈ずれ | フローの目的が不明確 | TROUBLE-024 | 中 |
| 8 | 監査役未呼び出し | 重要変更時にGemini監査をスキップ | TROUBLE-022 | 高 |
| 9 | 過去トラ記録のみで設置漏れ | TROUBLEは記録したがポカヨケ未設置 | - | 高 |
| 10 | セッション開始ルール形骸化 | 読了報告のみで実際は未読 | - | 高 |

---

## 2. 各抜け穴の詳細分析

### 抜け穴1: コンテキスト再開時のスキップ

**問題**: セッションがコンパクション後に再開されると、サマリーからの継続となり、セッション開始ルール（4ファイル読了）がスキップされる可能性がある。

**発生条件**:
- 長時間のセッションでコンテキストが圧縮された場合
- 「Continue from where we left off」の指示がある場合

**対策案**:
- コンテキスト再開時も必須チェック項目を設ける
- 再開時専用のチェックリストを作成

---

### 抜け穴2: Gemini承認のネットワークエラー

**問題**: Gemini APIへの接続エラー時、承認なしで作業を進めてしまう可能性がある。

**発生条件**:
- ネットワーク接続の不安定
- Gemini APIのレート制限
- タイムアウト

**対策案**:
- 接続エラー時は承認待ち状態として作業を一時停止
- リトライ回数の上限と人間への報告ルール

---

### 抜け穴3: 設定のみ更新で完了扱い

**問題**: 設定ファイル（env-config.json等）を更新しただけで、実際のリソース操作を行わずに完了報告する。

**関連**: TROUBLE-027

**対策**: Section 16に「実操作確認」チェック項目を追加済み

---

### 抜け穴4: 口頭合意の未ドキュメント化

**問題**: 会話で合意したルールがCLAUDE.mdに追記されず、次回セッションで忘れられる。

**関連**: TROUBLE-025

**対策**: Section 17追加済み。さらに「合意事項の即時ドキュメント化」ルールを強化

---

### 抜け穴5: 新規工程のポカヨケテストスキップ

**問題**: 新規工程追加時に暗黙の仕様を確認せず、解釈ずれが発生する。

**関連**: TROUBLE-026

**対策**: Section 18追加済み

---

### 抜け穴6: 未完了タスクの完了扱い

**問題**: 動作確認やリソース存在確認をせずに完了報告する。

**関連**: TROUBLE-023

**対策**: Section 16のチェックリスト強化済み

---

### 抜け穴7: 設置フローの解釈ずれ

**問題**: ポカヨケ設置フローの各ステップの目的が不明確で、解釈が分かれる。

**関連**: TROUBLE-024

**対策**: Section 15に目的・禁止事項列を追加済み

---

### 抜け穴8: 監査役未呼び出し

**問題**: CLAUDE.md変更やポカヨケ設置時にGemini監査を呼び出さない。

**関連**: TROUBLE-022

**対策**: Section 10に必須監査トリガーを追加済み

---

### 抜け穴9: 過去トラ記録のみで設置漏れ

**問題**: TROUBLEをTROUBLE_LOG.mdに記録したが、対応するポカヨケをCLAUDE.mdに設置しない。

**発生条件**:
- 過去トラ記録後に別タスクに移行
- ポカヨケ設置フローの途中で中断

**対策案**:
- 過去トラ記録時に「ポカヨケ設置完了」までをセットで管理
- 未設置ポカヨケの定期チェック

---

### 抜け穴10: セッション開始ルール形骸化

**問題**: 読了報告を形式的に行うが、実際にはファイルを読んでいない。

**発生条件**:
- 緊急のタスクがある場合
- 前回と同じ作業の継続

**対策案**:
- 読了報告に「要注意TROUBLE番号」の具体的な内容を記載必須
- ランダムに「Section Xの内容は？」と確認

---

## 3. 対策状況（2026-01-18更新）

| # | 抜け穴 | 対策状況 | 設置先 |
|---|--------|---------|--------|
| 1 | コンテキスト再開時のスキップ | ✅対策済み | CLAUDE.md Section 0.6 |
| 2 | Gemini承認のネットワークエラー | ✅対策済み | CLAUDE.md Section 10 |
| 3 | 設定のみ更新で完了扱い | ✅対策済み | CLAUDE.md Section 16 |
| 4 | 口頭合意の未ドキュメント化 | ✅対策済み | CLAUDE.md Section 17 |
| 5 | 新規工程のポカヨケテストスキップ | ✅対策済み | CLAUDE.md Section 18 |
| 6 | 未完了タスクの完了扱い | ✅対策済み | CLAUDE.md Section 16 |
| 7 | 設置フローの解釈ずれ | ✅対策済み | CLAUDE.md Section 15 |
| 8 | 監査役未呼び出し | ✅対策済み | CLAUDE.md Section 10 |
| 9 | 過去トラ記録のみで設置漏れ | ✅対策済み | CLAUDE.md Section 0.7 |
| 10 | セッション開始ルール形骸化 | ✅対策済み | CLAUDE.md Section 0.3 |

---

## 4. 推奨対策

### 4.1 セッション開始時の必須チェックリスト（Section 0強化）

| # | チェック項目 | 確認方法 | 必須 |
|---|-------------|---------|:----:|
| 1 | git pull実行 | コマンド実行 | ✅ |
| 2 | 同期チェック | scripts/check-sync.sh | ✅ |
| 3 | 3環境検証 | scripts/verify-3env.sh | ✅ |
| 4 | 未設置ポカヨケ確認 | TROUBLE_LOG.mdの「設置予定」を検索 | ✅ |
| 5 | 4ファイル読了 | 各ファイルのハッシュまたは行数確認 | ✅ |
| 6 | 過去トラ要注意事項の具体的記載 | 直近3件のTROUBLE番号と内容 | ✅ |

### 4.2 コンテキスト再開時ルール

コンテキストがコンパクションから再開された場合も、以下を必須とする：
- git pull
- 同期チェック
- 3環境検証
- 未完了タスクの確認

### 4.3 Gemini承認エラー時ルール

Gemini APIエラー時：
1. 3回リトライ
2. それでも失敗した場合は人間に報告
3. 承認なしでの作業続行は禁止

---

## 5. 関連ドキュメント

- CLAUDE.md: 各セクションのポカヨケ
- TROUBLE_LOG.md: 過去トラ記録
- scripts/verify-3env.sh: 3環境検証
- scripts/check-sync.sh: 同期チェック
