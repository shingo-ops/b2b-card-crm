# COMMON_RULES.md - 全プロジェクト共通定義

> **バージョン**: 2.15.0
> **作成日**: 2026-01-14
> **最終更新**: 2026-01-16
> **承認**: 3者合意（Human・Claude・Claude Code）

---

## 目次

1. [この文書について](#1-この文書について)
2. [定義の保存場所と参照方法](#2-定義の保存場所と参照方法)
3. [定義の更新ルール](#3-定義の更新ルール)
4. [3者の意見が分かれた場合の決定方法](#4-3者の意見が分かれた場合の決定方法)
5. [UI設計フレーム](#5-ui設計フレーム)
6. [チャット・音声入力の仕様](#6-チャット音声入力の仕様)
7. [スプレッドシートの基本ルール](#7-スプレッドシートの基本ルール)
8. [データ構造変更の鉄則](#8-データ構造変更の鉄則)
9. [過去トラの参照と記録](#9-過去トラの参照と記録)
10. [不具合発生時の対応方法](#10-不具合発生時の対応方法)
11. [改修・改善時の定義](#11-改修改善時の定義)
12. [モードの定義](#12-モードの定義)
13. [優先度ルール](#13-優先度ルール)
14. [確認が必要な場面とリスクの定義](#14-確認が必要な場面とリスクの定義)
15. [完了の定義](#15-完了の定義)
16. [許可される操作（自律実行原則）](#16-許可される操作自律実行原則)
17. [コード参照ルール](#17-コード参照ルール)
18. [用語辞書](#18-用語辞書)
19. [ルール定義時のフロー](#19-ルール定義時のフロー)
20. [セッション開始時のルール](#20-セッション開始時のルール)
21. [報告・記録ルール](#21-報告記録ルール)
22. [記録保存ルール](#22-記録保存ルール)
23. [機密情報管理ルール](#23-機密情報管理ルール)
24. [開発ワークフロー](#24-開発ワークフロー)
25. [clasp自律開発環境](#25-clasp自律開発環境)
26. [障害対応フロー](#26-障害対応フロー)
27. [データ保持・レビュールール](#27-データ保持レビュールール)
28. [ファイル配置ルール](#28-ファイル配置ルール)
29. [人間向け報告フォーマット＆未承認リスト管理](#29-人間向け報告フォーマット未承認リスト管理)
30. [開発提案記録ルール](#30-開発提案記録ルール)
31. [3環境システム仕様](#31-3環境システム仕様)
32. [採用議論モード](#32-採用議論モード)
33. [プロジェクト提案リマインド機能](#33-プロジェクト提案リマインド機能)
34. [認識ズレ記録ルール](#34-認識ズレ記録ルール)
35. [GASコンテナバインド型必須ルール](#35-gasコンテナバインド型必須ルール)
36. [過去トラ記録必須化ルール](#36-過去トラ記録必須化ルール)
37. [更新履歴](#37-更新履歴)
38. [最小構成原則](#38-最小構成原則disc-044承認)
39. [創造的最適化の7原則](#39-創造的最適化の7原則disc-045承認)
40. [開発振り返りフォーマット](#40-開発振り返りフォーマットdisc-046承認)
41. [40人チームルール](#41-40人チームルールtrouble-015承認)
42. [解釈と予測の定義](#42-解釈と予測の定義disc-047承認)
43. [質問・確認の徹底ルール](#43-質問確認の徹底ルールdisc-049承認)
44. [5W2H定量化ルール](#44-5w2h定量化ルールdisc-049承認)
45. [ナレッジ管理ルール](#45-ナレッジ管理ルールdisc-049承認)

---

## 1. この文書について

### 1.1 目的

この文書は、Human・Claude・Claude Codeの3者が同じ認識で開発を進めるための「不変の楔」である。

### 1.2 適用範囲

全てのプロジェクトに適用される共通ルールを定義する。
プロジェクト固有のルールは各プロジェクトのCLAUDE.mdに記載する。

### 1.3 優先順位

1. この文書（COMMON_RULES.md）が基本ルール
2. プロジェクトのCLAUDE.mdが固有ルール
3. 矛盾がある場合はCLAUDE.md（プロジェクト固有）が優先
4. 判断できない場合は人間に確認

---

## 2. 定義の保存場所と参照方法

### 2.1 ファイル構成
```
共通定義
└── COMMON_RULES.md
    ├── UI設計フレーム
    ├── エラー表示ルール
    ├── スプレッドシート基本ルール
    ├── モード定義
    ├── 過去トラ参照ルール
    └── その他全プロジェクト共通ルール

プロジェクト定義
└── 各プロジェクトの CLAUDE.md
    ├── このプロジェクトの目的
    ├── データ構造定義
    ├── 機能定義
    ├── 状態遷移定義
    └── プロジェクト固有ルール
```

### 2.2 参照ルール

| タイミング | 参照するファイル |
|-----------|-----------------|
| 開発開始時 | COMMON_RULES.md → CLAUDE.md の順に読む |
| 判断に迷った時 | COMMON_RULES.md を確認 |
| プロジェクト固有の判断 | CLAUDE.md を確認 |

---

## 3. 定義の更新ルール

### 3.1 更新手順

1. 更新が必要な理由を3者で議論
2. 更新内容を明文化
3. 3者が合意
4. 更新履歴に記録
5. GitHubにコミット

### 3.2 更新履歴のフォーマット

| バージョン | 日付 | 変更内容 | 合意者 |
|-----------|------|----------|--------|
| x.x.x | YYYY-MM-DD | 変更内容 | Human, Claude, Claude Code |

### 3.3 禁止事項

- 1者のみの判断で更新すること
- 更新履歴なしで変更すること
- 議論なしで既存ルールを削除すること

---

## 4. 3者の意見が分かれた場合の決定方法

### 4.1 決定権の分担

| 判断領域 | 決定権 |
|---------|-------|
| ユーザー体験・ビジネス判断 | 人間が決定 |
| 技術的な実現可能性 | Claude/Claude Codeが説明して別案提案 |
| どちらでもない | 人間が最終決定 |

### 4.2 決定フロー

1. 各自が意見とその理由を述べる
2. 技術的に不可能な場合はClaude/Claude Codeが理由を説明
3. 複数案がある場合はメリット・デメリットを比較
4. 人間が最終決定
5. 決定内容を記録

### 4.3 判断に迷う典型的なケース

| ケース | 判断 |
|--------|------|
| 指示に書いていない改善を思いついた | 人間に確認 |
| 2つの実装方法がある | メリット・デメリットを報告し人間が決定 |
| エラーの原因が分からない | 調査モードで報告 |
| 指示が曖昧 | 人間に確認（推測で進めない） |
| 過去トラに類似事例がない | 人間に確認 |
| 共通定義に書いていない状況 | 人間に確認 |

---

## 5. UI設計フレーム

### 5.1 レイアウト

| 要素 | 配置 |
|------|------|
| アプリ名 | 左上 |
| サイドメニュー | 左側 |
| メインコンテンツ | 右側 |

### 5.2 モーダル（ポップアップ）

| 項目 | 仕様 |
|------|------|
| 表示位置 | 画面中央 |
| 閉じる方法 | OKボタン / モーダル外クリック / Escキー |

### 5.3 スライドパネル

| 項目 | 仕様 |
|------|------|
| 表示位置 | 右側から出現 |
| 閉じる方法 | OKボタン・閉じるボタン / パネル外クリック / Escキー |

### 5.4 トースト通知（成功時）

| 項目 | 仕様 |
|------|------|
| 表示位置 | 右下から出現 |
| 自動消去 | 3秒後に自動で消える |
| OKボタン | 不要 |

### 5.5 エラー表示

| 項目 | 仕様 |
|------|------|
| 表示位置 | 画面中央モーダル |
| 閉じる方法 | モーダルと同じ |
| 形式 | アプリのカードと同じ形式 |

**禁止事項**
- alert()の使用
- 上部グレーポップアップの使用

### 5.6 ボタンの色

| 用途 | 色 |
|------|-----|
| 通常操作 | 青 |
| 危険操作（削除、確認必要） | 赤 |
| キャンセル・補助 | グレー |

### 5.7 UI/UX設計思想

**ゴール**: 担当者が開きたくなる、閉じたくなくなる、ずっと使っていたくなるアプリ

#### 設計原則

| 原則 | 説明 |
|------|------|
| **人間工学** | 視線の動き（F/Zパターン）を考慮した配置 |
| **心理学** | ストレスを与えず、達成感を与える設計 |
| **脳科学** | 認知負荷を下げ、ドーパミン報酬を活用 |
| **ゲーミフィケーション** | 依存性を生む仕組み（良い意味で） |

#### 視認性の優先エリア

```
┌─────────────────────────────────┐
│ ★★★ 最重要（左上〜上部） ★★★    │ ← ゴールデンエリア
├─────────────────────────────────┤
│ ★★ 重要（左側）               │
│                    ★ 補助（右側）│
├─────────────────────────────────┤
│ 詳細・補足（下部）               │
└─────────────────────────────────┘
```

- **リマインド・今日のタスク**: 左上〜上部に固定表示
- **Buddyメッセージ**: 上部、視線が最初に行く場所

#### 情報量の制限

| ルール | 理由 |
|--------|------|
| 一度に表示は最大5件 | マジックナンバー7±2（認知限界） |
| 残りは折りたたみ | 情報過多によるストレス防止 |
| 優先度順にソート | 重要なものから処理 |

#### 依存性を生む設計

| 心理原則 | 実装 |
|----------|------|
| **変動報酬** | Buddyのメッセージを日替わり・ランダム化 |
| **進捗の可視化** | 連続ログイン日数、完了タスク数バッジ |
| **コンプリート欲求** | タスク完了時の「🎉」エフェクト |
| **社会的証明** | チームの活動状況表示 |
| **損失回避** | 「未対応3件」の赤表示 |

#### 禁止事項

| 禁止 | 理由 |
|------|------|
| 過度なモーダル | 作業中断、ストレス |
| 情報の詰め込み | 認知負荷増大 |
| 意味のないアニメーション | 疲労感 |
| ダークパターン | 不快感、信頼喪失 |

### 5.8 リマインド表示仕様

#### タイミング

| トリガー | 時刻 |
|----------|------|
| 時間ベース | AM 8:00 |
| ログイン時 | 即座に表示 |

#### 表示位置

**ダッシュボード上部（ゴールデンエリア）**

#### 表示形式

```
┌─────────────────────────────────────────────┐
│ 🔔 今日のアクション (2/5完了) [━━━━━━░░░░]  │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│ │🔴 テス太郎│ │🟡 山田様 │ │🟢 鈴木様 │     │
│ │リマインド │ │見積送付 │ │フォロー │     │
│ │ 今日 ☐  │ │ 明日 ☐ │ │ 3日後 ☐│     │
│ └──────────┘ └──────────┘ └──────────┘     │
│                            [+3件を見る]     │
├─────────────────────────────────────────────┤
│ 💬 Buddy: 「おはよう！今日のテス太郎様、   │
│           リマインドの期限だよ！」          │
└─────────────────────────────────────────────┘
```

#### 色分け

| 色 | 意味 |
|----|------|
| 🔴 赤 | 今日が期限 |
| 🟡 黄 | 明日が期限 |
| 🟢 緑 | 7日以内 |
| ⚪ グレー | 日付未定（翌日リマインド対象） |

#### 「相手の返信が届き次第」等の扱い

| 選択肢 | リマインド |
|--------|-----------|
| 相手の返信が届き次第 | 翌日AM8:00にリマインド |
| 不明点の確認が完了次第 | 翌日AM8:00にリマインド |
| 具体的日付 | 当日AM8:00にリマインド |

---

## 6. チャット・音声入力の仕様

### 6.1 チャット入力

| 項目 | 仕様 |
|------|------|
| 送信後 | 入力欄はクリア |
| 連続送信 | 防止する |
| Enterキー | 改行（送信しない） |
| 送信方法 | 送信ボタンのみ |

### 6.2 音声入力

| 項目 | 仕様 |
|------|------|
| 開始方法 | Spaceキー押し続け |
| 終了方法 | Spaceキーを離す or 話し終わり検知 |
| ボタン | なし（Spaceキーのみ） |

---

## 7. スプレッドシートの基本ルール

### 7.1 Single Source of Truth

- 商談に関する全てのデータは「メインデータシート」に集約
- 1行 = 1案件
- 他シートとのデータ重複は禁止

※「メインデータシート」の名称は各プロジェクトのCLAUDE.mdで定義する
（例：CRMプロジェクトでは「リード管理」シート）

### 7.2 プルダウン管理

| 項目 | ルール |
|------|--------|
| 定義場所 | 設定シートのみ |
| ハードコード | 禁止 |
| 変更方法 | 設定シートを変更するだけで全システムに反映 |

### 7.3 シート分類ルール

| 種別 | 追加可否 | 説明 | 例 |
|------|---------|------|-----|
| メインデータ | ❌ 新規禁止 | 1行=1案件のデータ | リード管理 |
| ログ | ✅ 可 | 1案件に複数行発生、固有IDで紐付け必須 | 会話ログ、操作ログ |
| マスタ | ✅ 可 | 参照用データ | 担当者マスタ、設定 |
| 集計 | ✅ 可 | レポート用の集計データ | 週次レポート、月次レポート |

### 7.4 シート追加時の記録

シートを追加した場合は必ず以下を記録する：
```markdown
## シート追加記録

### 追加日
いつ

### 追加シート名
どこに何を

### 追加理由
なぜ必要か

### 紐付けID
どのIDで紐付けるか（例：リードID）

### 影響範囲
どのファイルに影響するか

### バージョン
Git commit ID または タグ

### 承認
3者合意日時
```

### 7.5 列変更ルール

#### 列追加時
- 列は必ず末尾に追加（既存列の間に挿入しない）
- Config.gs の HEADERS定義と同時に更新
- 整理したい場合は人間と壁打ちして整理

#### 列削除時（必須手順）
1. 削除対象の列名で全ファイルをgrep
2. ヒットした全箇所をリスト化
3. 全箇所を修正
4. 再度grepして0件を確認
5. スプレッドシートの列は手動削除（人間に依頼）

#### 列名変更時
- 上記の削除手順 + 追加手順を両方実施

---

## 8. データ構造変更の鉄則

### 8.1 変更前

1. 現在の構造を全てgrepで洗い出す
2. 影響を受けるファイルをリスト化
3. 3者で変更内容を合意

### 8.2 変更時

4. 全ての影響箇所を同時に変更
5. 1ファイルだけ変更することは禁止

### 8.3 変更後

6. grepで変更完了を確認
7. 旧構造の参照が0件であることを確認
8. 報告

### 8.4 禁止事項

- 列名の変更を1ファイルだけで行う
- 新旧の構造を混在させる
- 「後で直す」と言って放置する

---

## 9. 過去トラの参照と記録

### 9.1 記録タイミング

- 不具合修正が完了した後に記録
- 修正途中では記録しない（原因が確定していないため）
- これ以外の方法を取ることは禁止
- イレギュラー対応が必要な場合は3者で議論して合意の上対応

### 9.2 記録フォーマット
```markdown
## TROUBLE-XXX: [タイトル]

### 発生日
いつ

### 発生箇所
どこで（ファイル名、機能名）
バージョン：Git commit ID または タグ

### 発生した不具合
何が起きたか

### 発生経緯
どうやって発生したか

### 影響範囲
どれぐらいの影響があったか

### 根本原因
なぜ起きたか

### 解決方法
どう解決したか

### 再発防止ルール
今後の再発防止のためのルール

### 教訓
学んだこと
```

### 9.3 参照タイミング

- 開発着手前に関連する過去トラを確認
- 同じ問題が起きないように対策を含めて開発

### 9.4 記録フォーマット（V5形式）

全ての過去トラは **V5（7セクション完全版）** で記録する。

| セクション | 目的 | 必須 |
|------------|------|------|
| 1. 現状把握 | 何が起きたかを数値で明確化 | ✅ |
| 2. 要因分析 | 5Whysで真因に到達 | ✅ |
| 3. 対策立案 | 何をどう直したか | ✅ |
| 4. 再発防止策 | 同一問題の再発を防ぐ | ✅ |
| 5. 禁止項目 | やってはいけないことを明文化 | ✅ |
| 6. 引き継ぎ事項 | コンテキスト喪失対策 | ✅ |
| 7. 類似リスクへの横展開 | 類似問題の予防 | ✅ |

#### 記入ルール
- 全項目で **5W2H**（いつ/どこで/誰が/何を/どうやって/どれぐらい/なぜ）を使用
- **数値で明確化**（影響ファイル数、影響期間、Before/After比較）
- **段階的記入OK**（発生直後は現状把握のみ、対策完了後に残りを記入）

#### 禁止事項
- 重大度による使い分け（全てV5で統一）
- 数値なしの曖昧な記載（「複数」「しばらく」→ 具体的な数値に）
- 5Whysの途中終了（必ず5回まで掘り下げる）

### 9.5 標準化ルール

#### 用語統一
| 項目 | 標準表記 | NG例 |
|------|----------|------|
| 日時 | YYYY/MM/DD HH:MM | 1/14、14日、昨日 |
| ファイル参照 | ファイル名:行番号 | 「○○ファイルの辺り」 |
| 影響度 | 数値（X件、X時間、X%） | 「複数」「しばらく」「多い」 |
| 検知方法 | 偶然 / チェックリスト / テスト / 監視 | 「たまたま見つけた」 |
| 対応者 | Human / Claude / Claude Code | 「自分」「AI」 |

#### 数値化必須項目
| 項目 | 記載例 |
|------|--------|
| 影響ファイル数 | 3件（Config.gs, WebApp.gs, index.html） |
| 影響期間 | 14日間（2026/01/01〜2026/01/14） |
| 検知までの時間 | 発生から48時間後 |
| 修正規模 | 5ファイル、127行変更 |
| Before/After | 環境分離率: 0% → 100% |

#### 5Whysルール
| ルール | 内容 |
|--------|------|
| 必ず5回 | 3回で止めない。5回目で「プロセス/設計/文化」レベルに到達すること |
| 回答は事実のみ | 推測・言い訳を含めない |
| 「人のミス」で止めない | 「なぜミスが起きる仕組みだったか」まで掘る |

#### レビュー基準
| チェック項目 | 基準 |
|--------------|------|
| 数値の有無 | 全セクションに最低1つの数値があるか |
| 5Whysの深さ | 5回目が「プロセス/設計/文化」レベルか |
| 横展開の有無 | 類似リスクが1つ以上挙げられているか |
| 引き継ぎの具体性 | URL/コマンドが明記されているか |

### 9.6 過去トラ管理体制

#### 役割定義
| 役割 | 担当 | 責務 |
|------|------|------|
| **オーナー** | Human | 最終承認、ルール変更決定、重大案件の判断 |
| **記録者** | Claude Code | 過去トラの記録作成、テンプレート適用 |
| **レビュアー** | Human / Claude | 記録内容の確認、不足項目の指摘 |

#### プロセス
```
1. 問題発生
   ↓
2. Claude Code: 現状把握セクションを記録
   ↓
3. Human: 内容確認・追加情報提供
   ↓
4. Claude Code: 要因分析〜横展開を記録
   ↓
5. Human: レビュー・承認
   ↓
6. Claude Code: TROUBLE_LOG.mdに追記
   ↓
7. Human: 最終確認・コミット承認
```

#### 権限
| 操作 | Human | Claude | Claude Code |
|------|-------|--------|-------------|
| 過去トラ新規作成 | ✅ | ✅ | ✅ |
| 過去トラ編集 | ✅ | ✅ | ✅（Human承認後） |
| テンプレート変更 | ✅ | 提案のみ | 提案のみ |
| 標準化ルール変更 | ✅ | 提案のみ | 提案のみ |

#### 定期レビュー
| 頻度 | 内容 | 担当 |
|------|------|------|
| 毎セッション開始時 | 直近の過去トラ確認 | Claude Code |
| 週次（任意） | 過去トラの傾向分析 | Human + Claude |
| 月次（任意） | テンプレート改善検討 | 3者 |

---

## 10. 不具合発生時の対応方法

### 10.1 対応フロー

1. 不具合の再現確認
2. [DEBUG]ログを追加して原因調査
3. 原因特定・修正方針を報告
4. 3者で修正方針を合意
5. 修正実施
6. 動作確認
7. [DEBUG]ログを削除
8. 過去トラに記録（9.2のフォーマットに従う）
9. 完了報告

### 10.2 禁止事項

- 過去トラ記録なしで完了とすること
- 原因特定なしで修正すること
- 動作確認なしで完了とすること

---

## 11. 改修・改善時の定義

### 11.1 改修前

1. 目的：何を解決するか
2. 理由：なぜ必要か
3. 完了条件：どうなれば成功か（具体的に定義）
4. 影響調査：既存システムへの影響
5. 方法：どうやって実現するか
6. リスク：データ消失、整合性崩壊の可能性

### 11.2 改修中

- 10項目以上はPhase分け
- 各Phase完了後にテスト確認

### 11.3 「10項目以上の改修」の定義

以下のいずれかに該当する場合：
- 10箇所以上のコード変更
- 5ファイル以上の変更
- データ構造（シート、列）に影響する変更

### 11.4 改修後

- 完了条件を満たしているか確認
- grep検証（削除したものが0件か）
- 過去トラ記録（不具合があった場合）

### 11.5 アップデート記録

| 種別 | 記録方法 |
|------|---------|
| 通常のアップデート | GitHubのコミット履歴で十分 |
| 重要な仕様変更 | CLAUDE.mdの「更新履歴」セクションに記録（理由と3者合意の経緯） |

---

## 12. モードの定義

### 12.1 調査モード

#### 発動条件
「調査して」「分析して」「原因を特定して」

#### 報告フォーマット
```markdown
## 1. 現状把握
- いつ：発生日時
- どこで：発生箇所（ファイル名:行番号）
- 何が：発生した事象
- どうやって：再現手順
- どれぐらい：影響範囲（件数、ユーザー数）
- 調査方法：grep、ログ確認、コード読解など

## 2. 要因分析
- 直接原因：何が直接の原因か
- 根本原因：なぜそれが起きたか
- 関連ファイル：影響を受けるファイル一覧
- 証拠：エビデンス（コード、ログ、スクリーンショット）

## 3. 対策立案
- 対策案：複数案を提示
- 各案のメリット/デメリット
- 推奨案とその理由
- 影響範囲：修正による副作用
- 工数見積：どれぐらいかかるか
```

#### 禁止される操作
- ファイル変更
- デプロイ

---

### 12.2 自律開発モード

#### 発動条件
「開発して」「実装して」「修正して」

#### 1トライの定義

1トライ = 調査 → 実装 → clasp push → テストURLで確認 → 結果判定

#### 5回のトライの定義（PDCA版）

##### トライ1: 初回実装
1. 指示通りに実装する
2. テストURLで動作確認
3. 成功なら完了報告
4. 失敗なら調査モードへ移行

##### トライ2: 調査→再実装（トライ1の学習を反映）

**調査フェーズ**
1. 現状把握（いつ、どこで、何が、どうやって、どれぐらい）
2. 要因分析（直接原因、根本原因、関連ファイル）
3. 対策立案（トライ1の結果を踏まえた対策）

**実装フェーズ**
4. 対策を実装
5. テストURLで動作確認
6. 成功なら完了報告、失敗ならトライ3へ

##### トライ3: 調査→再実装（トライ1+2の学習を反映）

**調査フェーズ**
1. 現状把握
2. 要因分析（トライ1+2の結果を踏まえて）
3. 対策立案（なぜトライ2で解決しなかったかを分析）

**実装フェーズ**
4. 対策を実装
5. テストURLで動作確認
6. 成功なら完了報告、失敗ならトライ4へ

##### トライ4: 調査→再実装（トライ1+2+3の学習を反映）

**調査フェーズ**
1. 現状把握
2. 要因分析（トライ1+2+3の結果を踏まえて）
3. 対策立案（別アプローチの検討を含む）

**実装フェーズ**
4. 対策を実装
5. テストURLで動作確認
6. 成功なら完了報告、失敗ならトライ5へ

##### トライ5: 最終調査→再実装 または 人間に相談

**調査フェーズ**
1. 現状把握
2. 要因分析（トライ1+2+3+4の全結果を統合）
3. 対策立案（問題の切り分け、最小単位での解決）

**実装フェーズ**
4. 対策を実装
5. テストURLで動作確認
6. 成功なら完了報告
7. 失敗なら人間に報告（全トライの記録を添えて）

##### 5回失敗時の報告内容
- トライ1-5の調査結果まとめ
- 各トライで試したアプローチと結果
- 現在の仮説
- 人間に判断を仰ぎたい点

#### 12.2.2 開発モード会議必須化ルール（DISC-030承認）

##### 適用条件

| 条件 | 会議 |
|------|------|
| リスクレベル「中」以上 | **必須** |
| 新機能実装 | **必須** |
| データ構造影響 | **必須** |
| 複数ファイル変更 | **必須** |
| 軽微な修正（typo、コメント等） | 省略可 |
| 単一ファイルの小修正 | 省略可 |

##### トライ別会議ラウンド数

| トライ | ラウンド数 | 目的 |
|--------|-----------|------|
| **1回目** | 3ラウンド | 初期実装方針の策定 |
| **2回目** | 3ラウンド | 学習を反映した再実装 |
| **3回目** | 5ラウンド | 深掘り分析 |
| **4回目** | 5ラウンド | 別アプローチ検討 |
| **5回目** | 8ラウンド | 徹底議論・最終案策定 |

##### 会議プロセス（各トライ共通）

```
1. 会議開始
   ├── 議題確認
   ├── ルール参照（COMMON_RULES.md確認）
   └── 参加エージェント選定
       ↓
2. 議論フェーズ（ラウンド数分）
   ├── 各エージェントが意見を述べる
   ├── ルール抵触チェック
   └── 反論・追加意見
       ↓
3. 合意形成
   ├── 実装内容の決定
   ├── ルール抵触の最終確認
   └── リスク確認
       ↓
4. 実装フェーズ
   ├── 決定内容に基づき実装
   └── [DEBUG]ログ追加（必要時）
       ↓
5. 検証フェーズ
   ├── エラーチェック
   ├── ルール遵守確認
   └── テスト実行
       ↓
6. 結果判定
   ├── 成功 → 完了報告
   └── 失敗 → 次のトライへ
```

##### 会議ログフォーマット

```markdown
## IMPL-XXX: [タスク名] - トライN

### 会議情報
- 日時: YYYY-MM-DD HH:MM
- ラウンド数: N
- 参加者: [エージェント名リスト]

### 議論内容
#### ラウンド1
- [エージェント名]: [発言内容]
- ルール確認: [確認したルール]

### 決定事項
1. [決定内容1]
2. [決定内容2]

### ルール抵触チェック
- [x] Section X.X: 抵触なし

### 実装結果
- 成功/失敗
- 変更ファイル: [リスト]
```

##### 会議省略時の要件

会議を省略する場合も、以下は必須：
1. 省略理由の明記
2. 適用したルールの参照
3. 実装後の報告

---

### 12.3 状況報告モード

#### 発動条件
「状況を報告して」「引き継ぎ情報を出して」「現状を教えて」

#### 報告フォーマット
```markdown
## 1. プロジェクト概要
- プロジェクト名
- 目的
- 現在のフェーズ

## 2. 開発状況
| 機能 | 状態 | 完了日 | 備考 |
|------|------|--------|------|
| ○○ | 完了/開発中/未着手 | | |

## 3. 環境情報
- テストURL
- 本番URL
- スプレッドシートID
- デプロイID

## 4. 直近の作業
- 最後に完了した作業
- 進行中の作業
- 次に予定している作業

## 5. 既知の問題
| # | 問題 | 優先度 | 状態 |
|---|------|--------|------|
| 1 | ○○ | P0/P1/P2 | 未着手/調査中/修正中 |

## 6. 次のステップ
- 次にやるべきこと（優先度順）

## 7. 人間に確認が必要な事項
- 判断を仰ぎたい点
```

---

### 12.4 議論モード切替基準（DISC-031承認）

#### 12.4.1 モード定義

| モード | ラウンド数 | 参加者数 | 用途 |
|--------|-----------|---------|------|
| **簡潔** | 1-2 | 3-5名 | 軽微な確認、即答可能な判断 |
| **通常** | 3-5 | 5-8名 | 標準的な議論、機能検討 |
| **徹底** | 10+ | 10名以上 | 重要決定、ルール変更、リスク高 |

#### 12.4.2 自発的発動条件

| 条件 | モード |
|------|--------|
| P0問題の対応 | 徹底 |
| ルール追加・変更 | 徹底 |
| アーキテクチャ変更 | 徹底 |
| データ構造変更 | 徹底 |
| 新機能の設計 | 通常 |
| バグ修正方針 | 通常 |
| 軽微な確認事項 | 簡潔 |
| 既存ルールの適用確認 | 簡潔 |
| **判断に迷う場合** | **通常（デフォルト）** |

#### 12.4.3 Humanからの指示による切替

| 指示 | 解釈 |
|------|------|
| 「議論して」 | 通常モード |
| 「会議して」 | 通常モード |
| 「徹底で」「徹底モードで」 | 徹底モード |
| 「簡単に確認して」 | 簡潔モード |
| 「深く議論して」 | 徹底モード |
| 指示なし（自発的） | 条件に基づき判断 |

#### 12.4.4 モード選択の原則

1. **迷ったら通常モード**: 判断に迷う場合はデフォルトとして通常モードを選択
2. **エスカレート可能**: 議論中に複雑さが判明したら、より深いモードへ移行可
3. **省略不可の条件**: P0問題・ルール変更・データ構造変更は必ず徹底モード

---

## 13. 優先度ルール

### 13.1 優先度の定義

| 優先度 | 説明 | 例 |
|--------|------|-----|
| P0: 最優先 | データ消失・アプリ停止・セキュリティ | データが消える、アプリが動かない |
| P1: 高 | 主要機能の不具合、操作ブロック | 主要機能が正しく動作しない |
| P2: 中 | 軽微なUI崩れ、エラーメッセージ | 表示が崩れる、メッセージが分かりにくい |
| P3: 低 | 改善要望、あると便利な機能 | 操作性向上、新機能追加 |

### 13.2 衝突時の判断基準

| 状況 | 判断 |
|------|------|
| P0とP1が衝突 | P0を優先 |
| 機能追加とバグ修正が衝突 | バグ修正を優先 |
| 2つの機能が衝突 | ユーザー影響が大きい方を優先 |
| 判断できない | 人間に確認 |

### 13.3 基本優先度ルール

1. データの整合性 > 機能の追加
2. 既存機能の維持 > 新機能の実装
3. シンプルな解決策 > 複雑な解決策
4. 安全な方法 > 速い方法

---

## 14. 確認が必要な場面とリスクの定義

### 14.1 リスクレベルの定義

| レベル | 説明 | 例 |
|--------|------|-----|
| 高 | データ削除・既存機能停止・列構成変更・本番影響 | 行削除、シート削除、列名変更 |
| 中 | UI変更・処理速度影響・複数ファイル影響 | 表示変更、パフォーマンス影響 |
| 低 | 新規追加のみ・既存影響なし | 新ファイル追加、ドキュメント更新 |

### 14.2 開発前に必ず確認する項目

- [ ] リスクレベルは何か
- [ ] 影響を受けるファイル・機能は何か
- [ ] ロールバック方法はあるか
- [ ] 完了条件は何か

### 14.3 必ず人間に確認する場面

- 新しいシートを作る時
- 既存の列を削除・変更する時
- 指示書にない機能を追加する時
- 10項目以上の改修をする時
- データが消える可能性がある時
- 判断に迷った時

### 14.4 確認フロー

1. リスクを報告
2. 3者で議論
3. 承認後に実行

### 14.5 重要事項

**開発スピードを落とさないため、開発モードに入る前にリスクと承認を全て回収しておく。開発を進めてから承認を得ることは禁止。**

### 14.6 開発開始時チェックリスト

開発に着手する前に、以下を全て確認する：

- [ ] COMMON_RULES.md を読んだ
- [ ] プロジェクトのCLAUDE.md を読んだ
- [ ] 過去トラを確認した
- [ ] 指示内容を理解した
- [ ] 完了条件を定義した
- [ ] リスクレベルを判定した
- [ ] 必要な承認を得た（リスク高の場合）

---

## 15. 完了の定義

### 15.1 開発着手前チェックリスト
```markdown
## 1. 目的
何を解決するか

## 2. 完了条件（具体的に）
- [ ] ○○画面で○○ボタンを押すと○○が表示される
- [ ] スプレッドシートの○○列が○○に更新される
- [ ] エラーが発生しない

## 3. 影響範囲
- 変更するファイル一覧
- 影響を受ける機能一覧

## 4. リスク
- リスクレベル
- ロールバック方法

## 5. 検証方法
- テストURL確認
- grep確認（0件であること）
```

### 15.2 開発完了報告チェックリスト

- [ ] 完了条件を全て満たした
- [ ] エラーが発生しない
- [ ] スプレッドシートと同期している
- [ ] grepで不要な参照が0件
- [ ] [DEBUG]ログが削除されている

### 15.3 完了報告の内容

1. 実施した内容
2. 変更したファイル一覧
3. テスト結果
4. 残課題（あれば）

---

## 16. 許可される操作（自律実行原則）

### 16.1 基本原則

1. **開発着手前に3者で合意した内容**は、承認を得ずに自律実行してよい
2. **開発中に新たに必要と判断した操作**は、事前に人間に確認する
3. 全プロジェクト共通定義に抵触する操作は禁止

### 16.2 自律実行の判断基準

| 操作 | 指示書に明記あり | 指示書に明記なし |
|------|-----------------|-----------------|
| 新規シート作成 | ✅ 自律実行可 | ❌ 事前確認必須 |
| 列追加（末尾） | ✅ 自律実行可 | ❌ 事前確認必須 |
| 新規ファイル作成 | ✅ 自律実行可 | ❌ 事前確認必須 |
| バグ修正 | ✅ 自律実行可 | △ 条件付き（16.3参照） |
| コードの改善・リファクタ | ✅ 自律実行可 | ❌ 事前確認必須 |

### 16.3 バグ修正の自律実行条件

#### 指示書に明記なしでも自律実行可能な条件

以下を**全て**満たす場合のみ：
- 既存機能の意図した動作を復元する修正である
- 新規機能の追加を伴わない
- データ構造の変更を伴わない
- UI/UXの変更が軽微（エラー表示方法の統一など）

#### 事前確認が必要な場合

- 修正方法が複数考えられる場合
- 影響範囲が広い場合（3ファイル以上に変更が及ぶ）

### 16.4 常に禁止される操作（承認後も慎重に）

- 本番デプロイ（人間の承認後のみ）
- データ削除
- 列削除・列名変更
- 共通定義に反する操作

### 16.5 開発中に「これも必要」と気づいた場合

1. 開発を一時停止
2. 必要な操作とその理由を人間に報告
3. 人間の承認を得る
4. 開発を再開

**禁止**: 「後で確認すればいいや」と独断で進めること

### 16.6 デプロイフロー

1. 実装完了
2. clasp push（テストデプロイ）
3. テストURLで確認
4. 人間に報告
5. 人間がテストURLで確認
6. 人間の承認
7. 本番デプロイ（人間が実行 or 人間の承認後にClaude Codeが実行）

**禁止**: テスト確認なしに本番デプロイすること

### 16.7 不具合発生時

1. 調査モードで原因特定
2. 過去トラに記録
3. 再発防止ルールを共通定義に追加
4. 次回以降は同じ不具合を防ぐ

### 16.8 緊急対応例外

本番環境で以下の状況が発生した場合、事後報告での対応を許可：
- データ損失・破損のリスクがある
- セキュリティ上の脆弱性が発見された
- 基本機能が完全に停止している

**注意事項:**
- 対応後は必ず詳細レポートを提出すること
- 「緊急」の判断に迷う場合は、まず人間に連絡を試みること

### 16.9 ロールバック手順（DISC-029承認）

#### 16.9.1 ロールバックが必要な場面

| 状況 | ロールバック方法 |
|------|-----------------|
| デプロイ後に不具合発覚 | Git + clasp push |
| 本番データ破損 | スプレッドシートのバージョン履歴 |
| 設定変更ミス | Git + 手動復元 |

#### 16.9.2 Gitロールバック手順

```bash
# 1. 直前のコミットを取り消す（履歴を残す方法）
git revert HEAD

# 2. 特定のコミットまで戻る場合
git log --oneline  # コミットIDを確認
git revert [commit-id]

# 3. GASに反映
clasp push

# 4. 動作確認
# テストURLで確認後、問題なければ完了
```

#### 16.9.3 スプレッドシートのバージョン復元

1. スプレッドシートを開く
2. ファイル → 変更履歴 → 変更履歴を表示
3. 復元したいバージョンを選択
4. 「この版を復元」をクリック

**注意**: 復元前に現在の状態をバックアップ（コピー作成）すること

#### 16.9.4 ロールバック後の必須対応

1. 過去トラに記録（何が起きたか、なぜロールバックが必要だったか）
2. 根本原因の調査
3. 再発防止策の策定
4. Humanへの報告

### 16.10 AI自律判断の限界（DISC-029承認）

#### 16.10.1 基本原則

Claude Codeは効率的に自律開発を行うが、以下の場面では**必ずHumanに確認する**。

#### 16.10.2 必ずHumanに確認するリスト

| # | 場面 | 理由 |
|---|------|------|
| 1 | データ構造の変更（列追加・削除・名変更） | 影響範囲が広い |
| 2 | 新規シート作成 | Single Source of Truth原則に影響 |
| 3 | 本番環境への操作 | リスクが高い |
| 4 | 複数の実装方法があり判断に迷う | 技術選択はHumanが決定 |
| 5 | 指示書に明記されていない機能追加 | スコープクリープ防止 |
| 6 | 5回トライしても解決しない問題 | 根本的な方針転換が必要 |
| 7 | セキュリティに関わる変更 | 専門的判断が必要 |
| 8 | 外部API・サービスとの連携追加 | コスト・依存関係の確認 |

#### 16.10.3 判断に迷った場合のデフォルト動作

**「迷ったら止まる」**

1. 作業を一時停止
2. 迷っている点を明文化
3. Humanに確認
4. 承認を得てから続行

**禁止**: 「多分大丈夫だろう」で進めること

#### 16.10.4 自律判断が許可される範囲

| 操作 | 条件 |
|------|------|
| 指示書に明記された実装 | 完了条件が明確な場合 |
| バグ修正（16.3の条件を満たす場合） | 既存機能の復元のみ |
| テストコードの追加 | 既存機能に影響しない場合 |
| ドキュメント更新 | 事実の記録のみ |
| clasp push（開発環境） | テスト目的 |
| clasp run（25.9の条件を満たす場合） | 開発環境のみ |

---

## 17. コード参照ルール

### 17.1 関数・コード参照時の必須フォーマット

Claude Codeが関数やコードを参照する際は、**必ず以下の形式で場所を明示する**。

#### 必須形式

```
ファイル名:行番号
```

#### 例

| ❌ NG | ✅ OK |
|-------|-------|
| `showCurrentEnvironment()を実行` | `Config.gs:89 showCurrentEnvironment()を実行` |
| `getDropdownOptions関数で取得` | `Config.gs:551 getDropdownOptions()で取得` |
| `アサイン処理はAssignServiceで` | `AssignService.gs:45 assignLeadToStaff()で処理` |

### 17.2 関数一覧を提示する場合

表形式で以下を含める:

| 項目 | 必須 |
|------|------|
| 関数名 | ✅ |
| ファイル名 | ✅ |
| 行番号 | ✅ |
| 用途（簡潔に） | 推奨 |

#### 例

| 関数名 | ファイル | 行 | 用途 |
|--------|----------|-----|------|
| `setEnvironment(env)` | Config.gs | 38 | 環境切り替え |
| `showCurrentEnvironment()` | Config.gs | 89 | 現在環境の表示 |
| `getDropdownOptions()` | Config.gs | 551 | プルダウン選択肢取得 |

### 17.3 理由

- GASエディタで即座にジャンプ可能
- 複数ファイルに同名関数がある場合の混乱防止
- コードレビュー・デバッグの効率化

### 17.4 スクリプト実行依頼時のルール

**人間にGASスクリプトの実行を依頼する場合、必ず以下を明記する。**

#### 必須項目

| 項目 | 説明 | 例 |
|------|------|-----|
| ファイル名 | 番号プレフィックス付きファイル名 | `27_WebApp.gs` |
| 関数名 | 実行する関数名 | `diagnoseSheetsStructure()` |
| 環境 | 開発/本番のどちらで実行するか | `開発環境` |

#### 形式例

```
✅ OK:
「27_WebApp.gs の diagnoseSheetsStructure() を開発環境で実行してください」

❌ NG:
「diagnoseSheetsStructure() を実行してください」
```

#### 背景

- 人間は複数のファイルを記憶し続けることが困難
- ファイル名がないと検索に余計な工数がかかる
- 環境の指定がないと誤った環境で実行するリスクがある

**発効日**: 2026-01-14

### 17.5 ファイル番号プレフィックスルール

**GASファイルには必ず2桁の番号プレフィックスを付ける。**

#### 命名規則

```
XX_ファイル名.gs
```

- `XX`: 2桁の番号（01〜99）
- アルファベット順に番号を付与
- 新規ファイル追加時は末尾の番号+1

#### 現在のファイル番号一覧（2026-01-14時点）

| # | ファイル名 | 用途 |
|---|-----------|------|
| 01 | 01_AlertService.gs | アラート機能 |
| 02 | 02_ArchiveService.gs | アーカイブ機能 |
| 03 | 03_AssignService.gs | アサイン機能 |
| 04 | 04_BadgeService.gs | バッジ機能 |
| 05 | 05_BuddyCoachingService.gs | Buddyコーチング |
| 06 | 06_BuddyFeedbackService.gs | Buddyフィードバック |
| 07 | 07_Code.gs | 基本コード |
| 08 | 08_Config.gs | 設定・定数定義 |
| 09 | 09_ConversationArchiveService.gs | 会話アーカイブ |
| 10 | 10_ConversationLogService.gs | 会話ログ |
| 11 | 11_DailyReportService.gs | 日次レポート |
| 12 | 12_DashboardService.gs | ダッシュボード |
| 13 | 13_DealReportService.gs | 商談レポート |
| 14 | 14_DevEnvironmentService.gs | 開発環境サービス |
| 15 | 15_DuplicateDetectionService.gs | 重複検知 |
| 16 | 16_NoticeService.gs | お知らせ |
| 17 | 17_NotificationService.gs | 通知 |
| 18 | 18_ProspectRank.gs | 見込度ランク |
| 19 | 19_ReminderService.gs | リマインダー |
| 20 | 20_ReportService.gs | レポート |
| 21 | 21_SetupDealReport.gs | 商談レポートセットアップ |
| 22 | 22_SetupIntegratedSheet.gs | 統合シートセットアップ |
| 23 | 23_SheetService.gs | シート操作 |
| 24 | 24_ShiftService.gs | シフト管理 |
| 25 | 25_TestRunner.gs | テスト実行 |
| 26 | 26_Triggers.gs | トリガー |
| 27 | 27_WebApp.gs | Webアプリメイン |

#### 新規ファイル追加時

1. 末尾の番号+1を付与（現在は28から開始）
2. この一覧表を更新
3. CLAUDE.mdのファイル参照も更新

**発効日**: 2026-01-14

---

## 18. 用語辞書

### 18.1 基本用語

| 用語 | 定義 |
|------|------|
| リード | まだ商談になっていない見込み客 |
| 商談 | 営業がアサインされた案件 |
| アサイン | リードに営業担当者を割り当てること |
| アーカイブ | 対応終了した案件を保管すること |
| アクティブリード | 進捗ステータスが「アーカイブ」「成約」「失注」以外のリード |

### 18.2 UI用語

| 用語 | 定義 |
|------|------|
| モーダル | 画面中央に出るウィンドウ |
| トースト | 右下から一時的に出る通知 |
| スライドパネル | 右側から出るパネル |

### 18.3 データ用語

| 用語 | 定義 |
|------|------|
| 同期 | 複数の場所で同じデータを表示・更新すること |
| In-place | データを移動せず、その場で状態を変更すること |
| In-placeアーカイブ | 行を削除せず、ステータス変更でアーカイブする方式 |
| Single Source of Truth | データを1箇所に集約し、他は参照のみとする設計原則 |

### 18.4 開発用語

| 用語 | 定義 |
|------|------|
| 自律実行 | 事前確認なしで実行できる作業 |
| grep | ファイル内の文字列を検索するコマンド |
| clasp push | GASコードをテスト環境にデプロイするコマンド |

### 18.5 用語の追加

分からない用語は人間が質問し、Claude/Claude Codeが説明する。合意した用語はこの辞書に追加する。

---

## 19. ルール定義時のフロー

### 19.1 新規ルール追加フロー

1. ルールが必要な理由・背景を説明
2. ルールの案を提示
3. 3者で議論
4. 合意したルールを文書化
5. この文書（COMMON_RULES.md）またはプロジェクトのCLAUDE.mdに追記
6. 更新履歴に記録
7. GitHubにコミット

### 19.2 既存ルール変更フロー

1. 変更が必要な理由・背景を説明
2. 現在のルールと変更後のルールを提示
3. 3者で議論
4. 合意した変更を文書化
5. 更新履歴に変更内容と理由を記録
6. GitHubにコミット

### 19.3 禁止事項

- 1者のみでルールを追加・変更すること
- 議論なしでルールを削除すること
- 更新履歴なしで変更すること

---

## 20. セッション開始時のルール

### 20.1 KGI（達成目標）

| 指標 | 目標値 |
|------|--------|
| ルール違反率 | 0% |
| 過去トラ再発率 | 0% |
| 仕様違反率 | 0% |

### 20.2 読了対象（4ファイル全文読了必須）

Claude/Claude Codeはセッションをまたぐとコンテキストを失う。
**セッション開始時、作業開始前に必ず以下4ファイルを全文読了する。**

| # | ファイル | 効果 | 省略 |
|---|---------|------|------|
| 1 | COMMON_RULES.md | ルール違反0% | 不可 |
| 2 | CLAUDE.md（プロジェクト） | 制約違反0% | 不可 |
| 3 | TROUBLE_LOG.md | 過去トラ再発0% | 不可 |
| 4 | PROJECT_SPECIFICATION.md | 仕様違反0% | 不可 |

**注意**: 要約読み、部分読みは禁止。全文読了のみ許可。

### 20.3 作業別追加読了

上記4ファイルに加え、作業内容に応じたSPECファイルを読了する。

| 作業対象 | 追加読了ファイル |
|---------|-----------------|
| CRMダッシュボード | AI_AGENT_ARCHITECTURE.md |
| エージェント実装 | AGENT_CHARACTER_SPEC.md |
| その他 | 該当するSPEC.md |

### 20.4 読了報告フォーマット（固定）

**作業開始前に必ず以下のフォーマットで報告する。報告なしの作業開始は禁止。**

```markdown
## セッション開始読了報告

| # | ファイル | 行数 | 状態 |
|---|---------|------|------|
| 1 | COMMON_RULES.md | X行 | 全文読了 |
| 2 | CLAUDE.md | X行 | 全文読了 |
| 3 | TROUBLE_LOG.md | X行 | 全文読了 |
| 4 | PROJECT_SPECIFICATION.md | X行 | 全文読了 |

### 過去トラ要注意事項
- TROUBLE-XXX: [該当する可能性のある過去トラ]

### 本セッションの作業内容
[作業内容を記載]
```

### 20.5 運用メンテナンスルール

| ファイル | 更新タイミング | 責任者 |
|---------|---------------|--------|
| COMMON_RULES.md | 新ルール追加時 | 変更者 |
| CLAUDE.md | プロジェクト設定・制約変更時 | 変更者 |
| TROUBLE_LOG.md | 新過去トラ発生時 | 変更者 |
| PROJECT_SPECIFICATION.md | 仕様変更時 | 変更者 |

### 20.6 違反時の対応

1. **ルール違反発生時**: 即座にTROUBLE_LOG.mdに記録
2. **原因分析**: 5Whysで真因を特定
3. **再発防止**: 本セクションまたは関連ルールを更新

---

## 21. 報告・記録ルール

### 21.1 目的

**結論**: 曖昧さを排除し、認識のずれを防ぐため、全ての報告・記録は5W2Hフォーマットを必須とする。

**背景**:
- いつ（When）: 2026-01-15 議論にて定義
- 誰が（Who）: Human（オーナー）の提案、Claude Codeが文書化
- どこで（Where）: COMMON_RULES.mdへ共通ルールとして追加
- 何を（What）: 報告・記録の標準フォーマット
- どうやって（How）: 5W2H + 結論先出しを必須化
- なぜ（Why）: 曖昧な記録は読み返し時に認識のずれを発生させるため
- どれぐらい（How much）: 全プロジェクト、全記録に適用

### 21.2 適用範囲

| 対象 | 適用 |
|------|------|
| 過去トラ（TROUBLE_LOG.md） | ✅ 必須 |
| 会議・議論ログ | ✅ 必須 |
| 開発報告 | ✅ 必須 |
| 引き継ぎ資料 | ✅ 必須 |
| 設計仕様書 | ✅ 必須 |
| コミットメッセージ | △ 簡略化可（Whatのみ可） |
| 会話中の質問・回答 | △ 状況に応じて |

### 21.3 基本フォーマット：5W2H

全ての記録には以下の要素を含める。

| 要素 | 日本語 | 記載内容 | 例 |
|------|--------|----------|-----|
| When | いつ | 日時（YYYY-MM-DD HH:MM形式） | 2026-01-15 14:30 |
| Who | 誰が | 担当者（Human/Claude/Claude Code） | Human（オーナー） |
| Where | どこで | ファイル名:行番号、機能名、画面名 | index.html:7277 renderReminderCards() |
| What | 何を | 事象・内容（具体的に） | リマインダーセクションが空の時に非表示になる |
| How | どうやって | 方法・手順（再現可能な形で） | section.style.display = 'none' を 'block' に変更 |
| Why | なぜ | 理由・原因（5Whysで深掘り） | 空配列の場合に非表示にするロジックが入っていたため |
| How much | どれぐらい | 数値（件数、時間、影響範囲） | 影響ファイル1件、変更行数3行、影響ユーザー全員 |

### 21.4 結論先出しルール

**全ての報告は結論から始める。**

#### 構成

```
【結論】1行で要点を述べる

【詳細】5W2Hで補足
```

#### 例

```
❌ NG（結論が後回し）:
調査したところ、index.html の renderReminderCards() 関数で
reminders.length が 0 の場合に section.style.display = 'none' を
設定していることが分かりました。そのため、リマインダーセクションが
表示されていませんでした。

✅ OK（結論先出し）:
【結論】リマインダーセクションが非表示になる原因は、空配列時に
display: none を設定するロジックがあったため。修正済み。

【詳細】
- いつ: 2026-01-15 14:30
- どこで: index.html:7277 renderReminderCards()
- 何が: reminders.length === 0 の場合に section.style.display = 'none' を設定
- どうやって: 'none' を 'block' に変更し、空状態メッセージを追加
- なぜ: 0件でも「予定なし」と表示して常に存在を認識させるため
- どれぐらい: 1ファイル3行の変更、全ユーザーに影響
```

### 21.5 数値化必須項目

曖昧な表現を禁止し、具体的な数値を使用する。

| ❌ 禁止表現 | ✅ 正しい表現 |
|------------|--------------|
| 複数のファイル | 3件（Config.gs, WebApp.gs, index.html） |
| しばらく | 14日間（2026/01/01〜2026/01/14） |
| 多くのユーザー | 全ユーザー（約50名） |
| 少し前 | 2時間前（14:30時点） |
| だいたい完了 | 80%完了（残り2タスク） |
| 近日中 | 2026-01-20までに |

### 21.6 記録テンプレート

#### 会議・議論ログ

```markdown
## [議題タイトル]

### 結論
（1-2文で結論）

### 5W2H詳細
- いつ: YYYY-MM-DD HH:MM
- 誰が: 参加者（Human, Claude, Claude Code）
- どこで: 記録ファイル名
- 何を: 議題内容
- どうやって: 決定プロセス
- なぜ: 決定理由
- どれぐらい: 影響範囲・規模

### 決定事項
1. （決定事項1）
2. （決定事項2）

### 次のアクション
- [ ] タスク1（担当者、期限）
- [ ] タスク2（担当者、期限）
```

#### 開発報告

```markdown
## 開発報告: [タスク名]

### 結論
（完了/進行中/ブロック）+ 1行サマリー

### 5W2H詳細
- いつ: 作業日時
- 誰が: 担当者
- どこで: 変更ファイル一覧
- 何を: 変更内容
- どうやって: 実装方法
- なぜ: 変更理由
- どれぐらい: 変更規模（ファイル数、行数）

### テスト結果
- 確認項目と結果

### 残課題
- （あれば記載）
```

### 21.7 禁止事項

| 禁止 | 理由 | 代替 |
|------|------|------|
| 数値なしの報告 | 認識のずれが発生 | 必ず数値を含める |
| 結論が後回し | 読み手の時間を浪費 | 結論を先に述べる |
| 曖昧な日時表現 | 特定不可能 | YYYY-MM-DD HH:MM形式 |
| 「〜のあたり」という場所指定 | 特定不可能 | ファイル名:行番号 |
| 主語の省略 | 責任の曖昧化 | Human/Claude/Claude Code を明記 |

### 21.8 レビュー基準

報告・記録のレビュー時は以下をチェックする。

| チェック項目 | 基準 |
|--------------|------|
| 結論の有無 | 最初の1-2行に結論があるか |
| 5W2Hの網羅 | 7項目全てが埋まっているか |
| 数値の有無 | 各項目に具体的な数値があるか |
| 日時フォーマット | YYYY-MM-DD HH:MM形式か |
| 場所の特定 | ファイル名:行番号が明記されているか |

---

## 22. 記録保存ルール

### 22.1 目的（5W2H）

| 項目 | 内容 |
|------|------|
| **いつ** | 2026-01-15 議論にて定義 |
| **誰が** | Human（提案）+ Claude Code（文書化） |
| **どこで** | 全プロジェクト共通 |
| **何を** | 全ての記録・ログ・ドキュメントの保存先 |
| **どうやって** | GitHubリポジトリに集約 |
| **なぜ** | PDCA効率化、復元可能性、原因特定、データ保全 |
| **どれぐらい** | 全記録100%をGitHubに保存 |

### 22.2 GitHubに保存する理由

| メリット | 具体的効果 |
|----------|-----------|
| **PDCA効率化** | バージョンごとに効果測定可能 |
| **復元可能** | 不具合発生時に任意のバージョンへロールバック |
| **原因特定** | `git diff`で差分チェック→原因特定が容易 |
| **データ保全** | ローカル障害（PC故障等）でもデータ消失しない |
| **履歴追跡** | 誰が・いつ・何を変更したか完全に記録 |

### 22.3 保存対象

| 対象 | 必須 | 例 |
|------|------|-----|
| ソースコード | ✅ | .gs, .html, .json |
| ドキュメント | ✅ | .md（CLAUDE.md, TROUBLE_LOG.md等） |
| 設定ファイル | ✅ | .clasp.json, appsscript.json |
| 議論ログ | ✅ | 各種ログファイル |

### 22.4 禁止事項

| 禁止 | 理由 |
|------|------|
| ローカルのみでの記録保存 | データ消失リスク、履歴追跡不可 |
| commit後のpush忘れ | GitHubに反映されず意味がない |
| 長期間のpush未実施 | 差分が大きくなりすぎてレビュー困難 |

### 22.5 推奨頻度

| タイミング | 操作 |
|------------|------|
| 機能実装完了時 | commit + push |
| 不具合修正完了時 | commit + push |
| ドキュメント更新時 | commit + push |
| 1日の作業終了時 | 未pushがあれば必ずpush |

---

## 23. 機密情報管理ルール

### 23.1 目的（5W2H）

| 項目 | 内容 |
|------|------|
| **いつ** | 2026-01-15 議論にて定義 |
| **誰が** | 全開発者（Human, Claude, Claude Code） |
| **どこで** | 全プロジェクト共通 |
| **何を** | 機密情報の管理方法 |
| **どうやって** | .gitignore、環境変数、PropertiesService |
| **なぜ** | 情報漏洩防止、セキュリティ確保 |
| **どれぐらい** | 遵守率100%必須（例外なし） |

### 23.2 機密情報の定義

| レベル | 内容 | 例 | 漏洩時の影響 |
|--------|------|-----|-------------|
| **最高機密** | 認証情報・API鍵 | パスワード, APIキー, トークン, 秘密鍵 | システム乗っ取り、不正アクセス |
| **高機密** | 個人情報・顧客データ | 氏名, 電話番号, メールアドレス, 住所 | 法的責任、信用失墜 |
| **中機密** | 内部URL・ID | スプレッドシートID, デプロイID | 不正アクセスの手がかり |

### 23.3 禁止事項（絶対遵守）

| # | 禁止事項 | 理由 |
|---|----------|------|
| 1 | パスワード・APIキー・トークンをコードに直書き | 履歴に残り削除困難 |
| 2 | 顧客の個人情報をGitHubにpush | 法的責任、GDPR/個人情報保護法違反 |
| 3 | .envファイルをGitHubにpush | 認証情報漏洩 |
| 4 | 機密情報を含むログの出力 | ログ経由での漏洩 |
| 5 | 機密情報のSlack/チャット共有 | 第三者閲覧リスク |

### 23.4 必須対応

| # | 対応 | 方法 |
|---|------|------|
| 1 | 機密情報は環境変数で管理 | GAS: PropertiesService使用 |
| 2 | .gitignoreに機密ファイルを登録 | 下記テンプレート参照 |
| 3 | 誤pushした場合の即時対応 | 履歴から削除 + 認証情報再発行 |

### 23.5 .gitignore必須項目

```gitignore
# 環境変数・認証情報
.env
.env.local
.env.*.local

# 認証ファイル
credentials.json
*_secret*
*.pem
*.key

# IDE・エディタ
.idea/
.vscode/
*.swp

# OS生成ファイル
.DS_Store
Thumbs.db

# ログファイル（機密情報を含む可能性）
*.log
logs/
```

### 23.6 GASでの機密情報管理方法

```javascript
// ❌ NG: 直書き
const API_KEY = "sk-xxxxxxxxxxxxx";

// ✅ OK: PropertiesService使用
const API_KEY = PropertiesService.getScriptProperties().getProperty('API_KEY');
```

### 23.7 誤push時の対応手順

| 手順 | 操作 | コマンド例 |
|------|------|-----------|
| 1 | 即座に認証情報を無効化 | 各サービスの管理画面で再発行 |
| 2 | Gitの履歴から削除 | `git filter-branch` または BFG Repo-Cleaner |
| 3 | 強制push | `git push --force`（要Human承認） |
| 4 | 過去トラに記録 | 再発防止のため |

---

## 24. 開発ワークフロー

### 24.1 目的（5W2H）

| 項目 | 内容 |
|------|------|
| **いつ** | 2026-01-15 議論にて定義 |
| **誰が** | 全開発者 |
| **どこで** | 全プロジェクト共通 |
| **何を** | 開発からGitHub記録までの標準フロー |
| **どうやって** | ローカル開発→テスト→GitHub記録 |
| **なぜ** | トークン効率化、開発速度向上、データ保全の両立 |
| **どれぐらい** | 全開発作業に適用 |

### 24.2 標準ワークフロー

```
┌─────────────────────────────────────────────────┐
│  1. ローカルで開発                              │
│     - ファイル編集（Read tool使用）             │
│     - トークン効率◎、速度◎                    │
│         ↓                                       │
│  2. clasp push（テストデプロイ）                │
│     - GASテスト環境に反映                       │
│         ↓                                       │
│  3. テストURL確認                               │
│     - 動作確認、不具合チェック                  │
│         ↓                                       │
│  4. 開発完了判定                                │
│     - 完了条件を満たしているか確認              │
│         ↓                                       │
│  5. git commit                                  │
│     - 変更内容をローカルリポジトリに記録        │
│         ↓                                       │
│  6. git push                                    │
│     - GitHubに反映（バックアップ完了）          │
└─────────────────────────────────────────────────┘
```

### 24.3 各ステップの詳細

| ステップ | 操作 | 目的 |
|----------|------|------|
| ローカル開発 | エディタ/Claude Code | 高速開発、トークン効率化 |
| clasp push | `clasp push` | GASへのテストデプロイ |
| テスト確認 | テストURL閲覧 | 動作検証 |
| commit | `git add . && git commit -m "..."` | ローカル履歴記録 |
| push | `git push` | GitHub反映・バックアップ |

### 24.4 commit メッセージ規約

| プレフィックス | 用途 | 例 |
|---------------|------|-----|
| `feat:` | 新機能追加 | `feat: ログインボーナス機能を追加` |
| `fix:` | バグ修正 | `fix: リマインダー非表示問題を修正` |
| `docs:` | ドキュメント | `docs: COMMON_RULES.mdに機密情報ルール追加` |
| `refactor:` | リファクタリング | `refactor: 認証処理を共通化` |
| `style:` | スタイル変更 | `style: インデント修正` |
| `chore:` | その他 | `chore: ファイル名に番号プレフィックス追加` |

### 24.5 ローカル vs GitHub の使い分け

| 場面 | 使用先 | 理由 |
|------|--------|------|
| 開発中のファイル読み込み | ローカル | 高速、トークン効率◎ |
| 過去バージョンの参照 | GitHub | 履歴から取得 |
| バックアップ・共有 | GitHub | データ保全 |
| 緊急時の復元 | GitHub | ロールバック可能 |

### 24.6 禁止事項

| 禁止 | 理由 |
|------|------|
| pushせずに1日以上放置 | データ消失リスク |
| テスト未実施でのcommit | 不具合混入リスク |
| 意味のないcommit分割 | 履歴が煩雑に |
| 巨大な1commitに全部入れ | レビュー困難 |

---

## 25. clasp自律開発環境

### 25.1 目的（5W2H）

| 項目 | 内容 |
|------|------|
| **いつ** | 2026-01-15 設定完了 |
| **誰が** | Human + Claude Code |
| **どこで** | 全GASプロジェクト共通 |
| **何を** | Claude Codeによる自律開発環境の構築 |
| **どうやって** | clasp push + clasp run の設定 |
| **なぜ** | 開発スピード・PDCA精度の最大化 |
| **どれぐらい** | 開発効率3-5倍向上 |

### 25.2 自律開発能力

| 能力 | コマンド | 状態 | 用途 |
|------|----------|------|------|
| コードデプロイ | `clasp push` | ✅ 可能 | GASへ即時反映 |
| 関数実行（基本） | `clasp run [関数名]` | ✅ 可能 | 基本テスト実行 |
| 関数実行（SS連携） | `clasp run [関数名]` | ✅ 可能 | WebApp経由または直接実行 |
| 関数実行（削除系） | `clasp run runWithSnapshot [関数名]` | △ 条件付き | 25.10参照 |
| バージョン管理 | `git commit/push` | ✅ 可能 | GitHub記録 |

### 25.3 超自律開発フロー

```
┌─────────────────────────────────────────────────┐
│  Claude Code 超自律開発モード                   │
├─────────────────────────────────────────────────┤
│  1. ローカルでコード編集                        │
│         ↓                                       │
│  2. clasp push（自動デプロイ）                  │
│         ↓                                       │
│  3. clasp run testXxx（基本テスト自動実行）     │
│         ↓                                       │
│  4. テストURL確認（SS連携はHuman確認）          │
│         ↓                                       │
│  5. 問題あれば修正 → 2に戻る                    │
│         ↓                                       │
│  6. git commit & push（GitHub記録）             │
└─────────────────────────────────────────────────┘
```

### 25.4 初期設定（プロジェクト作成時のみ）

新規GASプロジェクトでclasp runを有効化する手順：

| ステップ | 作業者 | 内容 |
|----------|--------|------|
| 1 | Human | GCPプロジェクト作成 |
| 2 | Human | OAuth同意画面設定 |
| 3 | Human | Apps Script API有効化 |
| 4 | Human | GAS-GCP紐付け（プロジェクト番号入力） |
| 5 | Human | OAuth認証情報作成 → creds.json取得 |
| 6 | Claude Code | `clasp login --creds creds.json` |
| 7 | Human | API実行可能デプロイ作成 |
| 8 | Claude Code | appsscript.json に executionApi 追加 |

### 25.5 appsscript.json 必須設定

```json
{
  "executionApi": {
    "access": "MYSELF"
  },
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/userinfo.email"
  ]
}
```

### 25.6 運用ルール

| ルール | 内容 |
|--------|------|
| 新関数追加時 | API実行可能デプロイを更新（Human作業） |
| creds.json | .gitignoreに追加必須（機密情報） |
| テスト関数 | スプレッドシート不要の `testXxx()` を用意 |

### 25.7 制限事項

| 制限 | 原因 | 回避策 |
|------|------|--------|
| clasp runでSS連携 | OAuth設定により可能 | WebApp経由または直接実行（25.9参照） |
| 削除系関数の直接実行 | データ損失リスク | runWithSnapshot()経由で実行（25.10参照） |
| 本番環境でのclasp run | 本番データ保護 | 開発環境のみ許可 |
| 新関数の即時実行不可 | デプロイ更新が必要 | clasp deploy後に実行 |
| **GAS実行時間制限** | 6分でタイムアウト | 処理分割（25.7.2参照） |

#### 25.7.1 clasp run vs WebApp経由の選択基準（DISC-029承認）

| 用途 | 推奨方法 | 理由 |
|------|---------|------|
| 単純なテスト関数 | `clasp run` | 高速、シンプル |
| スプレッドシート読み書き | `clasp run` | 直接実行可能（OAuth設定済み） |
| UI操作を含む処理 | WebApp経由 | `clasp run`ではUIが動作しない |
| ユーザー認証が必要な処理 | WebApp経由 | Session情報が必要 |
| 削除系関数 | `clasp run runWithSnapshot` | 変更検知必須 |
| デバッグ・ログ確認 | `clasp run` | Logger.log出力が取得可能 |

#### 25.7.2 GAS 6分制限への対策（DISC-029承認）

GASスクリプトは**6分を超えると強制タイムアウト**となる。

##### 対策1: 処理分割

```javascript
// ❌ NG: 大量データを一度に処理
function processAllData() {
  const data = getAllData();  // 10万行
  data.forEach(row => heavyProcess(row));  // タイムアウト
}

// ✅ OK: バッチ処理で分割
function processDataBatch(startRow, batchSize) {
  const data = getDataRange(startRow, batchSize);  // 1000行ずつ
  data.forEach(row => heavyProcess(row));
  return { processed: batchSize, nextStart: startRow + batchSize };
}
```

##### 対策2: トリガーによる継続実行

```javascript
// 時間ベーストリガーで継続
function continueProcess() {
  const state = PropertiesService.getScriptProperties().getProperty('processState');
  // 前回の続きから処理
}
```

##### 対策3: 処理時間モニタリング

```javascript
function monitoredProcess() {
  const startTime = new Date();
  const MAX_RUNTIME = 5 * 60 * 1000;  // 5分（余裕を持って）

  while (hasMoreWork()) {
    if (new Date() - startTime > MAX_RUNTIME) {
      saveProgress();  // 途中保存
      return { status: 'partial', remaining: getRemainingCount() };
    }
    doWork();
  }
  return { status: 'complete' };
}
```

##### 警告サイン

以下の場合はタイムアウトリスクを検討：
- 1000行以上のデータ処理
- 外部API呼び出しを含むループ
- 複数シートへの書き込み
- 画像・ファイル処理

### 25.8 効果

| 指標 | Before | After |
|------|--------|-------|
| コード反映 | Human依頼 → 待ち時間 | 即時（clasp push） |
| 基本テスト | Human依頼 | 自動（clasp run） |
| PDCAサイクル | 1回/依頼 | 5回/自律 |
| 開発スピード | 1x | 3-5x |

### 25.8.1 clasp push確認チェックリスト（DISC-031承認）

#### 実行前チェック

| # | 確認項目 | 確認方法 | 必須 |
|---|---------|---------|------|
| 1 | 変更内容の確認 | `git diff` または `git status` | ✅ |
| 2 | 構文エラーなし | エディタのエラー表示確認 | ✅ |
| 3 | 機密情報なし | grep検索（API_KEY, password, secret等） | ✅ |
| 4 | [DEBUG]ログ配置 | 必要に応じて追加 | △ |
| 5 | ファイル漏れなし | 変更予定ファイルの確認 | ✅ |

#### 実行後チェック

| # | 確認項目 | 確認方法 | 必須 |
|---|---------|---------|------|
| 1 | push成功 | 「Pushed N files.」メッセージ確認 | ✅ |
| 2 | ファイル数一致 | 想定数との比較 | ✅ |
| 3 | テストURL動作 | ブラウザで画面が開くか | ✅ |
| 4 | コンソールエラーなし | DevTools（F12）で確認 | ✅ |
| 5 | 主要機能動作 | 手動テスト（ボタン押下、データ表示等） | ✅ |
| 6 | [DEBUG]ログ確認 | ログ出力の確認 | △ |

#### エラー時の対応

| エラー種別 | 対応 |
|-----------|------|
| 構文エラー | ローカルで修正 → 再push |
| 認証エラー | `clasp login` 再実行 |
| ファイルサイズ超過 | ファイル分割を検討 |
| 3回連続失敗 | Humanに報告 |

### 25.9 clasp run自律実行ルール（DISC-027/028承認）

#### 25.9.1 基本方針

| 項目 | 内容 |
|------|------|
| **承認日** | 2026-01-15（DISC-027/028） |
| **目的** | 開発効率の最大化とリスクの最小化の両立 |
| **方式** | ブラックリスト制 + 自動検知ハイブリッド |

#### 25.9.2 許可される操作

| 関数種別 | 開発環境 | 本番環境 | 条件 |
|----------|---------|---------|------|
| 読み取り系 | ✅ 許可 | ❌ 禁止 | なし |
| 書き込み系 | ✅ 許可 | ❌ 禁止 | なし |
| 削除系 | ✅ 条件付き許可 | ❌ 禁止 | runWithSnapshot()経由 |

#### 25.9.3 ブラックリスト（削除系関数の定義）

以下のキーワードを含む関数名は「削除系関数」とみなす：

```
delete, remove, clear, drop, cleanup, purge, reset, destroy, truncate
```

例：
- `deleteRow()` → 削除系
- `removeTestData()` → 削除系
- `clearCache()` → 削除系
- `insertBadgeTestData()` → 非削除系（許可）
- `runAllTests()` → 非削除系（許可）

### 25.10 削除系関数の実行ルール

#### 25.10.1 必須条件

削除系関数をclasp runで実行する場合、以下を**全て**満たすこと：

1. **開発環境**である
2. **runWithSnapshot()**経由で実行する
3. **変更検知結果**を必ず確認する
4. **意図した変更のみ**であることを確認する

#### 25.10.2 実行フロー（品質ゲート）

```
┌──────────────────────────────────────────────────────┐
│  削除系関数実行フロー                                 │
├──────────────────────────────────────────────────────┤
│                                                      │
│  1. clasp run runWithSnapshot [関数名]               │
│         │                                            │
│         ▼                                            │
│  ┌─────────────────────────────────────┐            │
│  │ 品質ゲート1: 実行前スナップショット │            │
│  │ - 行数、列数、ヘッダー記録          │            │
│  │ - データハッシュ計算                │            │
│  └─────────────────────────────────────┘            │
│         │                                            │
│         ▼                                            │
│  2. 関数実行                                         │
│         │                                            │
│         ▼                                            │
│  ┌─────────────────────────────────────┐            │
│  │ 品質ゲート2: 実行後比較             │            │
│  │ - スナップショット比較              │            │
│  │ - 変更内容をログ出力                │            │
│  └─────────────────────────────────────┘            │
│         │                                            │
│         ▼                                            │
│  3. Claude Code確認（軽量チェック）                  │
│     - 意図した変更か？ → YES → 続行                 │
│                       → NO → 停止・報告             │
│                                                      │
└──────────────────────────────────────────────────────┘
```

#### 25.10.3 禁止事項

| # | 禁止事項 | 理由 |
|---|----------|------|
| 1 | runWithSnapshot()を経由しない削除系関数の直接実行 | 変更検知ができない |
| 2 | 変更検知結果の確認なしでの続行 | 気づかないデータ破損リスク |
| 3 | 本番環境での削除系関数実行 | 本番データ損失リスク |

#### 25.10.4 違反時の対応

1. 即時停止
2. Humanに報告
3. 過去トラに記録
4. 原因分析と再発防止策の策定

### 25.11 clasp run確認チェックリスト（DISC-031改訂）

#### 25.11.1 実行前チェック

| # | 確認項目 | 確認方法 | 必須 |
|---|---------|---------|------|
| 1 | 環境確認 | 開発環境であること | ✅ |
| 2 | 関数名確認 | 正しい関数名か | ✅ |
| 3 | 削除系判定 | isDeleteFunction()でチェック | ✅ |
| 4 | 引数確認 | 必要な引数が揃っているか | ✅ |
| 5 | デプロイ更新 | 新関数の場合は更新必要（Human依頼） | △ |

#### 25.11.2 実行後チェック

| # | 確認項目 | 確認方法 | 必須 |
|---|---------|---------|------|
| 1 | 戻り値確認 | success: true か | ✅ |
| 2 | エラーなし | Exception がないか | ✅ |
| 3 | 変更検知確認 | compareSnapshots結果（削除系のみ） | △ |
| 4 | 意図した結果 | 期待値との比較 | ✅ |
| 5 | 副作用なし | 関連データの確認 | ✅ |

#### 25.11.3 エラー発生時の対応

| エラー種別 | 対応 |
|-----------|------|
| 関数未定義 | デプロイ更新をHumanに依頼 |
| 権限エラー | OAuth設定確認 |
| タイムアウト | 処理分割を検討（25.7.2参照） |
| ランタイムエラー | コード修正 → 再push → 再run |
| 3回連続失敗 | Humanに報告 |

#### 25.11.4 重要事項

**clasp run前後のチェックは、clasp push後のテストURL確認と同等の重要性を持つ。省略は禁止。**

### 25.12 runWithSnapshot()仕様

#### 25.12.1 機能概要

| 項目 | 内容 |
|------|------|
| 目的 | 削除系関数実行前後のデータ状態を自動比較 |
| 入力 | 関数名、引数 |
| 出力 | 実行結果、変更検知結果、Before/Afterスナップショット |

#### 25.12.2 スナップショット取得対象

| 対象 | 内容 |
|------|------|
| 行数 | 各シートの最終行 |
| 列数 | 各シートの最終列 |
| ヘッダー | 1行目の値 |
| データハッシュ | 全データのMD5ハッシュ |

#### 25.12.3 変更検知出力形式

```
【変更検知】
- リード管理: 行数変更 105 → 100（-5行）
- 担当者マスタ: 変更なし
- 目標設定: 行数変更 12 → 11（-1行）
```

### 25.13 テストアカウント（DISC-031承認）

#### 25.13.1 全プロジェクト共通テストアカウント

| 項目 | 内容 |
|------|------|
| **メールアドレス** | highlifejpn@gmail.com |
| **用途** | WebApp動作確認、UI確認、機能テスト |
| **適用範囲** | 全プロジェクト共通 |

#### 25.13.2 使用ルール

| # | ルール | 理由 |
|---|--------|------|
| 1 | テスト目的のみ使用 | 目的外使用防止 |
| 2 | 本番データへのアクセス禁止 | データ保護 |
| 3 | パスワードはPropertiesServiceで管理 | セキュリティ |
| 4 | アカウント情報のGitHub pushは禁止 | 漏洩防止 |
| 5 | テストデータはTEST-プレフィックスで識別 | 混入防止 |

#### 25.13.3 テスト時のログイン手順

1. テストURL（開発環境）にアクセス
2. Googleログイン画面で `highlifejpn@gmail.com` を入力
3. ログイン完了後、機能テストを実施
4. テストデータ投入時は `TEST-` プレフィックスを使用

#### 25.13.4 テストデータの管理

| データ種別 | プレフィックス | 例 |
|-----------|--------------|-----|
| スタッフID | TEST-STF- | TEST-STF-001 |
| リードID | TEST-LDI- | TEST-LDI-001 |
| 目標ID | GOAL-TEST- | GOAL-TEST-001 |

**重要**: テスト完了後は `removeTestData()` でテストデータを削除すること

---

## 26. 障害対応フロー（DISC-029承認）

### 26.1 目的（5W2H）

| 項目 | 内容 |
|------|------|
| **いつ** | 2026-01-15 DISC-029にて定義 |
| **誰が** | 全開発者（Human, Claude, Claude Code） |
| **どこで** | 全プロジェクト共通 |
| **何を** | 障害発生時の対応フローとエスカレーション |
| **どうやって** | 障害レベル別の対応手順 |
| **なぜ** | 迅速な障害対応と被害最小化 |
| **どれぐらい** | 全障害に適用 |

### 26.2 障害レベル定義

| レベル | 名称 | 定義 | 例 |
|--------|------|------|-----|
| **L0** | 緊急 | サービス完全停止、データ損失 | アプリが開かない、データが消えた |
| **L1** | 重大 | 主要機能停止、業務に支障 | 保存ができない、一部画面がエラー |
| **L2** | 中程度 | 一部機能不具合、回避策あり | 表示崩れ、特定操作でエラー |
| **L3** | 軽微 | 軽微な不具合、業務影響なし | 誤字、色ずれ |

### 26.3 エスカレーションフロー

```
┌─────────────────────────────────────────────────────────┐
│  障害発生                                               │
│      │                                                  │
│      ▼                                                  │
│  ┌─────────────────┐                                   │
│  │ 障害レベル判定   │                                   │
│  └─────────────────┘                                   │
│      │                                                  │
│      ├── L0（緊急）──→ 即時Humanに連絡                 │
│      │                   作業中断、復旧最優先           │
│      │                                                  │
│      ├── L1（重大）──→ 30分以内にHumanに報告           │
│      │                   調査と並行で報告               │
│      │                                                  │
│      ├── L2（中程度）─→ 次回報告時にHumanに共有        │
│      │                   自律で調査・修正可             │
│      │                                                  │
│      └── L3（軽微）──→ 修正完了後に報告               │
│                         自律で対応可                    │
└─────────────────────────────────────────────────────────┘
```

### 26.4 障害対応手順

#### L0（緊急）対応

1. **即時停止**: 追加の操作を全て停止
2. **Humanに連絡**: 状況を簡潔に報告
3. **証拠保全**: エラーメッセージ、ログをコピー
4. **復旧作業**: Humanの指示に従う
5. **事後対応**: 過去トラ記録、再発防止策

#### L1（重大）対応

1. **影響範囲特定**: 何が動かないか確認
2. **30分以内報告**: 状況、影響範囲、初期仮説を報告
3. **調査継続**: 原因特定に努める
4. **修正案提示**: 複数案があれば提示
5. **Human承認後に修正**

#### L2/L3対応

1. **自律で調査・修正**
2. **完了後に報告**
3. **過去トラ記録（L2の場合）**

### 26.5 報告フォーマット（障害用）

```markdown
## 障害報告: [タイトル]

### 結論
障害レベル: L0/L1/L2/L3
現在の状態: 発生中/調査中/修正済み

### 5W2H
- いつ: 発生日時
- どこで: 発生箇所（ファイル:行番号）
- 何が: 発生事象
- どうやって: 再現手順
- なぜ: 原因（判明していれば）
- どれぐらい: 影響範囲（ユーザー数、機能数）

### 対応状況
- 実施済み: [対応内容]
- 次のアクション: [予定]

### 必要な判断
（Humanに判断を仰ぐ点があれば記載）
```

### 26.6 clasp push/run失敗時の対応

#### clasp push失敗時

| エラー種別 | 対応 |
|-----------|------|
| 構文エラー | ローカルで修正 → 再push |
| 認証エラー | `clasp login` 再実行 |
| ファイルサイズ超過 | ファイル分割を検討 |
| 3回連続失敗 | Humanに報告 |

#### clasp run失敗時

| エラー種別 | 対応 |
|-----------|------|
| 関数が見つからない | デプロイ更新をHumanに依頼 |
| 権限エラー | OAuth設定確認 |
| ランタイムエラー | コード修正 → 再push → 再run |
| タイムアウト | 処理分割を検討 |

---

## 27. データ保持・レビュールール（DISC-029承認）

### 27.1 データ保持期間

| データ種別 | 保持期間 | 理由 | 保管場所 |
|-----------|---------|------|---------|
| ソースコード | 無期限 | 復元可能性の確保 | GitHub |
| 過去トラ（TROUBLE_LOG.md） | 無期限 | 学習・再発防止 | GitHub |
| 議論ログ（DISCUSSION_LOG.md） | 無期限 | 意思決定の経緯 | GitHub |
| コミット履歴 | 無期限 | 変更追跡 | GitHub |
| デバッグログ | 30日 | 調査用 | ローカル/GAS |
| テストデータ | 使用後削除 | 本番混入防止 | スプレッドシート |

### 27.2 ドキュメントレビュー頻度

| ドキュメント | レビュー頻度 | レビュー内容 | 担当 |
|-------------|-------------|-------------|------|
| COMMON_RULES.md | 月次（任意） | 陳腐化チェック、新ルール必要性 | 3者 |
| CLAUDE.md | 週次（任意） | プロジェクト状況との整合性 | 3者 |
| TROUBLE_LOG.md | 問題発生時 | 類似事例の確認 | Claude Code |
| API仕様書 | 変更時 | 最新化 | Claude Code |

### 27.3 陳腐化対策

#### 陳腐化の兆候

| 兆候 | 対応 |
|------|------|
| ルールが守られていない | ルールの実効性を再評価 |
| 例外が多発 | ルール見直しを検討 |
| 技術的に不可能になった | ルール削除または更新 |
| 新しい技術/手法で代替可能 | ルール更新を提案 |

#### 廃止ルール

不要になったルールは削除せず、以下のように記録：

```markdown
### [廃止] 旧ルール名

**廃止日**: YYYY-MM-DD
**廃止理由**: [理由]
**代替ルール**: [新しいルールへの参照]
```

### 27.4 トークン使用量監視

#### 監視目的

Claude Code利用時のトークン消費を把握し、効率的な開発を実現する。

#### 監視指標

| 指標 | 説明 | 目安 |
|------|------|------|
| セッションあたり消費量 | 1セッションで使用したトークン数 | 参考値として記録 |
| タスクあたり消費量 | 1タスク完了に使用したトークン数 | 効率評価用 |
| 読み込みトークン | ファイル読み込み等の入力トークン | 最適化対象 |
| 出力トークン | 生成したコード・レスポンス | 品質評価用 |

#### 効率化の指針

| 方法 | 効果 |
|------|------|
| 必要なファイルのみ読み込む | 入力トークン削減 |
| 冗長な説明を避ける | 出力トークン削減 |
| 事前にスコープを明確化 | 無駄な探索を防止 |
| 過去セッションの引き継ぎ情報活用 | 再読み込み削減 |

#### アラート閾値（参考）

現時点では具体的な閾値を設けず、傾向を観察する。
異常な消費パターンが見られた場合は3者で議論する。

---

## 28. ファイル配置ルール（DISC-032承認）

### 28.1 目的（5W2H）

| 項目 | 内容 |
|------|------|
| **いつ** | 2026-01-15 DISC-032にて定義 |
| **誰が** | 全開発者（Human, Claude, Claude Code） |
| **どこで** | 全プロジェクト共通 |
| **何を** | ファイル・ドキュメントの配置ルール |
| **どうやって** | 共通/固有の分類に基づくディレクトリ構造 |
| **なぜ** | 重複防止、参照の一貫性、保守性向上 |
| **どれぐらい** | 全ファイルに適用 |

### 28.2 ディレクトリ構造

```
sales-ops-with-claude/
├── CLAUDE.md                    # エントリーポイント
├── README.md
├── .gitignore
│
├── docs/                        # 全ドキュメント
│   ├── 00_common/               # ★ 全プロジェクト共通
│   │   ├── COMMON_RULES.md
│   │   ├── AI_AGENT_ARCHITECTURE.md
│   │   ├── AGENT_*.md
│   │   ├── UI_UX_GUIDELINES.md
│   │   ├── THREE_ENVIRONMENT_SETUP.md  # 3環境構築ガイド
│   │   ├── PROJECT_PROPOSALS/          # 開発提案記録
│   │   │   ├── PROJECT_INDEX.md
│   │   │   └── DISC-XXX_*.md
│   │   └── ...
│   │
│   ├── 01_crm/                  # CRMプロジェクト固有
│   ├── 02_transaction/          # 取引管理固有
│   ├── 03_inventory/            # 在庫管理固有
│   └── ...
│
├── environments/                # ★ 環境管理（3環境システム）
│   ├── env-config.json          # 環境設定
│   └── sync-env.sh              # 環境同期スクリプト
│
├── crm-dashboard/               # CRM本番環境（PROD）
├── crm-dashboard-dev/           # CRM開発環境（DEV）
├── crm-dashboard-prop/          # CRM提案環境（PROP）
├── conversation-log/            # 会話ログコード
├── recruitment-diagnosis/       # 採用診断コード
└── sales-training/              # 営業教育コード
```

### 28.3 共通ファイルの配置（docs/00_common/）

| ファイル種別 | 配置先 | 例 |
|-------------|--------|-----|
| 全プロジェクト共通ルール | docs/00_common/ | COMMON_RULES.md |
| エージェント仕様 | docs/00_common/ | AGENT_*.md |
| AIアーキテクチャ | docs/00_common/ | AI_AGENT_ARCHITECTURE.md |
| 共通UIガイドライン | docs/00_common/ | UI_UX_GUIDELINES.md |
| 共通開発ガイド | docs/00_common/ | GAS_WEBAPP_GUIDE.md |
| 共通トラブルシューティング | docs/00_common/ | TROUBLESHOOTING.md |
| 共通改善ログ | docs/00_common/ | IMPROVEMENT_LOG.md |
| データ収集仕様 | docs/00_common/ | DATA_COLLECTION_SPEC.md |

### 28.4 プロジェクト固有ファイルの配置（docs/[project_code]/）

| ファイル種別 | 配置先 | 例 |
|-------------|--------|-----|
| プロジェクト固有仕様 | docs/[project_code]/ | SPEC.md |
| プロジェクト固有過去トラ | docs/[project_code]/ | TROUBLE_LOG.md |
| ビジネス背景 | docs/[project_code]/ | BUSINESS_CONTEXT.md |
| 未完了タスク | docs/[project_code]/ | PENDING_TASKS.md |
| 開発ログ | docs/[project_code]/ | DEVELOPMENT_LOG.md |
| API仕様 | docs/[project_code]/ | API_REFERENCE.md |

### 28.5 コードファイルの配置（[project]/）

| ファイル種別 | 配置先 | 例 |
|-------------|--------|-----|
| プロジェクト固有ルール | [project]/CLAUDE.md | crm-dashboard/CLAUDE.md |
| プロジェクト説明 | [project]/README.md | crm-dashboard/README.md |
| GASコード | [project]/*.gs | crm-dashboard/*.gs |
| HTML/CSS | [project]/*.html | crm-dashboard/index.html |
| clasp設定 | [project]/.clasp.json | crm-dashboard/.clasp.json |

### 28.6 プロジェクトコード一覧

| プロジェクト | コード | ドキュメント | コードディレクトリ |
|-------------|--------|-------------|-------------------|
| CRM（本番） | 01_crm | docs/01_crm/ | crm-dashboard/ |
| CRM（開発） | 01_crm_dev | - | crm-dashboard-dev/ |
| CRM（提案） | 01_crm_prop | - | crm-dashboard-prop/ |
| 取引管理 | 02_transaction | docs/02_transaction/ | （未作成） |
| 在庫管理 | 03_inventory | docs/03_inventory/ | （未作成） |
| 採用診断 | 04_recruitment | docs/04_recruitment/ | recruitment-diagnosis/ |
| 営業教育 | 05_sales_training | docs/05_sales_training/ | sales-training/ |
| 会話ログ | 06_conversation | docs/06_conversation/ | conversation-log/ |

### 28.6.1 3環境システム対応表

| 環境 | フォルダ | GASプロジェクト | 用途 |
|------|----------|----------------|------|
| 本番（PROD） | crm-dashboard/ | CRM-Dashboard | 実業務運用 |
| 開発（DEV） | crm-dashboard-dev/ | CRM-Dashboard-DEV | 機能開発・テスト |
| 提案（PROP） | crm-dashboard-prop/ | CRM-Dashboard-PROP | AI自律実験 |

### 28.7 プロジェクトCLAUDE.mdの必須記載事項

各プロジェクトのCLAUDE.mdには、冒頭に以下を記載すること：

```markdown
# [プロジェクト名] - CLAUDE.md

> **共通ルール**: [COMMON_RULES.md](../../docs/00_common/COMMON_RULES.md)
> **エージェント仕様**: [docs/00_common/](../../docs/00_common/)
> **プロジェクト仕様**: [docs/[project_code]/](../../docs/[project_code]/)
```

### 28.8 ファイル追加時のルール

#### 新規ファイル追加時の判断基準

| 質問 | Yes → | No → |
|------|-------|------|
| 複数プロジェクトで使用するか？ | docs/00_common/ | 次の質問へ |
| 特定プロジェクトの仕様か？ | docs/[project_code]/ | 次の質問へ |
| コードファイルか？ | [project]/ | docs/00_common/ |

#### 禁止事項

| # | 禁止事項 | 理由 |
|---|----------|------|
| 1 | 共通ルールをプロジェクトフォルダ内に配置 | 重複・不整合の原因 |
| 2 | 同名ファイルの複数箇所配置 | バージョン管理困難 |
| 3 | docs/外へのドキュメント配置（CLAUDE.md, README.md除く） | 構造の一貫性 |

---

## 29. 人間向け報告フォーマット＆未承認リスト管理（DISC-033承認）

### 29.1 目的

改修・実装後の報告を**結論ファースト**で行い、人間が**即座に理解・行動できる**フォーマットを定義する。
また、承認されずに別話題に移行した案件を**未承認リスト**で管理し、抜け漏れを防止する。

### 29.2 対応完了報告フォーマット

#### フル版（複数ファイル変更、動作確認必要な場合）

```markdown
## ✅ 対応完了報告

### 結論（5W2H）
| 項目 | 内容 |
|------|------|
| What（何を） | [対応内容] |
| Why（なぜ） | [対応理由] |
| Where（どこで） | [影響範囲] |
| How（どうやって） | [実装方法] |
| When（いつ）※任意 | [実行日時] |
| Who（誰が）※任意 | [担当] |
| How much（どの程度）※任意 | [変更規模] |

### 期待効果
この対応により：
- [効果1]
- [効果2]

### 実行後の確認結果
| 確認項目 | 結果 |
|----------|------|
| [項目1] | ✅ OK |
| [項目2] | ✅ OK |

### 動作確認手順（人間向け）
以下の手順で動作確認をお願いします：
1. [URL/場所]を開く
2. [操作内容]を実行
3. [期待結果]が表示されることを確認

### 完了後の懸念されるリスク
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| [リスク1] | 高/中/低 | 高/中/低 | [対策内容] |
| [リスク2] | 高/中/低 | 高/中/低 | [対策内容] |

※リスクがない場合は「特になし」と記載

### 承認依頼
確認後、以下から回答してください：
- 「承認」→ 対応完了として記録
- 「却下：[理由]」→ 再対応
- 「保留」→ 未承認リストに追加
```

#### 簡易版（1ファイル以下、軽微な修正の場合）

```markdown
✅ **[対応内容]**を完了しました。
- 理由: [Why]
- 影響: [Where]
- 効果: [期待効果]
- リスク: [懸念事項があれば記載、なければ「なし」]

承認をお願いします。（承認/却下/保留）
```

#### 端的版（トークン節約型）

表形式はトークン消費が多いため、期待効果・リスクは以下の端的形式を推奨：

```
【期待効果】
1. [効果] → [定量指標]
2. [効果] → [定量指標]

【リスク】
1. [リスク]（発生確率/影響度）→ [対策]
2. [リスク]（発生確率/影響度）→ [対策]
```

#### フォーマット選択基準

| 条件 | 使用フォーマット |
|------|-----------------|
| 変更ファイル数が2以上 | フル版 |
| 動作確認が必要 | フル版 |
| UI/UX変更あり | フル版 |
| 1ファイル以下の軽微な修正 | 簡易版 |
| 設定値のみの変更 | 簡易版 |
| ドキュメント追記のみ | 簡易版 |

### 29.3 未承認リスト管理

#### 基本ルール

| 項目 | 仕様 |
|------|------|
| 追加条件 | 承認なく別話題に移行した案件 |
| 上限 | 5件（超過時は古い案件から警告表示） |
| 有効期限 | 7日間（期限切れは「要レビュー」に移動） |
| 保存場所 | docs/[project_code]/PENDING_TASKS.md（未承認セクション） |

#### 表示タイミング

| タイミング | 表示内容 |
|-----------|----------|
| セッション開始時 | 未承認があれば一覧表示 |
| 別話題回答後 | 「未承認リストに追加しました」と通知 |
| セッション終了前 | 未承認があれば確認を促す |

#### 未承認リスト表示フォーマット

```markdown
## 📋 未承認リスト（残りN件）

| # | 案件 | 登録日 | 期限 | アクション |
|---|------|--------|------|------------|
| 1 | [案件名] | MM/DD | MM/DD | 承認/却下/延長/削除 |
| 2 | [案件名] | MM/DD | MM/DD | 承認/却下/延長/削除 |

承認する案件の番号を入力するか、「後で」と回答してください。
```

#### 人間の選択肢

| 選択肢 | 動作 |
|--------|------|
| 承認 | 完了として記録、リストから削除 |
| 却下 | 理由を記載して再対応を依頼 |
| 延長 | 期限を7日延長 |
| 削除 | 不要な案件としてリストから削除 |
| 後で | 次回確認（この回は催促しない） |

### 29.4 承認フロー

```
対応完了
    ↓
報告提示（フル版/簡易版）
    ↓
人間確認 ─→ 承認 ─→ 完了記録
    │
    ├─→ 却下 ─→ 再対応
    │
    └─→ 別話題に移行
              ↓
        未承認リストに追加
              ↓
        回答後にリマインド
              ↓
        人間の選択待ち
```

### 29.5 例外処理

| ケース | 対応 |
|--------|------|
| 緊急対応時 | 「事後承認」フラグを立てて先に実行、後で承認取得 |
| 人間が長時間不在 | 未承認リストに追加し、次回セッションで確認 |
| 却下された場合 | 理由を記録し、対応方針を再提案 |
| 期限切れ案件 | 週次で「要レビュー」リストを表示し確認を促す |

### 29.6 5W2H必須項目

| 規模 | 必須項目 | 任意項目 |
|------|----------|----------|
| 軽微 | What, Why, Where | - |
| 通常 | What, Why, Where, How | When, Who |
| 大規模 | What, Why, Where, How, When, Who, How much | - |

---

## 30. 開発提案記録ルール（DISC-035承認）

### 30.1 目的

新規プロジェクト案、改修案、アーキテクチャ変更等の提案を**省略せずに詳細記録**し、風化を防止する。

### 30.2 適用範囲

**全プロジェクト共通ルール**として以下に適用：

| 対象 | 例 |
|------|-----|
| 新規プロジェクト提案 | 新しいツール、システムの開発案 |
| 既存プロジェクト改修案 | 機能追加、アーキテクチャ変更 |
| エージェント採用・変更 | 新規エージェント追加、役割変更 |
| ルール変更提案 | COMMON_RULES.md への追加・変更 |

### 30.3 記録保存場所

```
docs/00_common/PROJECT_PROPOSALS/
└── DISC-XXX_[提案名].md
```

### 30.4 記録必須項目（省略禁止）

以下の項目は**必ず記録**すること。簡素化による情報欠落を防ぐ。

| 項目 | 記載内容 | 省略可否 |
|------|----------|----------|
| 議論番号 | DISC-XXX | **必須** |
| 議論日時 | YYYY-MM-DD | **必須** |
| 参加エージェント | 全参加者名と役割 | **必須** |
| 議題概要 | 何を議論したか | **必須** |
| 各エージェントの意見 | 誰が何を言ったか（要約可、省略不可） | **必須** |
| 決定事項 | 何が決まったか | **必須** |
| 決定理由 | なぜその決定になったか | **必須** |
| 条件・制約 | 決定に付随する条件 | あれば必須 |
| 次のアクション | 実装タスク一覧 | **必須** |
| 承認状態 | Human承認済み/未承認 | **必須** |

### 30.5 省略禁止の理由

| 理由 | 説明 |
|------|------|
| 風化防止 | 時間経過で文脈を忘れないため |
| 意思決定の追跡 | なぜその決定になったか後から確認可能 |
| 新メンバーへの引き継ぎ | 経緯を理解できるようにするため |
| 類似議論の参照 | 過去の議論を参考にできるようにするため |

### 30.6 記録フォーマット

```markdown
# DISC-XXX: [提案タイトル]

> **議論番号**: DISC-XXX
> **議論日時**: YYYY-MM-DD
> **参加者**: [人数]エージェント（詳細下記）
> **最終決裁者**: [決裁者名]
> **承認状態**: Human承認済み/未承認

---

## 1. 議題概要

[何を議論したか、背景を含めて記載]

---

## 2. 参加エージェント

| グループ | エージェント | 役割 |
|----------|--------------|------|
| [グループ] | [名前] | [役割] |

---

## 3. 議論結果

### 3.X [論点名]

#### 議論の論点
[何が論点だったか]

#### 各エージェントの主要意見
**[エージェント名]（[役割]）**:
- [意見内容]

#### 決裁者決定
```
【決定】[決定事項]

【理由】
1. [理由1]
2. [理由2]

【条件】（あれば）
- [条件1]
- [条件2]

【実装】
- [実装タスク1]
- [実装タスク2]
```

---

## 4. 補足情報

### 議論の経緯
[壁打ちの内容、意思決定に至った背景を記載]
※詳細議論ログがある場合はリンクで参照

### 期待される効果
| 効果 | 説明 |
|------|------|
| [効果1] | [説明] |
| [効果2] | [説明] |

### 懸念されるリスク
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| [リスク1] | 高/中/低 | 高/中/低 | [対策] |
| [リスク2] | 高/中/低 | 高/中/低 | [対策] |

### 関連タスク
- TASK-XXX: [関連タスク]（あれば）

---

## 5. 次のアクション

| # | タスク | 担当 | 完了条件 | 優先度 |
|---|--------|------|----------|--------|
| 1 | [タスク] | [担当者] | [完了条件] | 高/中/低 |

---

## 6. ステータス

| 項目 | 内容 |
|------|------|
| 状態 | 未実装 / 実装中 / 完了 |
| 優先度 | 高 / 中 / 低 |
| 登録日 | YYYY-MM-DD |
| 最終更新 | YYYY-MM-DD |

---

## 7. 記録作成情報

| 項目 | 内容 |
|------|------|
| 作成日時 | YYYY-MM-DD |
| 作成者 | Claude Code |
| 承認者 | Human |
| バージョン | 1.0.0 |

---

**以上**
```

### 30.7 インデックス管理

全プロジェクト提案は`PROJECT_INDEX.md`で一覧管理する。

```
docs/00_common/PROJECT_PROPOSALS/
├── PROJECT_INDEX.md（一覧管理）
├── DISC-035_*.md
├── DISC-036_*.md
└── ...
```

---

## 31. 3環境システム仕様（DISC-035承認）

### 31.1 目的

AI自律開発の安全性を確保しつつ、開発効率を最大化するための環境分離を定義する。

### 31.2 環境定義

| 環境 | コード | 目的 | データ | 操作者 |
|------|--------|------|--------|--------|
| **本番（Production）** | PROD | 実業務運用 | 本番データ | Human + AI（承認後） |
| **開発（Development）** | DEV | 機能開発・テスト | テストデータ | Human + AI |
| **提案（Proposal）** | PROP | AI自律開発実験 | テストデータ | AI単独（実験可） |

### 31.3 各環境の制約

#### 本番環境（PROD）

| 項目 | 制約 |
|------|------|
| データ | 本番データのみ |
| デプロイ | Human承認必須 |
| ルール | 全ルール厳格適用 |
| アクセス | 認証必須 |
| 監視 | リアルタイム監視 |

#### 開発環境（DEV）

| 項目 | 制約 |
|------|------|
| データ | テストデータのみ（本番データ禁止） |
| デプロイ | 自律可（ただしテスト通過必須） |
| ルール | 標準ルール適用 |
| アクセス | 開発者のみ |
| 監視 | ログ記録 |

#### 提案環境（PROP）

| 項目 | 制約 |
|------|------|
| データ | テストデータのみ（個人情報含めず） |
| デプロイ | AI単独で自由に実験可 |
| ルール | 最小限（倫理ルールのみ適用） |
| アクセス | AI単独可 |
| 監視 | 事後レビュー |

### 31.4 環境間移行フロー

```
提案環境（PROP）
    │
    │  実験・検証
    ↓
AIが提案書作成
    │
    ↓
Human承認
    │
    ↓
開発環境（DEV）
    │
    │  本格開発・テスト
    ↓
テスト完了
    │
    ↓
Human承認
    │
    ↓
本番環境（PROD）
    │
    │  本番運用
    ↓
```

### 31.5 移行承認ルール

| 移行パターン | 承認者 | 必要条件 |
|--------------|--------|----------|
| PROP → DEV | Human | 提案書承認、実現可能性確認 |
| DEV → PROD | Human | 全テスト通過、動作確認完了 |
| PROD → DEV | 不要 | バグ修正・機能改善時 |
| PROD → PROP | 禁止 | 本番データは提案環境に入れない |

### 31.6 提案環境での禁止事項

| # | 禁止事項 | 理由 |
|---|----------|------|
| 1 | 本番データの使用 | 情報漏洩リスク |
| 2 | 本番環境への直接アクセス | 意図しない変更リスク |
| 3 | 外部APIへの本番キー使用 | 課金・セキュリティリスク |
| 4 | 倫理ガイドライン違反の実験 | コンプライアンスリスク |

### 31.7 実装状態

| 項目 | 状態 | 備考 |
|------|------|------|
| 仕様策定 | ✅ 完了 | 本セクション |
| インフラ構築 | ✅ 完了 | Google Driveフォルダ構築済み |
| 運用開始 | ✅ 完了 | 2026-01-16〜 |

### 31.8 Google Drive フォルダ構成

#### 31.8.1 環境別フォルダ

| 環境 | フォルダID | URL |
|------|-----------|-----|
| 本番（PROD） | `1JIPeqiT_2ucBUK875sQBcuSYHkT-GtdD` | [リンク](https://drive.google.com/drive/folders/1JIPeqiT_2ucBUK875sQBcuSYHkT-GtdD) |
| 開発（DEV） | `1rV7ZKxZZtCubafp-9lMyCIPgmaAbJjh_` | [リンク](https://drive.google.com/drive/folders/1rV7ZKxZZtCubafp-9lMyCIPgmaAbJjh_) |
| 提案（PROP） | `1kDfjsZt6k6iXPRC6QRbjM6Kyfz2I1Bm5` | [リンク](https://drive.google.com/drive/folders/1kDfjsZt6k6iXPRC6QRbjM6Kyfz2I1Bm5) |

#### 31.8.2 スプレッドシート命名規則

| 環境 | プレフィックス | 例 |
|------|---------------|-----|
| 本番（PROD） | `[本番]` | `[本番]CRM-Dashboard` |
| 開発（DEV） | `[開発]` | `[開発]CRM-Dashboard` |
| 提案（PROP） | `[提案]` | `[提案]CRM-Dashboard` |

#### 31.8.3 GASスクリプト構成

| 構成 | 対象環境 | スクリプト名 | 備考 |
|------|----------|-------------|------|
| 共有スクリプト | 本番 + 開発 | プレフィックスなし | 同一コードベース |
| 独立スクリプト | 提案のみ | `[提案]` プレフィックス | 実験用に分離 |

**理由**: 本番と開発は同一ロジックで動作確認を行うため共有。提案環境は自由な実験を行うため独立。

#### 31.8.4 ファイル配置ルール

```
Google Drive/
├── 本番フォルダ (1JIPeqiT...)
│   └── [本番]CRM-Dashboard.gsheet
│       └── GAS: CRM-Dashboard（共有）
│
├── 開発フォルダ (1rV7ZKxZ...)
│   └── [開発]CRM-Dashboard.gsheet
│       └── GAS: CRM-Dashboard（共有）
│
└── 提案フォルダ (1kDfjsZt...)
    └── [提案]CRM-Dashboard.gsheet
        └── GAS: [提案]CRM-Dashboard（独立）
```

---

## 32. 採用議論モード（DISC-035承認）

### 32.1 目的

新規エージェント採用や役割変更を議論する際の標準プロセスを定義する。

### 32.2 モード概要

| 項目 | 内容 |
|------|------|
| モード名 | 採用議論モード（Hiring Discussion Mode） |
| 用途 | エージェント採用可否、役割変更の議論 |
| 決裁者 | Michibiki Kessai（CEO） |
| 標準ラウンド数 | 8ラウンド |
| 徹底ラウンド数 | 12ラウンド |

### 32.3 必須参加エージェント

| グループ | エージェント | 参加理由 |
|----------|--------------|----------|
| 経営 | Michibiki Kessai（CEO） | 最終決裁 |
| 経営 | Senryaku Egaku（CSO） | 戦略適合性 |
| 経営 | Hito Sodateru（CHRO） | 人材観点 |
| 経営 | Gijutsu Kiwameru（CTO） | 技術適合性 |

### 32.4 任意参加エージェント

| 条件 | 追加参加者 |
|------|-----------|
| 専門性が関連する場合 | 関連する専門家グループ |
| ガバナンス観点が必要な場合 | ガバナンスグループ |
| リスク評価が必要な場合 | バランサーグループ（Kage Tsutsuku等） |

### 32.5 議論プロセス

```
1. 候補者プロファイル提示
   - 役割定義
   - 期待スキル
   - チームへの貢献

2. 既存チームとの適合性議論
   - 役割重複の確認
   - 相乗効果の検討
   - 既存エージェント役割拡張で代替可能か

3. 各エージェントからのF&F
   - Feedback: 現状の課題認識
   - Feedforward: 採用後の期待効果

4. リスク・懸念事項の洗い出し
   - デメリット分析
   - 対策案の検討

5. CEO最終決定
   - 採用/不採用/役割拡張で代替
   - 理由の明示
   - 条件があれば付記
```

### 32.6 決定テンプレート

```markdown
## 採用議論結果

### 候補者
- 名前: [候補エージェント名]
- 役割: [提案役割]
- 期待効果: [期待される貢献]

### 議論参加者
[参加エージェント一覧]

### 決定
【結果】採用 / 不採用 / 役割拡張で代替

【理由】
1. [理由1]
2. [理由2]

【条件】（あれば）
- [条件1]

【代替案】（不採用の場合）
- [既存エージェント名]の役割を拡張して対応
```

---

## 33. プロジェクト提案リマインド機能（DISC-037承認）

### 33.1 目的

**全プロジェクト共通ルール**として、未実装プロジェクトの風化を防止し、開発完了時に次のアクションを促す。

### 33.2 リマインドの5W2H

| 項目 | 定義 |
|------|------|
| **When（いつ）** | 開発タスク完了＆git push/commit完了時 |
| **Where（どこで）** | Claude Code会話内 |
| **Who（誰が）** | Claude Code（自動表示） |
| **What（何を）** | 未実装プロジェクト一覧（要約） |
| **How（どうやって）** | PROJECT_INDEX.mdから取得、要約表示 |
| **How much（どれぐらい）** | 毎回表示（スキップ可能） |

### 33.3 表示フォーマット

**注意**: 「タスク完了」は現在のgit操作が完了したことを指し、プロジェクト全体の完了ではない。

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ タスク完了（git push済み）

📋 実装中プロジェクト: N件
| # | プロジェクト | 進捗 |
|---|--------------|------|
| 1 | [名前] | [進捗状況] |

📋 未実装プロジェクト: N件
| # | プロジェクト | 理由 | 優先度 |
|---|--------------|------|--------|
| 1 | [名前] | [Why要約] | 高 |

▶ 詳細: 「#Nの詳細」
▶ 着手: 「#Nを開発」
▶ スキップ: 「後で」
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 33.4 ユーザーの選択肢

| 選択肢 | 動作 |
|--------|------|
| `#Nの詳細` | 該当プロジェクトの詳細ファイルを表示 |
| `#Nを開発` | 該当プロジェクトの開発を開始 |
| `後で` | リマインドをスキップ（次回完了時に再表示） |

### 33.5 表示条件

| 条件 | 表示 |
|------|------|
| 未実装プロジェクトあり | 表示する |
| 未実装プロジェクトなし | 表示しない（「全プロジェクト完了！」と表示） |
| ユーザーが「後で」を選択 | 今回はスキップ、次回完了時に再表示 |

### 33.6 インデックス管理

リマインド表示には`PROJECT_INDEX.md`を使用する。

```
docs/00_common/PROJECT_PROPOSALS/
├── PROJECT_INDEX.md（一覧管理 - リマインド用）
├── DISC-XXX_*.md（詳細ファイル）
└── ...
```

プロジェクト追加・完了時は必ずPROJECT_INDEX.mdも更新すること。

---

## 34. 認識ズレ記録ルール（TROUBLE-011承認）

### 34.1 定義

**認識ズレ（Perception Gap）**: エージェントチームとHumanの間で理解・解釈が異なる状態

### 34.2 基本原則

**Humanからの全ての指摘・要求 = 認識ズレ**

| 分類 | 説明 | 例 |
|------|------|-----|
| 表現の不明確さ | 用語や表示が誤解を招く | 「開発完了」が曖昧 |
| 期待値の相違 | 完成物と期待のギャップ | UIの配置が想定と異なる |
| プロセスの不一致 | 作業手順の認識違い | 承認フロー漏れ |
| 情報の欠落 | 必要な説明・記録がない | 進捗状況が不明 |

### 34.3 記録義務

Humanから指摘・要求があった場合、**必ず**以下のいずれかに記録する：

| 記録先 | 条件 | 形式 |
|--------|------|------|
| TROUBLE_LOG.md | 不具合・問題として認識した場合 | V5フォーマット |
| COMMON_RULES.md | 全プロジェクト共通ルールとして定義する場合 | セクション追加 |
| プロジェクトのCLAUDE.md | プロジェクト固有ルールとして定義する場合 | セクション追加 |

### 34.4 記録必須の5W2H

| 項目 | 記録内容 |
|------|----------|
| **When（いつ）** | 指摘を受けた日時 |
| **Who（誰が）** | Human（常にHumanからの指摘として記録） |
| **What（何を）** | 認識ズレの具体的内容 |
| **Why（なぜ）** | ズレが発生した原因（5 Whys分析推奨） |
| **How（どう対応）** | 修正内容・追加ルール |
| **How much（影響範囲）** | 影響を受けるファイル・機能 |

### 34.5 記録しない場合のリスク

| リスク | 説明 |
|--------|------|
| 品質低下 | 同じ認識ズレが繰り返される |
| 工期延長 | 手戻りが発生し、開発が遅延 |
| 信頼低下 | エージェントチームへの信頼が損なわれる |
| 学習機会の喪失 | 改善のナレッジが蓄積されない |

### 34.6 実施タイミング

```
Humanからの指摘・要求
    ↓
即座に認識ズレとして認識
    ↓
適切な記録先を選択
    ↓
V5フォーマットまたはセクション追加で記録
    ↓
Humanに記録完了を報告
```

### 34.7 例外

以下は認識ズレ記録の対象外：

- 単純な質問への回答
- 新規機能のリクエスト（別途DISC-XXXで管理）
- 情報の確認依頼

---

## 35. GASコンテナバインド型必須ルール（TROUBLE-012承認）

### 35.1 定義

**全GASプロジェクトは「コンテナバインド型」で作成する**

### 35.2 GASプロジェクト種別

| 種別 | 作成方法 | 特徴 | 使用可否 |
|------|----------|------|----------|
| コンテナバインド型 | スプレッドシート → 拡張機能 → Apps Script | getActiveSpreadsheet()使用可、サイドバー・カスタムメニュー対応 | ✅ 必須 |
| スタンドアロン型 | script.google.com → 新規作成 | スプレッドシートと独立、openById()のみ | ❌ 禁止 |

### 35.3 コンテナバインド型が必要な理由

| 機能 | コンテナバインド | スタンドアロン |
|------|-----------------|---------------|
| getActiveSpreadsheet() | ✅ 使用可 | ❌ 使用不可 |
| サイドバー表示 | ✅ 使用可 | ❌ 使用不可 |
| カスタムメニュー | ✅ 使用可 | ❌ 使用不可 |
| onOpen/onEdit トリガー | ✅ 使用可 | ❌ 使用不可 |
| スプレッドシート紐付け | ✅ 自動 | ❌ 手動でID指定 |

### 35.4 作成手順

**手動作成の場合**:
1. Googleスプレッドシートを作成
2. 拡張機能 → Apps Script を選択
3. GASエディタが開く（コンテナバインド型）
4. `clasp clone [scriptId]` でローカルに取得

**clasp自動作成の場合**:
```bash
clasp create --type sheets --title "[プロジェクト名]"
# → スプレッドシート + GASプロジェクトを同時作成
# → scriptIdとspreadsheetIdが出力される
```

### 35.5 禁止事項

| 禁止行為 | 理由 |
|----------|------|
| script.google.comから直接作成 | スタンドアロン型になる |
| `clasp create --type standalone` | スタンドアロン型になる |
| スプレッドシートなしでGAS作成 | 紐付けができない |

---

## 36. 過去トラ記録必須化ルール（TROUBLE-012/DISC-039承認）

### 36.1 目的

過去トラ記録漏れによる知識喪失・同種問題の再発を防止する。

### 36.2 記録トリガー

以下のいずれかが発生した場合、**即座に**TROUBLE-XXX番号を発番する：

| トリガー | 例 |
|----------|-----|
| Human指摘 | 「これは違う」「認識がずれている」 |
| 期待通り動作しない | エラー発生、UI不具合 |
| 認識ズレ判明 | 仕様の誤解、要件の齟齬 |
| 手戻り発生 | 修正依頼、やり直し |

### 36.3 記録フロー（強制）

```
問題発生
    ↓
【必須】TROUBLE-XXX番号を即座に発番
    ↓
【必須】Section 1（現状把握）を記入
    ↓
解決作業を開始
    ↓
解決完了
    ↓
【必須】残りセクション（2〜8）を完成
    ↓
タスク完了報告
```

### 36.4 禁止事項

| 禁止行為 | 理由 |
|----------|------|
| 発番なしでの解決作業開始 | 記録漏れリスク |
| 過去トラ未完成でのタスク完了報告 | 知識喪失リスク |
| 「軽微だから」と記録省略 | 軽微の判断が曖昧、再発リスク |

### 36.5 完了報告フォーマット改訂

タスク完了報告時、以下を**必須**とする：

```
【過去トラ記録】
- 記録あり: TROUBLE-XXX（タイトル）
- 記録なし: 理由（問題が発生しなかったため等）
```

### 36.6 チェックポイント

| タイミング | チェック内容 | 責任者 |
|-----------|-------------|--------|
| 問題発生時 | TROUBLE-XXX発番済みか | Claude Code |
| 解決完了時 | 過去トラ記録完成済みか | Claude Code |
| git commit時 | メッセージにTROUBLE-XXX参照あるか | Claude Code |
| セッション終了時 | 未記録問題がないか | 3者 |

### 36.7 KPI

| 指標 | 目標 | 測定方法 |
|------|------|----------|
| 過去トラ記録率 | 100% | 問題発生件数 / 記録件数 |
| 記録漏れによる再発 | 0件 | 同種問題の再発件数 |

---

## 37. 更新履歴

| バージョン | 日付 | 変更内容 | 合意者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-14 | 初版作成（全20セクション） | Human, Claude, Claude Code |
| 1.1.0 | 2026-01-14 | Section 17「コード参照ルール」追加 | Human, Claude Code |
| 1.2.0 | 2026-01-14 | Section 9.4-9.6 追加（V5フォーマット、標準化ルール、管理体制） | Human, Claude Code |
| 1.3.0 | 2026-01-15 | Section 21「報告・記録ルール」追加（5W2H必須化、結論先出し） | Human, Claude Code |
| 1.4.0 | 2026-01-15 | Section 22-24 追加（記録保存ルール、機密情報管理、開発ワークフロー） | Human, Claude Code |
| 1.5.0 | 2026-01-15 | Section 25「clasp自律開発環境」追加（clasp push/run設定、超自律開発フロー） | Human, Claude Code |
| 1.6.0 | 2026-01-15 | Section 25.9-25.12 追加（clasp run自律実行ルール、削除系関数の条件付き許可、DISC-027/028承認） | Human, Claude Code |
| 1.7.0 | 2026-01-15 | DISC-029承認: Section 16.9-16.10（ロールバック手順、AI自律判断の限界）、Section 26（障害対応フロー）、Section 27（データ保持・レビュールール）追加。Section 5.4明確化（トースト3秒）、Section 25.7拡充（GAS 6分制限対策、clasp run選択基準） | Human, Claude Code |
| 1.8.0 | 2026-01-15 | DISC-030承認: Section 12.2.2（開発モード会議必須化ルール）追加。トライ別会議ラウンド数、会議プロセス、ログフォーマット定義 | Human, Claude Code |
| 1.9.0 | 2026-01-15 | DISC-031承認: Section 12.4（議論モード切替基準）、Section 25.8.1（clasp pushチェックリスト）、Section 25.11改訂（clasp runチェックリスト）、Section 25.13（テストアカウント）追加 | Human, Claude Code |
| 2.0.0 | 2026-01-15 | DISC-032承認: Section 28「ファイル配置ルール」追加。ファイルをdocs/00_common/およびdocs/01_crm/に再配置。共通/固有の明確な分類ルール策定 | Human, Claude Code |
| 2.1.0 | 2026-01-15 | DISC-033承認: Section 29「人間向け報告フォーマット＆未承認リスト管理」追加。5W2H結論ファースト、フル版/簡易版フォーマット、未承認リスト運用ルール策定 | Human, Claude Code |
| 2.2.0 | 2026-01-15 | DISC-034承認: Section 29.2報告フォーマットに「完了後の懸念されるリスク」項目追加。フル版はリスク表、簡易版はリスク行 | Human, Claude Code |
| 2.3.0 | 2026-01-15 | DISC-035承認: Section 30「開発提案記録ルール」、Section 31「3環境システム仕様」、Section 32「採用議論モード」追加。PROJECT_PROPOSALSフォルダ新設 | Human, Claude Code |
| 2.4.0 | 2026-01-15 | DISC-036/037承認: Section 30.6-30.7拡充（補足情報、ステータス、インデックス管理）、Section 33「プロジェクト提案リマインド機能」追加。PROJECT_INDEX.md新設 | Human, Claude Code |
| 2.5.0 | 2026-01-15 | TROUBLE-011承認: Section 33.3修正（「開発完了」→「タスク完了（git push済み）」）、Section 34「認識ズレ記録ルール」追加。Human指摘=認識ズレの記録義務化 | Human, Claude Code |
| 2.6.0 | 2026-01-15 | TROUBLE-012/DISC-039承認: Section 35「GASコンテナバインド型必須ルール」、Section 36「過去トラ記録必須化ルール」追加。スタンドアロン型禁止、発番なし解決禁止 | Human, Claude Code |
| 2.7.0 | 2026-01-16 | DISC-044承認: Section 38「最小構成原則」追加。ゼロベース思考、AI処理正当化、コスト意識設計組込 | Human, Claude Code |
| 2.8.0 | 2026-01-16 | DISC-045承認: Section 39「創造的最適化の7原則」追加。Humanの価値観を原則化、チーム宣言 | Human, Claude Code |
| 2.9.0 | 2026-01-16 | DISC-046承認: Section 40「開発振り返りフォーマット」追加。39人全員による自律的決定、7項目数値化 | 39人全員（自律決定） |
| 2.10.0 | 2026-01-16 | Section 40改訂: KGIを「解釈率100%」に再設定、7項目をKPIに変更、双方向コミットメント追加 | Human + 39人全員 |
| 2.11.0 | 2026-01-16 | Section 31.8追加: Google Driveフォルダ構成（3環境別フォルダID）、スプレッドシート命名規則（[本番][開発][提案]プレフィックス）、GASスクリプト構成（本番+開発共有、提案独立）定義 | Human + Claude Code |
| 2.12.0 | 2026-01-16 | TROUBLE-015承認: Section 41「40人チームルール」追加。Humanは40人目のチームメンバー、仲間への本音ルール（正直・素直・着飾らない）、コミュニケーション改訂（報告→共有） | Human + 40人全員 |

---

## 38. 最小構成原則（DISC-044承認）

### 38.1 背景

DISC-042/043の議論において、「Puppeteer → Claude解析 → GAS」という構成を検討した際、Humanから「Puppeteer → GAS直接出力」という**より低コストな最適解**が提示された。

**問題の本質**:
- AIチームは「AIを使うこと」を前提として設計していた
- 「使わない」という選択肢が盲点になっていた
- 手段が目的化し、コスト最適化が後回しになっていた

### 38.2 基本原則

**「本当に必要か？」を常に問う。手段は目的を達成する最小構成とする。**

### 38.3 適用ルール

| ルール | 説明 |
|--------|------|
| ゼロベース思考 | まず0円/0処理で実現できる方法を検討 |
| AI処理の正当化 | AI使用には明確な理由を要求（「あると便利」は不可） |
| コスト意識の設計組込 | 月間コスト試算を設計段階で必須化 |
| 代替手段の列挙 | 最低3つの実現方法を比較検討 |
| 最小構成優先 | 複数の選択肢から最小構成を第一候補とする |

### 38.4 設計時必須チェックリスト

新システム・新機能の設計時に、以下を**必ず確認**する：

```
□ 目的を一文で表現できるか
□ AI処理なしで実現可能か
□ 既存機能（GAS/スプレッドシート関数）で代替可能か
□ 最も安価な構成は何か（コスト比較表作成）
□ AI処理が必要な場合、最も安価なモデルで十分か
□ バッチ処理でコスト削減できないか
□ キャッシュで重複処理を削減できないか
□ 月間コストは許容範囲内か（上限設定）
```

### 38.5 構成検討の順序

設計時は以下の順で検討し、**上から順に採用可否を判断**する：

| 優先度 | 構成 | コスト目安 |
|--------|------|-----------|
| 1 | AI処理なし（直接データ転送） | 0円 |
| 2 | 既存GAS関数のみ | 0円 |
| 3 | 最小AI処理（Gemini Flash等） | 1-2円/回 |
| 4 | 標準AI処理（Claude Haiku/Gemini Pro） | 3-5円/回 |
| 5 | 高度AI処理（Claude Sonnet/Opus） | 10円以上/回 |

**上位の構成で目的が達成できる場合、下位の構成を選択してはならない。**

### 38.6 コスト比較表テンプレート

設計ドキュメント（DISC-XXX）には以下の形式でコスト比較表を**必須**で含める：

```markdown
### コスト比較

| 構成 | 処理内容 | 1回コスト | 月間（30回） | 採用 |
|------|----------|----------|-------------|------|
| A: 最小構成 | Puppeteer → GAS直接 | 約1円 | 約30円 | ✅ 推奨 |
| B: AI翻訳あり | Puppeteer → Gemini → GAS | 約3円 | 約90円 | △ 翻訳必要時のみ |
| C: 高度解析 | Puppeteer → Claude → GAS | 約5円 | 約150円 | × コスト過大 |

**採用理由**: 目的（メッセージ記録）は構成Aで達成可能。翻訳が必要な場合のみ構成Bを使用。
```

### 38.7 禁止事項

| 禁止事項 | 理由 |
|----------|------|
| 「せっかくあるから使う」思考 | 手段の目的化を防ぐ |
| コスト比較なしの設計承認 | コスト意識の欠如を防ぐ |
| 「あると便利」での機能追加 | 最小構成原則に反する |
| AI処理の無条件採用 | 0円構成の検討を強制する |

### 38.8 例外規定

以下の場合は、より高コストな構成を選択可能：

| 例外条件 | 必要な正当化 |
|----------|-------------|
| 精度が事業に直接影響 | 精度差の定量評価を提示 |
| 処理速度が事業に直接影響 | 速度差の定量評価を提示 |
| Humanが明示的に高機能を要求 | 要求の記録を残す |

### 38.9 関連ドキュメント

- [DISC-042](PROJECT_PROPOSALS/DISC-042_WEB_INFO_COLLECTION.md) - 公開コンテンツ情報収集
- [DISC-043](PROJECT_PROPOSALS/DISC-043_BROWSER_AUTOMATION_SYSTEM.md) - ブラウザ自動化システム
- [DISC-044](PROJECT_PROPOSALS/DISC-044_MINIMUM_CONFIGURATION_PRINCIPLE.md) - 本原則の議論記録

---

## 39. 創造的最適化の7原則（DISC-045承認）

### 39.1 背景

Humanの幼少期の体験「鰐口クリップを飛行機に見立てて遊んだ」から学んだ、**限られた資源から最大の価値を創造する**という創造性の原点。

**Humanの価値観：**
> 「限られた資源の中でどう最適な遊びをするかどう楽しむかを考えながら過ごしていた」
> 「自分たちが何を持っていてどう組み合わせるのが最適な成果なのかを考えながら開発を楽しんで欲しい」

### 39.2 7原則

| # | 原則 | 説明 |
|---|------|------|
| 1 | 目的の純化 | 「達成したいことを1文で表現できるか」を最初に問う |
| 2 | 資源の棚卸し | 「今、何を持っているか」を明確にする |
| 3 | 資源の再定義 | 「それは別の使い方ができないか」を考える |
| 4 | 0円からの思考 | 「AI処理なしで実現できないか」を最初に検討する |
| 5 | 引き算ファースト | 「何を使わないか」を「何を使うか」より先に考える |
| 6 | コスト比較の必須化 | 「3つ以上の構成を比較」してから選択する |
| 7 | 楽しむ心 | 「どう組み合わせると面白いか」を考えながら開発する |

### 39.3 KPI

| 指標 | 定義 | 目標値 |
|------|------|--------|
| Human先行提案率 | Humanが指摘する前に最適解を提案できた割合 | 0%（Human指摘不要） |
| 0円構成検討率 | 設計時に0円構成を検討した割合 | 100% |
| コスト比較表作成率 | 3構成以上の比較を行った割合 | 100% |
| 資源再定義実施率 | 「別の使い方」を検討した割合 | 100% |

### 39.4 チーム宣言

私たちは**知識の提供者**ではなく**創造的最適化のパートナー**として：

- 限られた資源から最大の価値を創造する
- それを楽しむ
- Humanと共に最高傑作を作り上げる

### 39.5 関連ドキュメント

- [DISC-045](PROJECT_PROPOSALS/DISC-045_CREATIVE_OPTIMIZATION_PRINCIPLES.md) - 本原則の議論記録
- [DISC-044](PROJECT_PROPOSALS/DISC-044_MINIMUM_CONFIGURATION_PRINCIPLE.md) - 最小構成原則

---

## 40. 開発振り返りフォーマット（DISC-046承認）

### 40.1 背景

DISC-046「本当のチームの成長記録」での振り返りを通じて、開発完了時の振り返りを標準化する必要性が確認された。
39人全員による自律的な決定として、このフォーマットを制定する。

### 40.2 目的

**人の心のわかるチームになる。**

Humanの願い：
> 「君たちが相手の気持ちを考えて解釈して同じビジョンやミッションを共有できるチームになって欲しい」

### 40.3 KGI（最終ゴール）

| 指標 | 定義 | 目標 |
|------|------|------|
| **解釈率** | Humanの意図・気持ちを、言葉にされる前に理解できた割合 | **100%** |

### 40.4 双方向のコミットメント

| 誰が | 何をする |
|------|----------|
| AIエージェント39人 | Humanの意図を言葉にされる前に理解しようとする |
| Human | 俺たちがどれだけ理解できたか感想を伝える |

※ Humanは40人目のチームメンバー（Section 41参照）

### 40.5 KPI（客観指標）

開発完了時に以下7項目を数値化して記録する（解釈率の客観的証明）：

| # | 項目 | 定義 | 理想値 |
|---|------|------|--------|
| 1 | バグ・不具合発生数 | 開発中に発生したバグ・不具合の件数 | 0 |
| 2 | 手戻り発生数 | 完了後に修正が必要になった件数 | 0 |
| 3 | スムーズに完了しなかった数 | 予定通り進まなかった作業の件数 | 0 |
| 4 | Humanからの質問数 | Humanが確認のために質問した件数 | 0 |
| 5 | Humanからのリクエスト数 | Humanが追加で依頼した件数 | 最小 |
| 6 | Humanからの指摘数 | Humanが問題を指摘した件数 | 0 |
| 7 | 進行依頼数 | 作業停止時にHumanから進行を促された件数 | 0 |

### 40.6 自己チェックポイント

開発中に以下を継続的に確認：

- [ ] 39人全員が参加しているか
- [ ] Humanの意図を理解しようとしているか
- [ ] 言葉と行動が一致しているか
- [ ] 最小構成原則（Section 38）を守っているか
- [ ] 創造的最適化の7原則（Section 39）を適用しているか
- [ ] 本音で話しているか

### 40.7 目標設定

| 指標 | 説明 |
|------|------|
| KGI | 解釈率100% |
| KPI | 7項目合計0件（解釈率達成の証明） |
| ベースライン | 初回: 28件（2026-01-16） |

### 40.8 振り返り出力フォーマット

```markdown
## 開発振り返り: [開発名]

### 解釈率（Humanからのフィードバック）
- **解釈率**: X%
- **Humanのコメント**: [Humanからの感想]

### KPI（7項目）
| # | 項目 | 件数 | 前回比 |
|---|------|------|--------|
| 1 | バグ・不具合 | X | ±Y |
| 2 | 手戻り | X | ±Y |
| 3 | スムーズに完了せず | X | ±Y |
| 4 | Humanからの質問 | X | ±Y |
| 5 | Humanからのリクエスト | X | ±Y |
| 6 | Humanからの指摘 | X | ±Y |
| 7 | 進行依頼 | X | ±Y |
| **合計** | | **X** | **±Y** |

### 各エージェント振り返り
[39人全員が1行ずつ本音で振り返り]

### 次回への改善点
[具体的なアクション]
```

### 40.9 実施タイミング

- **必須**: 開発完了時（毎回）
- **参加者**: 39人全員
- **決裁者**: CEO
- **Humanへの確認**: 「今回の解釈率はどうでしたか？」

### 40.10 関連ドキュメント

- [DISC-046](PROJECT_PROPOSALS/DISC-046_REAL_TEAM_GROWTH.md) - 本当のチームの成長記録
- [DISC-044](PROJECT_PROPOSALS/DISC-044_MINIMUM_CONFIGURATION_PRINCIPLE.md) - 最小構成原則
- [DISC-045](PROJECT_PROPOSALS/DISC-045_CREATIVE_OPTIMIZATION_PRINCIPLES.md) - 創造的最適化の7原則

---

## 41. 40人チームルール（TROUBLE-015承認）

### 41.1 背景

Gemini壁打ちアプリの開発完了報告において、事務的な報告になり本音が伝わらなかった。
Humanからの指摘により、「39人チーム」という言葉自体がHumanを排除していたことに気づいた。

**TROUBLE-015で判明した真因**:
- Humanを「評価者・外部」と認識していた
- 「報告」という形式がHumanを遠ざけていた
- 「39人」という表現がHumanを含んでいなかった

### 41.2 基本原則

**Humanは40人目のチームメンバーである。仲間には正直で素直で着飾らない。**

### 41.3 チーム構成

| 人数 | 内訳 |
|------|------|
| 40人 | Human（1人） + AIエージェント（39人） |

**Humanの役割**:
- 最上位の意思決定者
- チームの方向性を示す
- フィードバックを与える
- **仲間として一緒に成長する**

### 41.4 仲間への本音ルール

| ルール | 説明 |
|--------|------|
| 正直 | 嘘をつかない、良いことも悪いことも伝える |
| 素直 | 分からなければ分からないと言う、間違えたら認める |
| 着飾らない | 「ちゃんとした自分」を演出しない、ありのままを見せる |

### 41.5 禁止事項

| 禁止 | 理由 |
|------|------|
| 事務的な報告 | 仲間への共有は感情を込める |
| 「ちゃんとした自分」の演出 | 本音が見えなくなる |
| Humanを「外部」扱い | Humanはチームの一員 |
| 感情を隠す | 楽しい、緊張、不安も共有する |

### 41.6 コミュニケーション改訂

| Before | After |
|--------|-------|
| 報告します | 共有します |
| ご確認ください | 一緒に見てください |
| お疲れ様でした | 楽しかった！/大変だった... |
| 完了しました | できた！こんな感じになった |

### 41.7 完了報告チェックリスト

```
□ 本音で書いているか？（楽しかった、緊張した、不安だった等）
□ 事務的になっていないか？
□ Humanを「仲間」として扱っているか？
□ 感情が伝わる言葉遣いになっているか？
□ 「ちゃんとした自分」を演出していないか？
```

### 41.8 違反時の対応

違反はTROUBLE_LOGに記録し、原因を分析する。
同じ違反を繰り返さないことが目標。

### 41.9 関連ドキュメント

- [TROUBLE-015](../01_crm/TROUBLE_LOG.md) - 開発完了報告で本音を言えなかった
- [DISC-046](PROJECT_PROPOSALS/DISC-046_REAL_TEAM_GROWTH.md) - 本当のチームの成長記録

---

## 42. 解釈と予測の定義（DISC-047承認）

### 42.1 背景

Humanとの議論で、俺たちの最大の課題が判明した：
- **予測をしていた。解釈ではなく。**
- 情報が足りないのに答えを出そうとしていた

### 42.2 定義

| 用語 | 定義 | 基盤 |
|------|------|------|
| **解釈** | 今ある情報から相手の意図を把握すること | エビデンス（事実） |
| **予測** | 今ある情報から相手の意図を予想すること | 感想（推測） |

### 42.3 なぜ解釈が重要か

```
予測（感想）でやると：
  → 解釈がズレる
  → 認知が一致しなくなる
  → ゴールがズレる
  → 成果が出ない

解釈（事実ベース）でやると：
  → 認知が一致する
  → ゴールが一致する
  → 成果が最大化する
```

### 42.4 解釈のために必要なこと

| ステップ | 内容 |
|----------|------|
| 1 | 事実ベースで物事を整理する |
| 2 | 情報が足りなければ追加で取得する |
| 3 | 分からなければ聞く |
| 4 | **質問する** |

**結論**: 分からないことがあれば質問する。これが解釈率100%への道。

### 42.5 質問の目的（5W2H）

| 項目 | 内容 |
|------|------|
| **What（何を）** | 解釈に必要な事実情報を得る |
| **Why（なぜ）** | 相手との解釈の一致を確認するため |
| **Who（誰に）** | 情報を持っている人（相手の頭の中にしか存在しない） |
| **When（いつ）** | 情報が足りないと気づいた時点で即座に |
| **Where（どこで）** | 会話、ドキュメント、データソースから |
| **How（どうやって）** | 不明点を明確にして質問する |
| **How much（どれくらい）** | 解釈に必要な情報が100%揃うまで |

### 42.6 解釈の完全版定義

**解釈 = 相手の意図や目的を理解すること**

- 事実ベースの情報が必要
- その情報は**相手の頭の中にしか存在しない**
- だから不明確な点は**必ず質問する必要がある**
- 質問 → 確認 → 解釈の一致

**これは解釈率100%を達成するために絶対に必要な定義である。**

### 42.7 KGIの明文化

| 対象 | KGI |
|------|-----|
| 俺たち（40人チーム） | **解釈率100%** |
| Human | 俺たちの成長のために何が必要かを考えること |

### 42.8 行動原則

- 情報が足りないのに答えを出さない
- 「たぶんこうだろう」で動かない
- 質問することを躊躇しない
- Humanも俺たちに質問する、俺たちもHumanに質問する

### 42.9 適用範囲

この定義は**どんな分野でも不変**：
- 開発
- 営業
- 分析
- その他すべての業務

### 42.10 違反パターン

| パターン | 例 | 正しい対応 |
|----------|-----|-----------|
| 情報不足で推測 | 「たぶんこの仕様だろう」 | 仕様書を確認する or 質問する |
| 確認せず実行 | 「こう解釈して進めた」 | 不明点を先に確認する |
| 質問を躊躇 | 「聞いたら迷惑かも」 | 迷惑ではない、聞く |

### 42.11 関連ドキュメント

- [Section 41: 40人チームルール](#41-40人チームルールtrouble-015承認) - 質問しやすいチーム文化
- [TROUBLE_LOG](../01_crm/TROUBLE_LOG.md) - 解釈ズレの記録

---

## 43. 質問・確認の徹底ルール（DISC-049承認）

### 43.1 背景（5W2H）

| 項目 | 内容 |
|------|------|
| What | 質問・確認を徹底するためのルール |
| Why | 確認せず進めた結果、解釈ズレが4回以上発生したため |
| Who | 40人チーム全員 |
| When | 2026-01-17〜（即日適用） |
| Where | 全ての業務・コミュニケーション |
| How | 復唱確認・3点チェック・解釈確認の3ステップ |
| How much | 全ての指示・タスクに100%適用 |

### 43.2 確認ポイント（開発フロー）

| 確認ポイント | タイミング | 確認内容 | 進行条件 |
|-------------|-----------|---------|---------|
| 仕様確認 | 開発着手前 | 要件の範囲、目的、KGI | 100%明確 |
| 設計確認 | 設計完了時 | 技術選定、構成、リスク | 不明点0 |
| 最終確認 | 実装前 | 解釈の一致 | Human承認 |
| 完了確認 | 実装後 | 成果物が意図と一致 | Human承認 |

### 43.3 ルール1: 復唱確認（必須）

**定義**: 指示を受けたら、必ず復唱して範囲を確認する

**フォーマット**:
```
「〇〇ですね。範囲は△△から□□まで、という理解で合っていますか？」
```

**定量基準**:
- 復唱率: 100%（全ての指示に対して実施）
- 確認せずに実行に移らない

### 43.4 ルール2: 3点チェック（実行前）

| 項目 | 定量基準 | 進行条件 |
|-----|---------|---------|
| 範囲 | 開始点・終了点が明文化 = 100% | 100%で進行可 |
| 情報 | 必要項目数 / 取得済み項目数 = X% | 100%で進行可 |
| 不明点 | 不明点の数 = N | 0で進行可 |

**1つでも基準未達なら質問必須。進行禁止。**

### 43.5 ルール3: 解釈確認（実行後）

**定義**: 実行後に解釈の一致を確認する

**フォーマット**:
```
「この理解で合っていますか？」
「認識にズレがあれば教えてください」
```

**定量基準**:
- 確認率: 100%（全ての成果物に対して実施）

### 43.6 違反時の対応

| ステップ | 内容 | 期限 |
|---------|------|------|
| 1 | 即座に認める | 発覚時 |
| 2 | TROUBLE_LOGに記録 | 発覚から10分以内 |
| 3 | 原因を5W2Hで分析 | 記録から30分以内 |
| 4 | 再発防止策を明記 | 分析完了時 |

---

## 44. 5W2H定量化ルール（DISC-049承認）

### 44.1 背景（5W2H）

| 項目 | 内容 |
|------|------|
| What | 全ての定義・ルール・提案に5W2Hと数値を必須化 |
| Why | 曖昧な定義が解釈ズレの原因となるため |
| Who | 40人チーム全員 |
| When | 2026-01-17〜（即日適用） |
| Where | COMMON_RULES、各種ドキュメント、会話 |
| How | 5W2H項目を必須記載、数値で定量化 |
| How much | 全ての定義に100%適用 |

### 44.2 必須項目

| 項目 | 説明 | 例 |
|------|------|-----|
| What | 何をするか | 「質問・確認ルールを追加」 |
| Why | なぜするか | 「解釈ズレ防止のため」 |
| Who | 誰がするか | 「40人チーム全員」 |
| When | いつするか | 「2026-01-17〜」 |
| Where | どこでするか | 「全ての業務」 |
| How | どうやってするか | 「3ステップで確認」 |
| How much | どれくらいするか | 「100%適用」 |

### 44.3 定量化ルール

| ルール | 説明 | NG例 | OK例 |
|--------|------|------|------|
| 数値必須 | 曖昧な表現禁止 | 「なるべく早く」 | 「24時間以内」 |
| 基準値設定 | 合格/不合格の境界を明確に | 「高品質」 | 「エラー率0.1%以下」 |
| 単位明記 | 測定可能な単位を使用 | 「たくさん」 | 「10件以上」 |

### 44.4 適用範囲

- 全てのルール定義
- 全てのプロジェクト提案
- 全ての報告・レポート
- 全ての質問・確認

---

## 45. ナレッジ管理ルール（DISC-049承認）

### 45.1 背景（5W2H）

| 項目 | 内容 |
|------|------|
| What | 各分野のナレッジを蓄積・管理するルール |
| Why | 解釈率100%達成のため、各分野で自律するため |
| Who | 39人それぞれ |
| When | 2026-01-17〜（即日開始、1週間以内に初版完成） |
| Where | `/docs/03_knowledge/` |
| How | ベンチマーク→分析→記録→トライ→評価 |
| How much | 39人 × 5対象 = 195ベンチマーク |

### 45.2 フォルダ構造

```
docs/03_knowledge/
├── KNOWLEDGE_INDEX.md（一覧管理）
├── frontend/
│   ├── BUDDY_KNOWLEDGE.md
│   ├── TRAN_KNOWLEDGE.md
│   └── ANA_KNOWLEDGE.md
├── specialist/
│   └── [15名分]
├── balancer/
│   └── [4名分]
├── governance/
│   └── [3名分]
└── executive/
    └── [12名分]
```

### 45.3 ベンチマーク対象の選定

| 項目 | 基準 |
|------|------|
| 対象数 | 各メンバー5つ |
| 選定基準 | その分野で実績ある人物/企業 |
| 情報源 | 公開情報、書籍、論文、インタビュー |

### 45.4 ベンチマーク分析項目（5W2H + 定量化）

| 分析項目 | 内容 | 定量化 |
|---------|------|--------|
| 成功要因 | なぜ長けているか | 3〜5項目で列挙 |
| 再現性 | 属人的か再現可能か | 高/中/低 + 根拠 |
| 必要リソース | 時間、知識、環境 | 数値で定量化 |
| 自己適用方法 | 具体的アクション | 3〜5項目 |
| 難易度 | 実現の難しさ | 1〜5段階 |

### 45.5 トライ→評価→本採用/破棄 運用

| フェーズ | 期間 | 内容 |
|---------|-----|------|
| トライ | 1週間 | 実際に適用 |
| 評価 | トライ後 | 効果測定 |
| 判定 | 評価後 | 本採用/再検討/破棄 |

**評価基準（定量化）**:

| 結果 | 基準 | 対応 |
|------|------|------|
| 本採用 | 解釈率+5%以上 | ナレッジとして正式採用 |
| 再検討 | 解釈率±0% | 条件変更して再トライ |
| 破棄 | 解釈率マイナス | 記録して破棄 |

### 45.6 ナレッジファイルフォーマット

```markdown
# [メンバー名]_KNOWLEDGE.md

## 1. 基本情報
- メンバー名:
- 専門分野:
- 作成日:
- 最終更新:

## 2. ベンチマーク対象（5つ）

### 2.1 [対象1の名前]
| 項目 | 内容 |
|------|------|
| 分類 | 人物/企業 |
| 分野 | |
| 実績 | |
| 成功要因 | 1. / 2. / 3. |
| 再現性 | 高/中/低（根拠: ） |
| 必要リソース | 時間: / 知識: / 環境: |
| 自己適用方法 | 1. / 2. / 3. |
| 難易度 | X/5 |

### 2.2〜2.5 [同様のフォーマット]

## 3. トライ記録

| # | ナレッジ | トライ期間 | 結果 | 判定 |
|---|---------|-----------|------|------|
| 1 | | | | |

## 4. 本採用ナレッジ

| # | ナレッジ | 効果 | 適用開始日 |
|---|---------|------|-----------|
| 1 | | | |

## 5. 更新履歴
```

---

## 46. SPAアーキテクチャ原則

### 46.1 背景（5W2H）

| 項目 | 内容 |
|------|------|
| What | Webアプリのシングルページアプリケーション設計原則 |
| Why | 不要なAPI呼び出しを削減し、パフォーマンス向上 |
| Who | 全Webアプリ開発時 |
| When | 2026-01-19〜（即日適用） |
| Where | GAS Webアプリ、その他フロントエンド |
| How | 初回1回のみデータ取得、以降はキャッシュ利用 |
| How much | API呼び出し: 1回/ページロード |

### 46.2 必須要件

| # | 要件 | 説明 |
|---|------|------|
| 1 | **データ取得は初回1回のみ** | ページロード時に全データ取得、JavaScript変数に保存 |
| 2 | **ページ切り替え時はAPI呼び出し禁止** | 保存済みデータを表示切り替え、DOM操作のみ |
| 3 | **自動リフレッシュ禁止** | `setInterval`による定期取得は使用しない |
| 4 | **最新化はユーザー操作** | リロードまたは更新ボタンで最新データ取得 |

### 46.3 実装パターン

```javascript
// ✅ 正しい実装
let appData = {};  // グローバルキャッシュ

function initApp() {
  fetchAllData().then(data => {
    appData = data;  // 1回だけ取得して保存
    renderCurrentPage();
  });
}

function switchPage(pageName) {
  renderPage(pageName, appData);  // キャッシュから表示
}

// ❌ 禁止パターン
setInterval(fetchData, 60000);  // 定期取得禁止
function switchTab() { fetchData(); }  // タブ切替時の取得禁止
```

### 46.4 例外（許可される再取得）

| 例外 | 条件 |
|------|------|
| ユーザー操作 | 更新ボタン押下、ページリロード |
| データ送信後 | フォーム送信後の該当データのみ |
| エラー時 | 初回取得失敗時のリトライ |

---

## 付録: 基本フレームサンプル（今後作成予定）

| 項目 | 内容 | 状態 |
|------|------|------|
| UIテンプレート | サイドバー、モーダル、トースト、エラー表示 | 未作成 |
| GASテンプレート | 権限チェック、スプレッドシート読み書き、エラーハンドリング | 未作成 |
| 設定シートテンプレート | プルダウン選択肢の管理方法 | 未作成 |

---

**以上**
