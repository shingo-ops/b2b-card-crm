# ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
# KGI: ã‚³ãƒ¼ãƒ‰å“è³ªé•å 0ä»¶ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ï¼‰
# GASã‚³ãƒ¼ãƒ‰ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã€æœªä½¿ç”¨å¤‰æ•°ã€å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º

name: Code Quality Check

on:
  push:
    branches: [main, develop]
    paths:
      - '**/*.gs'
      - '**/*.js'
      - '**/*.html'
  pull_request:
    branches: [main]
    paths:
      - '**/*.gs'
      - '**/*.js'
      - '**/*.html'

jobs:
  gas-code-quality:
    name: GAS Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check GAS syntax patterns
        id: syntax-check
        run: |
          echo "==========================================="
          echo "GASã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯"
          echo "KGI: ã‚³ãƒ¼ãƒ‰å“è³ªé•å 0ä»¶"
          echo "==========================================="
          echo ""

          ERRORS=0
          WARNINGS=0

          # GASãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
          GAS_FILES=$(find . -name "*.gs" ! -path "./.git/*" ! -path "./node_modules/*" 2>/dev/null || true)

          if [ -z "$GAS_FILES" ]; then
            echo "â„¹ï¸ GASãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          echo "--- æ§‹æ–‡ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ ---"
          echo ""

          for file in $GAS_FILES; do
            echo "ğŸ“„ $file"

            # 1. console.logæ¤œå‡ºï¼ˆGASã§ã¯ Logger.log ã‚’ä½¿ç”¨ã™ã¹ãï¼‰
            if grep -n "console\.log" "$file" 2>/dev/null; then
              echo "   âš ï¸ console.logæ¤œå‡º: Logger.logã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
              WARNINGS=$((WARNINGS + 1))
            fi

            # 2. varå®£è¨€æ¤œå‡ºï¼ˆconst/letã‚’æ¨å¥¨ï¼‰
            var_count=$(grep -c "^\s*var\s" "$file" 2>/dev/null || echo "0")
            if [ "$var_count" -gt 0 ]; then
              echo "   âš ï¸ varå®£è¨€ $var_count ä»¶: const/letã‚’æ¨å¥¨"
              WARNINGS=$((WARNINGS + 1))
            fi

            # 3. ç„¡é™ãƒ«ãƒ¼ãƒ—å±é™ºãƒ‘ã‚¿ãƒ¼ãƒ³
            if grep -nE "while\s*\(\s*true\s*\)|for\s*\(\s*;\s*;\s*\)" "$file" 2>/dev/null; then
              echo "   âŒ ç„¡é™ãƒ«ãƒ¼ãƒ—ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º"
              ERRORS=$((ERRORS + 1))
            fi

            # 4. evalä½¿ç”¨æ¤œå‡ºï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
            if grep -n "eval\s*(" "$file" 2>/dev/null; then
              echo "   âŒ eval()ä½¿ç”¨æ¤œå‡º: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯"
              ERRORS=$((ERRORS + 1))
            fi

            # 5. æœªå®šç¾©å¤‰æ•°ã®å¯èƒ½æ€§ï¼ˆç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼‰
            # functionå†…ã§returnãŒãªã„å ´åˆ
            if grep -qE "function\s+\w+\s*\([^)]*\)\s*\{" "$file"; then
              func_without_return=$(awk '/function\s+\w+\s*\([^)]*\)\s*\{/{found=1; start=NR} found && /\}/ && !/return/{if(found && NR>start){print start":"$0}; found=0}' "$file" 2>/dev/null | head -3 || true)
              # ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è¤‡é›‘ãªã®ã§è­¦å‘Šã®ã¿
            fi

            # 6. å±é™ºãªå‰Šé™¤æ“ä½œ
            if grep -nE "\.deleteSheet\(|\.deleteRow\(|\.deleteColumn\(" "$file" 2>/dev/null; then
              echo "   âš ï¸ å‰Šé™¤æ“ä½œæ¤œå‡º: ç¢ºèªæ¨å¥¨"
              WARNINGS=$((WARNINGS + 1))
            fi

            # 7. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸè¡Œ/åˆ—ç•ªå·ï¼ˆãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ï¼‰
            magic_numbers=$(grep -onE "getRange\([0-9]+," "$file" 2>/dev/null | wc -l || echo "0")
            if [ "$magic_numbers" -gt 5 ]; then
              echo "   âš ï¸ ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼å¤šæ•°: å®šæ•°åŒ–ã‚’æ¨å¥¨"
              WARNINGS=$((WARNINGS + 1))
            fi

            echo ""
          done

          echo "==========================================="
          echo "ãƒã‚§ãƒƒã‚¯çµæœ"
          echo "==========================================="
          echo ""
          echo "| é …ç›® | ä»¶æ•° |"
          echo "|------|------|"
          echo "| ã‚¨ãƒ©ãƒ¼ | $ERRORS |"
          echo "| è­¦å‘Š | $WARNINGS |"
          echo ""

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          if [ $ERRORS -gt 0 ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
            exit 1
          else
            echo "âœ… ã‚¨ãƒ©ãƒ¼ãªã—ï¼ˆè­¦å‘Šã¯ä»»æ„å¯¾å¿œï¼‰"
          fi

      - name: Check LockService usage
        run: |
          echo ""
          echo "==========================================="
          echo "LockServiceä½¿ç”¨ãƒã‚§ãƒƒã‚¯"
          echo "==========================================="
          echo ""

          # insertSheet/deleteSheet ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§LockServiceãŒãªã„ã‚‚ã®ã‚’æ¤œå‡º
          GAS_FILES=$(find . -name "*.gs" ! -path "./.git/*" ! -path "./node_modules/*" 2>/dev/null || true)

          VIOLATIONS=0

          for file in $GAS_FILES; do
            # ã‚·ãƒ¼ãƒˆæ“ä½œã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
            if grep -qE "insertSheet|deleteSheet|insertRows|deleteRows" "$file" 2>/dev/null; then
              if ! grep -q "LockService" "$file" 2>/dev/null; then
                echo "âŒ $file: ã‚·ãƒ¼ãƒˆæ“ä½œãŒã‚ã‚‹ãŒLockServiceãŒã‚ã‚Šã¾ã›ã‚“"
                VIOLATIONS=$((VIOLATIONS + 1))
              else
                echo "âœ… $file: LockServiceä½¿ç”¨ç¢ºèª"
              fi
            fi
          done

          echo ""
          if [ $VIOLATIONS -gt 0 ]; then
            echo "âŒ $VIOLATIONS ä»¶ã®LockServiceæœªä½¿ç”¨ã‚’æ¤œå‡º"
            echo ""
            echo "å‚ç…§: docs/00_common/PROCESS_QUALITY/03_GAS_EDITOR/POKAYOKE.md"
            exit 1
          else
            echo "âœ… LockService: å•é¡Œãªã—"
          fi

      - name: Check API function exports
        run: |
          echo ""
          echo "==========================================="
          echo "APIé–¢æ•°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯"
          echo "==========================================="
          echo ""

          # WebApp.gs ã¨ HTMLå†…ã® google.script.run å‘¼ã³å‡ºã—ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
          if [ -f "crm-dashboard/WebApp.gs" ]; then
            echo "ğŸ“„ CRM Dashboard APIæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯"

            # WebApp.gsã‹ã‚‰é–¢æ•°åã‚’æŠ½å‡º
            API_FUNCS=$(grep -oE "^function\s+\w+" crm-dashboard/WebApp.gs 2>/dev/null | sed 's/function //' | sort | uniq)

            # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹é–¢æ•°ã‚’æŠ½å‡º
            HTML_CALLS=$(grep -rohE "google\.script\.run\.[a-zA-Z_]+\(" crm-dashboard/*.html 2>/dev/null | sed 's/google\.script\.run\.//' | sed 's/($//' | sort | uniq)

            MISSING=0
            for call in $HTML_CALLS; do
              if ! echo "$API_FUNCS" | grep -qw "$call"; then
                echo "âŒ $call: HTMLã§å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ãŒWebApp.gsã«å­˜åœ¨ã—ã¾ã›ã‚“"
                MISSING=$((MISSING + 1))
              fi
            done

            if [ $MISSING -gt 0 ]; then
              echo ""
              echo "âŒ $MISSING ä»¶ã®APIä¸æ•´åˆã‚’æ¤œå‡º"
              exit 1
            else
              echo "âœ… APIæ•´åˆæ€§: å•é¡Œãªã—"
            fi
          else
            echo "â„¹ï¸ WebApp.gsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
          fi

  # HTMLã‚³ãƒ¼ãƒ‰å“è³ª
  html-quality:
    name: HTML Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check HTML patterns
        run: |
          echo "==========================================="
          echo "HTMLå“è³ªãƒã‚§ãƒƒã‚¯"
          echo "==========================================="
          echo ""

          ERRORS=0
          WARNINGS=0

          HTML_FILES=$(find . -name "*.html" ! -path "./.git/*" ! -path "./node_modules/*" 2>/dev/null || true)

          for file in $HTML_FILES; do
            echo "ğŸ“„ $file"

            # 1. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«éå¤š
            inline_styles=$(grep -c "style=\"" "$file" 2>/dev/null || echo "0")
            if [ "$inline_styles" -gt 20 ]; then
              echo "   âš ï¸ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« $inline_styles ä»¶: CSSã‚¯ãƒ©ã‚¹åŒ–ã‚’æ¨å¥¨"
              WARNINGS=$((WARNINGS + 1))
            fi

            # 2. innerHTMLä½¿ç”¨ï¼ˆXSSãƒªã‚¹ã‚¯ï¼‰
            if grep -n "\.innerHTML\s*=" "$file" 2>/dev/null | head -3; then
              echo "   âš ï¸ innerHTMLä½¿ç”¨: textContentã¾ãŸã¯ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚’æ¨å¥¨"
              WARNINGS=$((WARNINGS + 1))
            fi

            # 3. document.writeä½¿ç”¨
            if grep -n "document\.write" "$file" 2>/dev/null; then
              echo "   âŒ document.writeä½¿ç”¨: éæ¨å¥¨"
              ERRORS=$((ERRORS + 1))
            fi

            echo ""
          done

          echo "==========================================="
          echo "| é …ç›® | ä»¶æ•° |"
          echo "|------|------|"
          echo "| ã‚¨ãƒ©ãƒ¼ | $ERRORS |"
          echo "| è­¦å‘Š | $WARNINGS |"
          echo ""

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

  # ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã®ãƒã‚«ãƒ¨ã‚±
  code-quality-self-check:
    name: Code Quality Self Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate code quality check configuration
        run: |
          echo "==========================================="
          echo "ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯è‡ªå·±æ¤œè¨¼"
          echo "==========================================="
          echo ""

          if [ -f ".github/workflows/code-quality-check.yml" ]; then
            echo "âœ… code-quality-check.yml: å­˜åœ¨"

            # å¿…é ˆã®ã‚¸ãƒ§ãƒ–ç¢ºèª
            for job in "gas-code-quality" "html-quality"; do
              if grep -q "$job" .github/workflows/code-quality-check.yml; then
                echo "âœ… $job job: å­˜åœ¨"
              else
                echo "âŒ $job job: æ¬ è½"
                exit 1
              fi
            done
          else
            echo "âŒ code-quality-check.yml: å­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi

          echo ""
          echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯è¨­å®š: æ­£å¸¸"
