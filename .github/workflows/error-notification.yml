# ç•°å¸¸æ¤œçŸ¥æ™‚ã®è‡ªå‹•é€šçŸ¥ãƒ»Issueä½œæˆ
# ãƒ•ãƒ­ãƒ¼: ç•°å¸¸æ¤œçŸ¥ â†’ Discordé€šçŸ¥ + Issueä½œæˆ â†’ æ”¹ä¿®ä¾é ¼

name: Error Notification

on:
  workflow_run:
    workflows:
      - "Scheduled Health Check"
      - "Security Check"
      - "Code Quality Check"
      - "Backup Verification"
      - "Process Quality Check"
      - "GAS Pokayoke Check"
    types:
      - completed

jobs:
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get failure details
        id: failure-info
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_BUGREPORT_WEBHOOK }}
        run: |
          # Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "âš ï¸ DISCORD_WEBHOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Secrets ã« DISCORD_WEBHOOK_URL ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"
            exit 0
          fi

          WORKFLOW_NAME="${{ steps.failure-info.outputs.workflow_name }}"
          RUN_URL="${{ steps.failure-info.outputs.run_url }}"
          TIMESTAMP="${{ steps.failure-info.outputs.timestamp }}"

          # Discordé€šçŸ¥ã‚’é€ä¿¡
          curl -s -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ğŸš¨ **ç•°å¸¸æ¤œçŸ¥**\n\nâŒ **å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${WORKFLOW_NAME}\nğŸ“… **ç™ºç”Ÿæ—¥æ™‚**: ${TIMESTAMP}\nğŸ”— **è©³ç´°**: ${RUN_URL}\n\nğŸ‘‰ **å¯¾å¿œä¾é ¼**: Claude Codeã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„\n\`\`\`\ncd ~/sales-ops-with-claude && git pull\n# ä¸Šè¨˜URLã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ä¿®æ­£ä¾é ¼\n\`\`\`\"
            }" \
            "$DISCORD_WEBHOOK"

          echo "âœ… Discordé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ"

      - name: Create GitHub Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="${{ steps.failure-info.outputs.workflow_name }}"
          RUN_URL="${{ steps.failure-info.outputs.run_url }}"
          RUN_ID="${{ steps.failure-info.outputs.run_id }}"
          TIMESTAMP="${{ steps.failure-info.outputs.timestamp }}"

          # åŒã˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœªè§£æ±ºIssueãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          EXISTING=$(gh issue list --label "auto-detected" --label "$WORKFLOW_NAME" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING" ]; then
            echo "æ—¢å­˜ã®Issue #$EXISTING ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚"
            gh issue comment "$EXISTING" --body "## å†ç™ºæ¤œçŸ¥

**ç™ºç”Ÿæ—¥æ™‚**: $TIMESTAMP
**ãƒ­ã‚°**: $RUN_URL

åŒã˜ã‚¨ãƒ©ãƒ¼ãŒå†åº¦ç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          else
            echo "æ–°è¦Issueã‚’ä½œæˆã—ã¾ã™ã€‚"
            gh issue create \
              --title "ğŸš¨ [è‡ªå‹•æ¤œçŸ¥] $WORKFLOW_NAME ãŒå¤±æ•—" \
              --label "auto-detected" \
              --label "$WORKFLOW_NAME" \
              --label "bug" \
              --body "## ç•°å¸¸æ¤œçŸ¥ãƒ¬ãƒãƒ¼ãƒˆ

### æ¦‚è¦
| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | $WORKFLOW_NAME |
| ç™ºç”Ÿæ—¥æ™‚ | $TIMESTAMP |
| ãƒ­ã‚°URL | $RUN_URL |

### å¯¾å¿œæ‰‹é †

1. **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª**
   - ä¸Šè¨˜URLã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª

2. **Claude Codeã§ä¿®æ­£ä¾é ¼**
   \`\`\`
   cd ~/sales-ops-with-claude
   git pull
   # Claude Codeã«ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ä¼ãˆã¦ä¿®æ­£ä¾é ¼
   \`\`\`

3. **ä¿®æ­£å¾Œã®ç¢ºèª**
   - git pushå¾Œã€GitHub ActionsãŒè‡ªå‹•ã§å†ãƒã‚§ãƒƒã‚¯
   - PASSã—ãŸã‚‰ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º

### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®šã—ãŸ
- [ ] ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ãŸ
- [ ] GitHub ActionsãŒPASSã—ãŸ
- [ ] POKA_HISTORY.mdã«è¨˜éŒ²ã—ãŸ
- [ ] å¿…è¦ã«å¿œã˜ã¦ãƒã‚«ãƒ¨ã‚±ã‚’è¿½åŠ ã—ãŸ

---
*ã“ã®Issueã¯è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ*"
          fi

  notify-on-success-after-failure:
    name: Notify Recovery
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if recovering from failure
        id: check-recovery
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"

          # ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœªè§£æ±ºIssueãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          EXISTING=$(gh issue list --label "auto-detected" --label "$WORKFLOW_NAME" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING" ]; then
            echo "issue_number=$EXISTING" >> $GITHUB_OUTPUT
            echo "is_recovery=true" >> $GITHUB_OUTPUT
          else
            echo "is_recovery=false" >> $GITHUB_OUTPUT
          fi

      - name: Send recovery notification
        if: steps.check-recovery.outputs.is_recovery == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_BUGREPORT_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            exit 0
          fi

          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          ISSUE_NUM="${{ steps.check-recovery.outputs.issue_number }}"

          curl -s -H "Content-Type: application/json" \
            -d "{
              \"content\": \"âœ… **æ”¹ä¿®å®Œäº†**\n\nğŸ”§ **å¾©æ—§ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${WORKFLOW_NAME}\nğŸ“‹ **é–¢é€£Issue**: #${ISSUE_NUM}\n\nğŸ‘‰ Issue #${ISSUE_NUM} ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„\"
            }" \
            "$DISCORD_WEBHOOK"

          echo "âœ… å¾©æ—§é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ"

      - name: Comment on issue
        if: steps.check-recovery.outputs.is_recovery == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check-recovery.outputs.issue_number }}"

          gh issue comment "$ISSUE_NUM" --body "## âœ… æ”¹ä¿®å®Œäº†

GitHub ActionsãŒæ­£å¸¸ã«PASSã—ã¾ã—ãŸã€‚

### æ®‹ã‚Šã®ä½œæ¥­
- [ ] POKA_HISTORY.mdã«è¨˜éŒ²ã—ãŸã‹ç¢ºèª
- [ ] ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º"
